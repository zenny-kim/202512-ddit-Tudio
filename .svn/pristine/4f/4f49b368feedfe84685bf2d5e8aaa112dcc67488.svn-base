package kr.or.ddit.projectTask.controller;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.ServiceResult;
import kr.or.ddit.common.code.TaskPriority;
import kr.or.ddit.common.code.TaskStatus;
import kr.or.ddit.file.service.IFileService;
import kr.or.ddit.projectMember.service.IProjectMemberService;
import kr.or.ddit.projectTask.service.IProjectTaskService;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.project.ProjectMemberVO;
import kr.or.ddit.vo.project.ProjectTaskSubVO;
import kr.or.ddit.vo.project.ProjectTaskVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : ProjectTaskController
 * DESC : 프로젝트 상위업무 생성, 수정, 삭제, 목록 컨트롤러
 * </pre>
 * 
 * @author [대덕인재개발원] team1 PSE
 * @version 1.0, 2025.01.02
 * 
 */
@Controller
@Slf4j
//@RequestMapping("/tudio/project/{projectNo}")
@RequestMapping("/tudio/project/task")
public class ProjectTaskController {
	
	@Autowired
	private IProjectTaskService projectTaskService;
	
	@Autowired
	private IProjectMemberService projectMemberService;
	
	@Autowired
	private IFileService fileService;
	
	/**
	 * <p>업무 목록 가져오기</p>
	 * @auther PSE
	 * @param session 로그인 사용자 정보
	 * @param model
	 * @return project/tabs/tab_tasks.jsp
	 */
	@GetMapping("/list")
	public String projectTaskList(
									@RequestParam int projectNo, 
									HttpSession session, 
									Model model) {
		log.info("projectTaskList() 실행~ | projectNo={}", projectNo);
		
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		log.info("loginUser: " + loginUser);
		
		// 로그인 체크
		if(loginUser == null) {
			return "redirect:/tudio/login";
		}
		// 사이트 관리자 접근 차단
		boolean isAdmin = loginUser.getMemberAuthVOList()
									.stream()
									.anyMatch(auth -> "ROLE_ADMIN".equals(auth.getAuth()));
		if(isAdmin) {
			model.addAttribute("errorMsg", "사이트 관리자는 프로젝트 업무에 접근할 수 없습니다.");
			return "error/403";
		}

/*	
		// 프로젝트 구성원 역할 제크 - CLIENT 접근 차단
		if(memberRole.equals("CLIENT")) {
			model.addAttribute("errorMsg", "고객사는 프로젝트 업무에 접근할 수 없습니다.");
			return "error/403";
		}
		// 우선순위 수정 권한 부여를 위한 MANAGER 체크
		boolean isManager = memberRole.equals("MANAGER");
		model.addAttribute("isManager", isManager);
*/		
		
		// 업무 목록 조회
		List<ProjectTaskVO> projectTaskList = projectTaskService.selectTaskList(projectNo);
		
		model.addAttribute("taskList", projectTaskList);
		
		
		return "project/tabs/projectTask/taskList";
	}
	
	/**
	 * <p>업무 생성 폼 불러오기</p>
	 * @auther PSE
	 * @param session 로그인 사용자 정보
	 * @param model
	 * @return taskCreate.jsp
	 */
	@GetMapping("/create")
	public String createProjectTaskForm(
									@RequestParam int projectNo,
									HttpSession session, 
									Model model) {
		log.info("createProjectTaskForm() 실행~ | projectNo={}", projectNo);
		
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		// 로그인 체크
		if(loginUser == null) {
			return "redirect:/tudio/login";
		}
		
		// 권한 체크 - (고객사는 안 되도록)
		
		
		model.addAttribute("projectNo", projectNo);
		model.addAttribute("taskStatusList", TaskStatus.values());
	    model.addAttribute("taskPriorityList", TaskPriority.values());
		
		// 프로젝트 멤버 목록
	    List<ProjectMemberVO> allMemberList = projectMemberService.projectMemberList(projectNo);
	    
	    // 프로젝트 멤버 목록에서 고객사 제거
	    List<ProjectMemberVO> memberList = allMemberList.stream()
	    												.filter(member -> !"CLIENT".equals(member.getProjectRole()))
	    												.collect(Collectors.toList()); // 고객사 회원을 목록에서 제거하고 다시 리스트로 생성
	    
	    model.addAttribute("memberList", memberList);
		
		return "project/tabs/projectTask/taskCreate";
	}
	
	/**
	 * <p>하위업무 생성 폼</p>
	 * @param projectNo
	 * @param model
	 * @return taskSubCreate.jsp
	 */
	@GetMapping("/view/sub/create")
	public String getSubTaskCreateView(@RequestParam int projectNo, Model model) {
		// 프로젝트 멤버 목록
	    List<ProjectMemberVO> allMemberList = projectMemberService.projectMemberList(projectNo);
	    
	    // 프로젝트 멤버 목록에서 고객사 제거
	    List<ProjectMemberVO> memberList = allMemberList.stream()
	    												.filter(member -> !"CLIENT".equals(member.getProjectRole()))
	    												.collect(Collectors.toList()); // 고객사 회원을 목록에서 제거하고 다시 리스트로 생성
	    
	    model.addAttribute("subStatusList", TaskStatus.values());
	    model.addAttribute("subPriorityList", TaskPriority.values());
	    model.addAttribute("memberList", memberList);
		
		return "project/tabs/projectTask/taskSubCreate";
	}
	
	/**
	 * <p>업무 생성하기<p>
	 * @param projectNo
	 * @param projectTaskVO
	 * @param session
	 * @param ra
	 * @return
	 */
	@PostMapping("/create")
	public ResponseEntity<String> createProjectTask(
									@RequestParam int projectNo,
									ProjectTaskVO projectTaskVO,
									@RequestParam(value = "files", required = false) List<MultipartFile> files,
									HttpSession session
									) {
		log.info("createProjectTaskForm() 실행~ | projectNo={}", projectNo);
		
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		// 로그인 체크
		if(loginUser == null) {
			return ResponseEntity.status(401).body("LOGIN_REQUIRED");
		}
		
		try {
			// projectNo & 작성자 설정
			projectTaskVO.setProjectNo(projectNo);
			projectTaskVO.setTaskWriter(loginUser.getMemberNo());

			// 파일 업로드
			if(files != null && !files.isEmpty() && !files.get(0).isEmpty()) {
				int fileGroupNo = fileService.uploadFiles(files, loginUser.getMemberNo(), 403);
				// 생성한 파일 그룹 번호를 VO에 세팅
				projectTaskVO.setFileGroupNo(fileGroupNo);
			}
			
			// 상위 업무 단건 생성
			ServiceResult result = projectTaskService.createTask(projectTaskVO, loginUser.getMemberNo());
			
			if(result.equals(ServiceResult.OK)) {
				return ResponseEntity.ok("SUCCESS");
			} else {
				return ResponseEntity.status(500).body("FAILED");
			}
		}catch(Exception e) {
			log.error("업무 생성 중 에러 발생!", e);
			return ResponseEntity.status(500).body("SERVER_ERROR");
		}
	}
	
	@PostMapping("/sub/create")
	public ResponseEntity<String> createsubTask(
											ProjectTaskSubVO subVO,
											@RequestParam(value = "files", required = false) List<MultipartFile> files,
											HttpSession session
											){
		log.info("createsubTask() 실행~ | parentTaskId={}", subVO.getTaskId());
		
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		if(loginUser == null) {
			return ResponseEntity.status(401).body("LOGIN_REQUIRED");
		}
		
		try {
			// 작성자 설정
			subVO.setSubWriter(loginUser.getMemberNo());
			
			// 파일 업로드
			if(files != null && !files.isEmpty() && !files.get(0).isEmpty()) {
				int fileGroupNo = fileService.uploadFiles(files, loginUser.getMemberNo(), 404);
				// 생성한 파일 그룹 번호를 VO에 세팅
				subVO.setFileGroupNo(fileGroupNo);
			}
			
			ServiceResult result = projectTaskService.createSubTask(subVO);
			
			if(result.equals(ServiceResult.OK)) {
				return ResponseEntity.ok("SUCCESS");
			} else {
				return ResponseEntity.status(500).body("FAILED");
			}
		}catch(Exception e) {
			log.error("하위 업무 생성 중 에러 발생!", e);
			return ResponseEntity.status(500).body("SERVER_ERROR");
		}
		
	}
	
	/**
	 * <p>업무 상세 모달 반환</p>
	 * @return taskDetail.jsp
	 */
	@GetMapping("/view/detail")
	public String getTaskDetailView() {
		return "project/tabs/projectTask/taskDetail";
	}
	
	/**
	 * <p>업무 상세정보 조회</p>
	 * @param taskId
	 * @return ResponseEntity<ProjectTaskVO>
	 */
	@GetMapping("/detail/{taskId}")
	@ResponseBody
	public ResponseEntity<ProjectTaskVO> getTaskDetail(@PathVariable int taskId){
		log.info("getTaskDetail() 실행~ | taskId={}", taskId);
		
		ProjectTaskVO taskVO = projectTaskService.getTaskDetail(taskId);
		
		if(taskVO != null) {
			return ResponseEntity.ok(taskVO);
		} else {
			return ResponseEntity.notFound().build();
		}
	}
	
	/**
	 * <p>하위업무 상제정보 조회</p>
	 * @param subId
	 * @return ResponseEntity<ProjectTaskSubVO>
	 */
	@GetMapping("/sub/detail/{subId}")
	@ResponseBody 
	public ResponseEntity<ProjectTaskSubVO> getSubTaskDetail(@PathVariable int subId){
		log.info("getSubTaskDetail() 실행~ | subId={}", subId);
		
		ProjectTaskSubVO subVO = projectTaskService.getSubTaskDetail(subId);
		
		if(subVO != null) {
			return ResponseEntity.ok(subVO);
		} else {
			return ResponseEntity.notFound().build();
		}
	}
}

