package kr.or.ddit.projectTask.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.projectTask.service.IProjectTaskService;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.project.ProjectTaskVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : ProjectTaskController
 * DESC : 프로젝트 상위업무 생성, 수정, 삭제, 목록 컨트롤러
 * </pre>
 * 
 * @author [대덕인재개발원] team1 PSE
 * @version 1.0, 2025.01.02
 * 
 */
@Controller
@Slf4j
//@RequestMapping("/tudio/project/{projectNo}")
@RequestMapping("/tudio/project/task")
public class ProjectTaskController {
	
	@Autowired
	private IProjectTaskService projectTaskService;

	/**
	 * <p>업무 목록 가져오기</p>
	 * @auther PSE
	 * @param session 로그인 사용자 정보
	 * @param model
	 * @return project/tabs/tab_tasks.jsp
	 */
	@GetMapping("/list")
	public String projectTaskList(
									@RequestParam int projectNo, 
									HttpSession session, Model model) {
		log.info("projectTaskList() 실행~");
		
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		log.info("loginUser: " + loginUser);
		
		// 로그인 체크
		if(loginUser == null) {
			return "redirect:/tudio/login";
		}
		// 사이트 관리자 접근 차단
		boolean isAdmin = loginUser.getMemberAuthVOList()
									.stream()
									.anyMatch(auth -> "ROLE_ADMIN".equals(auth.getAuth()));
		if(isAdmin) {
			model.addAttribute("errorMsg", "사이트 관리자는 프로젝트 업무에 접근할 수 없습니다.");
			return "error/403";
		}

/*	
		// 프로젝트 구성원 역할 제크 - CLIENT 접근 차단
		if(memberRole.equals("CLIENT")) {
			model.addAttribute("errorMsg", "고객사는 프로젝트 업무에 접근할 수 없습니다.");
			return "error/403";
		}
		// 우선순위 수정 권한 부여를 위한 MANAGER 체크
		boolean isManager = memberRole.equals("MANAGER");
		model.addAttribute("isManager", isManager);
*/		
		
		// 업무 목록 조회
		List<ProjectTaskVO> projectTaskList = projectTaskService.selectTaskList(projectNo);
		
		model.addAttribute("taskList", projectTaskList);
		
		
		return "project/tabs/tab_tasks";
	}
	
	/**
	 * <p>업무 생성하기</p>
	 * @auther PSE
	 * @param session 로그인 사용자 정보
	 * @param model
	 * @return project/tabs/task_create.jsp
	 */
	@GetMapping("/create")
	public String createProjectTask(HttpSession session, Model model) {
		log.info("createProjectTask() 실행~");
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");

		// 로그인 체크
		if(loginUser == null) {
			return "redirect:/tudio/login";
		}
		
		// 권한 체크 - (고객사는 안 되도록)
		
		// 
		
		return "projectTask/task_create";
	}
}

