<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<head>
    <meta charset="UTF-8">
    <title>Tudio</title> 
	<jsp:include page="/WEB-INF/views/include/common.jsp" />
	<link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">
	
</head>
<style>

/* 1. 기본 버튼 스타일 (더 작고 연하게) */
.fc .fc-button {
	background-color: #f8fbff !important; /* 배경색을 더 하얗고 투명하게 */
	border: 1px solid #e2e8f0 !important; /* 테두리 색상을 아주 연한 회색빛으로 변경 */
	color: #64748b !important; /* 글자색을 쨍한 파랑 대신 차분한 슬레이트 블루로 */
	font-weight: 500 !important;
	border-radius: 8px !important; /* 라운딩 살짝 조절 */
	padding: 5px 12px !important; /* 안쪽 여백을 줄여 버튼 크기 축소 */
	text-transform: capitalize; /* 전체 대문자보다는 첫 글자만 대문자로 해서 차분하게 */
	font-size: 0.78rem !important; /* 글자 크기 축소 */
	transition: all 0.2s ease !important;
	box-shadow: none !important;
}

/* 2. 마우스를 올렸을 때 (Hover) */
.fc .fc-button:hover {
	background-color: #f1f5f9 !important;
	border-color: #cbd5e1 !important;
	color: var(--main-blue) !important; /* 마우스 올릴 때만 파란색 강조 */
}

/* 3. 활성화된 버튼 (현재 선택된 View) */
.fc .fc-button-active {
	background-color: #eff6ff !important; /* 활성화 시에도 너무 진하지 않은 연한 파랑 배경 */
	border-color: #bfdbfe !important; /* 테두리도 연한 파랑 */
	color: var(--main-blue) !important; /* 글자색만 파란색으로 유지하여 강조 */
	font-weight: 700 !important;
	box-shadow: none !important; /* 그림자 제거해서 더 평면적이고 깔끔하게 */
}

/* 4. 버튼 사이 간격 및 그룹 해제 */
.fc .fc-button-group>.fc-button {
	margin-right: 6px !important; /* 버튼 사이 간격을 살짝 벌림 */
	border-radius: 8px !important; /* 각 버튼의 사방을 모두 둥글게 */
	border-left: 1px solid #e2e8f0 !important; /* 그룹화 시 왼쪽 테두리 사라짐 방지 */
}

/* 5. 오늘(Today) 버튼 */
.fc .fc-today-button {
	background-color: #ffffff !important;
	border: 1px solid #e2e8f0 !important;
	color: #94a3b8 !important; /* 오늘 버튼은 더 은은하게 */
}

/* 6. 화살표 버튼 (prev, next) 크기 조절 */
.fc .fc-button .fc-icon {
	font-size: 0.9em !important; /* 화살표 아이콘 크기도 함께 축소 */
}
/* 7. 달력 날짜 숫자 스타일 (링크 느낌 제거 및 색상 통일) */
.fc .fc-daygrid-day-number {
    text-decoration: none !important;
    color: #333333; /* 평일 기본 검정색 */
    font-weight: 500;
}

/* 8. 일요일 날짜 빨간색 */
.fc .fc-day-sun .fc-daygrid-day-number {
    color: #e11d48 !important;
}

/* 9. 토요일 날짜 파란색 */
.fc .fc-day-sat .fc-daygrid-day-number {
    color: #2563eb !important;
}
/* 10. 마우스 오버 시 날짜 배경 약간 변경 (선택사항) */
.fc .fc-daygrid-day:hover {
    background-color: #f8fafc;
}

/* more 링크 관련 스타일 */
/* 1. +n more 링크 스타일 (알약 모양 배지 스타일) */
.fc .fc-daygrid-more-link {
    display: block;                /* 블록 요소로 변경하여 너비 차지 */
    text-align: center;            /* 텍스트 중앙 정렬 */
    font-size: 0.75rem !important; /* 글자 크기 */
    font-weight: 600;
    color: #64748b !important;     /* 글자색 (슬레이트) */
    background-color: #f1f5f9;     /* 배경색 (아주 연한 회색) */
    border-radius: 50rem;          /* 둥근 알약 모양 */
    padding: 2px 0;                /* 상하 패딩 */
    margin: 2px 5px 0 5px;         /* 양옆 여백 */
    text-decoration: none !important;
    transition: all 0.2s ease;
}

/* 마우스 올렸을 때 */
.fc .fc-daygrid-more-link:hover {
    background-color: #e2e8f0;     /* 배경 조금 더 진하게 */
    color: #334155 !important;     /* 글자 진하게 */
    transform: translateY(-1px);   /* 살짝 떠오르는 효과 */
}

/* 2. 더보기 팝업(Popover) 전체 박스 디자인 */
.fc-theme-standard .fc-popover {
    border: none !important;                 /* 기본 테두리 제거 */
    border-radius: 12px !important;          /* 둥근 모서리 */
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 
                0 8px 10px -6px rgba(0, 0, 0, 0.1) !important; /* 부드러운 그림자 */
    background-color: #ffffff;
    overflow: hidden;                        /* 내부 컨텐츠 넘침 방지 */
}

/* 3. 팝업 헤더 (날짜 부분) */
.fc-theme-standard .fc-popover-header {
    background-color: #f8fbff;               /* 연한 파랑 배경 */
    padding: 12px 16px !important;
    border-bottom: 1px solid #f1f5f9;
}

.fc-theme-standard .fc-popover-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1e293b;
    letter-spacing: -0.02em;
}

.fc-theme-standard .fc-popover-close {
    opacity: 0.5;
    font-size: 0.9em;
}
.fc-theme-standard .fc-popover-close:hover {
    opacity: 1;
}

/* 4. 팝업 바디 (일정 리스트 영역) */
.fc-theme-standard .fc-popover-body {
    padding: 12px !important;
}

/* 팝업 내부의 이벤트 항목 간격 */
.fc-popover-body .fc-daygrid-event-harness {
    margin-bottom: 6px !important;
}
.fc .fc-daygrid-day-frame {
    min-height: 120px !important;
}

</style>
<section class="tudio-section">
    <div class="tudio-section-header">
        <h2 class="h5 fw-bold m-0 text-primary-dark">
            <i class="bi bi-calendar3 me-2"></i> 프로젝트 일정
        </h2>
        <button class="tudio-btn tudio-btn-primary" type="button" id="addScheduleBtn">
            <i class="bi bi-plus-lg me-1"></i> 새 일정 등록
        </button>
    </div>
    <div class="tudio-card p-4 shadow-sm bg-white mt-3">
        <div id="calendar"></div>
    </div>
</section>

<!-- 일정 등록 모달 -->
	<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content tudio-modal">
				<div class="modal-header tudio-modal-header">
					<h5 class="modal-title fw-bold tudio-modal-title" id="addScheduleModalLabel">
						<i class="bi bi-calendar-plus me-2"></i>새 일정 등록
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body p-4">
					
					<form id="scheduleForm">
						<input type="hidden" id="scheduleId" name="scheduleId">
    					<input type="hidden" id="projectNo" name="projectNo">
						<div class="mb-3">
							<label class="form-label fw-bold">일정 제목</label>
							<input type="text" class="form-control" id="scheduleTitle" name="scheduleTitle" placeholder="제목을 입력하세요" required>
						</div>
						<div class="row mb-3">
						    <div class="col-12 mb-2">
						        <div class="form-check form-check-inline">
						            <input class="form-check-input" type="checkbox" id="scheduleAllday" name="scheduleAllday" value="Y">
						            <label class="form-check-label small fw-bold text-muted" for="scheduleAllday">
						                <i class="bi bi-clock-fill me-1"></i>종일 일정
						            </label>
						        </div>
						    </div>
						    
						    <div class="col-md-6">
						        <label class="form-label fw-bold small text-secondary">시작 일시</label>
						        <div class="input-group">
						            <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-event"></i></span>
						            <input type="datetime-local" class="form-control border-start-0" id="scheduleStartdate" name="scheduleStartdate" step="3600">
						        </div>
						    </div>
						
						    <div class="col-md-6">
						        <label class="form-label fw-bold small text-secondary">종료 일시</label>
						        <div class="input-group">
						            <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-check"></i></span>
						            <input type="datetime-local" class="form-control border-start-0" id="scheduleEnddate" name="scheduleEnddate" step="3600">
						        </div>
						    </div>
						</div>
						<div class="row">
							<div class="col-md-6 mb-3">
								<label class="form-label fw-bold">일정 색상</label>
								<input type="color" class="form-control form-control-color w-100" id="scheduleColor" name="scheduleColor" value="#1E90FF">
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label fw-bold">일정 내용</label>
							<textarea class="form-control" id="scheduleDescription" name="scheduleDescription" rows="3" placeholder="내용을 입력하세요"></textarea>
						</div>
					</form>
					
				</div>

				<div class="modal-footer tudio-modal-footer" style="border-top: 1px solid #f1f5f9;">
					<button type="button" class="tudio-btn" data-bs-dismiss="modal" style="background: #f1f5f9; color: #64748b;">취소</button>
					<button type="button" class="tudio-btn tudio-btn-primary" id="saveSchedule" style="padding: 10px 24px;">
						<i class="bi bi-check-lg me-1"></i>일정 저장
					</button>
				</div>
			</div>
		</div>
	</div>
	
<!-- 상세 일정 모달 -->
<div class="modal fade" id="detailScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content tudio-modal" style="border-radius: 15px; overflow: hidden; border: none;">
            <div id="modalHeaderColor" style="height: 10px; width: 100%;"></div>

            <div class="modal-header border-0 pt-4 px-4 pb-2">
                <h5 class="modal-title fw-bold tudio-modal-title" style="color: #334155;">
                    <i class="bi bi-info-circle-fill me-2 text-primary"></i>일정 상세 정보
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4">
                <div class="detail-item mb-4">
                    <div class="small text-muted mb-1" style="font-size: 0.85rem;">일정 제목</div>
                    <a id="detailTitleLink" href="#" class="fw-bold fs-5 text-decoration-none d-block" style="color: #1e293b;">
                        <span id="detailTitle"></span>
                    </a>
                </div>

                <div class="row mb-4">
                    <div class="col-6">
                        <div class="small text-muted mb-1" style="font-size: 0.85rem;">시작 일시</div>
                        <div id="detailStart" class="fw-semibold" style="color: #475569;"></div>
                    </div>
                    <div class="col-6 border-start"> <div class="small text-muted mb-1" style="font-size: 0.85rem;">종료 일시</div>
                        <div id="detailEnd" class="fw-semibold" style="color: #475569;"></div>
                    </div>
                </div>

                <div class="detail-item mb-4">
                    <div class="small text-muted mb-1" style="font-size: 0.85rem;">일정 구분</div>
                    <span id="detailType" class="badge rounded-pill d-inline-flex align-items-center justify-content-center px-3 py-2 fw-medium" style="font-size: 0.8rem; color: #475569;"></span>
                </div>
                
				<div class="detail-item mb-4">
				    <div class="small text-muted mb-1" style="font-size: 0.85rem;">담당자</div>
				    <div class="d-flex align-items-center">
				        <span id="detailMember" class="fw-bold text-dark fs-6"></span>
				    </div>
				</div>
                
                <div class="detail-item mb-2">
                    <div class="small text-muted mb-2" style="font-size: 0.85rem;">상세 내용</div>
                    <div id="detailDescription" class="p-3 rounded-3" 
                         style="white-space: pre-wrap; color: #444; background-color: #f8fafc; border: 1px solid #f1f5f9; min-height: 80px;">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer border-0 px-4 pb-4 pt-3">
                <button type="button" class="tudio-btn" id="deleteScheduleBtn" 
                        style="display: none; background: #fff1f2; color: #e11d48; border: 1px solid #fecdd3; padding: 8px 16px; border-radius: 8px;">
                    <i class="bi bi-trash3 me-1"></i> 일정 삭제
                </button>
                <button type="button" class="tudio-btn btn-secondary px-4" data-bs-dismiss="modal" 
                        style="background-color: #64748b; color: white; border: none; border-radius: 8px; padding: 8px 24px;">
                    확인
                </button>
            </div>
        </div>
    </div>
</div>


<script>
$(function() {
    const currentProjectNo = "${projectNo}";
    
    // [날짜 포맷 함수] JSP와의 충돌 방지를 위해 백틱(``) 대신 + 연산자 사용
    // XML의 TO_TIMESTAMP 포맷('YYYY-MM-DD HH24:MI:SS')에 맞춰 변환
    const formatDate = (date) => {
        if (!date) return null;
        const d = new Date(date);
        const pad = (n) => n < 10 ? '0' + n : n;
        
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' +
               pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
    };

    const calendarEl = $('#calendar')[0];
    const calendar = new FullCalendar.Calendar(calendarEl, {
    	buttonIcons: {
    	    prev: 'chevron-left',
    	    next: 'chevron-right'
    	  },
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: 'auto',
        editable: true,             // 수정 가능 여부 (전체 마스터 스위치)
        eventDurationEditable: true,// [중요] 기간(길이) 변경 허용
        eventResizableFromStart: true, // 앞쪽(시작일) 잡고 늘리기 허용
        droppable: true,            // 외부 요소 드롭 허용

        // [이벤트 스타일 설정] 블록 형태로 보여야 리사이즈 핸들이 잘 보임
        displayEventTime: false,    
        eventDisplay: 'block',      
        eventTextColor: '#000000',

        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
        },
        dayCellContent: function(info) { return info.date.getDate(); },
        buttonText: { today: 'TODAY', month: 'MONTH', list: 'LIST' },
        
        // [이동 시 실행] 날짜를 드래그해서 옮길 때
        eventDrop: function(info) {
            updateEventDate(info, '이동');
        },

        // [길이 조절 시 실행] 일정의 끝을 잡고 늘리거나 줄일 때
        eventResize: function(info) {
            updateEventDate(info, '기간 변경');
        },

        // [클릭 시 실행] 상세 모달
        eventClick: function(info) {
            openDetailModal(info.event);
        },

        // 데이터 로드
        events: function(info, successCallback, failureCallback) {
            if (!currentProjectNo || currentProjectNo === "0") return;

            $.ajax({
                url: `${pageContext.request.contextPath}/tudio/project/schedule/getProjectScheduleList/` + currentProjectNo,
                type: 'GET',
                dataType: 'json',
                success: function(list) {
                    if(!list || list.length === 0) {
                        successCallback([]);
                        return;
                    }

                    const events = list.map(item => {
                        // DB 컬럼명 대소문자 호환 처리
                        let start = item.scheduleStartdate || item.SCHEDULESTARTDATE;
                        let end = item.scheduleEnddate || item.SCHEDULEENDDATE;
                        let mName = item.memberName || item.MEMBERNAME; 
                        let sType = item.scheduleType || item.SCHEDULETYPE;

                        if(start) start = start.replace(/\//g, '-');
                        if(end) end = end.replace(/\//g, '-');

                        return {
                            id: item.scheduleId || item.SCHEDULEID,
                            title: item.scheduleTitle || item.SCHEDULETITLE,
                            start: start,
                            end: end,
                            backgroundColor: item.scheduleColor || item.SCHEDULECOLOR,
                            borderColor: item.scheduleColor || item.SCHEDULECOLOR,
                            allDay: (item.scheduleAllday || item.SCHEDULEALLDAY) === 'Y',
                            extendedProps: {
                                type: sType, // SCHEDULE, TASK, SUB
                                description: item.scheduleDescription || item.SCHEDULEDESCRIPTION,
                                status: item.scheduleStatus || item.SCHEDULESTATUS,
                                memberName: mName
                            }
                        };
                    });
                    successCallback(events);
                },
                error: function(xhr) {
                    console.error("일정 로드 실패:", xhr);
                    failureCallback(xhr);
                }
            });
        }
    });
    
    calendar.render();

    // ==========================================
    // [2] 날짜 업데이트 AJAX 함수 (이동 & 리사이즈 공용)
    // ==========================================
    function updateEventDate(info, actionName) {
        const event = info.event;
        const props = event.extendedProps;
        
        // 종료일 계산: FullCalendar에서 리사이즈 시 end 날짜가 자동으로 변경됨
        // 만약 하루짜리라 end가 null이면 start와 동일하게 세팅
        let startDate = formatDate(event.start);
        let endDate = event.end ? formatDate(event.end) : startDate;

        const updateData = {
            id: event.id,
            type: props.type, // XML의 <choose> 문에서 사용할 타입 (SCHEDULE, TASK, SUB)
            start: startDate,
            end: endDate
        };

        // 디버깅용 로그
        // console.log(actionName + " 요청:", updateData);

        $.ajax({
            url: `${pageContext.request.contextPath}/tudio/project/schedule/updateDate`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updateData),
            success: function(res) {
                if (res === "success") {
                    // 성공 시 우측 상단 토스트 메시지
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
                    });
                    Toast.fire({ icon: 'success', title: '일정이 변경되었습니다.' });
                } else if (res === "login_required") {
                    info.revert(); // 실패 시 원래대로 되돌림
                    Swal.fire('로그인 필요', '로그인이 필요합니다.', 'warning');
                } else {
                    info.revert(); // 권한 없음 등 실패 시 되돌림
                    Swal.fire('권한 없음', '본인이 담당자인 업무만 수정할 수 있습니다.', 'error');
                }
            },
            error: function(xhr) {
                info.revert(); // 에러 발생 시 되돌림
                console.error("업데이트 에러:", xhr);
                Swal.fire('서버 오류', '일정 수정 중 문제가 발생했습니다.', 'error');
            }
        });
    }

    // [상세 모달 열기 함수]
    function openDetailModal(event) {
        const props = event.extendedProps;
        const type = props.type || 'SCHEDULE';
        const id = event.id;

        $('#detailTitle').text(event.title);
        $('#detailDescription').text(props.description || '상세 내용이 없습니다.');
        
        // 담당자 이름 표시
        if($('#detailMember').length > 0) {
             $('#detailMember').text(props.memberName || '담당자 없음');
        }

        const formatToHour = (dateStr) => {
            if (!dateStr) return '-';
            let dateTime = dateStr.replace('T', ' '); 
            return dateTime.includes(':') ? dateTime.split(':')[0] + '시' : dateTime;
        };

        const isAllDay = event.allDay;
        const startStr = isAllDay ? event.startStr : formatToHour(event.startStr);
        let endStr = '-';
        if (event.endStr) {
            endStr = isAllDay ? event.endStr : formatToHour(event.endStr);
        }

        $('#detailStart').text(startStr);
        $('#detailEnd').text(endStr);

        // 일정 구분 텍스트 및 스타일 설정
        $('#detailType').text(
            type === 'SCHEDULE' ? '개인 일정' : 
            type === 'TASK' ? '상위 업무' : '하위 업무'
        ).css({
            'background-color': event.backgroundColor,
            'color': '#000000' // 글씨색 검정
        });

        if (type === 'SCHEDULE') {
            $('#deleteScheduleBtn').show().data('id', id); 
        } else {
            $('#deleteScheduleBtn').hide();
        }

        $('#modalHeaderColor').css('background-color', event.backgroundColor);
        $('#detailScheduleModal').modal('show');
    }

    // --- (이하 기존 등록/삭제 로직 유지) ---

    $('#scheduleAllday').on('change', function() {
        const isChecked = $(this).prop('checked');
        const $startInput = $('#scheduleStartdate');
        const $endInput = $('#scheduleEnddate');
        
        if (isChecked) {
            const offset = new Date().getTimezoneOffset() * 60000;
            const today = new Date(Date.now() - offset).toISOString().split('T')[0];
            if(today) {
                $startInput.val(today + "T00:00");
                $endInput.val(today + "T23:59");
                $startInput.attr('readonly', true).addClass('bg-light');
                $endInput.attr('readonly', true).addClass('bg-light');
            }
        } else {
            $startInput.attr('readonly', false).removeClass('bg-light');
            $endInput.attr('readonly', false).removeClass('bg-light');
        }
    });
    
    $('#addScheduleBtn').on('click', function() {
        if(typeof $('#scheduleForm')[0] !== 'undefined') {
            $('#scheduleForm')[0].reset();
            $('#projectNo').val(currentProjectNo);
            $('#addScheduleModal').modal('show');
        }
    });
    
    $('#deleteScheduleBtn').on('click', function() {
        const scheduleId = $(this).data('id');
        Swal.fire({
            title: '일정을 삭제하시겠습니까?',
            text: "삭제된 일정은 복구할 수 없습니다.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e11d48',
            cancelButtonColor: '#64748b',
            confirmButtonText: '삭제',
            cancelButtonText: '취소',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `${pageContext.request.contextPath}/tudio/project/schedule/delete`,
                    type: 'POST',
                    data: { scheduleId: scheduleId },
                    success: function(res) {
                        if (res === "success" || res > 0) {
                            Swal.fire({
                                title: '삭제 완료',
                                text: '일정이 삭제되었습니다.',
                                icon: 'success',
                                confirmButtonColor: '#00407F'
                            });
                            $('#detailScheduleModal').modal('hide');
                            calendar.refetchEvents(); 
                        } else {
                            Swal.fire('실패', '일정 삭제에 실패했습니다.', 'error');
                        }
                    }
                });
            }
        });
    });
    
    $('#saveSchedule').on('click', function() {
        const scheduleData = {
            projectNo: $('#projectNo').val(),
            scheduleTitle: $('#scheduleTitle').val(),
            scheduleDescription: $('#scheduleDescription').val(),
            scheduleStartdate: $('#scheduleStartdate').val(),
            scheduleEnddate: $('#scheduleEnddate').val(),
            scheduleAllday: $('#scheduleAllday').is(':checked') ? 'Y' : 'N',
            scheduleColor: $('#scheduleColor').val(),
            memberNo: "${loginUser.memberNo}"
        };

        if(!scheduleData.scheduleTitle) {
            Swal.fire({
                title: '입력 오류',
                text: '일정 제목을 입력해 주세요.',
                icon: 'warning',
                confirmButtonColor: '#00407F'
            });
            return;
        }

        $.ajax({
            url: `${pageContext.request.contextPath}/tudio/project/schedule/insert`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(scheduleData),
            success: function(res) {
                if(res === "success") {
                    Swal.fire({
                        title: '등록 완료',
                        text: '일정이 등록되었습니다.',
                        icon: 'success',
                        confirmButtonColor: '#00407F'
                    }).then(() => {
                        $('#addScheduleModal').modal('hide');
                        calendar.refetchEvents();
                    });
                } else {
                    Swal.fire('등록 실패', '오류가 발생했습니다.', 'error');
                }
            }
        });
    });
});
</script>