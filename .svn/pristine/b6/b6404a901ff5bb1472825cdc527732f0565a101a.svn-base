package kr.or.ddit.notification.service.impl;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronization;
import org.springframework.transaction.support.TransactionSynchronizationManager;

import kr.or.ddit.notification.handler.NotificationHandler;
import kr.or.ddit.notification.mapper.INotificationMapper;
import kr.or.ddit.notification.service.INotificationService;
import kr.or.ddit.vo.NotificationVO;

/**
 * 컨트롤러에서 호출하는 알림 조회/읽음 처리/삭제를 처리한다.
 * 알림은 DB에 쌓는 데이터이고, 웹소켓은 "실시간 갱신"을 위한 옵션이다.
 */
@Service
public class NotificationServiceImpl implements INotificationService {

    @Autowired
    private INotificationMapper notiMapper;

    @Autowired
    private NotificationHandler notiHandler;


    /**
     * 프로젝트 초대
     * @param vo
     * @return
     */
    @Transactional
    public int insertNoti(NotificationVO vo) {

        int cnt = notiMapper.insertNoti(vo);

        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {

            @Override
            public void afterCommit() {

                int unread = notiMapper.selectUnreadCount(vo.getMemberNo());

                Map<String, Object> notiPayload = new HashMap<>();
                notiPayload.put("type", "NOTI_NEW"); 
                notiPayload.put("unreadCount", unread);
                notiPayload.put("noti", vo);

               
                notiHandler.sendToMember(vo.getMemberNo(), notiPayload);
            }
        });

        return cnt;
    }

    /**
     * 설정이 ON일 때만 알림 저장
     * @param vo         
     * @param settingKey
     * @return insert 결과

     */
    public int insertNotiEnabled(NotificationVO vo, String settingKey) {
        Map<String, Object> insertNotiEnabledParam = new HashMap<>();
        insertNotiEnabledParam.put("vo", vo);
        insertNotiEnabledParam.put("settingKey", settingKey);

        return notiMapper.insertNotiEnabled(insertNotiEnabledParam);
    }

    /**
     * 알림 목록 조회 (전체 / 안읽음만)
     *
     * @param memberNo    
     * @param unreadOnly 
     * @return 알림 리스트
     */
    @Override
    public List<NotificationVO> notiList(int memberNo, boolean unreadOnly) {
        Map<String, Object> notiParam = new HashMap<>();
        notiParam.put("memberNo", memberNo);
        notiParam.put("unreadOnly", unreadOnly);

        return notiMapper.notiList(notiParam);
    }

    /**
     * 안읽은 알림 개수
     *
     * @param memberNo 
     * @return 
     */
    @Override
    public int notiUnreadCount(int memberNo) {
        return notiMapper.selectUnreadCount(memberNo);
    }

    /**
     * 특정 알림 1건 읽음 처리
     * @param memberNo 
     * @param notiNo   
     */
    @Override
    public void notiMarkRead(int memberNo, long notiNo) {
        Map<String, Object> notiMarkReadParam = new HashMap<>();
        notiMarkReadParam.put("memberNo", memberNo);
        notiMarkReadParam.put("notiNo", notiNo);

        notiMapper.updateRead(notiMarkReadParam);
    }

    /**
     * 특정 알림 삭제(물리)
     *
     * @param memberNo 
     * @param notiNo   
     */
    @Override
    public void notiDelete(int memberNo, long notiNo) {
        Map<String, Object> notiDeleteParam = new HashMap<>();
        notiDeleteParam.put("memberNo", memberNo);
        notiDeleteParam.put("notiNo", notiNo);

        notiMapper.deleteNoti(notiDeleteParam);
    }

    
    /**
     * 사이트 공지사항 DB 저장
     */
	@Override
	public void insertSiteNoticeNoti(String notiUrl, int notiNo) {
		
		Map<String,Object> notiParam = new HashMap<>();
		notiParam.put("notiUrl", notiUrl);
		notiParam.put("notiNo", notiNo);
		
		notiMapper.insertSiteNoticeNoti(notiParam);
		
		
		
	}

	@Override
	public List<NotificationVO> notiListByTab(int memberNo, String tab) {
		
		boolean unreadOnly = "unread".equalsIgnoreCase(tab);
		boolean readOnly = "read".equalsIgnoreCase(tab);
		
		Map<String, Object> notiParam = new HashMap<>();
		notiParam.put("memberNo", memberNo);
		notiParam.put("unreadOnly", unreadOnly);
		notiParam.put("readOnly", readOnly);
		
		return notiMapper.notiList(notiParam);
	}
}
