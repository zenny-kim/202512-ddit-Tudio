package kr.or.ddit.approval.controller;

import java.security.Principal;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.approval.service.IApprovalService;
import kr.or.ddit.member.service.IMemberService;
import kr.or.ddit.vo.ApprovalPaginationInfoVO;
import kr.or.ddit.vo.DraftDocumentVO;
import kr.or.ddit.vo.MemberVO;

@Controller
@RequestMapping("/tudio/approval")
public class ApprovalController {
	
	@Autowired
	private IMemberService memberService;
	
	@Autowired
	private IApprovalService approvalService;
	
	@GetMapping("/list")
	public String approvalList(
	        @RequestParam(name="projectNo") int projectNo, // 어떤 프로젝트의 결재함인지 필수
	        @RequestParam(name="page", required=false, defaultValue="1") int currentPage,
	        @RequestParam(value="tabType", required=false, defaultValue="ALL") String tabType, // 미니탭
	        @RequestParam(value="searchType", required=false) String searchType,
	        @RequestParam(value="searchWord", required=false) String searchWord,
	        Principal principal, Model model, HttpSession session) {

	    // 1. 보안 체크 (로그인 여부)
	    if (principal == null) {
	        return "redirect:/tudio/login";
	    }

	    // 2. 로그인 사용자 정보 가져오기 및 세션 저장
	    String memberId = principal.getName();
	    MemberVO member = memberService.findByMemberId(memberId);
	    if (member == null) return "redirect:/tudio/login";
	    
	    session.setAttribute("loginUser", member);
	    int userNo = member.getMemberNo();

	    // 3. ★핵심: 이 프로젝트에서 이 유저의 역할(MANAGER/CLIENT/MEMBER) 조회
	    // 이 정보가 있어야 상단 카드와 탭을 다르게 보여줍니다.
	    String projectRole = approvalService.getProjectRole(projectNo, userNo);
	    model.addAttribute("projectRole", projectRole);

	    // 4. 상단 카드용 통계 데이터 조회 (Role에 따라 결과가 다름)
	    Map<String, Object> stats = approvalService.getApprovalStats(projectNo, userNo, projectRole);
	    model.addAttribute("stats", stats);

	    // 5. 페이징 및 검색 조건 설정
	    // 기존 InquiryPaginationInfoVO를 활용하거나 Approval용을 새로 만듭니다.
	    ApprovalPaginationInfoVO<DraftDocumentVO> pagingVO = new ApprovalPaginationInfoVO<>();
	    pagingVO.setCurrentPage(currentPage);
	    pagingVO.setUserNo(userNo);
	    pagingVO.setProjectNo(projectNo);
	    pagingVO.setProjectRole(projectRole); // 쿼리 분기용
	    pagingVO.setTabType(tabType);
	    pagingVO.setSearchType(searchType);
	    pagingVO.setSearchWord(searchWord);

	    // 6. 데이터 개수 및 리스트 조회
	    int totalRecord = approvalService.getApprovalCount(pagingVO);
	    pagingVO.setTotalRecord(totalRecord);

	    List<DraftDocumentVO> approvalList = approvalService.getApprovalList(pagingVO);
	    pagingVO.setDataList(approvalList);

	    model.addAttribute("pagingVO", pagingVO);
	    model.addAttribute("projectNo", projectNo); // 페이지 이동 시 필요

	    return "approval/list"; // 결재 리스트 JSP
	}
}