<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/css/projectTabMemberList.css">
<div class="tab-content-card" id="tabMember"
	data-project-no="${projectNo}">
	
	<!-- ✅ 여기: 탭 컨텐츠 최상단 제목 -->
<div class="my-page-header">
  <div class="h5 fw-bold m-0 text-primary-dark">
    <i class="bi bi-people-fill me-2"></i> 구성원
  </div>
</div>


	<!-- ===== 구성원 탭 컨텐츠 시작 ===== -->
	<section class="member-panel">

		<main class="project-main">

			<!-- 좌측 : 업무 현황 차트 -->
			<section class="main-card chart-area">
				<h3 class="card-title">진행 중인 담당 업무 현황</h3>
				<div class="chart-box">
					<!-- chart.js / echarts 들어갈 자리 -->
					<canvas id="memTaskChart"></canvas>
					<div id="noTaskMsg"
						style="display: none; text-align: center; padding: 24px 0; font-weight: 600;">
						진행중인 업무가 없습니다</div>
				</div>
			</section>


			<section class="main-card member-area">
				<h3 class="card-title">구성원 목록 (${projectMemberCount})</h3>


				<!--  검색 영역 -->
				<div class="d-flex gap-2 align-items-center mb-2">
					<select id="searchType" class="form-select form-select-sm"
						style="width: 140px;">
						<option value="memberName">이름</option>
						<option value="companyName">회사명</option>
						<option value="memberDepartment">부서</option>
					</select> <input id="searchWord" class="form-control form-control-sm"
						style="max-width: 240px;" type="text" placeholder="검색어 입력" />

					<button id="memSearchBtn" class="btn btn-sm btn-primary"
						type="button">검색</button>
				</div>
				<!--  검색 영역 -->

				<table class="member-table">
					<thead>
						<tr>
							<th>No</th>
							<th>이름</th>
							<th>구분</th>
							<th>회사명</th>
							<th>부서</th>
							<th>직급</th>
							<th>채팅</th>
						</tr>
					</thead>

					<tbody id="memTbody">
						<!-- 비동기 렌더링 -->
					</tbody>

				</table>
			</section>

		</main>

	</section>

</div>

<!-- ===== 구성원 상세 모달 (Bootstrap) ===== -->
<div class="modal fade" id="memberModal" tabindex="-1"
	aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content member-modal">

			<div class="modal-header">
				<div>
					<h5 class="modal-title">구성원 상세 정보</h5>
				</div>

				<div class="d-flex align-items-center gap-2">
					<!-- 마스킹(누르고 있는 동안 해제) 버튼 -->


					<!-- 닫기 -->
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>
			</div>

			<div class="modal-body">
				<!-- 상단 -->
				<div class="mm-modal2">

					<!-- 상단: 프로필 + 업무현황 -->
					<div class="mm-topWrap2">
						<div class="mm-avatar4">
							<img id="mAvatarImg" alt="profile" />
						</div>

						<div class="mm-right2">
							<div class="mm-nameRow">
								<div class="mm-name4" id="mName">-</div>


								<!-- 	<button type="button" class="mm-maskTopBtn" id="maskHoldBtn"
									aria-label="이름 마스킹 해제">
									<i class="bi bi-eye"></i>
								</button> -->
							</div>

							<div class="mm-workCard2 mm-workAlign" id="mWorkCard">
								<div class="mm-workHead2">
									<div class="mm-workTitle2">업무 현황</div>
									<div class="mm-workHint2" id="mWorkHint" style="display: none;"></div>
								</div>

								<div class="mm-workGrid2">

									<!-- 1줄: 총업무 + 진행중 (반반) -->
									<div class="mm-workRowTop">
										<!-- 총 업무 -->
										<div class="mm-stat2 mm-total">
											<div class="mm-statTop2">
												<i class="bi bi-clipboard-check mm-ico2"></i> <span
													class="mm-statLabel2">총 업무</span>
											</div>
											<div class="mm-statNum2">
												<span id="mTotal">0</span><small>개</small>
											</div>
										</div>

										<!-- 진행중 -->
										<div class="mm-stat2">
											<div class="mm-statTop2">
												<i class="bi bi-play-circle mm-ico2"></i> <span
													class="mm-statLabel2">진행중</span>
											</div>
											<div class="mm-statNum2">
												<span id="mIng">0</span><small>개</small>
											</div>
										</div>
									</div>

									<!-- 2줄: 완료 / 지연 / 보류 (3칸) -->
									<div class="mm-workRowBottom">
										<!-- 완료 -->
										<div class="mm-stat2">
											<div class="mm-statTop2">
												<i class="bi bi-check-circle mm-ico2"></i> <span
													class="mm-statLabel2">완료</span>
											</div>
											<div class="mm-statNum2">
												<span id="mDone">0</span><small>개</small>
											</div>
										</div>

										<!-- 지연 -->
										<div class="mm-stat2">
											<div class="mm-statTop2">
												<i class="bi bi-exclamation-triangle mm-ico2"></i> <span
													class="mm-statLabel2">지연</span>
											</div>
											<div class="mm-statNum2">
												<span id="mDelay">0</span><small>개</small>
											</div>
										</div>

										<!-- 보류 -->
										<div class="mm-stat2 mm-hold">
											<div class="mm-statTop2">
												<i class="bi bi-pause-circle mm-ico2"></i> <span
													class="mm-statLabel2">보류</span>
											</div>
											<div class="mm-statNum2">
												<span id="mHold">0</span><small>개</small>
											</div>
										</div>
									</div>

								</div>
							</div>


						</div>
					</div>
				</div>

				<!-- 구분선 -->
				<div class="mm-divider2"></div>

				<!-- ✅ Info: 리스트 말고 "카드형"으로 압축 -->
				<div class="mm-infoGrid2">
					<div class="mm-infoItem2">
						<div class="k">참여일</div>
						<div class="v" id="mDate">-</div>
					</div>

					<div class="mm-infoItem2">
						<div class="k">연락처</div>
						<div class="v" id="mTel">-</div>
					</div>

					<!-- ✅ 부서/직급을 위로 -->
					<div class="mm-infoItem2">
						<div class="k">부서</div>
						<div class="v" id="mDept">-</div>
					</div>

					<div class="mm-infoItem2">
						<div class="k">직급</div>
						<div class="v" id="mPos">-</div>
					</div>

					<!-- ✅ 이메일을 아래로(길어서 span2) -->
					<div class="mm-infoItem2 mm-span2">
						<div class="k">이메일</div>
						<div class="v" id="mEmail">-</div>
					</div>
				</div>


				<div class="mm-desc" id="mProgHint" style="display: none;"></div>
			</div>







			<div class="modal-footer">
				<button type="button" class="btn btn-outline-secondary btn-sm"
					data-bs-dismiss="modal">닫기</button>
			</div>

		</div>
	</div>
</div>


<!-- 플러그인 CDN 추가. 파이조각 위에 숫자값 표시를 하려고 추가함 -->
<script src="${pageContext.request.contextPath}/js/footer.js"></script>

<script type="text/javascript">



//모달 이벤트 리스너
document.getElementById('memberModal').addEventListener('show.bs.modal', async (event) => {
  const target = event.relatedTarget;
  const row = target.closest(".member-name");
  if (!row) return;

  const memberNo = row.dataset.memberNo;

  const url = "/tudio/project/member/memberModal?projectNo=" + encodeURIComponent(projectNo)
            + "&memberNo=" + encodeURIComponent(memberNo);

  try {
    const res = await fetch(url);
    if (!res.ok) {
      console.error("memberModal 응답 실패:", res.status, url);
      return;
    }
    const data = await res.json();

    // 안전하게 넣기 (존재하는 엘리먼트만)
    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.innerText = (v ?? "-");
    };

    setText("mName",  data.memberName);
    setText("mEmail", data.memberEmail);
    setText("mTel",   data.memberTel);
    setText("mDate",  data.projectMemregdate);

    // 네 JSP에서 mDept는 '부서' 칸인데 지금 data.companyName 넣고 있었음
    // 부서/회사명 중 실제 원하는 값으로 골라서 쓰면 됨
    setText("mDept",  data.memberDepartment ?? data.companyName);
    setText("mPos",   data.memberPosition);

    // 업무현황 (JSP id 기준)
    setText("mTotal", data.totalTaskCnt);
    setText("mIng",   data.ingCnt);
    setText("mDone",  data.doneCnt);
    setText("mDelay", data.delayCnt);
    setText("mHold",  data.holdCnt);
    
 // ✅ ROLE_CLIENT(기업관리자)면 업무현황 숨김
    const workCard = document.getElementById("mWorkCard");
    if (workCard) {
      const isClient =
        data.projectRole === "CLIENT" ||
        data.projectRole === "ROLE_CLIENT";

      workCard.style.display = isClient ? "none" : "";
    }

    

    // 프로필 이미지
    const img = document.getElementById("mAvatarImg");
    if (img) img.src = data.memberProfileImg ? data.memberProfileImg : "/images/default_profile.png";

  } catch (err) {
    console.error("모달 데이터 로드 실패:", err);
  }
});

//2. 차트 데이터를 불러오고 그리는 비동기 함수
async function loadMemberChart() {
	
	var canvasEl = document.getElementById("memTaskChart"); // 존재여부 체크, 화면 숨김 제어
	var noTaskMsg = document.getElementById("noTaskMsg");

    var canvas = document.querySelector("#memTaskChart"); // 렌더링 대상

    
    try {
    	const response = await fetch("/tudio/project/member/memberChart?projectNo=" + encodeURIComponent(projectNo));

        if (!response.ok) {
            throw new Error(`서버 통신 오류: ${response.status}`);
        }

        const data = await response.json();

        // data 안전 처리
        const safeData = Array.isArray(data) ? data : [];
        
        console.log("safeData : ",safeData);

        // 담당업무 0개 제외 (여기가 핵심) 배열에서 조건을 만족하는 요소를 남김. 배열순회
		const filteredData = safeData
		  .filter(item =>
		    item.projectRole !== "CLIENT" &&
		    item.projectRole !== "ROLE_CLIENT"
		  );


        
        // 진행중인 총 업무 개수가 많은 기준으로 내림차순 정렬하기
        filteredData.sort((a,b) =>{
        	const aTotal = (a.ingCnt ?? 0) +(a.ingSubCnt ?? 0);
        	const bTotal = (b.ingCnt ?? 0) + (b.ingSubCnt ?? 0);
        	  return bTotal - aTotal;
        	
        })
        
        
        console.log("filteredData : ",filteredData);

        // 전부 0개면 차트 영역 숨김 + 기존 차트 제거 후 종료
        if (filteredData.length === 0) {
		  if (window.memChartInstance) {
		    window.memChartInstance.destroy();
		    window.memChartInstance = undefined;
		  }
		  canvasEl.style.display = "none";
		  noTaskMsg.style.display = "block";
		  return;
		} else {
		  noTaskMsg.style.display = "none";
		  canvasEl.style.display = "block";
		}

        // 데이터 가공. 새 배열 생성. memberName와 totalWorkCnt뽑아서
        var labels = filteredData.map(item => item.memberName); 
        
        //  총 업무,빨강(진행중), 완료, 지연,보류 
        
        var totalTaskCnt  = filteredData.map(item => item.totalTaskCnt ?? 0);  // 총 업무
        var ingCnt  = filteredData.map(item => item.ingCnt ?? 0);  // 진행중
        var doneCnt = filteredData.map(item => item.doneCnt ?? 0); // 완료
        var delayCnt = filteredData.map(item => item.delayCnt ?? 0); // 지연
        var holdCnt = filteredData.map(item => item.holdCnt ?? 0); // 보류

        var palette = ['#4e79a7', '#f28e2b', '#bab0ab', '#edc949', '#76b7b2', '#59a14f', '#2f4b7c', '#e15759', '#79706e', '#ff9da7'];
        var bgColors = filteredData.map((_, i) => palette[i % palette.length]);
		// 팔레트 부족 언디파인드 방지, 가독성
        
        
        // 기존 차트 파괴 (중복 방지)
        if (window.memChartInstance != undefined) {
            window.memChartInstance.destroy();
        }

        // 차트 생성
        window.memChartInstance = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                	
                	{
                    	label: '총업무',
                        data: totalTaskCnt,
                        backgroundColor: '#6c757d',
                        categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                        barPercentage: 0.8 ,       // 그 안에서 막대 비율
                        barThickness: 8       // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                    },
                   {
                	label: '진행중',
                    data: ingCnt,
                    backgroundColor: '#2ecc71',
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8 ,       // 그 안에서 막대 비율
                    barThickness: 8       // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                },
                {
                	label: '완료',
                    data: doneCnt,
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8,        // 그 안에서 막대 비율
                    barThickness: 8,        // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                    backgroundColor: '#3498db'
                },
                {
                	label: '지연',
                    data: delayCnt,
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8,        // 그 안에서 막대 비율
                    barThickness: 8,        // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                    backgroundColor: '#e74c3c'
                },
                {
                	label: '보류',
                    data: holdCnt,
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8,        // 그 안에서 막대 비율
                    barThickness: 8,        // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                    backgroundColor: '#f1c40f'
                },
                
                ]
            },
            options: {
            	 layout: {
            		    padding: { right: 24 }   // 16~40 사이로 조절
            		  },
            	indexAxis:'y', 	// 가로 막대 핵심
                responsive: true,
                maintainAspectRatio: false,
                scales:{
                	x:{
                		beginAtZero:true,
                		grace: '10%',   // 끝에 여유 (Chart.js v3+)
                		ticks:{precision:1}	// 정수만
                		
                	}
                },
                plugins: {
                    legend: { 
                    	position: 'top' 
                    	
                    },
                    datalabels: {
                    	 anchor: 'end',
                    	 align: 'end',
                    	 offset: 4,
                    	 clip: false,     //  중요: 잘림 방지
                    	 clamp: true,	  // 캔버스 밖으로 너무 나가면 안쪽으로 밀어줌(버전에 따라 지원
                         font: { weight: '700', size: 11 },
                  	     formatter: (v) => {
                  	    	 if(!v || v===0)return null; // 0이면 숫자 0표시안함
                  	    	 return v;
                  	     }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

    } catch (error) {
        console.error("차트 로딩 실패:", error);
    }
}

var memState = {
  searchType: "memberName",
  searchWord: ""
};
var memTbody = document.getElementById("memTbody");
var searchTypeEl = document.getElementById("searchType");
var searchWordEl = document.getElementById("searchWord");
var memSearchBtn = document.getElementById("memSearchBtn");

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function renderMemberList(list) {
	  if (!Array.isArray(list) || list.length === 0) {
	    memTbody.innerHTML = `
	      <tr>
	        <td colspan="7" style="text-align:center; padding:18px 0; color:#888;">
	          검색 결과가 없습니다.
	        </td>
	      </tr>
	    `;
	    return;
	  }

	  memTbody.innerHTML = list.map((l, idx) => {
		  const roleBadge =
			  (l.projectRole === "MANAGER") ? "<strong>PM</strong>" :
			  (l.projectRole === "CLIENT" || l.projectRole === "ROLE_CLIENT") ? "<strong>기업관리자</strong>" :
			  "팀원";



	    return `
	      <tr>
	        <td>\${idx + 1}</td>

	        <td class="member-name"
	            data-member-no="\${escapeHtml(l.memberNo)}"
	            data-bs-toggle="modal"
	            data-bs-target="#memberModal">
	          \${escapeHtml(l.memberName)}
	        </td>

	        <td>\${roleBadge}</td>

	        <td>\${escapeHtml(l.companyName || "")}</td>
	        <td>\${escapeHtml(l.memberDepartment || "")}</td>
	        <td>\${escapeHtml(l.memberPosition || "")}</td>

	        <td>
	          <button class="btn btn-sm btn-outline-secondary" type="button">
	            <i class="bi bi-chat-square-text"></i>
	          </button>
	        </td>
	      </tr>
	    `;
	  }).join("");
	}


async function loadMemberList() {
  const params = new URLSearchParams();
  params.set("projectNo", projectNo);

  if (memState.searchWord && memState.searchWord.trim().length > 0) {
    params.set("searchType", memState.searchType);
    params.set("searchWord", memState.searchWord.trim());
  }
  console.log(params.toString());

  const url = "/tudio/project/member/listData?" + params.toString();

  try {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) {
    	const text = await response.text(); // 서버 에러 페이지/ 메세지 보기
      console.error("구성원 목록 응답 실패:", res.status, url, text);
      return;
    }

    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.listData || []);
    console.log(list);
    renderMemberList(list);

  } catch (e) {
    console.error("구성원 목록 로드 실패:", e);
  }
}

// 검색 버튼
memSearchBtn.addEventListener("click", () => {
	console.log("검색 버튼 클릭...!");
	console.log(searchTypeEl.value);
	console.log(searchWordEl.value);
  memState.searchType = searchTypeEl.value;
  memState.searchWord = searchWordEl.value || "";
  loadMemberList();
});

// 엔터 검색
searchWordEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    memState.searchType = searchTypeEl.value;
    memState.searchWord = searchWordEl.value || "";
    loadMemberList();
  }
});

	// 최초 로드
	loadMemberList();
	// 3. 페이지 로드 시 차트 함수 실행
	loadMemberChart();


</script>
