package kr.or.ddit.chat.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.ServiceResult;
import kr.or.ddit.chat.service.IChatService;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.chat.ChatVO;
import kr.or.ddit.vo.chat.ChatroomVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : ChattingController
 * DESC : 채팅 컨트롤러 클래스
 * </pre>
 * 
 * @author [대덕인재개발원] team1 KJS
 * @version 1.0, 2025.12.26
 * 
 */

@Slf4j
@Controller
@RequestMapping("/tudio/chat")
public class ChatController {
	
	@Autowired
	private IChatService chatService;
	
	// 특정 Broker로 메세지 전달
	@Autowired
	private SimpMessagingTemplate template;
	
	// 반복되는 리터럴 문자열을 final 변수로 만듦
	private static final String LOGIN_USER = "loginUser";
	
	/**
	 * 채팅 버튼이 있는 메인 화면 조회
	 * @return main.jsp 주소
	 */
	@GetMapping("/main")
	public String chatMain() {
		return "chat/main";
	}
	
	/**
	 * 채팅방 생성 화면 조회
	 * @param model
	 * @param session
	 * @return new.jsp 주소
	 */
	@GetMapping("/new")
	public String newChatroom(Model model, HttpSession session) {
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		if(loginUser != null) {
			ChatVO chatVo = new ChatVO();
			chatVo.setMemberNo(loginUser.getMemberNo());
			
			List<MemberVO> memberList = chatService.selectProjectMemberList(chatVo);
			model.addAttribute("memberList", memberList);
			model.addAttribute("myName", loginUser.getMemberName());
		}
		return "chat/new";
	}
	
	/**
	 * 새로운 채팅방 생성
	 * @param chatroomVo
	 * @param session
	 * @return 성공 여부와 채팅방 번호를 담은 map
	 */
	@PostMapping("/new")
	public ResponseEntity<Map<String, Object>> insertNewChatroom(
			@RequestBody ChatroomVO chatroomVo, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		ServiceResult result = null;
		
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		if(loginUser != null) {
			chatroomVo.getChatMemberNoList().add(loginUser.getMemberNo());
			chatroomVo.getChatMemberNameList().add(loginUser.getMemberName());
			result = chatService.insertChatroom(chatroomVo);
			
			map.put("result", result);
			map.put("chatroomNo", chatroomVo.getChatroomNo());
		}
		return new ResponseEntity<Map<String, Object>>(map, HttpStatus.OK);
	}
	
	/**
	 * 현재 로그인된 회원의 채팅방 목록 조회
	 * @param model
	 * @param session
	 * @return list.jsp 주소
	 */
	@GetMapping("/list")
	public String chatroomList(Model model, HttpSession session) {
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		if(loginUser != null) {
			List<ChatroomVO> chatroomList = chatService.selectChatroomList(loginUser.getMemberNo());
			model.addAttribute("chatroomList", chatroomList);
			model.addAttribute("memberNo", loginUser.getMemberNo());
		}
		return "chat/list";
	}
	
	/**
	 * chatroomNo에 해당하는 채팅방 상세 화면 조회
	 * @param chatVo
	 * @param model
	 * @param session
	 * @return chatroom.jsp 주소
	 */
	@GetMapping("/chatroom/{chatroomNo}")
	public String chatroom(
			ChatVO chatVo, Model model, HttpSession session) {
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		if(loginUser != null) {
			chatVo.setMemberNo(loginUser.getMemberNo());
			List<ChatVO> chatList = chatService.selectChatList(chatVo);
			Map<String, Object> chatroomTitle = chatService.selectChatroomTitle(chatVo);

			model.addAttribute("chatList", chatList);
			model.addAttribute("chatroomTitle", chatroomTitle);
			model.addAttribute("myMemNo", loginUser.getMemberNo());
			model.addAttribute("myName", loginUser.getMemberName());
		}
		return "chat/chatroom";
	}
	
	/**
	 * 채팅방 나가기 (특정 chatMember 삭제)
	 * @param deleteInfo chatroomNo, memberNo(나가는 사람)가 담겨있음
	 * @param model
	 * @param session
	 * @return delete 결과
	 */
	@PostMapping("/chatroom/exit")
	public ResponseEntity<ServiceResult> exitChatroom(
			@RequestBody Map<String, Object> deleteInfo, Model model, HttpSession session){
		ServiceResult result = null;
		
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		if(loginUser != null) {
			result = chatService.deleteChatMember(deleteInfo);
		}
		return new ResponseEntity<ServiceResult>(result, HttpStatus.OK);
	}
	
	/**
	 * 사용자의 화면상에 출력되어 있는 채팅보다 더 이전 채팅 목록들을 조회
	 * @param chatVo
	 * @param session
	 * @return List<ChatVO>와 상태코드를 담은 ResponseEntity 객체
	 */
	@GetMapping("/chatroom/oldchat")
	@ResponseBody
	public ResponseEntity<List<ChatVO>> oldChats(ChatVO chatVo, HttpSession session){
		MemberVO loginUser = (MemberVO) session.getAttribute(LOGIN_USER);
		ResponseEntity<List<ChatVO>> entity = null;
		
		if(loginUser != null) {
			chatVo.setMemberNo(loginUser.getMemberNo());
			List<ChatVO> chatList =  chatService.selectChatList(chatVo);
			entity = new ResponseEntity<List<ChatVO>>(chatList, HttpStatus.OK);
		}
		
		return entity;
	}
	
	/**
	 * Client가 보낸 메세지를 전송해줌
	 * @param chatVo
	 */
	@MessageMapping("/chat/message")
	public void message(ChatVO chatVo) {
		chatService.insertChat(chatVo);
		List<Integer> memNoList = chatService.selectChatroomMemList(chatVo.getChatroomNo());
		
		String chatUrl = "/sub/chat/chatroom/" + chatVo.getChatroomNo();
		template.convertAndSend(chatUrl, chatVo);
		for(int memNo : memNoList) {
			String roomListUrl = "/sub/chat/list/" + memNo;
			template.convertAndSend(roomListUrl, chatVo);
		}
	}

}
