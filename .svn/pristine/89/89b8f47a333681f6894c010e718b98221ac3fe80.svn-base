<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.admin.siteMember.mapper.IAdminMemberMapper">

    <resultMap type="kr.or.ddit.vo.MemberVO" id="memberMap">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberTel" column="MEMBER_TEL"/>
        <result property="memberEmail" column="MEMBER_EMAIL"/>
        <result property="memberDepartment" column="MEMBER_DEPARTMENT"/>
        <result property="memberPosition" column="MEMBER_POSITION"/>
        <result property="companyNo" column="COMPANY_NO"/>
        <result property="memberRegno" column="MEMBER_REGNO"/>
        <result property="memberJoinDate" column="MEMBER_JOIN_DATE"/>
        <result property="leaveStatus" column="LEAVE_STATUS"/>
        <result property="leaveReason" column="LEAVE_REASON"/>
        <result property="memberLeaveDate" column="MEMBER_LEAVE_DATE"/>
        <result property="projectCount" column="PROJECT_COUNT"/>
        <collection property="memberAuthVOList" resultMap="authMap"/>
    </resultMap>

    <resultMap type="kr.or.ddit.vo.MemberAuthVO" id="authMap">
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="auth" column="AUTH"/>
    </resultMap>

    <sql id="whereCondition">
        <if test="type != null and type != 'all'">
            <choose>
                <when test="type == 'general'">AND (B.AUTH = 'ROLE_MEMBER' OR B.AUTH IS NULL)</when>
                <when test="type == 'company'">AND B.AUTH = 'ROLE_CLIENT'</when>
                <when test="type == 'withdrawal'">AND A.LEAVE_STATUS = 'Y'</when>
            </choose>
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (
                A.MEMBER_ID LIKE '%' || #{searchKeyword} || '%' OR 
                A.MEMBER_NAME LIKE '%' || #{searchKeyword} || '%'
            )
        </if>
    </sql>

    <select id="selectAdminMember" parameterType="String" resultType="kr.or.ddit.dto.AdminUserDTO">
        SELECT 
            MEMBER_NO          AS memNo
            , MEMBER_ID        AS memId
            , MEMBER_NAME      AS memName       
            , MEMBER_PROFILEIMG AS memProfile     
        FROM MEMBER
        WHERE MEMBER_ID = #{memId}
    </select>

    <select id="selectMemberCount" parameterType="kr.or.ddit.vo.MemberVO" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER A
        LEFT OUTER JOIN MEMBER_AUTH B ON (A.MEMBER_NO = B.MEMBER_NO)
        WHERE 1=1
        <include refid="whereCondition"/>
    </select>

    <select id="selectMemberListForExcel" parameterType="kr.or.ddit.vo.MemberVO" resultMap="memberMap">
        SELECT * FROM (
            SELECT T.*, ROWNUM RNUM FROM (
                SELECT 
                    A.MEMBER_NO, A.MEMBER_ID, A.MEMBER_NAME, A.MEMBER_TEL,
                    A.MEMBER_EMAIL, A.MEMBER_DEPARTMENT, A.MEMBER_POSITION,
                    A.COMPANY_NO, A.MEMBER_REGNO, A.MEMBER_JOIN_DATE,
                    A.LEAVE_STATUS, A.LEAVE_REASON, A.MEMBER_LEAVE_DATE,
                    B.AUTH,
                    (SELECT COUNT(*) FROM PROJECT_MEMBER PM WHERE PM.MEMBER_NO = A.MEMBER_NO) AS PROJECT_COUNT
                FROM MEMBER A
                LEFT OUTER JOIN MEMBER_AUTH B ON(A.MEMBER_NO = B.MEMBER_NO)
                WHERE 1=1
                <include refid="whereCondition"/>
                ORDER BY A.MEMBER_JOIN_DATE DESC
            ) T
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RNUM &gt;= #{startRow}
    </select>
    
    <insert id="insertMember" parameterType="kr.or.ddit.vo.MemberVO">
        <selectKey keyProperty="memberNo" resultType="int" order="BEFORE">
            SELECT seq_member.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO MEMBER (
            MEMBER_NO, MEMBER_ID, MEMBER_PW, MEMBER_NAME,
            MEMBER_TEL, COMPANY_NO, COMPANY_NO_STATUS,
            MEMBER_EMAIL, EMAIL_STATUS, MEMBER_JOIN_DATE,
            LEAVE_STATUS, MEMBER_REGNO, 
            MEMBER_DEPARTMENT, MEMBER_POSITION
        ) VALUES (
            #{memberNo}, #{memberId}, #{memberPw}, #{memberName},
            #{memberTel}, #{companyNo}, 'N',
            #{memberEmail}, 'N', CURRENT_TIMESTAMP,
            'N', #{memberRegno},
            #{memberDepartment}, #{memberPosition}
        )
    </insert>
	
    <insert id="insertMemberAuth" parameterType="map">
        INSERT INTO MEMBER_AUTH (MEMBER_NO, AUTH)
        VALUES (#{memberNo}, #{auth})
    </insert>

</mapper>