<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<!DOCTYPE html>
<html>
<head>
<title>Tudio - 설문조사</title>
<jsp:include page="/WEB-INF/views/include/common.jsp" />
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

<style>
/* 전체 레이아웃 (사이드바 고려) */
:root {
    --primary-color: #3182CE;
    --primary-dark: #2C5282;
    --bg-color: #F7FAFC;
    --text-color: #2D3748;
    --border-color: #E2E8F0;
}

body {
    font-family: 'Pretendard', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
}

/* 사이드바가 float이나 fixed일 경우를 대비해 메인 컨텐츠 영역 확보 */
.main-wrapper {
    display: flex;
    min-height: 100vh;
}

.content-area {
    flex: 1;
    padding: 40px;
    margin-left: 250px; /* 사이드바 너비만큼 여백 (사이드바 설정에 따라 조정 필요) */
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

/* 설문 카드 디자인 */
.survey-card {
    background: white;
    width: 100%;
    max-width: 700px;
    padding: 50px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    border-top: 6px solid var(--primary-color);
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 타이틀 영역 */
.survey-header {
    text-align: center;
    margin-bottom: 50px;
    border-bottom: 2px dashed var(--border-color);
    padding-bottom: 30px;
}

.survey-title {
    font-size: 28px;
    font-weight: 800;
    color: var(--primary-dark);
    margin-bottom: 15px;
}

.survey-desc {
    font-size: 16px;
    color: #718096;
    line-height: 1.6;
}

/* 질문 박스 */
.question-box {
    margin-bottom: 40px;
    padding: 20px;
    border-radius: 12px;
    transition: background 0.3s;
}

.question-box:hover {
    background-color: #f8fbff;
}

.question-text {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.q-num {
    background: var(--primary-color);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
    margin-right: 10px;
}

/* 보기(옵션) 스타일 */
.option-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.option-label {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    background: #fff;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
    color: #4A5568;
}

.option-label:hover {
    border-color: #BEE3F8;
    background-color: #EBF8FF;
}

/* 라디오 버튼 선택 시 스타일 (JavaScript 없이 CSS로 처리) */
.option-label:has(input:checked) {
    border-color: var(--primary-color);
    background-color: #EBF8FF;
    color: var(--primary-dark);
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(49, 130, 206, 0.1);
}

.option-label input[type="radio"] {
    appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #CBD5E0;
    border-radius: 50%;
    margin-right: 15px;
    position: relative;
    transition: all 0.2s;
}

.option-label input[type="radio"]:checked {
    border-color: var(--primary-color);
    background-color: var(--primary-color);
}

.option-label input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
}

/* 버튼 스타일 */
.submit-btn {
    width: 100%;
    padding: 20px;
    background: linear-gradient(135deg, #3182CE 0%, #2B6CB0 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(49, 130, 206, 0.3);
    transition: transform 0.2s, box-shadow 0.2s;
    margin-top: 20px;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(49, 130, 206, 0.4);
}

.submit-btn:active {
    transform: translateY(0);
}

/* 완료 화면 스타일 */
.complete-box {
    text-align: center;
    padding: 60px 20px;
}

.complete-icon {
    font-size: 60px;
    color: #48BB78;
    margin-bottom: 20px;
    display: block;
}

.btn-home {
    background-color: #718096;
    margin-top: 30px;
}
.btn-home:hover {
    background-color: #4A5568;
}

/* 반응형 (모바일) */
@media (max-width: 768px) {
    .content-area { margin-left: 0; padding: 20px; }
    .survey-card { padding: 30px 20px; }
}
</style>
</head>
<body>

<jsp:include page="/WEB-INF/views/include/headerUser.jsp" />
<jsp:include page="../include/sidebarCs.jsp"/>

<div class="main-wrapper">
    <div class="content-area">
        <div class="survey-card">
        
            <%-- [1] 이미 참여한 경우 --%>
            <c:choose>
                <c:when test="${survey.participated}">
                    <div class="complete-box">
                        <span class="complete-icon">✅</span>
                        <h1 class="survey-title">참여 완료</h1>
                        <p class="survey-desc">이미 설문에 참여하셨습니다.<br>소중한 의견 감사합니다.</p>
                        <button class="submit-btn btn-home" onclick="location.href='/tudio/dashboard'">
                            메인으로 돌아가기
                        </button>
                    </div>
                </c:when>
                
                <%-- [2] 설문 참여 폼 --%>
                <c:otherwise>
                    <div class="survey-header">
                        <h1 class="survey-title">${survey.surveyTitle}</h1>
                        <p class="survey-desc">${survey.surveyDescription}</p>
                    </div>

                    <form id="surveyForm">
                        <input type="hidden" id="surveyNo" value="${survey.surveyNo}">
                        <input type="hidden" id="totalQuestions" value="${survey.questionList.size()}">

                        <c:forEach var="q" items="${survey.questionList}" varStatus="status">
                            <div class="question-box">
                                <h3 class="question-text">
                                    <span class="q-num">${status.count}</span>
                                    ${q.questionContent}
                                </h3>
                                
                                <div class="option-container">
                                    <c:forEach var="opt" items="${q.optionList}">
                                        <label class="option-label">
                                            <input type="radio" 
                                                   name="q-${q.questionNo}" 
                                                   value="${opt.answerNo}" 
                                                   data-question-no="${q.questionNo}">
                                            <span>${opt.answerContent}</span>
                                        </label>
                                    </c:forEach>
                                </div>
                            </div>
                        </c:forEach>

                        <button type="button" class="submit-btn" onclick="submitSurvey()">
                            설문 제출하기
                        </button>
                    </form>
                </c:otherwise>
            </c:choose>
            
        </div>
    </div>
</div>

<jsp:include page="/WEB-INF/views/include/footer.jsp" />

<script>
    function submitSurvey() {
        const surveyNo = document.getElementById("surveyNo").value;
        const totalQuestions = document.getElementById("totalQuestions").value;
        
        // 1. 답변 데이터 수집
        const answerList = [];
        const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
        
        checkedRadios.forEach(radio => {
            answerList.push({
                questionNo: parseInt(radio.dataset.questionNo),
                selectAnswerNo: parseInt(radio.value)
            });
        });

        // 2. 유효성 검사 (SweetAlert 적용)
        if (answerList.length < totalQuestions) {
            Swal.fire({
                icon: 'warning',
                title: '잠깐만요!',
                text: '모든 문항에 답변해 주세요.',
                confirmButtonColor: '#3182CE',
                confirmButtonText: '확인'
            });
            return;
        }

        const payload = {
            surveyNo: parseInt(surveyNo),
            answerList: answerList
        };

        // 3. AJAX 전송
        fetch("/tudio/survey/submit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (response.status === 409) {
                // 이미 참여함
                Swal.fire({
                    icon: 'info',
                    title: '이미 참여하셨습니다',
                    text: '설문 결과는 한 번만 제출 가능합니다.',
                    confirmButtonColor: '#3182CE'
                }).then(() => {
                    location.reload();
                });
            } else if (response.ok) {
                // 성공
                Swal.fire({
                    icon: 'success',
                    title: '제출 완료!',
                    text: '소중한 의견 감사합니다.',
                    confirmButtonColor: '#3182CE'
                }).then(() => {
                    location.reload();
                });
            } else if (response.status === 401) {
                // 비로그인
                Swal.fire({
                    icon: 'error',
                    title: '로그인 필요',
                    text: '로그인 후 이용해 주세요.',
                    confirmButtonColor: '#d33'
                }).then(() => {
                    location.href = "/login";
                });
            } else {
                throw new Error("Server Error");
            }
        })
        .catch(error => {
            console.error("통신 에러:", error);
            Swal.fire({
                icon: 'error',
                title: '오류 발생',
                text: '저장 중 문제가 발생했습니다. 관리자에게 문의하세요.',
                confirmButtonColor: '#d33'
            });
        });
    }
</script>

</body>
</html>