<%@ page contentType="text/html; charset=UTF-8" %> <%-- JSP ì¸ì½”ë”© --%>

<link rel="stylesheet" href="${pageContext.request.contextPath}/css/notification.css"> <%-- CSS ë¡œë“œ --%>

<input type="hidden" name="memberNo" id="memberNo" value="${loginUser.memberNo}" /> <%-- ë¡œê·¸ì¸ íšŒì› ë²ˆí˜¸(í•„ìš”ì‹œ) --%>

<!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ íŒ¨ë„  -->
<div id="notiPanel"
     class="dropdown-menu dropdown-menu-end shadow border-0 mt-2 p-0"
     style="width: 380px;"> <%-- ë¶€íŠ¸ìŠ¤íŠ¸ë© dropdown + ìŠ¤ìƒ· í­ --%>

  <!-- ìƒë‹¨ í—¤ë”: ì•Œë¦¼ + X -->
  <div class="noti-top"> <%-- í—¤ë” ë© --%>
    <span class="noti-title">ì•Œë¦¼</span> <%-- ì œëª© --%>
    <button type="button" class="noti-close-btn" id="notiCloseBtn" aria-label="close">Ã—</button> <%-- ìš°ì¸¡ X --%>
  </div>

  <!-- í° íƒ­: ì•ˆì½ìŒ / ì½ìŒ -->
  <div class="noti-tabs2"> <%-- íƒ­ ë© --%>

    <button type="button"
            class="noti-tab2 active"
            data-tab="unread"
            id="tabUnread"> <%-- ì•ˆì½ìŒ íƒ­ --%>
      ì•ˆì½ìŒ
      <span id="unreadCountTab" class="noti-count" style="display:none;">0</span> <%-- ì•ˆì½ìŒ ì¹´ìš´íŠ¸(0ì´ë©´ ìˆ¨ê¹€) --%>
    </button>

    <button type="button"
            class="noti-tab2"
            data-tab="read"
            id="tabRead"> <%-- ì½ìŒ íƒ­ --%>
      ì½ìŒ
    </button>

  </div>

  <!-- ì¹´í…Œê³ ë¦¬ í•„í„°: ì „ì²´/í”„ë¡œì íŠ¸/ë©˜ì…˜/ì‹œìŠ¤í…œ/ê²°ì¬  -->
  <div class="noti-filters"> <%-- í•„í„° ë© --%>
    <button type="button" class="noti-filter-btn active" data-filter="ALL">ì „ì²´</button> <%-- ì „ì²´ --%>
    <button type="button" class="noti-filter-btn" data-filter="PROJECT">í”„ë¡œì íŠ¸</button> <%-- í”„ë¡œì íŠ¸ --%>
    <button type="button" class="noti-filter-btn" data-filter="MENTION">ë©˜ì…˜</button> <%-- ë©˜ì…˜ --%>
    <button type="button" class="noti-filter-btn" data-filter="SYSTEM">ì‹œìŠ¤í…œ</button> <%-- ì‹œìŠ¤í…œ --%>
    <button type="button" class="noti-filter-btn" data-filter="APPROVAL">ê²°ì¬</button> <%-- ê²°ì¬ --%>
  </div>

  <!--  ë¦¬ìŠ¤íŠ¸(ìŠ¤í¬ë¡¤)  -->
  <div class="noti-list-wrap"> <%-- ìŠ¤í¬ë¡¤ ë© --%>
    <ul id="notiList"></ul> <%-- ë™ì  ë Œë”ë§ ëŒ€ìƒ --%>
    <div id="notiEmpty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div> <%-- ë¹ˆ ìƒíƒœ --%>
  </div>

</div>

<script>
  /* ê¸°ë³¸ ê²½ë¡œ / API ë² ì´ìŠ¤ */
  const ctxPathNoti = "${pageContext.request.contextPath}"; // ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ
  const apiBaseNoti = ctxPathNoti + "/tudio/noti"; // ì•Œë¦¼ API ë² ì´ìŠ¤ (/list, /read, /delete ë“±)

  /*  í™”ë©´ ìƒíƒœ(íƒ­/í•„í„°) ì „ì—­ ê´€ë¦¬  */
  const notiState = { // í˜„ì¬ ì„ íƒ ìƒíƒœ
    tab: "unread",     // "unread" | "read"
    filter: "ALL"      // "ALL" | "PROJECT" | "MENTION" | "SYSTEM" | "APPROVAL"
  };

  /* ìƒë‹¨(í—¤ë”) ì /ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸  */
  function updateHeaderNotiDot(unreadCount) { // í—¤ë” ì¢…(ë²¨) ì˜† ë¹¨ê°„ì  í‘œì‹œ/ìˆ¨ê¹€
    const $dot = $("#headerNotiDot"); // ë„¤ê°€ ì´ë¯¸ ì“°ë˜ í—¤ë” ì  ì—˜ë¦¬ë¨¼íŠ¸
    if (!$dot.length) return; // í—¤ë” ì ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
    if (Number(unreadCount) > 0) $dot.removeClass("d-none"); // ìˆìœ¼ë©´ ë³´ì´ê¸°
    else $dot.addClass("d-none"); // ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
  }

  function updateUnreadCountTab(unreadCount) { // "ì•ˆì½ìŒ 4" í˜•íƒœ ì¹´ìš´íŠ¸ í‘œì‹œ
    const $c = $("#unreadCountTab"); // íƒ­ ì•ˆ ì¹´ìš´íŠ¸ span
    const n = Number(unreadCount || 0); // ìˆ«ì ë³´ì •
    if (n > 0) { // 1ê°œ ì´ìƒì´ë©´
      $c.text(n).show(); // ìˆ«ì í‘œì‹œ
    } else { // 0ì´ë©´
      $c.text("0").hide(); // ìˆ¨ê¹€
    }
  }
  

  /* ëª©ë¡ ì¡°íšŒ (íƒ­ + í•„í„°)  */
  function loadNotiList() { // í˜„ì¬ ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ ëª©ë¡ ë¡œë“œ
    $.ajax({ // AJAX í˜¸ì¶œ
      url: apiBaseNoti + "/list", // ëª©ë¡ API
      method: "GET", // GET
      dataType: "json", // JSON ì‘ë‹µ
      data: { // ì¿¼ë¦¬ìŠ¤íŠ¸ë§
        tab: notiState.tab, // unread/read
        filter: notiState.filter // ALL/PROJECT/...
      },
      success: function (data) { // ì„±ê³µ ì½œë°±
        // ê¸°ëŒ€ í˜•íƒœ ì˜ˆì‹œ:
        // { notiList: [...], notiUnreadCount: 4 }
        renderNotiList(data.notiList || []); // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        updateUnreadCountTab(data.notiUnreadCount || 0); // íƒ­ ì¹´ìš´íŠ¸ ê°±ì‹ 
        updateHeaderNotiDot(data.notiUnreadCount || 0); // í—¤ë” ì  ê°±ì‹ 
      },
      error: function (xhr) { // ì‹¤íŒ¨ ì½œë°±
        console.error("ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨", xhr.status, xhr.responseText); // ë¡œê·¸
      }
    });
  }

  /* ë Œë”ë§: ìŠ¤ìƒ· ìŠ¤íƒ€ì¼(ë¼ë²¨/ì‹œê°„/ì œëª©/í”„ë¦¬ë·°)  */
  function renderNotiList(list) { // ëª©ë¡ ë Œë”ë§
    const $list = $("#notiList"); // UL
    const $empty = $("#notiEmpty"); // ë¹ˆ ìƒíƒœ
    $list.empty(); // ê¸°ì¡´ ì œê±°

    if (!list || list.length === 0) { // ë¹„ì–´ ìˆìœ¼ë©´
      $empty.show(); // ë¹ˆ ì•ˆë‚´ í‘œì‹œ
      return; // ì¢…ë£Œ
    }

    $empty.hide(); // ë°ì´í„° ìˆìœ¼ë©´ ë¹ˆ ì•ˆë‚´ ìˆ¨ê¹€

    $.each(list, function (i, n) { // ê° ì•Œë¦¼ ìˆœíšŒ
      const isUnread = (String(n.isRead || n.IS_READ || "N") === "N"); // ì•ˆì½ìŒ ì—¬ë¶€(Nì´ë©´ ì•ˆì½ìŒ)
      const stateClass = isUnread ? "is-unread" : "is-read"; // í´ë˜ìŠ¤ ê²°ì •

      const tagInfo = getTagInfo(n); // ë¼ë²¨ ì •ë³´(í…ìŠ¤íŠ¸/í´ë˜ìŠ¤)
      const whenText = formatNotiTime(n.notiRegdate || n.NOTI_REGDATE); // "ë°©ê¸ˆ ì „/30ë¶„ ì „/2ì‹œê°„ ì „"
      const headline = escapeHtml(getHeadline(n)); // êµµì€ ì œëª©(ì²«ì¤„)
      const preview = escapeHtml(getPreview(n)); // ì•„ë˜ í”„ë¦¬ë·°(ë‘˜ì§¸ì¤„)
      const notiNo = n.notiNo || n.NOTI_NO; // ì•Œë¦¼ ë²ˆí˜¸
      const notiUrl = n.notiUrl || n.NOTI_URL || ""; // ì´ë™ URL

      const html =
    	  '' +
    	  '<li class="noti-row ' + stateClass + '"' +
    	  ' data-noti-no="' + escapeHtml(notiNo) + '"' +
    	  ' data-noti-url="' + escapeHtml(notiUrl) + '">' +

    	    // ğŸ”¹ ì˜¤ë¥¸ìª½ ì˜ì—­ (X + ë‚ ì§œ)
    	    '<div class="noti-right">' +
    	      '<button type="button" class="noti-item-x" aria-label="delete">Ã—</button>' +
    	      '<div class="noti-when">' + escapeHtml(whenText) + '</div>' +
    	    '</div>' +

    	    // ğŸ”¹ ì™¼ìª½ ì½˜í…ì¸ 
    	    '<div class="noti-content">' +
    	      '<div class="noti-meta">' +
    	        '<span class="noti-tag ' + tagInfo.cls + '">' + escapeHtml(tagInfo.text) + '</span>' +
    	      '</div>' +
    	      '<div class="noti-headline">' + headline + '</div>' +
    	      (preview ? ('<div class="noti-preview">"' + preview + '"</div>') : '') +
    	    '</div>' +

    	  '</li>';

      $list.append($(html)); // ULì— ì¶”ê°€
    });
  }

  /* ë¼ë²¨(í”„ë¡œì íŠ¸/ë©˜ì…˜/ì‹œìŠ¤í…œ/ê²°ì¬) ê²°ì • . ì„œë²„ì—ì„œ category ê°™ì€ ê°’ì„ ì£¼ë©´ ê·¸ê±¸ ìµœìš°ì„  ì‚¬ìš© */
  function getTagInfo(n) { // ë¼ë²¨ ê²°ì •
    const raw = String(n.category || n.CATEGORY || n.notiCategory || "").toUpperCase(); // ì„œë²„ê°€ ì£¼ëŠ” ì¹´í…Œê³ ë¦¬
    const type = String(n.notiType || n.NOTI_TYPE || n.notiMessage || n.NOTI_MESSAGE || "").toUpperCase(); // íƒ€ì…(ì—†ìœ¼ë©´ ê¸°ì¡´ notiMessage ì‚¬ìš©)

    // category ìš°ì„  ë§¤í•‘
    if (raw === "PROJECT") return { text: "í”„ë¡œì íŠ¸", cls: "tag-project" }; // í”„ë¡œì íŠ¸
    if (raw === "MENTION") return { text: "ë©˜ì…˜", cls: "tag-mention" }; // ë©˜ì…˜
    if (raw === "SYSTEM") return { text: "ì‹œìŠ¤í…œ", cls: "tag-system" }; // ì‹œìŠ¤í…œ
    if (raw === "APPROVAL") return { text: "ê²°ì¬", cls: "tag-approval" }; // ê²°ì¬

    // categoryê°€ ì—†ìœ¼ë©´ type ê¸°ë°˜ ì¶”ì •(ë„¤ notiType ê·œì¹™ì— ë§ì¶° ì¶”ê°€/ìˆ˜ì •)
    if (type.includes("MENTION")) return { text: "ë©˜ì…˜", cls: "tag-mention" }; // ë©˜ì…˜
    if (type.includes("APPROVAL") || type.includes("DRAFT")) return { text: "ê²°ì¬", cls: "tag-approval" }; // ê²°ì¬
    if (type.includes("SITE") || type.includes("SYSTEM") || type.includes("NOTICE")) return { text: "ì‹œìŠ¤í…œ", cls: "tag-system" }; // ì‹œìŠ¤í…œ
    if (type.includes("PROJECT")) return { text: "í”„ë¡œì íŠ¸", cls: "tag-project" }; // í”„ë¡œì íŠ¸

    return { text: "ê¸°íƒ€", cls: "tag-etc" }; // ê·¸ ì™¸
  }

  /*  ì œëª©/í”„ë¦¬ë·° í…ìŠ¤íŠ¸ ê²°ì •
     - ì„œë²„ê°€ notiTitle / snapshotText ë“±ì„ ì£¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
     - ì—†ìœ¼ë©´ ê¸°ì¡´ getNotiTitle(type) ê°™ì€ fallback ì‚¬ìš©  */
  function getHeadline(n) { // êµµì€ ì œëª©(ì²« ì¤„)
    // ì„œë²„ê°€ ì´ë¯¸ ì‚¬ëŒì´ ì½ëŠ” ë¬¸êµ¬ë¥¼ ì£¼ëŠ” ê²½ìš°(ê¶Œì¥)
    if (n.notiTitle) return String(n.notiTitle); // notiTitle ìš°ì„ 
    if (n.NOTI_TITLE) return String(n.NOTI_TITLE); // ëŒ€ë¬¸ì ëŒ€ì‘
    if (n.displayTitle) return String(n.displayTitle); // ë‹¤ë¥¸ í•„ë“œëª… ëŒ€ì‘

    // fallback: íƒ€ì… ì½”ë“œ -> ì§§ì€ ì œëª©
    const type = String(n.notiMessage || n.NOTI_MESSAGE || n.notiType || n.NOTI_TYPE || ""); // íƒ€ì…
    return getNotiTitle(type); // ê¸°ì¡´ ë§¤í•‘ ì‚¬ìš©
  }

  function getPreview(n) { // í”„ë¦¬ë·°(ë‘˜ì§¸ ì¤„)
    // ì„œë²„ê°€ "ìŠ¤ëƒ…ìƒ·"ì„ ì£¼ëŠ” êµ¬ì¡°ë©´ ì´ê±¸ ì“°ëŠ” ê²Œ ë² ìŠ¤íŠ¸
    if (n.snapshotText) return String(n.snapshotText); // snapshotText
    if (n.SNAPSHOT_TEXT) return String(n.SNAPSHOT_TEXT); // ëŒ€ë¬¸ì ëŒ€ì‘
    if (n.notiBody) return String(n.notiBody); // notiBody
    if (n.NOTI_BODY) return String(n.NOTI_BODY); // ëŒ€ë¬¸ì
    if (n.previewText) return String(n.previewText); // ë‹¤ë¥¸ ì´ë¦„
    return ""; // ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
  }

  /* 7) íƒ€ì… ì½”ë“œ -> ì§§ì€ ì œëª© ë§¤í•‘ ì“°ë˜ switch ìœ ì§€ */
  function getNotiTitle(type) { // íƒ€ì… ì½”ë“œ ë§¤í•‘
    switch (type) { // ë¶„ê¸°
      case "NOTI_TASK_COMMENT":     return "ë³¸ì¸ ì—…ë¬´ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤."; // ì˜ˆì‹œ
      case "NOTI_BO_COMMENT":       return "ê²Œì‹œê¸€ì— ëŒ“ê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤."; // ì˜ˆì‹œ
      case "NOTI_MANAGER":          return "ìƒˆë¡œìš´ ì—…ë¬´ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤."; // ì˜ˆì‹œ
      case "NOTI_SCHEDULE":         return "ì¼ì • ì•Œë¦¼"; // ì˜ˆì‹œ
      case "NOTI_SITE":             return "ì •ê¸° ì ê²€ ì•ˆë‚´"; // ì˜ˆì‹œ
      case "NOTI_INQUIRY_COMMENT":  return "ë¬¸ì˜ ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."; // ì˜ˆì‹œ
      case "NOTI_DRAFT_UPLOAD":     return "ê¸°ì•ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."; // ì˜ˆì‹œ
      case "NOTI_APPROVAL":         return "ê¸°ì•ˆ ìŠ¹ì¸ ìš”ì²­"; // ì˜ˆì‹œ
      case "NOTI_PROJECT_NOTICE":   return "í”„ë¡œì íŠ¸ ê³µì§€"; // ì˜ˆì‹œ
      case "NOTI_CHAT":             return "ì±„íŒ… ì•Œë¦¼"; // ì˜ˆì‹œ
      default:                      return String(type || ""); // ê·¸ëŒ€ë¡œ
    }
  }

     // ë‚ ì§œ í˜•ì‹ ì§€ì •
     function formatNotiTime(notiDate) {
       if (!notiDate) return "";

       // YYYY-MM-DD HH:ss íŒŒì‹± ë³´ì¥
       const dt = new Date(String(notiDate).replace(" ", "T"));
       if (isNaN(dt.getTime())) return "";

       const now = new Date();

       const notiToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
       const notiThatDay = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());

       const diffDays = Math.floor((notiToday - notiThatDay) / 86400000); // 1 day(ms)

       const pad2 = (n) => String(n).padStart(2, "0");

       const isToday =
         dt.getFullYear() === now.getFullYear() &&
         dt.getMonth() === now.getMonth() &&
         dt.getDate() === now.getDate();

       // ì „ë…„ë„
       if (dt.getFullYear() < now.getFullYear()) {
         return dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
       }

       // ì˜¤ëŠ˜ì´ë©´ hh:mm AM/PM (12ì‹œê°„ì œ)
       if (isToday) {
         const h = dt.getHours();
         const ampm = (h < 12) ? "AM" : "PM";
         const h12 = (h % 12) === 0 ? 12 : (h % 12); // 0ì‹œëŠ” 12ë¡œ
         return ampm + " " + pad2(h12) + ":" + pad2(dt.getMinutes());
       }

       // ì˜¤ëŠ˜ì´ ì•„ë‹ˆë©´ MM-DD
       return pad2(dt.getMonth() + 1) + "-" + pad2(dt.getDate());
     }

  /* ===============================
     9) XSS ë°©ì§€: HTML ì´ìŠ¤ì¼€ì´í”„
     =============================== */
  function escapeHtml(s) { // ë¬¸ìì—´ ì´ìŠ¤ì¼€ì´í”„
    return String(s ?? "") // null/undefined ë°©ì§€
      .replaceAll("&", "&amp;") // & ì²˜ë¦¬
      .replaceAll("<", "&lt;") // < ì²˜ë¦¬
      .replaceAll(">", "&gt;") // > ì²˜ë¦¬
      .replaceAll('"', "&quot;") // " ì²˜ë¦¬
      .replaceAll("'", "&#039;"); // ' ì²˜ë¦¬
  }
  
  $(document).on("click", ".noti-item-x", function (e) {
	  e.stopPropagation();   // â­ ì´ í•œ ì¤„ì´ í•µì‹¬ (ë¶€ëª¨ li í´ë¦­ ë§‰ê¸°)

	  const $row = $(this).closest(".noti-row");
	  const notiNo = $row.data("noti-no");

	  $.ajax({
	    url: apiBaseNoti + "/delete",
	    method: "POST",
	    dataType: "json",
	    data: { notiNo },
	    success: function () {
	      $row.remove(); // í™”ë©´ì—ì„œ ì œê±°
	    }
	  });
	});


  /* WebSocket: ìƒˆ ì•Œë¦¼ ì˜¤ë©´ ì¹´ìš´íŠ¸/ëª©ë¡ ê°±ì‹  */
  (function connectNotiWs(){ // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜
    const scheme = (location.protocol === "https:") ? "wss" : "ws"; // httpsë©´ wss
    const url = scheme + "://" + location.host + ctxPathNoti + "/ws/noti"; // ws ì—”ë“œí¬ì¸íŠ¸

    const ws = new WebSocket(url); // ì›¹ì†Œì¼“ ìƒì„±

    ws.onopen = () => console.log("noti ws opened"); // ì—´ë¦¼ ë¡œê·¸
    ws.onclose = (e) => console.log("noti ws closed", e.code, e.reason); // ë‹«í˜ ë¡œê·¸
    ws.onerror = (e) => console.log("noti ws error", e); // ì—ëŸ¬ ë¡œê·¸

    ws.onmessage = (e) => { // ë©”ì‹œì§€ ìˆ˜ì‹ 
      let data; // íŒŒì‹± ë³€ìˆ˜
      try { data = JSON.parse(e.data); } catch (_) { return; } // JSON íŒŒì‹± ì‹¤íŒ¨ ë°©ì§€

      if (data.type === "NOTI_NEW") { // ìƒˆ ì•Œë¦¼ ì´ë²¤íŠ¸ë¼ë©´
        updateUnreadCountTab(data.unreadCount); // ì•ˆì½ìŒ íƒ­ ì¹´ìš´íŠ¸ ê°±ì‹ 
        updateHeaderNotiDot(data.unreadCount); // í—¤ë” ì  ê°±ì‹ 
        loadNotiList(); // í˜„ì¬ íƒ­/í•„í„° ê¸°ì¤€ìœ¼ë¡œ ì¬ì¡°íšŒ
      }
    };
  })();

  /*   ì´ë²¤íŠ¸ ë°”ì¸ë”© + ì´ˆê¸° ë¡œë“œ */
  $(function(){ // DOM Ready

    //  íŒ¨ë„ X í´ë¦­: ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    $(document).off("click", "#notiCloseBtn").on("click", "#notiCloseBtn", function(){ // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
      $("#notiPanel").removeClass("show"); // ë¶€íŠ¸ìŠ¤íŠ¸ë© dropdown ìˆ¨ê¹€ ì²˜ë¦¬(ë‹¨ìˆœ)
    });

    // í° íƒ­ í´ë¦­: ì•ˆì½ìŒ/ì½ìŒ ì „í™˜
    $(document).off("click", ".noti-tab2").on("click", ".noti-tab2", function(){ // íƒ­ í´ë¦­
      $(".noti-tab2").removeClass("active"); // ê¸°ì¡´ í™œì„± ì œê±°
      $(this).addClass("active"); // í˜„ì¬ í™œì„±

      notiState.tab = $(this).data("tab"); // ìƒíƒœ ê°±ì‹ (unread/read)
      loadNotiList(); // ì¬ì¡°íšŒ
    });

    //  í•„í„° í´ë¦­: ì „ì²´/í”„ë¡œì íŠ¸/ë©˜ì…˜/ì‹œìŠ¤í…œ/ê²°ì¬
    $(document).off("click", ".noti-filter-btn").on("click", ".noti-filter-btn", function(){ // í•„í„° í´ë¦­
      $(".noti-filter-btn").removeClass("active"); // í™œì„± ì œê±°
      $(this).addClass("active"); // í™œì„± ë¶€ì—¬

      notiState.filter = $(this).data("filter"); // ìƒíƒœ ê°±ì‹ 
      loadNotiList(); // ì¬ì¡°íšŒ
    });

    // ì•„ì´í…œ í´ë¦­: ì•ˆì½ìŒì´ë©´ ì½ìŒ ì²˜ë¦¬ í›„ URL ì´ë™
    $(document).off("click", "#notiList .noti-row").on("click", "#notiList .noti-row", function(){ // í–‰ í´ë¦­
      const $row = $(this); // í˜„ì¬ row
      const notiNo = $row.data("noti-no"); // ì•Œë¦¼ ë²ˆí˜¸
      const url = $row.data("noti-url"); // ì´ë™ URL

      // ì•ˆì½ìŒ -> ì½ìŒ ì²˜ë¦¬(ë¹„ë™ê¸°)
      if ($row.hasClass("is-unread")) { // ì•ˆì½ìŒì´ë©´
        $.ajax({ // ì½ìŒ ì²˜ë¦¬ ìš”ì²­
          url: apiBaseNoti + "/read", // read API
          method: "POST", // POST
          dataType: "json", // JSON
          data: { notiNo: notiNo }, // íŒŒë¼ë¯¸í„°
          success: function(res){ // ì„±ê³µ
            $row.removeClass("is-unread").addClass("is-read"); // UI ì½ìŒ ì²˜ë¦¬
            if (res && typeof res.notiUnreadCount !== "undefined") { // ì¹´ìš´íŠ¸ê°€ ì˜¤ë©´
              updateUnreadCountTab(res.notiUnreadCount); // íƒ­ ì¹´ìš´íŠ¸ ë°˜ì˜
              updateHeaderNotiDot(res.notiUnreadCount); // í—¤ë” ì  ë°˜ì˜
            } else { // ì¹´ìš´íŠ¸ê°€ ì•ˆ ì˜¤ë©´(ì˜ˆë¹„)
              // ê·¸ëŒ€ë¡œ ë‘ê±°ë‚˜, ë‹¤ìŒ ì¡°íšŒì—ì„œ ë§ì¶°ì§
            }
          }
        });
      }

      // URL ì´ë™(ì½ìŒ/ì•ˆì½ìŒ ìƒê´€ ì—†ì´)
      if (url) window.location.href = url; // í˜ì´ì§€ ì´ë™
    });

    // ìµœì´ˆ ë¡œë“œ: "ì•ˆì½ìŒ" íƒ­ë¶€í„°
    notiState.tab = "unread"; // ì´ˆê¸° íƒ­
    loadNotiList(); // ìµœì´ˆ ëª©ë¡ ë¡œë“œ
  });
</script>
