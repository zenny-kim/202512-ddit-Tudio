package kr.or.ddit.chat.service.impl;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import kr.or.ddit.chat.mapper.IChatMapper;
import kr.or.ddit.chat.service.IChatService;
import kr.or.ddit.vo.chat.ChatVO;
import kr.or.ddit.vo.chat.ChatroomVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class ChatServiceImpl implements IChatService{

	@Autowired
	private IChatMapper chatMapper;

	SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
	SimpleDateFormat timeFormat = new SimpleDateFormat("a hh:mm");
	
	@Override
	public List<ChatroomVO> selectChatroomList(int memberNo) {
		List<ChatroomVO> chatroomList = chatMapper.selectChatroomList(memberNo);
		

		// 각 채팅방별 마지막 채팅 출력 날짜의 포맷을 변경
		for(ChatroomVO chatroom : chatroomList) {
			
			Date lastChatDate = chatroom.getLastChatDate();
			
			if(lastChatDate != null) {
				String today = dateFormat.format(new Date());
				String yesterday = dateFormat.format(new Date(new Date().getTime() - 60*60*24*1000*1));
				String strLastChatDate = dateFormat.format(chatroom.getLastChatDate());
			
				if(today.equals(strLastChatDate)) {
					chatroom.setFmtLastChatDate(timeFormat.format(lastChatDate));
				}else if(yesterday.equals(strLastChatDate)) {
					chatroom.setFmtLastChatDate("어제");
				}else {
					chatroom.setFmtLastChatDate(dateFormat.format(lastChatDate));
				}
			}
		}
		
		return chatroomList;
	}

	@Override
	public List<ChatVO> selectChatList(ChatVO chatVo) {
		List<ChatVO> chatList = chatMapper.selectChatList(chatVo);
		
		for(ChatVO chat : chatList) {
			chat.setFmtCreateDate(timeFormat.format(chat.getCreateDate()));
		}
		
		return chatList;
	}

	@Override
	public Map<String, Object> selectChatroomTitle(ChatVO chatVo) {
		return chatMapper.selectChatroomTitle(chatVo);
	}

}
