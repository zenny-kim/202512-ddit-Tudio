<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tudio</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/sidebar.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/project.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/header.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/footer.css">
</head>
<body data-context-path="${pageContext.request.contextPath}"
	data-status="${status}" 
    data-project-no="${project.projectNo}">
    
    <jsp:include page="../include/header_user.jsp"/>

    <div>
        <jsp:include page="../include/sidebar_user.jsp">
              <jsp:param name="menu" value="project_new" />
        </jsp:include>

        <main class="main-content-wrap flex-grow-1">
            <div class="container-fluid">
                <h1 class="h3 fw-bold mb-4 text-primary">               
	                <i class="bi bi-folder-${status eq 'u' ? 'check' : 'plus'} me-2"></i>
	                ${status eq 'u' ? '프로젝트 설정' : '프로젝트 생성'}
	                
	                <c:if test="${project.projectStatus eq 1}">
				        <span class="badge bg-success ms-3 fs-6">
				            <i class="bi bi-check-circle-fill me-1"></i> 완료됨
				        </span>
				    </c:if>
                </h1>
                
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="card shadow p-4">
                            <form id="projectForm">
                                
                                <c:if test="${status eq 'c'}">
                                <div class="admin-note mb-4">
                                    <i class="bi bi-info-circle-fill me-1"></i> 프로젝트를 생성하는 사용자는 자동으로 <strong>프로젝트 관리자</strong> 권한이 부여됩니다.
                                </div>
                                </c:if>

                                <div class="mb-4">
                                    <label for="projectName" class="form-label fw-bold">프로젝트명 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="projectName" name="projectName" placeholder="예: 차세대 금융 플랫폼 구축" 
                                    value="${project.projectName}" required>
                                </div>

                                <div class="mb-4">
                                    <label for="projectDesc" class="form-label fw-bold">프로젝트에 대한 설명</label>
                                    <textarea class="form-control" id="projectDesc" name="projectDesc" rows="3" placeholder="프로젝트의 목적, 주요 목표, 핵심 범위 등을 입력하세요.">${project.projectDesc}</textarea>
                                </div>
                                
                                <div class="row mb-5">
                                    <div class="col-md-4">
                                        <label for="projectType" class="form-label fw-bold">프로젝트 타입 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="projectType" name="projectType" required>
                                            <option value="" disabled ${empty project.projectType ? 'selected' : ''}>선택해주세요</option>
                                            <option value="IT" ${project.projectType eq 'IT' ? 'selected' : ''}>IT</option>
                                            <option value="MARKETING" ${project.projectType eq 'MARKETING' ? 'selected' : ''}>마케팅</option>
                                            <option value="ENTERTAINMENT" ${project.projectType eq 'ENTERTAINMENT' ? 'selected' : ''}>엔터테인먼트</option>
                                            <option value="CONSTRUCTION" ${project.projectType eq 'CONSTRUCTION' ? 'selected' : ''}>건설</option>
                                            <option value="SECURITIES" ${project.projectType eq 'SECURITIES' ? 'selected' : ''}>증권</option>
                                            <option value="EDUCATION" ${project.projectType eq 'EDUCATION' ? 'selected' : ''}>학교</option>
                                            <option value="DESIGN" ${project.projectType eq 'DESIGN' ? 'selected' : ''}>디자인</option>
                                            <option value="RESEARCH" ${project.projectType eq 'RESEARCH' ? 'selected' : ''}>연구</option>
                                            <option value="MANUFACTURING" ${project.projectType eq 'MANUFACTURING' ? 'selected' : ''}>제조&amp;생산</option>
                                            <option value="FNB" ${project.projectType eq 'FNB' ? 'selected' : ''}>F&amp;B</option>
                                            <option value="ETC" ${project.projectType eq 'ETC' ? 'selected' : ''}>기타</option>
                                        </select>
                                    </div>
                                
                                    <div class="col-md-4">
                                        <label for="startDate" class="form-label fw-bold">프로젝트 시작일시 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="startDate" name="projectStartdate" 
                                        	value="<fmt:formatDate value='${project.projectStartdate}' pattern='yyyy-MM-dd'/>" required>
                                    </div>
                                
                                    <div class="col-md-4">
                                        <label for="endDate" class="form-label fw-bold">프로젝트 종료일시 <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="endDate" name="projectEnddate" 
                                        	value="<fmt:formatDate value='${project.projectEnddate}' pattern='yyyy-MM-dd'/>" required>
                                    </div>
                                </div>

                                <h5 class="text-primary fw-bold mb-3 border-top pt-4">
                                    <i class="bi bi-layout-text-window-reverse me-1"></i> 프로젝트 탭 및 순서 설정
                                </h5>
                                
                                <p class="text-muted small mb-4">
                                    ${status eq 'u' ? '현재 설정된 탭 순서대로 표시됩니다.' : '프로젝트 상세 화면에서 사용할 탭을 선택하고 순서를 변경할 수 있습니다.'}
                                </p>
                                
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 10%;" class="text-center">이동</th>
                                                <th style="width: 40%;">탭 이름 (기능)</th>
                                                <th style="width: 20%;" class="text-center">사용 여부</th>
                                                <th style="width: 30%;">비고</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabSortableList">
                                        	<c:forEach items="${tabList}" var="tab">
                                            <tr class="draggable-row" data-tap-id="${tab.id}">
                                                <td class="text-center drag-handle"><i class="bi bi-grip-vertical"></i></td>
                                                <td><i class="bi ${tab.icon} me-2 ${tab.color}"></i><strong>${tab.name}</strong></td>
                                                <td class="text-center">
                                                    <div class="form-check form-switch d-flex justify-content-center">
                                                    	<input class="form-check-input" type="checkbox" role="switch" 
                                   							${tab.checked ? 'checked' : ''}>
                                                    </div>
                                                </td>
                                                <td class="small text-muted">${tab.desc}</td>
                                            </tr>
                                            </c:forEach>
                                        </tbody>
                                    </table>
                                </div>

                                <h5 class="text-primary fw-bold mb-3 border-top pt-4"><i class="bi bi-people-fill me-1"></i> 팀원 구성 및 초대</h5>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-exclamation-circle me-1"></i>
                                        ${status eq 'u' ? '팀원을 추가하거나 제외할 수 있습니다.' : '팀원이 없는 프로젝트는 <strong>생성 7일 후 자동으로 삭제</strong>됩니다.'}
                                    </p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
                                        <i class="bi bi-envelope-plus me-1"></i> 팀원 초대
                                    </button>
                                </div>
                                
                                <div class="table-responsive mb-4">
                                    <table class="table table-striped align-middle small">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col" class="w-25">사용자 이름</th>
                                                <th scope="col" class="w-50">이메일</th>
                                                <th scope="col" class="w-25 text-center">관리</th>
                                            </tr>
                                        </thead>
                                        <tbody id="participantList">
                                        	<c:if test="${status eq 'c'}">
                                            <tr>
                                                <td>
                                                	<span class="fw-bold">${loginUser.memberName}</span>
                                                	<span class="badge bg-secondary ms-1">관리자 (본인)</span>
                                                </td>
                                                <td>${loginUser.memberEmail}</td>
                                                <td class="text-center"><button type="button" class="btn btn-sm btn-outline-secondary p-1" disabled><i class="bi bi-lock-fill"></i></button></td>
                                            </tr>
                                            </c:if>
                                    		
                                    		<c:if test="${status eq 'u'}">
                                                <c:forEach items="${project.memberList}" var="mem">
                                                    <tr data-type="${mem.projectRole}" class="${mem.projectMemstatus eq 'N' ? 'table-secondary text-muted excluded-member' : ''}">
                                                        <td>
                                                            <span class="fw-bold ${mem.projectMemstatus eq 'N' ? 'text-muted' : 'text-dark'}">${mem.memberName}</span>
                                                            <!-- <span style="color:red; font-weight:bold;">[${mem.projectMemstatus}]</span> -->
                                                            <c:choose>
                                                                <c:when test="${mem.projectRole eq 'CLIENT'}">
                                                                    <span class="badge bg-warning text-dark ms-2"><i class="bi bi-building-fill me-1"></i>기업 담당자</span>
                                                                </c:when>
                                                                <c:when test="${mem.projectRole eq 'MANAGER'}">
                                                                    <span class="badge bg-secondary ms-1">관리자</span>
                                                                </c:when>
                                                                <c:otherwise>
                                                                    <span class="badge bg-primary ms-2"><i class="bi bi-person-fill me-1"></i>팀원</span>
                                                                </c:otherwise>
                                                            </c:choose>
                                                            
                                                            <c:if test="${mem.projectMemstatus eq 'Y'}">
											                    <span class="badge bg-light text-secondary border ms-1">참여중</span>
											                </c:if>
											                <c:if test="${mem.projectMemstatus eq 'N'}">
											                    <span class="badge bg-secondary border ms-1">삭제됨</span>
											                </c:if>
                                                        </td>
                                                        <td class="${mem.projectMemstatus eq 'N' ? 'text-decoration-line-through' : ''}">${mem.memberEmail}</td>
                                                        <td class="text-center">
                                                            <c:if test="${mem.projectRole ne 'MANAGER'}">
                                                                <c:if test="${mem.projectMemstatus eq 'Y'}">
											                        <button type="button" class="btn btn-sm btn-outline-danger p-1 btn-remove-member" title="삭제">
											                            <i class="bi bi-trash"></i>
											                        </button>
											                    </c:if>
											                    
											                    <c:if test="${mem.projectMemstatus eq 'N'}">
											                        <button type="button" class="btn btn-sm btn-outline-success p-1 btn-restore-member" title="복구">
											                            <i class="bi bi-arrow-counterclockwise"></i>
											                        </button>
											                    </c:if>
                                                            </c:if>
                                                            <c:if test="${mem.projectRole eq 'MANAGER'}">
                                                                <button class="btn btn-sm btn-outline-secondary p-1" disabled><i class="bi bi-lock-fill"></i></button>
                                                            </c:if>
                                                        </td>
                                                    </tr>
                                                </c:forEach>
                                            </c:if>
                                    	</tbody>
                                    </table>
                                </div>
                                
                                <div class="d-flex justify-content-end pt-3 border-top">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="history.back()">취소</button>
                                    
                                    <button type="button" class="btn btn-primary me-2" id="projectSubmitBtn"> <!-- onclick="submitProject()" -->
                                        <i class="bi bi-folder-${status eq 'u' ? 'check' : 'plus'} me-1"></i>  
                                        ${status eq 'u' ? '수정 저장' : '프로젝트 생성'}
                                    </button>
                                    
                                    <c:if test="${status eq 'u'}">
								        <c:choose>
								            <%-- CASE1: 이미 완료된 경우 -> '완료 취소(재진행)' 버튼 --%>
								            <c:when test="${project.projectStatus eq 1}">
								                <button type="button" class="btn btn-outline-warning" id="btnReopenProject">
								                    <i class="bi bi-arrow-counterclockwise me-1"></i> 완료 취소 (재진행)
								                </button>
								            </c:when>
								            
								            <%-- CASE2: 진행 중인 경우 -> '프로젝트 완료' 버튼 --%>
								            <c:otherwise>
								                <button type="button" class="btn btn-success" id="btnCompleteProject">
								                    <i class="bi bi-check-circle-fill me-1"></i> 프로젝트 완료
								                </button>
								            </c:otherwise>
								        </c:choose>
								    </c:if>
                                </div>
                                
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        
        <jsp:include page="../include/footer.jsp">
            <jsp:param name="footer" value="create" />
        </jsp:include>
        
    </div>
    
    <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inviteModalLabel"><i class="bi bi-envelope-paper me-2"></i> 팀원 초대</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <ul class="nav nav-tabs mb-3" id="inviteTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-pane" type="button" role="tab"><i class="bi bi-keyboard me-1"></i> 직접 입력</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel-pane" type="button" role="tab"><i class="bi bi-file-earmark-excel me-1"></i> 엑셀 업로드</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="manual-pane" role="tabpanel">
                            
                            <div class="mb-3 p-3 bg-light border rounded">
                                <label class="form-label fw-bold small text-muted mb-2">초대할 사용자의 역할을 선택하세요</label>
                                <div class="d-flex gap-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="inviteType" id="typeMember" value="MEMBER" checked>
                                        <label class="form-check-label fw-bold" for="typeMember">
                                            <i class="bi bi-person-fill text-primary"></i> 프로젝트 팀원
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="inviteType" id="typeClient" value="CLIENT">
                                        <label class="form-check-label fw-bold" for="typeClient">
                                            <i class="bi bi-building-fill text-warning"></i> 기업 담당자
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="inviteEmails" class="form-label fw-bold">이메일 주소 입력</label>
                                <textarea class="form-control" id="inviteEmails" rows="5" placeholder="여러 명을 초대하려면 이메일을 쉼표(,) 또는 줄 바꿈으로 구분하여 입력하세요.&#13;&#10;예: user1@example.com, user2@example.com"></textarea>
                                <div class="form-text">입력한 이메일로 프로젝트 초대 링크 및 알림이 발송됩니다.</div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="excel-pane" role="tabpanel">
                            <div class="mb-3 text-center p-4 border rounded bg-light">
                                <i class="bi bi-file-earmark-excel text-success fs-1 mb-2"></i>
                                <p class="small text-muted mb-3">이메일 목록이 담긴 엑셀(.xlsx, .csv) 파일을 업로드하세요.<br>(A열에 이메일 주소가 있어야 합니다)</p>
                                <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls, .csv">
                            </div>
                            <div class="alert alert-info small mb-0">
                                <i class="bi bi-info-circle me-1"></i> 준비 중인 기능입니다.
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="processInviteBtn"> <!-- onclick="processInvitations()" -->
                        <i class="bi bi-plus-lg me-1"></i> 추가
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script src="${pageContext.request.contextPath}/js/projectForm.js"></script>
</body>
</html>