<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.notification.mapper.INotificationMapper">


  <!-- 알림 목록 조회 (전체 / 안읽음) -->
  <select id="notiList"
          parameterType="map"
          resultType="kr.or.ddit.vo.NotificationVO">

    SELECT
         N.NOTI_NO
       , N.NOTI_TYPE
       , N.NOTI_URL
       , N.IS_READ
       , N.NOTI_REGDATE
       , N.MEMBER_NO
       , N.NOTI_MESSAGE
       
    FROM NOTIFICATION N
    WHERE N.MEMBER_NO = #{memberNo}

    <if test="unreadOnly == true">
        AND N.IS_READ = 'N'
    </if>
    
    <if test="readOnly == true">
    	AND N.IS_READ = 'Y'
    </if>

    ORDER BY
        N.NOTI_REGDATE DESC,
        N.NOTI_NO DESC
  </select>


  <!-- 안읽음 알림 개수 -->
  <select id="selectUnreadCount"
          parameterType="int"
          resultType="int">
    SELECT COUNT(*)
    FROM NOTIFICATION
    WHERE MEMBER_NO = #{memberNo}
      AND IS_READ = 'N'
  </select>


  <!-- 읽음 처리 -->
  <update id="updateRead"
          parameterType="map">
    UPDATE NOTIFICATION
       SET IS_READ = 'Y'
     WHERE MEMBER_NO = #{memberNo}
       AND NOTI_NO = #{notiNo}
  </update>


  <!-- 알림 물리 삭제 -->
  <delete id="deleteNoti"
          parameterType="map">
    DELETE
      FROM NOTIFICATION
     WHERE MEMBER_NO = #{memberNo}
       AND NOTI_NO = #{notiNo}
  </delete>


  <!-- 알림 저장 -->
  <insert id="insertNoti"
          parameterType="kr.or.ddit.vo.NotificationVO">
    INSERT INTO NOTIFICATION (
          NOTI_NO
        , MEMBER_NO
        , NOTI_TYPE
        , TARGET_ID
        , NOTI_URL
        , IS_READ
        , NOTI_REGDATE
        , NOTI_MESSAGE
    ) VALUES (
        SEQ_NOTIFICATION.NEXTVAL
        , #{memberNo}
        , #{notiType}
        , #{targetId}
        , #{notiUrl}
        , 'N'
        , CURRENT_TIMESTAMP
        , #{notiMessage}
        
    )
  </insert> 

<!--  모든 회원 중 공지사항 알림을 ON으로 한 사람 --> 
<select id="notiSiteMember" resultType="kr.or.ddit.vo.MemberVO" >

	select 
	    m.member_no
	    , m.member_name
	from member m 
	inner join notification_setting s  on m.member_no = s.member_no
	where s.noti_site = 'Y' AND M.LEAVE_STATUS='N'
	
</select> 
  
  <!--  모든 회원의 알림 설정 확인 -->
  <select id="notiAllMember" parameterType="int" resultType="kr.or.ddit.vo.NotificationSettingVO">
SELECT
    M.MEMBER_NO
  , NS.NOTI_TASK_COMMENT
  , NS.NOTI_BO_COMMENT
  , NS.NOTI_MANAGER
  , NS.NOTI_CHAT
  , NS.NOTI_SCHEDULE
  , NS.NOTI_SITE
  , NS.NOTI_INQUIRY_COMMENT
  , NS.NOTI_DRAFT_UPLOAD
  , NS.NOTI_APPROVAL
  , NS.NOTI_PROJECT_NOTICE
FROM
    NOTIFICATION_SETTING NS
INNER JOIN MEMBER M
    ON M.MEMBER_NO = NS.MEMBER_NO
WHERE
    M.LEAVE_STATUS = 'N' AND M.MEMBER_NO = #{memberNo}

  </select>
 
 
 
 
 
 <!--  내가 쓴 게시글에 달린 댓글 -->
 <select id="notiCommentNoti" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectBoardVO">
 	
 	SELECT
        PB.MEMBER_NO AS writerNo
	  , CASE
	        WHEN LENGTH(PB.BO_TITLE) > 10
	        THEN SUBSTR(PB.BO_TITLE, 1, 10) || '...'
	        ELSE PB.BO_TITLE
	    END AS BOTITLE
	  , CASE
	        WHEN BC.CATEGORY_NAME = 'FREE'    THEN '자유'
	        WHEN BC.CATEGORY_NAME = 'NOTICE'  THEN '공지'
	        WHEN BC.CATEGORY_NAME = 'MINUTES' THEN '회의'
	        ELSE '기타'
	    END AS categoryName
	  , BC.PROJECT_NO
	  , BC.CATEGORY_NO
	  
	FROM PROJECT_BOARD PB
	JOIN BOARD_CATEGORY BC
	  ON BC.CATEGORY_NO = PB.CATEGORY_NO
	WHERE PB.BO_NO = #{boNo}
		
 
 </select>
 
 
  

  
  
  <!--  공지사항 알림 db등록 -->
  <insert id="insertSiteNoticeNoti" parameterType="map">
	  INSERT INTO NOTIFICATION (
	    NOTI_NO, MEMBER_NO, NOTI_TYPE, TARGET_ID, NOTI_URL, IS_READ, NOTI_REGDATE, NOTI_MESSAGE
	  )
	  SELECT
	    SEQ_NOTIFICATION.NEXTVAL
	    , S.MEMBER_NO
	    , 'NOTI_SYSTEM'
	    , #{targetId}
	    , #{notiUrl}
	    , 'N'
	    , CURRENT_TIMESTAMP
	    , #{notiMessage}
	  FROM NOTIFICATION_SETTING S
	  WHERE S.NOTI_SITE = 'Y'
</insert>


<!-- 부모 댓글 조회 -->
<select id="selectNotiReply" resultType="map" parameterType="map">

	SELECT 
          PB.MEMBER_NO  AS "boardWriter"
        , ROOTC.MEMBER_NO AS "memberNo"
        , CASE 
            WHEN  LENGTH(ROOTC.CMT_CONTENT) >10 THEN
            SUBSTR(ROOTC.CMT_CONTENT,1,10)||'...' ELSE ROOTC.CMT_CONTENT END AS "cmtContent"
        , BC.PROJECT_NO AS "projectNo"
        , ROOTC.TARGET_TYPE AS "targetType"
        , PB.BO_TITLE AS "boTitle"
        , PB.BO_NO AS "boNo"
        , PB.CATEGORY_NO AS "categoryNo"
    FROM PROJECT_BOARD PB 
    JOIN BOARD_CATEGORY BC ON PB.CATEGORY_NO = BC.CATEGORY_NO
    JOIN TB_COMMENT ROOTC
    	  ON ROOTC.CMT_GROUP = (SELECT CMT_GROUP FROM TB_COMMENT WHERE CMT_NO = #{parentCmtNo})
	     AND ROOTC.CMT_DEPTH = 0 AND ROOTC.CMT_STATUS = 'Y' AND ROOTC.TARGET_ID = PB.BO_NO
    WHERE PB.BO_NO = #{boNo}	

</select>

<!-- PM, 기업관리자, 팀원인지 확인. 로그인한 세션의 memberNo로 판별하면 될듯?-->
<select id="selectAuthNoti" parameterType="int" resultType="string">
	
SELECT
     AM.AUTH
FROM MEMBER M
INNER JOIN MEMBER_AUTH AM
    ON M.MEMBER_NO = AM.MEMBER_NO
WHERE M.MEMBER_NO = #{memberNo} AND M.LEAVE_STATUS='N'

</select>


<!-- 프로젝트 멤버에게 공지사항 알림 일괄 INSERT -->
<insert id="insertProjectNoticeNoti" parameterType="map">
    INSERT INTO NOTIFICATION (
          NOTI_NO
        , MEMBER_NO
        , NOTI_TYPE
        , TARGET_ID
        , NOTI_URL
        , IS_READ
        , NOTI_REGDATE
        , NOTI_MESSAGE
    )
    SELECT
          SEQ_NOTIFICATION.NEXTVAL
        , PM.MEMBER_NO
        , 'NOTI_SYSTEM'
        , #{targetId}
        , #{notiUrl}
        , 'N'
        , CURRENT_TIMESTAMP
        , #{notiMessage}
    FROM PROJECT_MEMBER PM
    JOIN MEMBER M
      ON M.MEMBER_NO = PM.MEMBER_NO
    JOIN NOTIFICATION_SETTING NS
      ON NS.MEMBER_NO = PM.MEMBER_NO
    WHERE PM.PROJECT_NO = #{projectNo}
      AND M.LEAVE_STATUS = 'N'
      AND NS.NOTI_PROJECT_NOTICE = 'Y'
      
     <![CDATA[ AND PM.MEMBER_NO <> #{writerNo} ]]>
</insert>



<!--  프로젝트 멤버 푸시 대상 조회-->
<select id="selectProjectNoticeNoti" resultType="int">
	    
SELECT pm.MEMBER_NO
FROM PROJECT_MEMBER pm
JOIN MEMBER m ON m.MEMBER_NO = pm.MEMBER_NO
JOIN NOTIFICATION_SETTING ns ON ns.MEMBER_NO = pm.MEMBER_NO
WHERE pm.PROJECT_NO = #{projectNo}
  AND m.LEAVE_STATUS = 'N'
  AND ns.NOTI_PROJECT_NOTICE = 'Y'

   <![CDATA[ 
		AND pm.MEMBER_NO <> #{writerNo}
	]]>
  
</select>



</mapper>