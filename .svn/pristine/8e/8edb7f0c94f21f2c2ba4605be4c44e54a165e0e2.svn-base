<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>

<div class="tab-content-card" id="tabMember" data-project-no="${projectNo}">

	<!-- ===== 구성원 탭 컨텐츠 시작 ===== -->
	<section class="member-panel">

		<main class="project-main">

			<!-- 좌측 : 업무 현황 차트 -->
			<section class="main-card chart-area">
				<h3 class="card-title">담당 업무 현황</h3>
				<div class="chart-box">
					<!-- chart.js / echarts 들어갈 자리 -->
					<canvas id="memTaskChart"></canvas>
					<div id="noTaskMsg" style="display:none; text-align:center; padding:24px 0; font-weight:600;">
   				 진행중인 업무가 없습니다
				</div>
				</div>
			</section>

		
			<section class="main-card member-area">
				<h3 class="card-title">구성원 목록 (${count})</h3>
				
			
			<!--  검색 영역 -->
			  <div class="d-flex gap-2 align-items-center mb-2">
			    <select id="searchType" class="form-select form-select-sm" style="width:140px;">
			      <option value="memberName">이름</option>
			      <option value="companyName">회사명</option>
			      <option value="memberDepartment">부서</option>
			    </select>
			    
			    <input id="searchWord" class="form-control form-control-sm" style="max-width:240px;"
			           type="text" placeholder="검색어 입력" />
			
			    <button id="memSearchBtn" class="btn btn-sm btn-primary" type="button">검색</button>
			    
			    </div>
			<!--  검색 영역 -->
			
			


				<table class="member-table">
					<thead>
						<tr>
							<th>No</th>
							<th>구성원 이름</th>
							<th>회사명</th>
							<th>부서</th>
							<th>직급</th>
							<th>채팅</th>
						</tr>
					</thead>
					<tbody>
						<c:forEach items="${list}" var="l" varStatus="st">
							<tr>
								<td>${st.count}</td>


								<!-- data-bs-target="#memberModal : 모달 요소의 id 값 -->
								<td class="member-name" data-member-no="${l.memberNo}"
									data-bs-toggle="modal" data-bs-target="#memberModal">
									${l.memberName} <c:if test="${l.projectRole eq 'MANAGER' }"><span class="role-blue">(PM)</span></c:if>
									<c:if test="${l.projectRole eq 'CLIENT'}"><span class="role-blue">(기업관리자)</span></c:if>
								</td>

								<td>${l.companyName}</td>
								<td>${l.memberDepartment}</td>
								<td>${l.memberPosition}</td>
								<td><button class="btn btn-sm btn-outline-secondary">
										<i class="bi bi-chat-square-text"></i>
									</button></td>
							</tr>
						</c:forEach>
					</tbody>
				</table>
			</section>

		</main>

	</section>
</div>

	<!-- ===== 구성원 상세 모달 (Bootstrap) ===== -->
	<div class="modal fade" id="memberModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content member-modal">

				<div class="modal-header">
					<div>
						<h5 class="modal-title">구성원 상세 정보</h5>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body">
					<!-- 상단 -->
					<div class="modal-body">

						<!-- ===== 상단 카드 (사진 스타일) ===== -->
						<div class="memTopCard">
							<!--     <div class="memAvatarCircle" id="mProfile">프로필</div> -->
							<div class="memAvatarCircle">
								<img id="mAvatarImg" alt="profile" />
							</div>

							<div class="memName" id="mName">이름</div>

							<div class="memStatLine">
								<div class="memStatItem">
									<div class="k">담당업무</div>
									<div class="v">
										<span id="mTotal">0</span>개 (상위 : <span id="mTask">0</span>개, 하위 : <span id="mTaskSub">0</span>개)
									</div>
								</div>
								<div class="memStatItem">
									<div class="k">진행업무</div>
									<div class="v">
										<span id="mIng">0</span>개
									</div>
								</div>
								<div class="memStatItem">
									<div class="k">완료업무</div>
									<div class="v">
										<span id="mDone">0</span>개
									</div>
								</div>

							</div>
						</div>

						<!-- ===== 하단 Information ===== -->
						<div class="memInfoWrap">
							<div class="memInfoTitle">Infomation</div>

							<div class="memInfoBox">
								<div class="infoRow">
									<div class="label">이메일</div>
									<div class="val" id="mEmail">-</div>
								</div>

								<div class="infoRow">
									<div class="label">연락처</div>
									<div class="val" id="mTel">-</div>
								</div>

								<div class="infoRow">
									<div class="label">참여일</div>
									<div class="val" id="mDate">-</div>
								</div>
							</div>
						</div>

						<!-- 기존에 있던 힌트 div는 유지(안 쓰면 숨김 처리됨) -->
						<div class="mm-desc" id="mProgHint" style="display: none;"></div>
					</div>

				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary btn-sm"
						data-bs-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>


<!-- 플러그인 CDN 추가. 파이조각 위에 숫자값 표시를 하려고 추가함 -->
<script src="${pageContext.request.contextPath}/js/footer.js"></script>

<script type="text/javascript">

const ctx = "${pageContext.request.contextPath}";
const tabProjectNo = document.getElementById("tabMember").dataset.projectNo || window.projectNo;

// 1. 모달 이벤트 리스너
document.getElementById('memberModal').addEventListener('show.bs.modal', async(event)=>{
   

	const target = event.relatedTarget; // 얘가 td일 수도, span일 수도 있음
	const row = target.closest(".member-name"); // member-name td 찾기
	if (!row) return;

	const memberNo = row.dataset.memberNo;

  console.log("projectNo:", tabProjectNo);
   console.log("memberNo:", memberNo);
   
   
   /* Spring EL과 자바스크립트 템플릿 String 문법 충돌 방지 (\ 추가) */
   const url =  ctx + "/tudio/project/member/memberModal?projectNo=" + encodeURIComponent(tabProjectNo)
   + "&memberNo=" + encodeURIComponent(memberNo);

   // 서버 호출
   try {

	   const res = await fetch(url);
	   if (!res.ok) {
	     console.error("memberModal 응답 실패:", res.status, url);
	     return;
	   }
	   const data = await res.json();

      // 모달에 값 채우기
      document.getElementById('mName').innerText = data.memberName;
      document.getElementById('mEmail').innerText = data.memberEmail;
      document.getElementById('mTel').innerText = data.memberTel;
      document.getElementById('mDate').innerText = data.projectMemregdate;

      
      // 업무 수 (nullish coalescing 사용)
      document.getElementById("mTotal").innerText = data.totalCnt ?? 0;
      document.getElementById("mIng").innerText   = data.ingCnt ?? 0;
      document.getElementById("mDone").innerText  = data.doneCnt ?? 0;
      document.getElementById("mTask").innerText  = data.taskCnt ?? 0;
      document.getElementById("mTaskSub").innerText  = data.taskSubCnt ?? 0;
      

      // 프로필 이미지 처리
      const img = document.getElementById("mAvatarImg");
      img.src = data.memberProfileImg ? data.memberProfileImg : "/images/default_profile.png";
      
   } catch (err) {
      console.error("모달 데이터 로드 실패:", err);
   }
});

//2. 차트 데이터를 불러오고 그리는 비동기 함수
async function loadMemberChart() {

	
	
	var canvasEl = document.getElementById("memTaskChart");
	var noTaskMsg = document.getElementById("noTaskMsg");

    var canvas = document.querySelector("#memTaskChart");

    try {
    	const response = await fetch(ctx + "/tudio/project/member/memberChart?projectNo=" + encodeURIComponent(tabProjectNo));

        if (!response.ok) {
            throw new Error(`서버 통신 오류: ${response.status}`);
        }

        const data = await response.json();

        // data 안전 처리
        const safeData = Array.isArray(data) ? data : [];

        // 담당업무 0개 제외 (여기가 핵심)
        const filteredData = safeData.filter(item => (item.totalWorkCnt ?? 0) > 0);

        // 전부 0개면 차트 영역 숨김 + 기존 차트 제거 후 종료
        if (filteredData.length === 0) {
            if (window.memChartInstance != undefined) {
                window.memChartInstance.destroy();
                window.memChartInstance = undefined;
            }
            canvasEl.style.display = "none";
            noTaskMsg.style.display = "block";
            return;
           
        } else {
        	noTaskMsg.style.display = "none";
        	canvasEl.style.display = "block";
        }

        // 데이터 가공
        var labels = filteredData.map(item => item.memberName);
        var values = filteredData.map(item => item.totalWorkCnt);

        var palette = ['#4e79a7', '#f28e2b', '#bab0ab', '#edc949', '#76b7b2', '#59a14f', '#2f4b7c', '#e15759', '#79706e', '#ff9da7'];
        var bgColors = filteredData.map((_, i) => palette[i % palette.length]);

        // 기존 차트 파괴 (중복 방지)
        if (window.memChartInstance != undefined) {
            window.memChartInstance.destroy();
        }

        // 차트 생성
        window.memChartInstance = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: {
                        color: '#000',
                        font: { weight: '700', size: 12 },
                        anchor: 'center',
                        align: 'center',
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

    } catch (error) {
        console.error("차트 로딩 실패:", error);
    }
}

//검색 및 페이징. 페이지 값을 안 주면 기본으로 1페이지로 처리

/* let memState = {
	page:1
};

async function memPaging(page =1){
	memState.page = page;
	
	const searchTypeE1 = document.querySelector("#searchType");
	const searchWordE1 = document.querySelector("#searchWord");
	
	const searchType = searchTypeE1 ? searchTypeE1.value : ""; // 존재하면
	const searchWord = searchWordE1 ? searchWordE1.value.trim() : ""; 
	
	const memParam  = new
	
}

 */







// 3. 페이지 로드 시 차트 함수 실행
loadMemberChart();





</script>
