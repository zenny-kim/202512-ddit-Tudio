<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.functions" prefix="fn" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>

<div class="chat-widget">
    <c:set var="memCount" value="${chatroomTitle.MEM_COUNT }"/>

    <header class="chat-room-header">
        <div class="header-left">
            <button id="backBtn" class="header-btn" aria-label="뒤로 가기" 
                    data-tooltip="뒤로 가기" data-tooltip-pos="left">
                <i data-feather="chevron-left"></i>
            </button>
        </div>

        <h2 class="room-title">
            <span class="room-name-text">${chatroomTitle.CHATROOM_NAME}</span>
            <c:if test="${chatroomTitle.MEM_COUNT > 2}">
                <span class="member-count">${memCount }</span>
            </c:if>
        </h2>
        
        <div class="header-right">
            <button class="header-btn" aria-label="검색" data-tooltip="대화 검색">
                <i data-feather="search" style="width:20px; height:20px;"></i>
            </button>

            <button class="header-btn" aria-label="채팅방 설정" data-tooltip="설정">
                <i data-feather="settings" style="width:20px; height:20px;"></i>
            </button>
        </div>
    </header>

	<c:set var="isEnd" value="false"/>

    <main class="chat-room-content">
        <c:set var="lastChatNo" value=""/>
        <c:set var="preChatDate" value=""/>
        <c:set var="firstChatDate" value=""/>
        <c:set var="myName" value=""/>
        <c:set var="myProfileimg" value=""/>
        <c:set var="isEmptyChat" value="true"/>
    	
        <c:forEach items="${chatList }" var="chat" varStatus="status">
            <fmt:formatDate value="${preChatDate }" var="fmtPreChatDate" pattern="yyyyMMdd"/>
            <fmt:formatDate value="${chat.createDate }" var="fmtCurChatDate" pattern="yyyyMMdd"/>
        
            <c:if test="${status.first }">
		        <c:set var="isEmptyChat" value="false"/>
                <fmt:formatDate value="${chat.createDate }" var="firstChatDate" pattern="yyyyMMdd"/>
                <c:set var="lastChatNo" value="${chat.chatNo }"/>
                
                <%-- 
                	불러온 채팅의 길이가 30보다 작다는 것은 해당 채팅방의 전체 채팅을 다 불러온 것이다.
                	그렇기에 맨 상단에 날짜 알림 div를 띄워준다. 
               	--%>
                <c:if test="${fn:length(chatList) < 30 }">
					<c:set var="isEnd" value="true"/>
                	<div class="system-message-container" >
	                    <span class="system-message">
	                        <fmt:formatDate value="${chat.createDate }" pattern="yyyy년 MM월 dd일 E요일"/>
	                    </span>
	                </div>
                </c:if>
            </c:if>
            
            <c:if test="${!status.first and (fmtPreChatDate < fmtCurChatDate)}">
                <div class="system-message-container" >
                    <span class="system-message">
                        <fmt:formatDate value="${chat.createDate }" pattern="yyyy년 MM월 dd일 E요일"/>
                    </span>
                </div>
            </c:if>
            <c:set var="preChatDate" value="${chat.createDate }"/>
        
            <c:choose>
                <c:when test="${chat.chatType eq 'SYSTEM'}">
                    <div class="system-message-container" id="chat${chat.chatNo}">
                        <span class="system-message">${chat.message }</span>
                    </div>
                </c:when>
                <%-- 내가 보낸 채팅이라면 --%>
                <c:when test="${chat.memberNo eq myMemNo }">
			        <c:set var="myName" value="${chat.memberName }"/>
			        <c:set var="myProfileimg" value="${chat.memberProfileimg }"/>
                    <div class="message-row sent" id="chat${chat.chatNo}">
                        <div class="bubble-container">
                            <div class="sent-info">
                                <c:if test="${chat.notReadCnt ne 0}">
                                    <span class="unread-count">${chat.notReadCnt }</span>
                                </c:if>
                                <span class="message-time">${chat.fmtCreateDate }</span>
                            </div>
                            <div class="message-bubble">
                                ${chat.message }
                            </div>
                        </div>
                    </div>
                </c:when>
                <%-- 상대방이 보낸 채팅이라면 --%>
                <c:when test="${chat.memberNo ne myMemNo  }">
                    <div class="message-row received" id="chat${chat.chatNo}">
                        <c:choose>
                            <c:when test="${not empty chat.memberProfileimg}">
                                <img src="${pageContext.request.contextPath}${chat.memberProfileimg}" class="profile-img" alt="프로필">
                            </c:when>
                            <c:otherwise>
                                <div class="default-avatar avatar-color-${chat.memberNo % 5}">
                                    <i data-feather="user" style="width:20px; height:20px;"></i>
                                </div>
                            </c:otherwise>
                        </c:choose>
                        <div class="message-content">
                            <span class="sender-name">${chat.memberName }</span>
                            <div class="bubble-container">
                                <div class="message-bubble">
                                    ${chat.message }
                                </div>
                                <div class="received-info">
                                    <c:if test="${chat.notReadCnt ne 0}">
                                        <span class="unread-count">${chat.notReadCnt }</span>
                                    </c:if>
                                    <span class="message-time">${chat.fmtCreateDate }</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </c:when>
            </c:choose>
        </c:forEach>
    </main>

    <footer class="chat-input-area">
        <button class="footer-btn attach-btn" aria-label="파일 첨부" 
                data-tooltip="파일 첨부" data-tooltip-pos="left">
            <i data-feather="plus" width="24" height="24"></i>
        </button>
        
        <input type="file" class="input-file">

        <div class="input-wrapper">
            <textarea class="chat-input" placeholder="메시지 보내기" rows="1"></textarea>
        </div>

        <button class="footer-btn send-btn" aria-label="전송" 
                data-tooltip="전송" data-tooltip-pos="right">
            <i data-feather="send" width="18" height="18"></i>
        </button>
    </footer>
</div>

<script>
$(function(){
 	// 실시간 채팅을 위해 stompJS를 활용한 client 객체 설정 및 생성
 	const client = new StompJs.Client({
 		webSocketFactory: () => new SockJS("http://localhost:8060/ws-stomp"),
        reconnectDelay: 5000
 	});
 	

 	//////////////////////////////////////////////////////////////
 	// [디자인적 요소를 위한 스크립트 부분]
 	
 	// 아이콘 렌더링
    feather.replace();
    
 	// 스크롤을 맨 아래로 내려줌
    const chatContent = $('.chat-room-content');
    const textarea = $('.chat-input');

    if(chatContent.length > 0) {
    	chatContent.scrollTop(chatContent[0].scrollHeight);
    }
    
 	// textarea 높이 조절 및 스크롤바 제어 함수
    function adjustHeight() {
        // 1. 높이를 초기화해야 줄어들었을 때를 감지함
        textarea.css('height', 'auto'); 
        
        // 2. 현재 글자 높이 계산
        let newHeight = textarea[0].scrollHeight;
        
        // 3. 120px(CSS max-height)를 넘어가면 스크롤바 켜기, 아니면 끄기
        if (newHeight > 120) {
            textarea.css("overflow-y", "auto");  
        } else {
            textarea.css("overflow-y", "hidden"); 
        }
        
        // 4. 최소 높이 보정 
        if(newHeight < 36) newHeight = 36;
        
        // 5. 높이 적용
        textarea.css('height', newHeight + 'px');
    }

 	//////////////////////////////////////////////////////////////
    // [채팅 메세지 div 생성하는 함수 정의]
 	
    // 날짜 알림 div 만들어주는 함수
    function createDateNoti(date){
    	moment.locale("ko");
    	let fmtDate = moment(date).format("LL dddd");
    	
    	dateDiv = `
    		<div class="system-message-container">
	            <span class="system-message">
	            	\${fmtDate}
	            </span>
	        </div>
    	`;
    	
    	return dateDiv;
    }
    
    // 시스템 메시지 div 만들어주는 함수
    function createSystemNoti(chat){
    	let chatHtml = `
        	<div class="system-message-container" id="chat\${chat.chatNo}">
        		<span class="system-message">
        			\${chat.message }
       			</span>
   			</div>
		`;
		
        return chatHtml;
    }
    
    
    // 내가 보낸 메세지 div 만들어주는 함수
    function createMyChat(chat){
    	let chatHtml = "";
    	
    	chatHtml += `
        	<div class="message-row sent" id="chat\${chat.chatNo}">
        		<div class="bubble-container">
        			<div class="sent-info">
       	`;
        if(chat.notReadCnt != 0){ // 해당 채팅을 안읽은 사람이 있다면
        	chatHtml += `
                    	<span class="unread-count">
                    		\${chat.notReadCnt }
                    	</span>
        	`;
        }
        chatHtml += `
                    	<span class="message-time">
                       		\${chat.fmtCreateDate }
                        </span>
                    </div>
                    <div class="message-bubble">
                   		\${chat.message }
                    </div>
                </div>
            </div>
        `;
        
        return chatHtml;
    }
	
    // 상대방이 보낸 메세지 div 만들어주는 함수
    function createOtherChat(chat){
    	let chatHtml = "";
    	let profileHtml = "";
        
        if(chat.memberProfileimg != null && chat.memberProfileimg != "") {
            profileHtml = `<img src="${pageContext.request.contextPath}\${chat.memberProfileimg}" class="profile-img">`;
        } else {
            let colorIndex = chat.memberNo % 5;
            profileHtml = `
                <div class="default-avatar avatar-color-\${colorIndex}">
         			<i data-feather="user" style="width:20px; height:20px;"></i>
                </div>
            `;
        }
        
        chatHtml += `
            <div class="message-row received" id="chat\${chat.chatNo}">
            	\${profileHtml}	
            	<div class="message-content">
            		<span class="sender-name">
            			\${chat.memberName }
            		</span>
            		<div class="bubble-container">
            			<div class="message-bubble">
            				\${chat.message }
           			 	</div>
            			<div class="received-info">
        `;
        if(chat.notReadCnt != 0) chatHtml += `<span class="unread-count">\${chat.notReadCnt }</span>`;
        chatHtml += `
                        	<span class="message-time">
                            	\${chat.fmtCreateDate }
                            </span>
                		</div>
                	</div>
            	</div>
            </div>
        `;
        
        return chatHtml;
    }
	
    //////////////////////////////////////////////////////////
 	
    let chatroomNo = "${chatroomTitle.CHATROOM_NO}";
    let lastChatNo = "${lastChatNo}";

    const subUrl = "/sub/chat/chatroom/"+ chatroomNo
 	
 	client.onConnect = function(frame){
 		client.subscribe(subUrl, function(message){
 			let chat = JSON.parse(message.body);
 			
 			// TODO: 날짜 바뀔 경우를 대비해 날짜 알림 띄우는 로직 추가
 			
 			if(chat.chatType == "SYSTEM"){
 				$(chatContent).append(createSystemNoti(chat));
 			}else if(chat.memberNo == ${myMemNo}){
 				if(${isEmptyChat} == true){
 					$(chatContent).append(createDateNoti(new Date));
 				}
 				$(chatContent).append(createMyChat(chat));
 			}else if(chat.memberNo != ${myMemNo}){
 				if(${isEmptyChat} == true){
 					$(chatContent).append(createDateNoti(new Date));
 				}
 				$(chatContent).append(createOtherChat(chat));
 			}
 			
 			feather.replace();
 			chatContent.scrollTop(chatContent[0].scrollHeight);
 	 	});
 	}
 	
 	// 연결 시작
 	client.activate();
 	
	// 메세지 전송 함수
    function sendMessage(message){
    	client.publish({
	 		destination: "/pub/chat/message",
	 		body: JSON.stringify({
	 			chatroomNo: chatroomNo,
	 			memberNo : ${myMemNo},
	 			memberName : "${myName}",
	 			memberProfileimg : "${myProfileimg}",
				message : message,
				createDate : Date.now(),
				chatType: "TEXT"			
	 		})
	 	})
    	
    	textarea.val('');
    	textarea.css("height", 'auto'); 
        adjustHeight(); 
    }

 	if(textarea.length > 0){
        textarea.on('input', adjustHeight);
        textarea.on('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                let msg = $(this).val()
                if(msg.trim() === "") return;

                sendMessage(msg);
            }
        });
        
        adjustHeight();
    }
    
 	// 파일 첨부 버튼을 눌렀을 경우
 	$(".attach-btn").on("click", function(){
 		const inputFile = $(".input-file");
 		inputFile.click();
 		inputFile.on("change", function(){
			console.log(this.files[0]);
			// TODO: ajax 로 파일 저장하고, 웹소켓으로 모두에게 파일url 뿌리기
 		})
 	})
 	
 	// 전송 버튼을 눌렀을 경우
    $(".send-btn").on("click", function(){
    	if(textarea.length > 0){
    		let msg = textarea.val();
            if(msg.trim() === "") return;
            sendMessage(msg);
    	}
    })
    
    // 뒤로가기 버튼을 클릭할 경우
    $("#backBtn").on("click", function(){
    	client.deactivate().then(() => {
    		console.log("연결 종료");
    	});
    	
        $container.load("/tudio/chat/list", function(){
            feather.replace();
        });
    });
    
    // 서버에서 데이터를 가져오는 중인지 판별
    let isLoading = false;
    // 서버에서 해당 채팅방의 모든 채팅을 가져왔는지 확인
    let isEnd = ${isEnd};
    
 	// 이미 생성되어있는 div의 첫 채팅 날짜
    let bottomFirstChatDate = "${firstChatDate}";
    // ajax 요청을 통해 생성된 div의 첫 채팅 날짜
    let firstChatDate = "";
    
     chatContent.on('scroll', function(){
        if(isLoading || isEnd) return;
        
        let currentScrollTop = $(this).scrollTop();
        let viewHeight = $(this).innerHeight();
        
     	// 사용자가 스크롤 맨 위로 도달하기까지 얼마 안남았다면 실행됨
        if(currentScrollTop <= viewHeight){
            isLoading = true;
            $.ajax({
                url: "/tudio/chat/chatroom/oldchat",
                type: "get",
                contentType : "application/json;charset=utf-8",
                data: { 
                	chatroomNo : chatroomNo, 
                	chatNo : lastChatNo 
               	},
                success: function(result){
                    let chatHtml = "";
                 	// forEach에서 현재 index의 바로 직전 ChatDate
                    let preChatDate = "";
                    
                 	// ajax로 불러온 이전 채팅 메세지 목록 html 구조로 변환
                    result.forEach(function(chat, index){
                        if(index == 0) {
                        	lastChatNo = chat.chatNo;
                        	  
                            if(result.length < 30){
                            	chatHtml += createDateNoti(chat.createDate);          	
                               	isEnd = true;
                            }
                        }
                        
                     	// 동일한 메세지가 있는지 확인 
	   					// (이미 출력한 메세지를 다시 출력하는 불상사를 막기위해)
                        let idChatNo = "#chat"+chat.chatNo;
                        if($(idChatNo).length == 0){
                        	// 날짜 비교를 위해 moment 라이브러리를 사용하여 변수 생성
                            let mmtPreChatDate = parseInt(moment(preChatDate).format("YYYYMMDD"));
                            let mmtCurChatDate = parseInt(moment(chat.createDate).format("YYYYMMDD"));
                            
                         	// 다음 ajax 요청 실행시, 마지막 채팅과의 날짜 비교를 위해 값 저장
                            if(index == 0){
                                firstChatDate = chat.createDate;
                                mmtPreChatDate = 99999999;
                            }
                            
                         	// 현재 채팅의 날짜가 이전 채팅 날짜 값보다 크다면 실행
	   						// (날짜가 다음날로 변경된 것이므로)
                            if(mmtCurChatDate > mmtPreChatDate){
                                chatHtml += createDateNoti(chat.createDate);
                            }
                            preChatDate = chat.createDate;
                            
                            if(chat.chatType == "SYSTEM"){
                            	chatHtml += createSystemNoti(chat);
                            }else if(chat.memberNo == ${myMemNo}){	// 본인이 작성한 메세지라면
                            	chatHtml += createMyChat(chat);
                            }else if(chat.memberNo != ${myMemNo}){	// 타인이 작성한 메세지라면
                            	chatHtml += createOtherChat(chat);
                            } 

                            if(index == result.length-1){
                                let mmtBottomFirstChatDate = parseInt(moment(bottomFirstChatDate).format("YYYYMMDD"));
                                
                                if(mmtCurChatDate < mmtBottomFirstChatDate){
                                    chatHtml += createDateNoti(bottomFirstChatDate);
                                }
                                bottomFirstChatDate = firstChatDate;
                            }
                            
                            
                        } // 기존에 없는 채팅인지 확인 if문 끝
                    }) // forEach 끝

                 	// 불러온 메세지들을 기존 메세지의 앞에 붙여줌
                    chatContent.prepend(chatHtml);

                    feather.replace();
                    isLoading = false;
                },
                error: function(error){ 
               		console.log("error : " + error.status); 
           		}
            }) // ajax 끝
        } // 스크롤 상단 도착 직전 확인 if문 끝
    }) // scroll 이벤트 끝
})
</script>