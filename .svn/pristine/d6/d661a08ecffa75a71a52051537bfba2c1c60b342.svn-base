package kr.or.ddit.approval.controller;

import java.security.Principal;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.approval.service.IApprovalService;
import kr.or.ddit.member.service.IMemberService;
import kr.or.ddit.vo.ApprovalPaginationInfoVO;
import kr.or.ddit.vo.DraftDocumentVO;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.project.ProjectVO;


/**
 * <pre>
 * PROJ : Tudio
 * Name : class
 * DESC : 결재 기능 관련 클래스
 * </pre>
 * 
 * @author [대덕인재개발원] team1 KHJ
 * @version 1.0, 2026.01.17
 */
@Controller
@RequestMapping("/tudio/approval")
public class ApprovalController {
	
	@Autowired
	private IMemberService memberService;
	
	@Autowired
	private IApprovalService approvalService;
	
	
	/**
	 * 선택한 프로젝트 관련 결재 목록조회
	 */
	
	@GetMapping("/list")
	public String approvalList(
	        @RequestParam(name="projectNo", required=false, defaultValue="0") int projectNo, // 어떤 프로젝트의 결재함인지 필수
	        @RequestParam(name="page", required=false, defaultValue="1") int currentPage,
	        @RequestParam(value="tabType", required=false, defaultValue="ALL") String tabType, // 미니탭
	        @RequestParam(value="searchType", required=false) String searchType,
	        @RequestParam(value="searchWord", required=false) String searchWord,	        
	        Principal principal, Model model, HttpSession session) {
		
		//로그인 여부 체크
	    if (principal == null) {
	        return "redirect:/tudio/login";
	    }

	    //로그인 사용자 정보 가져오기 및 세션 저장
	    String memberId = principal.getName();
	    MemberVO member = memberService.findByMemberId(memberId);
	    if (member == null) return "redirect:/tudio/login";
	    
	    session.setAttribute("loginUser", member);
	    int memberNo = member.getMemberNo();
	    
	    List<ProjectVO> myProjectList = approvalService.getMyProjectList(memberNo);
	    model.addAttribute("myProjectList", myProjectList);
	    
	    String userAuth = "";
	    if (member.getMemberAuthVOList() != null && !member.getMemberAuthVOList().isEmpty()) {
	        // 리스트의 0번째 자식 객체에서 auth 필드값을 꺼냄
	    	userAuth = member.getMemberAuthVOList().get(0).getAuth(); 
	    }

	    // 역할 조회
	    String projectRole = "";
	    if (projectNo > 0) {
	        projectRole = approvalService.getProjectRole(projectNo, memberNo);
	    }
	    model.addAttribute("projectRole", projectRole);

	    // 통계 조회
	    Map<String, Object> stats = approvalService.getApprovalStats(projectNo, memberNo, projectRole, userAuth);
	    model.addAttribute("stats", stats);

	    // 페이징 및 검색 조건 설정
	    ApprovalPaginationInfoVO<DraftDocumentVO> pagingVO = new ApprovalPaginationInfoVO<>();
	    pagingVO.setCurrentPage(currentPage);
	    pagingVO.setUserNo(memberNo);
	    pagingVO.setProjectNo(projectNo);
	    pagingVO.setProjectRole(projectRole); // 쿼리 분기용
	    pagingVO.setTabType(tabType);
	    pagingVO.setSearchType(searchType);
	    pagingVO.setSearchWord(searchWord);
	    pagingVO.setUserAuth(userAuth);
	    

	    // 데이터 개수 및 리스트 조회
	    int totalRecord = approvalService.getApprovalCount(pagingVO);
	    pagingVO.setTotalRecord(totalRecord);

	    List<DraftDocumentVO> approvalList = approvalService.getApprovalList(pagingVO);
	    pagingVO.setDataList(approvalList);

	    model.addAttribute("pagingVO", pagingVO);
	    model.addAttribute("projectNo", projectNo); // 페이지 이동 시 필요
	    model.addAttribute("menu", "approval");
	    model.addAttribute("userAuth", userAuth);
	    
	    
	    return "approval/list"; // 결재 리스트 JSP
	}
	
	/**
	 * 결재문서 작성 화면 
	 */
	@GetMapping("/form")
	public String approvalForm(@RequestParam(value="projectNo", defaultValue="0") int projectNo, 
	                           HttpSession session, Model model) {
		// 1. 세션에서 로그인 유저 정보 가져오기
	    MemberVO member = (MemberVO) session.getAttribute("loginUser");
	    
	    // 2. 로그인 체크 (가장 먼저 수행)
	    if (member == null) {
	        // 로그인이 안 되어 있으면 즉시 중단하고 로그인 페이지로 보냄
	        return "redirect:/login"; 
	    }
	    
	    // 3. 로그인된 유저라면 정보 추출
	    int memberNo = member.getMemberNo();
	    
	    // 4. 프로젝트 목록 및 권한 정보 가져오기
	    List<ProjectVO> myProjectList = approvalService.getMyProjectList(memberNo);
	    
	    String projectRole = "";
	    if (projectNo > 0) {
	        projectRole = approvalService.getProjectRole(projectNo, memberNo);
	    }

	    // 5. 화면(JSP)으로 보낼 데이터 담기
	    model.addAttribute("myProjectList", myProjectList);
	    model.addAttribute("projectNo", projectNo); 
	    model.addAttribute("projectRole", projectRole);
	    
	    // loginUser 객체 전체를 모델에 담으면 JSP에서 ${loginUser.memberName} 식으로 쓰기 편합니다.
	    model.addAttribute("loginUser", member); 

	    return "approval/form";
	}
	
	/**
	 * 결재 상신 (등록) 
	 */
	@ResponseBody
    @PostMapping("/insert")
    public String insertDraft(@RequestBody DraftDocumentVO draftVO, HttpSession session) {
	    
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
	    
	    if (loginUser == null) {
	        System.out.println("로그인 세션이 만료되어 상신 실패");
	        return "login_required"; 
	    }
	    
	    String department = loginUser.getMemberDepartment();
	    String position = loginUser.getMemberPosition();
	    String name = loginUser.getMemberName();
	    System.out.println("기안자 정보 확인: " + name + " (" + department + " / " + position + ")");
	    
	    draftVO.setMemberNo(loginUser.getMemberNo());

	    try {
	        int result = approvalService.insertDraft(draftVO);
	        return result > 0 ? "success" : "fail";
	    } catch (Exception e) {
	        System.err.println("결재 상신 중 시스템 에러: " + e.getMessage());
	        e.printStackTrace();
	        return "error";
	    }
    }

}