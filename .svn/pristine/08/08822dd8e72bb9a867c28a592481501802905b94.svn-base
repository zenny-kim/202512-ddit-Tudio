<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.functions" prefix="fn" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>${chatroomTitle.CHATROOM_NAME} 채팅방</title>
	<script src="https://unpkg.com/feather-icons"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
	
	<link rel="stylesheet" href="${pageContext.request.contextPath}/css/chat/chatroom.css">
</head>
<body>

<div class="chat-widget">
    <header class="chat-room-header">
        <div class="header-left">
            <button id="backBtn" class="header-btn" aria-label="뒤로 가기" 
                    data-tooltip="뒤로 가기" data-tooltip-pos="left">
                <i data-feather="chevron-left"></i>
            </button>
        </div>

        <h2 class="room-title">
            <span class="room-name-text">${chatroomTitle.CHATROOM_NAME}</span>
            <c:if test="${chatroomTitle.MEM_COUNT > 2}">
	            <span class="member-count">${chatroomTitle.MEM_COUNT }</span>
            </c:if>
        </h2>
        
        <div class="header-right">
            <button class="header-btn" aria-label="검색" data-tooltip="대화 검색">
                <i data-feather="search" style="width:20px; height:20px;"></i>
            </button>

            <button class="header-btn" aria-label="채팅방 설정" data-tooltip="설정">
                <i data-feather="settings" style="width:20px; height:20px;"></i>
            </button>
            
            <button class="header-btn" aria-label="닫기" 
                    data-tooltip="닫기" data-tooltip-pos="right">
                <i data-feather="x" style="width:22px; height:22px;"></i>
            </button>
        </div>
    </header>

    <main class="chat-room-content">

		<c:set var="lastChatNo" value=""/>
		<c:set var="preChatDate" value=""/>
		<c:set var="firstChatDate" value=""/>
	
		<c:forEach items="${chatList }" var="chat" varStatus="status">
			<!-- 날짜만 비교해주기 위해 날짜 형식으로 포맷 -->
			<fmt:formatDate value="${preChatDate }" var="fmtPreChatDate" pattern="yyyyMMdd"/>
			<fmt:formatDate value="${chat.createDate }" var="fmtCurChatDate" pattern="yyyyMMdd"/>
		
			<c:if test="${status.first }">
				<fmt:formatDate value="${chat.createDate }" var="firstChatDate" pattern="yyyyMMdd"/>
				<c:set var="lastChatNo" value="${chat.chatNo }"/>
			</c:if>
			<!-- 이전 채팅보다 현재 채팅의 날짜가 더 크다면 날짜 알림 출력 -->
			<c:if test="${!status.first and (fmtPreChatDate < fmtCurChatDate)}">
				<div class="system-message-container" >
		            <span class="system-message">
						<fmt:formatDate value="${chat.createDate }" pattern="yyyy년 MM월 dd일 E요일"/>
					</span>
		        </div>
			</c:if>
			<c:set var="preChatDate" value="${chat.createDate }"/>
		
			<c:choose>
				<c:when test="${chat.chatType eq 'SYSTEM'}">
					<div class="system-message-container" id="chat${chat.chatNo}">
			            <span class="system-message">${chat.message }</span>
			        </div>
				</c:when>
				<c:when test="${chat.memberNo eq myMemNo }">
			        <div class="message-row sent" id="chat${chat.chatNo}">
			            <div class="bubble-container">
			                <div class="sent-info">
			                	<c:if test="${chat.notReadCnt ne 0}">
				                    <span class="unread-count">${chat.notReadCnt }</span>
			                	</c:if>
			                    <span class="message-time">${chat.fmtCreateDate }</span>
			                </div>
			                <div class="message-bubble">
			                    ${chat.message }
			                </div>
			            </div>
			        </div>
				</c:when>
				<c:when test="${chat.memberNo ne myMemNo  }">
					<div class="message-row received" id="chat${chat.chatNo}">
			            <div class="avatar">${fn:substring(chat.memberName, 0,1) }</div>
			            <div class="message-content">
			                <span class="sender-name">${chat.memberName }</span>
			                <div class="bubble-container">
			                    <div class="message-bubble">
			                        ${chat.message }
			                    </div>
			                    <div class="received-info">
				                	<c:if test="${chat.notReadCnt ne 0}">
					                    <span class="unread-count">${chat.notReadCnt }</span>
				                	</c:if>
				                    <span class="message-time">${chat.fmtCreateDate }</span>
			                    </div>
			                </div>
			            </div>
			        </div>
				</c:when>
			</c:choose>
		</c:forEach>
    </main>

    <footer class="chat-input-area">
        <button class="footer-btn attach-btn" aria-label="파일 첨부" 
                data-tooltip="파일 첨부" data-tooltip-pos="left">
            <i data-feather="plus" width="24" height="24"></i>
        </button>

        <div class="input-wrapper">
            <textarea class="chat-input" placeholder="메시지 보내기" rows="1"></textarea>
        </div>

        <button class="footer-btn send-btn" aria-label="전송" 
                data-tooltip="전송" data-tooltip-pos="right">
            <i data-feather="send" width="18" height="18"></i>
        </button>
    </footer>
    
</div>

<script>
$(function(){
    feather.replace();
    
    // 스크롤을 맨 아래로 내려줌
    const chatContent = document.querySelector('.chat-room-content');
    chatContent.scrollTop = chatContent.scrollHeight;

    const textarea = document.querySelector('.chat-input');
    
    // textarea 디자인적 설정 함수
    function adjustHeight() {
        textarea.style.height = 'auto'; 
        textarea.style.height = textarea.scrollHeight + 'px'; 
        chatContent.scrollTop = chatContent.scrollHeight; 
    }

    textarea.addEventListener('input', adjustHeight);

    // TODO: 웹소켓 연결 후 수정 필요
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            console.log("전송:", this.value);
            this.value = '';
            this.style.height = '44px'; 
        }
    });
    
    adjustHeight();
    
    //////////////////////////////////////////////////////////////
    
    // 뒤로가기 버튼 클릭 시
    $("#backBtn").on("click", function(){
        location.href = "/tudio/chat/list";
    })
    
    // 서버에서 데이터를 가져오는 중인지 판별
    let isLoading = false;
    
    // url 주소에서 채팅방 번호를 꺼내옴
    let urlArray = window.location.pathname.split("/");
    let chatroomNo = urlArray[urlArray.length-1];
    let lastChatNo = ${lastChatNo};
    
    // 이미 생성되어있는 div의 첫 채팅 날짜
	let bottomFirstChatDate = "${firstChatDate}";
	// ajax 요청을 통해 생성된 div의 첫 채팅 날짜
	let firstChatDate = "";
	   					
    // 사용자의 스크롤 이벤트 감지
    $('.chat-room-content').on('scroll', function(){
    	if(isLoading) return;
    	
	    let chatContent = $(this); 
    	let currentScrollTop = chatContent.scrollTop();
    	let viewHeight = chatContent.innerHeight();
    	let oldScrollHeight = chatContent.prop("scrollHeight");
    	
    	// 사용자가 스크롤 맨 위로 도달하기까지 얼마 안남았다면 실행됨
    	if(currentScrollTop <= viewHeight){
	   		isLoading = true;
	   		
	   		// 이전 채팅을 불러오기 위해 요청 보냄
	   		$.ajax({
	   			url: "/tudio/chat/chatroom/oldchat",
	   			type: "get",
	   			contentType : "application/json;charset=utf-8",
	   			data: {
	   				chatroomNo : chatroomNo, 
	   				chatNo : lastChatNo
				},
	   			success: function(result){
	   				
	   				let chatHtml = "";
	   				// forEach에서 현재 index의 바로 직전 ChatDate
   					let preChatDate = "";
	   				
	   				// 기존 채팅방 화면에 불러온 채팅 메세지 목록 붙여주기
	   				result.forEach(function(chat, index){
	   					console.log(index)
	   					if(index == 0){
	   						lastChatNo = chat.chatNo;
	   					}
	   					
	   					// 동일한 메세지가 있는지 확인 
	   					// (이미 출력한 메세지를 다시 출력하는 불상사를 막기위해)
	   					let idChatNo = "#chat"+chat.chatNo;
	   					if($(idChatNo).length == 0){
	   						
	   						// 날짜 비교를 위해 moment 라이브러리를 사용하여 변수 생성
	   						let mmtPreChatDate = parseInt(moment(preChatDate).format("YYYYMMDD"));
	   						let mmtCurChatDate = parseInt(moment(chat.createDate).format("YYYYMMDD"));
	   						let day = ["일", "월", "화", "수", "목", "금", "토"];
	   						
   							// 다음 ajax 요청 실행시, 마지막 채팅과의 날짜 비교를 위해 값 저장
   							if(index == 0){
   								firstChatDate = chat.createDate;
   								mmtPreChatDate = 99999999;
   							}
   							
	   						// 현재 채팅의 날짜가 이전 채팅 날짜 값보다 크다면 실행
	   						// (날짜가 다음날로 변경된 것이므로)
	   						if(mmtCurChatDate > mmtPreChatDate){
	   							let fmtCurChatDate = moment(chat.createDate).format("YYYY년 MM월 DD일 ");
	   							fmtCurChatDate += day[moment(chat.createDate).day()] +"요일";

	   							chatHtml += `
	   								<div class="system-message-container">
		   					            <span class="system-message">
		   					        		\${fmtCurChatDate}
		   								</span>
		   					        </div>
	   							`;
	   						}
	   						preChatDate = chat.createDate;
	   						
		   					// 채팅 타입이 system이라면
		   					if(chat.chatType == "SYSTEM"){
		   						chatHtml += `
	   								<div class="system-message-container" id="chat\${chat.chatNo}">
		   					            <span class="system-message">\${chat.message }</span>
		   					        </div>
	  								`;
		   					}else if(chat.memberNo == ${myMemNo}){	// 본인이 작성한 메세지라면
		   						console.log(index, "나의 메세지가 붙어요", chat.message);
		   						chatHtml += `
	   								<div class="message-row sent" id="chat\${chat.chatNo}">
		   					            <div class="bubble-container">
		   					                <div class="sent-info">
				                `;
		   						if(chat.notReadCnt != 0){ // 해당 채팅을 안읽은 사람이 없다면
		   							chatHtml += `<span class="unread-count">\${chat.notReadCnt }</span>`;
		   						}
		   						chatHtml += `
		   					                    <span class="message-time">\${chat.fmtCreateDate }</span>
		   					                </div>
		   					                <div class="message-bubble">
		   					                    \${chat.message }
		   					                </div>
		   					            </div>
		   					        </div>
	  								`;
		   					}else if(chat.memberNo != ${myMemNo}){	// 타인이 작성한 메세지라면
		   						console.log(index, "상대방의 메세지가 붙어요", chat.message);
		   						chatHtml += `
	   								<div class="message-row received" id="chat\${chat.chatNo}">
		   					            <div class="avatar">수정해</div>
		   					            <div class="message-content">
		   					                <span class="sender-name">\${chat.memberName }</span>
		   					                <div class="bubble-container">
		   					                    <div class="message-bubble">
		   					                        \${chat.message }
		   					                    </div>
		   					                    <div class="received-info">
			                    `;
		   						if(chat.notReadCnt != 0){
		   							chatHtml += `<span class="unread-count">\${chat.notReadCnt }</span>`;
		   						}
		   						chatHtml += `
		   						                    <span class="message-time">\${chat.fmtCreateDate }</span>
		   					                    </div>
		   					                </div>
		   					            </div>
		   					        </div>
		   						`;		
		   					} // 타인 작성 검사 if문

	   						if(index == result.length-1){
		   						let mmtBottomFirstChatDate = parseInt(moment(bottomFirstChatDate).format("YYYYMMDD"));
		   						console.log("mmtBottomFirstChatDate", mmtBottomFirstChatDate);
		   						
		   						if(mmtCurChatDate < mmtBottomFirstChatDate){
		   							let fmtBottomFirstChatDate = moment(bottomFirstChatDate).format("YYYY년 MM월 DD일 ");
		   							fmtBottomFirstChatDate += day[moment(bottomFirstChatDate).day()] +"요일"; 
			   						console.log("fmtBottomFirstChatDate", fmtBottomFirstChatDate);
		   							
		   							chatHtml += `
		   								<div class="system-message-container" >
			   					            <span class="system-message">
			   					        		\${fmtBottomFirstChatDate}
			   								</span>
			   					        </div>
		   							`;
		   						}
		   						
		   						bottomFirstChatDate = firstChatDate;
	   						}
	   					} // 기존에 없는 채팅인지 확인 if문
	   				}) // forEach
	   				
	   				// 불러온 메세지들을 기존 메세지의 앞에 붙여줌
	   				chatContent.prepend(chatHtml);
	   				
	   				let newScrollHeight = chatContent.prop("scrollHeight");
	   				
	   				// 사용자의 스크롤이 이전과 같은 위치에 있도록 조정(없으면 최상단으로 이동됨)
	   				chatContent.scrollTop((newScrollHeight-oldScrollHeight) + currentScrollTop);

	   				console.log("작업완료. ")
	   				
	   				isLoading = false;
	   			},
	   			error: function(error, status, thrown){
	   				console.log("error : " + error.status);
	   			}
	   			
	   		}) // ajax
    	} // 스크롤 상단 도착 직전 확인 if문
    }) // scroll 이벤트
})
</script>
</body>
</html>