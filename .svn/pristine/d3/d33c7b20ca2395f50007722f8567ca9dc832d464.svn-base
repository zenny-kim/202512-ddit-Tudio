<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>

	<link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css" />
	<link rel="stylesheet" href="${pageContext.request.contextPath}/css/task_list.css">   

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
 
<div class="tab-content-card">
    <div class="tudio-section-header mb-4">
        <h5 class="mb-0 text-primary-dark fw-bold" id="taskViewTitle">ì—…ë¬´ ëª©ë¡ (ë¦¬ìŠ¤íŠ¸)</h5>
        <div class="d-flex gap-2">
            <button class="tudio-btn tudio-btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                <i class="bi bi-plus"></i> ìƒˆ ì—…ë¬´ ì¶”ê°€
            </button>
            <button class="tudio-btn" id="toggleViewButton" style="border: 1px solid var(--tudio-border-soft);">
                <i class="bi bi-list me-1"></i> ì¹¸ë°˜ ë³´ê¸°
            </button>
        </div>
    </div>
   
    <div id="listView">
        <div class="d-flex justify-content-end mb-3 px-3">
            <div class="tudio-search-wrap">
                <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                <button class="border-0 bg-transparent" aria-label="search">ğŸ”</button>
            </div>
        </div>
        <div class="tudio-table-wrap">
            <table class="tudio-table-card">
                <thead>
                    <tr>
                        <th>ì—…ë¬´ëª…</th>
                        <th>ìƒíƒœ</th>
                        <th>ë‹´ë‹¹ì</th>
                        <th>ì‹œì‘ì¼</th>
                        <th>ë§ˆê°ì¼</th>
                        <th>ì¤‘ìš”ë„</th>
                        <th>ì§„ì²™ë„</th>
                        <th>ì‘ì„±ì</th>
                    </tr>
                </thead>
                <tbody>
                    <c:forEach items="${taskList}" var="task">
                    	<!-- ìƒìœ„ì—…ë¬´ -->
                        <tr class="task-row" 
                        	data-task-id="${task.taskId}"
                        	style="cursor:pointer;">
                            <td class="fw-bold">
	                        	<!-- ìƒìœ„ì—…ë¬´ ì•„ì½”ë””ì–¸ ì•„ì´ì½˜ -->
	                        	<i class="bi bi-caret-right-fill toggle-icon me-1"></i>
                            	${task.taskTitle}
                            </td>
                            <td><span class="tudio-badge free">${task.statusLabel }</span></td>
                            
                            <!-- ìƒìœ„ì—…ë¬´ ë‹´ë‹¹ì -->
                            <td>
                            	<c:set value="${task.taskManagers }" var="taskManager"/>
                            	<c:choose>
                            		<c:when test="${empty taskManager }">
                            			<span>-</span>
                            		</c:when>
                            		<c:when test="${fn:length(taskManager) > 1 }">
					                    <span>${taskManager[0].memberName } + ${fn:length(taskManager) -1 }</span>
                            		</c:when>
                            		<c:otherwise>
					                    <span>${taskManager[0].memberName }</span>
                            		</c:otherwise>
                            	</c:choose>
		                    </td>
                            <td class="text-muted">
                            	<fmt:formatDate value="${task.taskStartdate }" pattern="yyyy-MM-dd"/>
                            </td>
                            <td class="text-muted">
                            	<fmt:formatDate value="${task.taskEnddate }" pattern="yyyy-MM-dd"/>
                            </td>
                            <td><span class="tudio-badge notice">${task.priorityLabel }</span></td>
                            <td>
                                <div class="progress" style="height: 6px; width: 80px;">
                                    <div class="progress-bar bg-primary" style="width: 50%;"></div>
                                </div>
                                ${task.taskRate }%
                            </td>
                            <td><small class="text-muted">${task.writerName }</small></td>
                        </tr>
                        
                        <!-- í•˜ìœ„ì—…ë¬´ -->
                        <c:forEach items="${task.subTasks }" var="sub">
                        	<tr class="sub-row" 
                        		data-parent-task-id="${sub.taskId}"
                        		data-sub-id="${sub.subId }"
                        		style="display:none; background:#fafafa;">
                        		<td class="ps-4">${sub.subTitle}</td>
	                            <td><span class="tudio-badge free">${sub.statusLabel }</span></td>
	                            
	                            <!-- í•˜ìœ„ì—…ë¬´ ë‹´ë‹¹ì -->
	                            <td>
	                            	<c:set value="${sub.subManagers }" var="subManager"/>
	                            	<c:choose>
	                            		<c:when test="${empty subManager }">
	                            			<span>-</span>
	                            		</c:when>
	                            		<c:when test="${fn:length(subManager) > 1 }">
						                    <span>${subManager[0].memberName } + ${fn:length(subManager) -1 }</span>
	                            		</c:when>
	                            		<c:otherwise>
						                    <span>${subManager[0].memberName }</span>
	                            		</c:otherwise>
	                            	</c:choose>
			                    </td>
	                            <td class="text-muted">
	                            	<fmt:formatDate value="${sub.subStartdate }" pattern="yyyy-MM-dd"/>
	                            </td>
	                            <td class="text-muted">
	                            	<fmt:formatDate value="${sub.subEnddate }" pattern="yyyy-MM-dd"/>
	                            </td>
	                            <td><span class="tudio-badge notice">${sub.priorityLabel }</span></td>
	                            <td>
	                                <div class="progress" style="height: 6px; width: 80px;">
	                                    <div class="progress-bar bg-primary" style="width: 50%;"></div>
	                                </div>
	                                ${sub.subRate }%
	                            </td>
	                            <td><small class="text-muted">${sub.writerName }</small></td>
                        	</tr>
                        </c:forEach>
                        
                        <!-- í•˜ìœ„ì—…ë¬´ ì¶”ê°€ ë²„íŠ¼ -->
                        <tr class="sub-add-row"
					        data-parent-task-id="${task.taskId}"
					        style="display:none; background:#f0f0f0;">
					        <td colspan="8" class="ps-4">
					            <button class="btn btn-sm btn-outline-primary add-sub-btn"
					                    data-task-id="${task.taskId}">
					                + í•˜ìœ„ì—…ë¬´ ì¶”ê°€
					            </button>
					        </td>
					    </tr>
                        
                    </c:forEach>
                </tbody>
            </table>
        </div>
    </div> 
    <div id="kanbanView" class="d-flex gap-3 pb-2 d-none" style="min-height: 500px; overflow-x: auto;"> 
        <div class="flex-shrink-0" style="width: 300px; background: var(--tudio-surface-soft); padding: 15px; border-radius: 12px;">
            <h6 class="text-dark fw-bold border-bottom pb-2 mb-3">
                TO DO (í•  ì¼) <span class="badge bg-secondary rounded-pill small">2</span>
            </h6>
           
            <div class="kanban-items-list tudio-list" id="todo-list" data-status="todo">
                <div class="tudio-item" role="button" data-bs-toggle="modal" data-bs-target="#taskDetailModal"> 
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">TUDIO-001</small>
                        <i class="bi bi-three-dots-vertical text-muted"></i>
                    </div>
                    <p class="tudio-item-title mb-2">í”„ë¡ íŠ¸ì—”ë“œ ê¸°ë³¸ êµ¬ì¡° ì„¤ê³„</p>
                   
                    <div class="summary-progress-wrapper mb-2">
                        <div class="summary-progress-bar" style="width: 60%;"></div>
                    </div>
                   
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="tudio-badge notice">Critical</span>
                        <div class="text-end" style="font-size: 11px;">
                            <span class="d-block text-muted">ë§ˆê°: 12/20</span>
                            <span class="fw-bold">ë‹´ë‹¹: K</span>
                        </div>
                    </div>
                </div>
         </div>
      </div>
   </div>
</div> 

<script>
// ------------------ ì€íœ´ë‹˜ì´ ì‘ì„±í•´ ì£¼ì‹  ì½”ë“œ START -------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        // ì¹¸ë°˜ ë“œë˜ê·¸ì•¤ë“œë¡­
        const kanbanColumns = document.querySelectorAll('.kanban-items-list');
        kanbanColumns.forEach(column => {
            new Sortable(column, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag'
            });
        });

        // ë·° ì „í™˜
        const toggleBtn = document.getElementById('toggleViewButton');
        const listDiv = document.getElementById('listView');
        const kanbanDiv = document.getElementById('kanbanView');
        const title = document.getElementById('taskViewTitle');
        
        if (toggleBtn) {
        	toggleBtn.addEventListener('click', function () {
        	    if (!kanbanDiv.classList.contains('d-none')) {
        	        // í˜„ì¬: ì¹¸ë°˜ â†’ ë¦¬ìŠ¤íŠ¸
        	        kanbanDiv.classList.add('d-none');
        	        listDiv.classList.remove('d-none');
        	        title.textContent = 'ì—…ë¬´ ëª©ë¡ (ë¦¬ìŠ¤íŠ¸)';
        	        this.innerHTML = '<i class="bi bi-grid-fill me-1"></i> ì¹¸ë°˜ ë³´ê¸°';
        	    } else {
        	        // í˜„ì¬: ë¦¬ìŠ¤íŠ¸ â†’ ì¹¸ë°˜
        	        listDiv.classList.add('d-none');
        	        kanbanDiv.classList.remove('d-none');
        	        title.textContent = 'ì—…ë¬´ ëª©ë¡ (ì¹¸ë°˜)';
        	        this.innerHTML = '<i class="bi bi-list me-1"></i> ë¦¬ìŠ¤íŠ¸ ë³´ê¸°';
        	    }
        	});
        }
    });
// ------------------ ì€íœ´ë‹˜ì´ ì‘ì„±í•´ ì£¼ì‹  ì½”ë“œ END -------------------------------

document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.task-row').forEach(taskRow => {
        
    	// sub-row ìì²´ê°€ DOMì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    	const allSubRows = document.querySelectorAll('.sub-row');
        console.log('ì „ì²´ sub-row ê°œìˆ˜:', allSubRows.length);
        
        // ìƒìœ„ì—…ë¬´ í´ë¦­ ì´ë²¤íŠ¸
    	taskRow.addEventListener('click', function () {

            const taskId = this.dataset.taskId;
            console.log("í´ë¦­í•œ taskId:",taskId);
            
            const selector =
            	'.sub-row[data-parent-task-id="' + taskId + '"],' +
            	  '.sub-add-row[data-parent-task-id="' + taskId + '"]';
            
            console.log('ì‚¬ìš©ëœ selector:', selector);
            
            const subs = document.querySelectorAll(selector);
            console.log('í•´ë‹¹ taskIdì˜ sub-row ê°œìˆ˜:', subs.length);

            // í† ê¸€ ì²˜ë¦¬
            const icon = this.querySelector('.toggle-icon');
            const isOpen = subs.length > 0 && subs[0].style.display !== 'none';

            subs.forEach(row => {
                row.style.display = isOpen ? 'none' : 'table-row';
            });

            // ì•„ì´ì½˜ ë°©í–¥ ì „í™˜
            if (icon) {
                icon.classList.toggle('bi-caret-right-fill', isOpen);
                icon.classList.toggle('bi-caret-down-fill', !isOpen);
            }
        });
    });

    // í•˜ìœ„ì—…ë¬´ ì¶”ê°€ ë²„íŠ¼
    document.querySelectorAll('.add-sub-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.stopPropagation(); // ìƒìœ„ì—…ë¬´ í† ê¸€ ë°©ì§€
            const taskId = this.dataset.taskId;
            console.log("taskId",taskId);
            location.href = `/project/task/sub/create.do?taskId=${taskId}`;
        });
    });
});

</script>