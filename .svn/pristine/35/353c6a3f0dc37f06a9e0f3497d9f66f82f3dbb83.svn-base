package kr.or.ddit.notification.service.impl;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronization;
import org.springframework.transaction.support.TransactionSynchronizationManager;

import kr.or.ddit.common.WidgetType;
import kr.or.ddit.dashboard.service.IWidgetUpdateService;
import kr.or.ddit.notification.handler.NotificationHandler;
import kr.or.ddit.notification.mapper.INotificationMapper;
import kr.or.ddit.notification.service.INotificationService;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.NotificationSettingVO;
import kr.or.ddit.vo.NotificationVO;
import kr.or.ddit.vo.project.ProjectBoardVO;
import lombok.extern.slf4j.Slf4j;

/**
 * 컨트롤러에서 호출하는 알림 조회/읽음 처리/삭제를 처리한다.
 * 알림은 DB에 쌓는 데이터이고, 웹소켓은 "실시간 갱신"을 위한 옵션이다.
 */
@Slf4j
@Service
public class NotificationServiceImpl implements INotificationService {

    // 위젯 갱신
    @Autowired
    private IWidgetUpdateService widgetUpdateService;

    @Autowired
    private INotificationMapper notiMapper;

    @Autowired
    private NotificationHandler notiHandler;

    /**
     * 프로젝트 초대
     *
     * @param vo
     * @return
     */
    @Transactional
    public int insertProjectInviteNoti(NotificationVO vo) {
        int cnt = 0;

        String auth = selectAuthNoti(vo.getMemberNo());
        if (!"ROLE_ADMIN".equalsIgnoreCase(auth)) {
            cnt = notiMapper.insertNoti(vo);

            TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    int unread = notiMapper.selectUnreadCount(vo.getMemberNo());

                    Map<String, Object> notiPayload = new HashMap<>();
                    notiPayload.put("type", "NOTI_NEW");
                    notiPayload.put("unreadCount", unread);
                    notiPayload.put("noti", vo);

                    // 대상이 1명이라.. 효비님이 반복문 돌려주셔서 1ㄷ1로 쓰면 되니까
                    notiPayload.put("notiCategory", "프로젝트");

                    notiHandler.sendToMember(vo.getMemberNo(), notiPayload);
                }
            });
        }

        return cnt;
    }

    /*
     * 부모 댓글 작성자, 게시글 작성자 조회
     */
    @Override
    public Map<String, Object> selectNotiReply(Map<String, Object> map) {
        return notiMapper.selectNotiReply(map);
    }

    /**
     * 프로젝트 변경시 멤버 푸시 대상 목록 조회 (설정없음)
     */
    @Override
    public List<Integer> selectProjectUpdateNoti(Map<String, Object> param) {
        return notiMapper.selectProjectUpdateNoti(param);
    }

    /**
     * 프로젝트 변경시 푸쉬 대상을 DB 일괄 insert
     */
    @Override
    public int insertProjectUpdateNoti(NotificationVO vo) {
        return notiMapper.insertProjectUpdateNoti(vo);
    }

    /**
     * 프로젝트 변경 알림
     *
     * @param vo(notiType,targetId,notiUrl,notiMessage,notiCategory,projectNo,writerNo)
     * @param projectNo
     * @param writerNo
     */
    @Transactional
    public void pushProjectUpdateNoti(NotificationVO vo, int projectNo, int writerNo) {

        // 1) 푸시 대상 미리 조회
        Map<String, Object> p = new HashMap<>();
        p.put("projectNo", projectNo);
        p.put("writerNo", writerNo);

        List<Integer> targets = notiMapper.selectProjectUpdateNoti(p);

        // 2) DB 일괄 INSERT
        notiMapper.insertProjectUpdateNoti(vo);

        // 3) 커밋 후 푸시
        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                for (int memberNo : targets) {
                    int unread = notiMapper.selectUnreadCount(memberNo);

                    Map<String, Object> payload = new HashMap<>();
                    payload.put("type", "NOTI_NEW");
                    payload.put("unreadCount", unread);

                    // 프론트에서 리스트 다시 당겨오게 하는 방식이면 이것만 있어도 됨
                    notiHandler.sendToMember(memberNo, payload);

                    // 위젯 갱신
                    widgetUpdateService.sendWidgetUpdate(vo.getMemberNo(), WidgetType.ALARM);
                }
            }
        });
    }

    /**
     * 사이트 공지사항 알림 발송
     *
     * @return
     */
    @Transactional
    @Override
    public void pushSiteNotice(int targetId, String notiUrl, String notiMessage) {

        // db에 공지 알림이 y인 회원들에게 일괄 insert
        Map<String, Object> p = new HashMap<>();
        p.put("targetId", targetId);
        p.put("notiUrl", notiUrl);
        p.put("notiMessage", notiMessage);
        p.put("notiCategory", "공지사항");

        notiMapper.insertSiteNoticeNoti(p);

        // 푸시 대상 목록 미리 조회
        List<MemberVO> targets = notiMapper.notiSiteMember();

        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                for (MemberVO m : targets) {
                    int memberNo = m.getMemberNo();
                    int unread = notiMapper.selectUnreadCount(memberNo);

                    Map<String, Object> payload = new HashMap<>();
                    payload.put("type", "NOTI_NEW");
                    payload.put("unreadCount", unread);
                    payload.put("notiCategory", "공지사항");

                    // 즉시 렌더링 정보
                    Map<String, Object> noti = new HashMap<>();
                    noti.put("notiType", "NOTI_SYSTEM");

                    notiHandler.sendToMember(memberNo, payload);

                    // 위젯 갱신
                    widgetUpdateService.sendWidgetUpdate(memberNo, WidgetType.ALARM);
                }
            }
        });
    }

    /**
     * 알림 목록 조회 (전체 / 안읽음만)
     *
     * @param memberNo
     * @param unreadOnly
     * @return 알림 리스트
     */
    @Override
    public List<NotificationVO> notiList(int memberNo, boolean unreadOnly) {
        Map<String, Object> notiParam = new HashMap<>();
        notiParam.put("memberNo", memberNo);
        notiParam.put("unreadOnly", unreadOnly);

        return notiMapper.notiList(notiParam);
    }

    /**
     * 안읽은 알림 개수
     *
     * @param memberNo
     * @return
     */
    @Override
    public int notiUnreadCount(int memberNo) {
        return notiMapper.selectUnreadCount(memberNo);
    }

    /**
     * 특정 알림 1건 읽음 처리
     *
     * @param memberNo
     * @param notiNo
     */
    @Override
    public void notiMarkRead(int memberNo, long notiNo) {
        Map<String, Object> notiMarkReadParam = new HashMap<>();
        notiMarkReadParam.put("memberNo", memberNo);
        notiMarkReadParam.put("notiNo", notiNo);

        notiMapper.updateRead(notiMarkReadParam);

        // 위젯 갱신
        widgetUpdateService.sendWidgetUpdate(memberNo, WidgetType.ALARM);
    }

    /**
     * 특정 알림 삭제(물리)
     *
     * @param memberNo
     * @param notiNo
     */
    @Override
    public void notiDelete(int memberNo, long notiNo) {
        Map<String, Object> notiDeleteParam = new HashMap<>();
        notiDeleteParam.put("memberNo", memberNo);
        notiDeleteParam.put("notiNo", notiNo);

        int result = notiMapper.deleteNoti(notiDeleteParam);
        if (result > 0) {
            widgetUpdateService.sendWidgetUpdate(memberNo, WidgetType.ALARM);
        }
    }

    /**
     * 내가 쓴 게시글에 댓글이 달렸을 때 알림
     *
     * @param boNo
     * @return
     */
    @Override
    public ProjectBoardVO notiCommentNoti(int boNo) {
        return notiMapper.notiCommentNoti(boNo);
    }

    /**
     * 회원의 알림 설정 조회
     */
    @Override
    public NotificationSettingVO notiAllMember(int memberNo) {
        return notiMapper.notiAllMember(memberNo);
    }

    /**
     * 대시보드 알림 위젯 상태 변경
     */
    @Override
    public void toggleNotificationRead(int memberNo, long notiNo) {
        Map<String, Object> params = new HashMap<>();
        params.put("memberNo", memberNo);
        params.put("notiNo", notiNo);

        int result = notiMapper.toggleNotificationRead(params);
        if (result > 0) {
            widgetUpdateService.sendWidgetUpdate(memberNo, WidgetType.ALARM);
        }
        return;
    }

  
    /**
     * 커뮤니티 공지사항 발송
     */
    @Transactional
    public void pushProjectNotice(NotificationVO vo, Map<String, Object> map) {

    	
    	 String auth = selectAuthNoti(vo.getMemberNo());
    	 if (!"ROLE_ADMIN".equalsIgnoreCase(auth) && !"ROLE_CLIENT".equalsIgnoreCase(auth)) {
        // 알림 DB 저장 대상 조회
        List<Integer> notiList = notiMapper.selectProjectNoticeNoti(vo);


        map.put("projectNo", vo.getProjectNo());
        map.put("writerNo", vo.getWriterNo());

        // DB에 대상 저장
        notiMapper.insertProjectNoticeNoti(map);

        TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                for (Integer i : notiList) {
                    int memberNo = i;
                    int unread = notiMapper.selectUnreadCount(memberNo);

                    Map<String, Object> payload = new HashMap<>();
                    payload.put("type", "NOTI_NEW");
                    payload.put("unreadCount", unread);

                    notiHandler.sendToMember(memberNo, payload);
                }
            }
        });
        
    	 }
    }
    
    
    /**
     * 프로젝트 공지사항 알림 insert
     */
    @Override
    public void insertProjectNoticeNoti(Map<String, Object> map) {
        notiMapper.insertProjectNoticeNoti(map);
    }

    /**
     * 프로젝트 공지사항
     *
     * @Transactional
     * public void pushProjectNotice(int projectNo, int writerNo,
     *     String notiCategory, int targetId, String notiUrl,
     *     String notiType, String notiMessage) {
     *
     *     Map<String, Object> notiMap = new HashMap<>();
     *     notiMap.put("projectNo", projectNo);
     *     notiMap.put("targetId", targetId);
     *     notiMap.put("notiUrl", notiUrl);
     *     notiMap.put("notiMessage", notiMessage);
     *     notiMap.put("writerNo", writerNo);
     *     notiMap.put("notiCategory", notiCategory);
     *
     *     // 푸쉬 대상 미리 조회하기. notiAllMember는 특정 1명을 뽑는 거임. 그래서 따로 쿼리가 필요하다
     *     List<Integer> notiMemList = notiMapper.selectProjectNoticeNoti(projectNo, writerNo);
     *
     *     log.info("notiMemList~~~ {}", notiMemList);
     *
     *     // DB에 일괄 INSERT... DB에 “누가 들어갔는지”와 “누구에게 푸시를 보낼지”는 별개
     *     notiMapper.insertProjectNoticeNoti(notiMap);
     *
     *     TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
     *         @Override
     *         public void afterCommit() {
     *             for (int memberNo : notiMemList) {
     *                 int unread = notiMapper.selectUnreadCount(memberNo);
     *
     *                 Map<String, Object> payload = new HashMap<>();
     *                 payload.put("type", "NOTI_NEW");
     *                 payload.put("unreadCount", unread);
     *                 payload.put("notiType", "NOTI_SYSTEM");
     *
     *                 notiHandler.sendToMember(memberNo, payload);
     *             }
     *         }
     *     });
     * }
     *
     * // 위젯 갱신
     * widgetUpdateService.sendWidgetUpdate(memberNo, WidgetType.ALARM);
     */

    /**
     * 사이트 공지사항 DB 저장
     */
    /*
     * public void insertSiteNoticeNoti(String notiUrl, int noticeNo,
     *     String notiMessage, String notiCategory) {
     *
     *     Map<String, Object> notiParam = new HashMap<>();
     *     notiParam.put("notiUrl", notiUrl);
     *     notiParam.put("targetId", noticeNo);
     *     notiParam.put("notiCategory", "공지사항");
     *     notiParam.put("notiMessage", "...");
     *
     *     notiMapper.insertSiteNoticeNoti(notiParam);
     * }
     */

    @Override
    public List<NotificationVO> notiListByTab(int memberNo, String tab) {
        boolean unreadOnly = "unread".equalsIgnoreCase(tab);
        boolean readOnly = "read".equalsIgnoreCase(tab);

        Map<String, Object> notiParam = new HashMap<>();
        notiParam.put("memberNo", memberNo);
        notiParam.put("unreadOnly", unreadOnly);
        notiParam.put("readOnly", readOnly);

        return notiMapper.notiList(notiParam);
    }
    
    /**
     * Db에 알림 저장 + 푸쉬 (개인)
     *
     * @param vo memberNo, notiType,targetId,notiUrl,notiMessage,notiCategory
     * @return
     */
    @Transactional
    public int insertNotification(NotificationVO vo) {
        int cnt = 0;

        String auth = selectAuthNoti(vo.getMemberNo());
        if (!"ROLE_ADMIN".equalsIgnoreCase(auth) && !"ROLE_CLIENT".equalsIgnoreCase(auth)) {
            cnt = notiMapper.insertNoti(vo);

            TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    int unread = notiMapper.selectUnreadCount(vo.getMemberNo());

                    Map<String, Object> notiPayload = new HashMap<>();
                    notiPayload.put("type", "NOTI_NEW");
                    notiPayload.put("unreadCount", unread);
                    notiPayload.put("noti", vo);
                    notiPayload.put("notiCategory", vo.getNotiCategory());

                    notiHandler.sendToMember(vo.getMemberNo(), notiPayload);

                    // 위젯 갱신
                    widgetUpdateService.sendWidgetUpdate(vo.getMemberNo(), WidgetType.ALARM);
                }
            });
        }

        return cnt;
    }

    /**
     * 설정이 ON일 때만 알림 저장
     *
     * @param vo
     * @param settingKey
     * @return insert 결과
     */
    public int insertNotiEnabled(NotificationVO vo, String settingKey) {
        Map<String, Object> insertNotiEnabledParam = new HashMap<>();
        insertNotiEnabledParam.put("vo", vo);
        insertNotiEnabledParam.put("settingKey", settingKey);

        return notiMapper.insertNotiEnabled(insertNotiEnabledParam);
    }

    
    

    /**
     * 공지사항 on한 멤버
     */
    @Override
    public List<MemberVO> notiSiteMember() {
        return notiMapper.notiSiteMember();
    }

    @Override
    public void insertSiteNoticeNoti(NotificationVO vo) {
        // TODO Auto-generated method stub
    }

    /**
     * 권한 설정 정보
     */
    @Override
    public String selectAuthNoti(int memberNo) {
        return notiMapper.selectAuthNoti(memberNo);
    }



	@Override
	public List<Integer> selectProjectNoticeNoti(int projectNo, int writerNo) {
		// TODO Auto-generated method stub
		return null;
	}


    
    
}
