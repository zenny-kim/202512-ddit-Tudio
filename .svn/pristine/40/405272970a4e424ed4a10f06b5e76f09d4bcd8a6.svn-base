<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.approval.mapper.IApprovalMapper">

	<!-- 결재 목록 리스트 조회 -->
	<select id="getApprovalList" parameterType="kr.or.ddit.vo.ApprovalPaginationInfoVO" resultType="kr.or.ddit.vo.DraftDocumentVO">
	    SELECT 
		    DOCUMENT_NO, PROJECT_NO, MEMBER_NO, DOCUMENT_TYPE, 
	        DOCUMENT_STATUS, DOCUMENT_TITLE, DOCUMENT_REGDATE, 
	        DOCUMENT_APPROVALDATE, DRAFTER_NAME, PROJECT_NAME 
		FROM (
	        SELECT 
	            A.*, ROWNUM RNUM 
	        FROM (
	            SELECT 
	                D.DOCUMENT_NO,
	                D.PROJECT_NO,
	                D.MEMBER_NO,
	                D.DOCUMENT_TYPE,
	                D.DOCUMENT_STATUS,
	                D.DOCUMENT_TITLE,
	                TO_CHAR(D.DOCUMENT_REGDATE, 'YYYY-MM-DD') AS DOCUMENT_REGDATE, 
            		TO_CHAR(D.DOCUMENT_APPROVALDATE, 'YYYY-MM-DD') AS DOCUMENT_APPROVALDATE,
	                M.MEMBER_NAME AS DRAFTER_NAME, -- 기안자 이름
	                P.PROJECT_NAME
	            FROM DRAFT_DOCUMENT D
	            JOIN MEMBER M ON D.MEMBER_NO = M.MEMBER_NO
	            JOIN PROJECT P ON D.PROJECT_NO = P.PROJECT_NO
	            <where>
	                AND D.PROJECT_NO = #{projectNo}
	                
	                <choose>
	                    <when test="projectRole == 'MANAGER' or projectRole == 'MEMBER'">
	                        AND D.MEMBER_NO = #{userNo}
	                        <if test="tabType == 'TEMP'"> AND D.DOCUMENT_STATUS = 616 </if>
	                        <if test="tabType == 'REJECT'"> AND D.DOCUMENT_STATUS = 614 </if>
	                        <if test="tabType == 'COMPLETE'"> AND D.DOCUMENT_STATUS = 613 </if>
	                        <if test="tabType == 'PROGRESS'"> AND D.DOCUMENT_STATUS = 612 </if>
	                    </when>
	                    
	                    <when test="projectRole == 'CLIENT'">
	                        AND D.DOCUMENT_NO IN (
	                            SELECT DOCUMENT_NO FROM DRAFT_APPROVAL WHERE MEMBER_NO = #{userNo}
	                        )
	                        <if test="tabType == 'WAIT'"> AND D.DOCUMENT_STATUS = 611 </if>
	                        <if test="tabType == 'REJECT'"> AND D.DOCUMENT_STATUS = 614 </if>
	                        <if test="tabType == 'COMPLETE'"> AND D.DOCUMENT_STATUS = 613 </if>
	                    </when>
	                </choose>
	
	                <if test="searchWord != null and searchWord != ''">
	                    <choose>
	                        <when test="searchType == 'title'"> AND D.DOCUMENT_TITLE LIKE '%' || #{searchWord} || '%' </when>
	                        <when test="searchType == 'content'"> AND D.DOCUMENT_CONTENT LIKE '%' || #{searchWord} || '%' </when>
	                        <otherwise>
	                            AND (D.DOCUMENT_TITLE LIKE '%' || #{searchWord} || '%' OR D.DOCUMENT_CONTENT LIKE '%' || #{searchWord} || '%')
	                        </otherwise>
	                    </choose>
	                </if>
	            </where>
	            ORDER BY D.DOCUMENT_REGDATE DESC
	        ) A
	    )
	    WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 권한 체크 -->
	<select id="getProjectRole" resultType="String">
	    SELECT PROJECT_ROLE 
	    FROM PROJECT_MEMBER 
	    WHERE PROJECT_NO = #{projectNo} 
	      AND MEMBER_NO = #{userNo}
	</select>
	
	<!-- 결재 카운트 -->
	<select id="getApprovalCount" parameterType="kr.or.ddit.vo.ApprovalPaginationInfoVO" resultType="int">
	    SELECT COUNT(D.DOCUMENT_NO)
	    FROM DRAFT_DOCUMENT D
	    <where>
	        AND D.PROJECT_NO = #{projectNo}
	        <choose>
	            <when test="projectRole == 'MANAGER' or projectRole == 'MEMBER'">
	                AND D.MEMBER_NO = #{userNo}
	                <if test="tabType == 'TEMP'"> AND D.DOCUMENT_STATUS = 616 </if>
	                <if test="tabType == 'REJECT'"> AND D.DOCUMENT_STATUS = 614 </if>
	                <if test="tabType == 'COMPLETE'"> AND D.DOCUMENT_STATUS = 613 </if>
	                <if test="tabType == 'PROGRESS'"> AND D.DOCUMENT_STATUS = 612 </if>
	            </when>
	            
	            <when test="projectRole == 'CLIENT'">
	                AND D.DOCUMENT_NO IN (
	                    SELECT DOCUMENT_NO FROM DRAFT_APPROVAL WHERE MEMBER_NO = #{userNo}
	                )
	                <if test="tabType == 'WAIT'"> AND D.DOCUMENT_STATUS = 611 </if>
	                <if test="tabType == 'REJECT'"> AND D.DOCUMENT_STATUS = 614 </if>
	                <if test="tabType == 'COMPLETE'"> AND D.DOCUMENT_STATUS = 613 </if>
	            </when>
	        </choose>
	
	        <if test="searchWord != null and searchWord != ''">
	            AND (D.DOCUMENT_TITLE LIKE '%' || #{searchWord} || '%')
	        </if>
	    </where>
	</select>
	
	<!-- 상태별 건수 조회 -->
	<select id="getApprovalStats" parameterType="map" resultType="map">
	    SELECT 
	    <choose>
	        <when test="projectRole == 'MANAGER' or projectRole == 'MEMBER'">
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 612 THEN 1 END) AS PROGRESS_COUNT, -- 결재중
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 614 THEN 1 END) AS REJECT_COUNT,   -- 반려함
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 616 THEN 1 END) AS TEMP_COUNT,     -- 임시보관
	            -- 장기 미결 (결재중(612)이면서 3일 이상 지난 건)
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 612 AND D.DOCUMENT_REGDATE &lt;= CURRENT_TIMESTAMP - INTERVAL '3' DAY THEN 1 END) AS LONG_TERM_COUNT
	        </when>
	
	        <when test="projectRole == 'CLIENT'">
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 611 THEN 1 END) AS WAIT_COUNT,     -- 결재대기
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 614 THEN 1 END) AS MY_REJECT_COUNT, -- 내가 반려한 건
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 613 THEN 1 END) AS COMPLETE_COUNT, -- 결재 완료
	            -- 장기 미결 (결재대기(611) 상태로 나에게 온 지 3일 이상 된 건)
	            COUNT(CASE WHEN D.DOCUMENT_STATUS = 611 AND D.DOCUMENT_REGDATE &lt;= CURRENT_TIMESTAMP - INTERVAL '3' DAY THEN 1 END) AS LONG_TERM_COUNT
	        </when>
	    </choose>
	    FROM DRAFT_DOCUMENT D
	    WHERE D.PROJECT_NO = #{projectNo}
	    <choose>
	        <when test="projectRole == 'MANAGER' or projectRole == 'MEMBER'">
	            AND D.MEMBER_NO = #{userNo}
	        </when>
	        <when test="projectRole == 'CLIENT'">
	            AND D.DOCUMENT_NO IN (
	                SELECT DOCUMENT_NO FROM DRAFT_APPROVAL WHERE MEMBER_NO = #{userNo}
	            )
	        </when>
	    </choose>
	</select>

</mapper>