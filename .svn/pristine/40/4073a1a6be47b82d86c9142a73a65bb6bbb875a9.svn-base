<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kanban Board</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
body {
	font-family: 'Malgun Gothic', sans-serif;
	background: #fdfdfd; 
	margin: 0;
	padding: 20px;
}

.kanban-wrapper {
	display: flex;
	gap: 16px;
	align-items: flex-start;
}

/* [ì»¬ëŸ¼ ë””ìì¸ ìˆ˜ì •] */
.kanban-col {
	flex: 1;
	background: #f4f5f7; /* ì—°íšŒìƒ‰ */
	border-radius: 8px;
	min-width: 300px;
	display: flex;
	flex-direction: column;
}

/* [ì»¬ëŸ¼ í—¤ë” ë””ìì¸] */
.col-header {
	display: flex;
    align-items: center;
	padding: 16px 12px 8px 16px; /* ìœ„ì•„ë˜ ì—¬ë°± ì¡°ì ˆ */
	color: #5e6c84; /* ì§„íšŒìƒ‰ ê¸€ì */
	font-weight: 600;
	text-align: left; /* ì™¼ìª½ ì •ë ¬ */
	font-size: 13px;
	text-transform: uppercase; 
	letter-spacing: 0.5px;
}

.col-header.request {
	border-bottom: 3px solid #3498db;
	margin: 0 10px;
	padding-left: 6px;
}

.col-header.progress {
	border-bottom: 3px solid #f1c40f;
	margin: 0 10px;
	padding-left: 6px;
}

.col-header.done {
	border-bottom: 3px solid #2ecc71;
	margin: 0 10px;
	padding-left: 6px;
}

.col-header.hold {
	border-bottom: 3px solid #95a5a6;
	margin: 0 10px;
	padding-left: 6px;
}

.task-list {
	padding: 12px;
	min-height: 700px;
}

.task-card {
	background: white;
	padding: 16px;
	border-radius: 4px; 
	margin-bottom: 10px;
	box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12); /
	cursor: grab;
	position: relative;
	border: none;
	transition: background-color 0.2s;
}

.task-card:hover {
	background-color: #f9fafb; 
}

.task-card:active {
	cursor: grabbing;
}

.task-card.pin-on {
	background-color: #fff9db !important; /* ê³ ì •ëœ ì¹´ë“œëŠ” ì‚´ì§ ë”°ëœ»í•œ ëŠë‚Œ */
	box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
	border: 1px solid rgba(52, 152, 219, 0.3) !important;
}

.task-card.pin-on .pin-btn svg {
	fill: #3498db !important;
}

.task-card.pin-off .pin-btn svg {
	fill: #ccc !important;
	transform: rotate(-45deg);
}

.pin-btn {
	cursor: pointer;
	width: 20px;
	height: 20px;
	display: flex;
	align-items: center;
	justify-content: center;
}

.card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 8px;
}

.parent-title {
	font-size: 11px;
	color: #5e6c84;
	background: #ebecf0;
	padding: 2px 6px;
	border-radius: 3px;
}

.task-title {
	font-weight: 500;
	font-size: 14px;
	color: #172b4d;
	margin: 8px 0;
	display: block;
}

.manager-name {
	font-size: 12px;
	color: #5e6c84;
}

.end-date {
	font-size: 11px;
	color: #6b778c;
	margin-top: 4px;
}

.rate-container {
	margin-top: 12px;
	border-top: 1px solid #f4f5f7;
	padding-top: 8px;
}

.rate-slider {
	width: 100%;
	cursor: pointer;
	opacity: 0.7;
}

.rate-text {
	font-size: 11px;
	color: #0052cc;
	text-align: right;
	font-weight: bold;
}
.col-header .count {
    margin-left: 8px;
    font-size: 12px;
    color: #95a5a6; /* ì•½ê°„ íë¦° íšŒìƒ‰ */
    font-weight: normal;
}
</style>
</head>
<body>

	<input type="hidden" id="projectNoInput" value="${projectNo}" />

	<div class="kanban-wrapper">
		<div class="kanban-col">
			<div class="col-header request">TO DO<span class="count" id="count-1">0</span></div>
			<div class="task-list" data-status="1"></div>
		</div>
		<div class="kanban-col">
			<div class="col-header progress">IN PROGRESS<span class="count" id="count-2">0</span></div>
			<div class="task-list" data-status="2"></div>
		</div>
		<div class="kanban-col">
			<div class="col-header done">DONE<span class="count" id="count-3">0</span></div>
			<div class="task-list" data-status="3"></div>
		</div>
		<div class="kanban-col">
			<div class="col-header hold">ON HOLD<span class="count" id="count-4">0</span></div>
			<div class="task-list" data-status="4"></div>
		</div>
	</div>

	<script>
$(document).ready(function() {
    var pNo = $("#projectNoInput").val() || "7";

    // ê³µí†µ SVG ë„ì¥
    var pinIconSvg = `
        <svg viewBox="0 -960 960 960">
            <path d="M680-120 480-320H280v-80l80-80v-280q0-33 23.5-56.5T440-840h80q33 0 56.5 23.5T600-760v280l80 80v80H480l200 200-80 80Z"/>
        </svg>`;

    // [ì´ë²¤íŠ¸] í•€ í´ë¦­ ì²˜ë¦¬
    $(document).on('click', '.pin-btn', function(e) {
        e.stopPropagation();
        
        var $card = $(this).closest('.task-card');
        var id = $card.data('id');
        
        var currentPin = $card.attr('data-pin');
        var newPin = (currentPin === 'Y') ? 'N' : 'Y';
        
        console.log("í˜„ì¬ ìƒíƒœ:", currentPin, "-> ë³€ê²½ë  ìƒíƒœ:", newPin);

        $.post("/kanban/updatePin", { taskId: id, pinYn: newPin }, function() {
        	
        	$card.attr('data-pin', newPin);
        	
        	if (newPin === 'Y') {
                $card.removeClass('pin-off').addClass('pin-on');
                $card.prependTo($card.closest('.task-list'));
            } else {
                $card.removeClass('pin-on').addClass('pin-off');
            }
        });
    });

    function loadTasks() {
        $.ajax({
            url: "/kanban/getTaskList",
            type: "GET",
            data: { projectNo: pNo },
            success: function(data) { renderCards(data); },
            error: function(xhr) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", xhr.status); }
        });
    }

    function renderCards(data) {
        $(".task-list").empty();
        $(".count").text("0");
        
        var counts = { "1": 0, "2": 0, "3": 0, "4": 0 };

        // [ì •ë ¬] í•€ ê³ ì •(Y)ì¸ ë°ì´í„°ë¥¼ ìƒë‹¨ìœ¼ë¡œ ì •ë ¬
        data.sort(function(a, b) {
            var aPin = a.subPinYn || 'N';
            var bPin = b.subPinYn || 'N';
            return (aPin === 'Y' && bPin === 'N') ? -1 : (aPin === 'N' && bPin === 'Y') ? 1 : 0;
        });

        data.forEach(function(item) {
            var status = item.subStatus.toString();
            var rate = parseInt(item.subRate);
            var pinYn = item.subPinYn || 'N';
            var pinClass = (pinYn === 'Y') ? 'pin-on' : 'pin-off';

            if (rate == 100 && status != "3") {
                status = "3";
            }
            
            if(counts[status] !== undefined) {
                counts[status]++;
            }

            var $target = $('.task-list[data-status="' + status + '"]');
            if ($target.length > 0) {
                var cardHtml = `
                    <div class="task-card \${pinClass}" data-id="\${item.subId}" data-pin="\${pinYn}">
                        <div class="card-header">
                            <span class="parent-title">ğŸ“ \${item.parentTitle || 'ì¼ë°˜'}</span>
                            <span class="pin-btn">\${pinIconSvg}</span>
                        </div>
                        <span class="task-title">\${item.subTitle}</span>
                        <span class="manager-name">ğŸ‘¤ \${item.taskManagerName || 'ë¯¸ì§€ì •'}</span>
                        <span class="end-date">ğŸ“… \${item.subEnddate ? item.subEnddate.substring(0,10) : "-"}</span>
                        <div class="rate-container">
                            <input type="range" class="rate-slider" min="0" max="100" step="10" value="\${item.subRate}"
                                   onmousedown="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                            <span class="rate-text">\${item.subRate}% ì™„ë£Œ</span>
                        </div>
                    </div>
                `;
                $target.append(cardHtml);
            }
        });
        
        for (var s in counts) {
            $("#count-" + s).text(counts[s]);
        }

        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ë¡œì§
        $(".rate-slider").off('input change').on('input', function() {
            $(this).siblings('.rate-text').text($(this).val() + "% ì™„ë£Œ");
        }).on('change', function() {
            var $card = $(this).closest('.task-card');
            var id = $card.data('id');
            var rate = parseInt($(this).val());
            var currentStatus = $card.closest('.task-list').data('status');
            var newStatus = currentStatus;

            // ë¡œì§: 10% ì´ìƒ ì§„í–‰(2), 100% ì™„ë£Œ(3), 0% ìš”ì²­(1)
            if (currentStatus == 1 && rate >= 10) newStatus = 2;
            else if (rate == 100) newStatus = 3;
            else if (currentStatus == 3 && rate < 100) newStatus = 2;
            else if (rate == 0) newStatus = 1;

            if (newStatus != currentStatus) {
                $('.task-list[data-status="' + newStatus + '"]').append($card);
                $.post("/kanban/modifyStatus", { taskId: id, taskStatus: newStatus });
            }
            $.post("/kanban/updateRate", { taskId: id, taskRate: rate });
        });

        // SortableJS ì´ˆê¸°í™”
        $(".task-list").each(function() {
            new Sortable(this, {
                group: 'kanban',
                animation: 150,
                filter: '.rate-slider, .pin-btn',
                preventOnFilter: false,
                onEnd: function(evt) {
                    var $item = $(evt.item);
                    var id = $item.data('id');
                    var rate = parseInt($item.find('.rate-slider').val());
                    var toStatus = $(evt.to).data('status');

                    // 100% ì¹´ë“œë¥¼ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ì˜®ê¸¸ ë•Œ ë°©ì§€
                    if (rate == 100 && toStatus != 3) {
                        alert("ì™„ë£Œëœ ì—…ë¬´ì…ë‹ˆë‹¤.");
                        $('.task-list[data-status="3"]').append($item);
                        return;
                    }
                    
                    if (toStatus == 1 && rate >= 10) {
                        alert("ì§„í–‰ì¤‘ì¸ ì—…ë¬´ì…ë‹ˆë‹¤.");
                        $('.task-list[data-status="2"]').append($item);
                        $.post("/kanban/modifyStatus", { taskId: id, taskStatus: 2 });
                    }

                    // ë¯¸ì™„ë£Œ ì¹´ë“œë¥¼ ì™„ë£Œë¡œ ì˜®ê¸¸ ë•Œ ì»¨íŒ
                    if (toStatus == 3 && rate < 100) {
                        if (confirm("ì§„ì²™ë„ë¥¼ 100%ë¡œ ìˆ˜ì •í•˜ê³  ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            $item.find('.rate-slider').val(100);
                            $item.find('.rate-text').text("100% ì™„ë£Œ");
                            $.post("/kanban/updateRate", { taskId: id, taskRate: 100 });
                            $.post("/kanban/modifyStatus", { taskId: id, taskStatus: 3 });
                        } else {
                        	alert("ì™„ë£Œí•˜ì‹œë ¤ë©´ ì§„ì²™ë„ë¥¼ 100%ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.");
                            $('.task-list[data-status="2"]').append($item);
                            $.post("/kanban/modifyStatus", { taskId: id, taskStatus: 2 });
                        }
                    } else {
                        $.post("/kanban/modifyStatus", { taskId: id, taskStatus: toStatus });
                    }
                }
            });
        });
    }

    loadTasks();
});
</script>
</body>
</html>