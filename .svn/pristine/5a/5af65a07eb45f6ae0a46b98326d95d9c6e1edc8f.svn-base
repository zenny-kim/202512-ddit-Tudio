package kr.or.ddit.inquiry.service;

import java.io.File;
import java.io.IOException;
import java.util.List;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.inquiry.mapper.IInquiryMapper;
import kr.or.ddit.vo.FileDetailVO;
import kr.or.ddit.vo.FileGroupVO;
import kr.or.ddit.vo.InquiryVO;

@Service
public class InquiryServiceImpl implements IInquiryService {

	@Autowired
	private IInquiryMapper inquiryMapper;
	
	@Value("${kr.or.ddit.upload.path}")
	private String uploadPath;
	
	/* ==================== 사용자 ===================== */
	
	@Transactional
	@Override
	public void registerInquiry(InquiryVO inquiryVO, List<MultipartFile> files) {
		
		System.out.println("문의 등록 시작");
		System.out.println("userNo = " + inquiryVO.getUserNo());
		System.out.println("files = " + (files == null ? "null" : files.size()));
		
	    //파일 그룹 먼저 생성
	    FileGroupVO fileGroupVO = new FileGroupVO();
	    fileGroupVO.setMemberNo(inquiryVO.getUserNo());
	    fileGroupVO.setFileGroupType("02"); // 문의

	    inquiryMapper.insertInquiryFileGroup(fileGroupVO);

	    //inquiry에 fileGroupNo 세팅
	    inquiryVO.setFileGroupNo(fileGroupVO.getFileGroupNo());

	    //문의 등록
	    int result = inquiryMapper.insertInquiry(inquiryVO);
	    
	    System.out.println("insertInquiry result = " + result);
	    System.out.println("inquiryNo = " + inquiryVO.getInquiryNo());
	    
	    if(result == 0) {
	        throw new RuntimeException("문의 등록 실패");
	    }

	    //파일 없으면 끝
	    if(files == null || files.isEmpty()) return;

	    //파일 저장
	    
//	    String saveDir = uploadPath + "inquiry/" + inquiryVO.getInquiryNo();
//	    File dir = new File(saveDir);
//	    if(!dir.exists()) dir.mkdirs();
	    
	    File saveDir = new File(uploadPath, "inquiry/" + inquiryVO.getInquiryNo());
	    if(!saveDir.exists()) saveDir.mkdirs();

	    for(MultipartFile file : files) {
	        if(file.isEmpty()) continue;

	        String originName = file.getOriginalFilename();
	        String saveName = UUID.randomUUID() + "_" + originName;
	        String extension = originName.substring(originName.lastIndexOf(".") + 1);

	        try {
	            file.transferTo(new File(saveDir, saveName));
	        } catch (IOException e) {
	            throw new RuntimeException("파일 저장 실패");
	        }

	        FileDetailVO fileDetailVO = new FileDetailVO();
	        fileDetailVO.setFileGroupNo(fileGroupVO.getFileGroupNo());
	        fileDetailVO.setFileOriginalName(originName);
	        fileDetailVO.setFileSaveName(saveName);
	        fileDetailVO.setFilePath("/upload/inquiry/" + inquiryVO.getInquiryNo() + "/" + saveName);
	        fileDetailVO.setFileSize((int) file.getSize());
	        fileDetailVO.setFileExtension(extension);
	        fileDetailVO.setFileMime(file.getContentType());

	        inquiryMapper.insertInquiryFileDetail(fileDetailVO);
	    }
	    
	    System.out.println("files size = " + files.size());
	}

	@Override
	public List<InquiryVO> getInquiryListByUser(int userNo) {
		return inquiryMapper.selectInquiryListByUser(userNo);
	}

	@Transactional
	@Override
	public InquiryVO getInquiryDetail(int inquiryNo) {
		InquiryVO inquiryVO = inquiryMapper.selectInquiryDetail(inquiryNo);
		if(inquiryVO == null) {
			throw new IllegalArgumentException("존재하지 않는 문의입니다.");
		}
		
		inquiryMapper.incrementInquiryHit(inquiryNo);
		return inquiryVO;
	}
	
	@Transactional
	@Override
	public void modifyInquiry(InquiryVO inquiryVO, List<MultipartFile> files) {
		InquiryVO saved = inquiryMapper.selectInquiryDetail(inquiryVO.getInquiryNo());

	    if(saved == null)
	        throw new IllegalArgumentException("존재하지 않는 문의입니다.");

	    if(saved.getUserNo() != inquiryVO.getUserNo())
	        throw new SecurityException("본인 문의만 수정 가능");

	    if("Y".equals(saved.getReplyStatus()))
	        throw new IllegalArgumentException("답변 완료 문의는 수정 불가");

	    // 문의 수정
	    inquiryMapper.updateInquiry(inquiryVO);

	    // 파일 없으면 종료
	    if(files == null || files.isEmpty()) return;

	    // fileGroupNo는 InquiryVO에 이미 있음
	    int fileGroupNo = inquiryVO.getFileGroupNo();

	    // 파일 저장
	    String saveDir = uploadPath + "inquiry/" + inquiryVO.getInquiryNo();
	    File dir = new File(saveDir);
	    if(!dir.exists()) dir.mkdirs();

	    for(MultipartFile file : files) {
	        if(file.isEmpty()) continue;

	        String originName = file.getOriginalFilename();
	        String saveName = UUID.randomUUID() + "_" + originName;
	        String extension = originName.substring(originName.lastIndexOf(".") + 1);

	        try {
	            file.transferTo(new File(saveDir, saveName));
	        } catch (IOException e) {
	            throw new RuntimeException("파일 저장 실패");
	        }

	        FileDetailVO fileDetailVO = new FileDetailVO();
	        fileDetailVO.setFileGroupNo(fileGroupNo);
	        fileDetailVO.setFileOriginalName(originName);
	        fileDetailVO.setFileSaveName(saveName);
	        fileDetailVO.setFilePath("/upload/inquiry/" + inquiryVO.getInquiryNo() + "/" + saveName);
	        fileDetailVO.setFileSize((int) file.getSize());
	        fileDetailVO.setFileExtension(extension);
	        fileDetailVO.setFileMime(file.getContentType());

	        inquiryMapper.insertInquiryFileDetail(fileDetailVO);
	    }
	}

	@Transactional
	@Override
	public void removeInquiryByUser(int inquiryNo, int userNo) {
		int result = inquiryMapper.deleteInquiryByUser(inquiryNo, userNo);
		if(result == 0) {
			throw new RuntimeException("문의 삭제 실패");
		}
		
	}

	/* ==================== 관리자 ===================== */
	
	@Override
	public List<InquiryVO> getInquiryListAll() {
		return inquiryMapper.selectInquiryListAll();
	}

	@Transactional
	@Override
	public void registerReply(InquiryVO inquiryVO) {
		int result = inquiryMapper.updateInquiryReply(inquiryVO);
		if(result == 0) {
			throw new RuntimeException("답변 등록 실패");
		}
	}

	@Transactional
	@Override
	public void removeInquiryByAdmin(int inquiryNo) {
		int result = inquiryMapper.deleteInquiryByAdmin(inquiryNo);
		if(result == 0) {
			throw new RuntimeException("문의 삭제 실패");
		}
	}
}
