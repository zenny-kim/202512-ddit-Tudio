<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Tudio - 화싱미팅 대기실</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/video_chat.css">
	<jsp:include page="/WEB-INF/views/include/common.jsp" />
	
	</head>
<body data-context-path="${pageContext.request.contextPath}"
	data-login-no="${loginUser.memberNo}"
	class="d-flex flex-column min-vh-100">
	
	<jsp:include page="../include/headerUser.jsp"/>
    
    <div class="d-flex flex-grow-1">
	    <jsp:include page="../include/sidebarUser.jsp">
	    	<jsp:param name="menu" value="video_chat" />
	    </jsp:include>
	
		<main class="main-content-wrap flex-grow-1 px-4 pt-4 pb-5">
			<div class="container-fluid h-100">
				
				<div class="mb-4">
                    <h3 class="fw-bold text-primary-dark m-0">
                        <i class="bi bi-hourglass-split me-2"></i> 화상미팅 대기실
                    </h3>
                    <p class="text-muted small mt-2">입장 전 회의 정보를 확인하고 카메라 상태를 점검하세요.</p>
                </div>
                
                <div class="row g-4 align-items-stretch">
                	
                	<div class="col-lg-5 d-flex">
                        <div class="card waiting-card p-4 w-100 h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                            	<div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                            		<span class="badge bg-primary me-2">NEW</span>
                            		<h4 class="fw-bold m-0 text-truncate">${roomInfo.videochatTitle}</h4>
                            	</div>
	                            
	                            <div class="mb-4">
	                                <div class="info-label"><i class="bi bi-calendar-check me-1"></i> Date</div>
	                                <div class="fs-5 fw-bold text-dark">
	                                    <fmt:formatDate value="${now}" pattern="yyyy.MM.dd (E) HH:mm" />
	                                </div>
	                            </div>
	
								<div class="mb-4">
	                                <div class="info-label"><i class="bi bi-people-fill me-1"></i> Invited Members</div>
	                                <div class="text-primary fw-bold fs-5">
	                                    ${memberCount} 명 <span class="text-muted fs-6 fw-normal">이 초대되었습니다.</span>
	                                </div>
	                            </div>
	
								<div class="mb-3">
	                                <label class="info-label" for="roomIdDisplay">Room ID</label>
	                                <div class="input-group">
	                                	<span class="input-group-text bg-white text-primary"><i class="bi bi-hash"></i></span>
	                                    <input type="text" class="form-control copy-input" id="roomIdDisplay" value="${roomInfo.videochatId}" readonly>
	                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('roomIdDisplay')">
	                                    	<i class="bi bi-files"></i> 복사
	                                    </button>
	                                </div>
	                            </div>
	
								<div class="mb-4">
	                                <label class="info-label" for="roomPwDisplay">Password</label>
	                                <div class="input-group">
	                                	<span class="input-group-text bg-white text-danger"><i class="bi bi-key"></i></span>
	                                    <input type="text" class="form-control copy-input" id="roomPwDisplay" value="${roomInfo.videochatPw}" readonly>
	                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('roomPwDisplay')">
	                                    	<i class="bi bi-files"></i> 복사
	                                    </button>
	                                </div>
	                            </div>
	                            
	                            <div class="alert alert-light border small text-muted mb-0 mt-auto">
	                                <i class="bi bi-info-circle-fill me-1 text-info"></i>
	                                위 정보를 복사하여 팀원들에게 공유하세요.<br>
	                                보안을 위해 비밀번호는 외부 유출에 주의해주세요.
	                            </div>
                            </div>
                        </div>
                    </div>
	
					<div class="col-lg-7 d-flex">
                        <div class="card waiting-card p-5 bg-white text-center w-100 h-100">
                        	<div class="card-body d-flex flex-column justify-content-center">
	                        	<h5 class="fw-bold mb-3">화면 미리보기</h5>
	                        	
	                        	<div class="camera-preview-box">
	                        		<video id="localVideoPreview" autoplay playsinline muted></video>
	                        		
	                        		<div class="camera-placeholder" id="cameraPlaceholder">
		                        		<div class="avatar-circle">
		                        			<i class="bi bi-person-fill"></i>
		                        		</div>
		                        		<p class="mb-0">카메라 권한을 허용해주세요.</p>
	                        		</div>
	                        		
	                        		<div class="preview-controls" style="z-index: 2;">
	                        			<div class="control-icon"><i class="bi bi-mic-fill"></i></div>
	                        			<div class="control-icon"><i class="bi bi-camera-video-fill"></i></div>
	                        		</div>
	                        	</div>
	                        	
	                            <h3 class="fw-bold mb-2">준비 되셨나요?</h3>
	                            <p class="text-muted mb-4">
	                                브라우저의 카메라/마이크 권한 요청을 허용해주세요.<br>
	                                준비가 완료되면 입장 버튼을 눌러주세요.
	                            </p>
	                            
	                            <div class="d-grid gap-3 col-md-8 mx-auto mt-auto">
	                                <a href="${pageContext.request.contextPath}/tudio/videoChat/room/${roomInfo.videochatId}" 
	                                   class="btn btn-primary btn-lg rounded-pill fw-bold enter-btn py-3">
	                                    <i class="bi bi-box-arrow-in-right me-2"></i> 지금 바로 입장하기
	                                </a>
	                                
	                                <a href="${pageContext.request.contextPath}/tudio/videoChat/list" 
	                                   class="btn btn-outline-secondary btn-lg rounded-pill fw-bold py-3">
	                                    <i class="bi bi-arrow-left me-2"></i> 목록으로 돌아가기
	                                </a>
	                            </div>
                            </div>
                        </div>
                    </div>
                </div>
                
		    </div>
		</main>	
	</div>

	<jsp:include page="../chat/main.jsp"/>
	
	<jsp:include page="../include/footer.jsp"/>
    
	<script src="${pageContext.request.contextPath}/js/footer.js" ></script>
	
	<script>
		$(document).ready(function(){
			// 페이지 로드 시 카메라 미리보기 자동 실행
			startCameraPreview();
		});
	
		// ★ 카메라 미리보기 함수
		function startCameraPreview() {
		    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
		        .then(function(stream) {
		            // 성공 시 비디오 태그에 스트림 연결
		            const videoElement = document.getElementById('localVideoPreview');
		            const placeholder = document.getElementById('cameraPlaceholder');
		            
		            videoElement.srcObject = stream;
		            
		            // UI 전환: 플레이스홀더 숨김 -> 비디오 표시
		            placeholder.style.display = 'none';
		            videoElement.style.display = 'block';
		        })
		        .catch(function(err) {
		            console.error("카메라 접근 실패:", err);
		            // 실패 시 플레이스홀더 유지 (아무 작업 안 함)
		        });
		}
	
	    // 클립보드 복사 함수
	    function copyToClipboard(elementId) {
	        const copyText = document.getElementById(elementId);
	        
	        copyText.select();
	        copyText.setSelectionRange(0, 99999); 

	        navigator.clipboard.writeText(copyText.value).then(() => {
	            alert("클립보드에 복사되었습니다: " + copyText.value);
	        }).catch(err => {
	            console.error('복사 실패:', err);
	            try {
	            	document.execCommand('copy');
	            	alert("클립보드에 복사되었습니다.");
	            } catch (e) {
	            	alert("복사에 실패했습니다. 직접 복사해주세요.");
	            }
	        });
	    }
	</script>
</body>
</html>