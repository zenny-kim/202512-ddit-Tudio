// 1. 공통 변수 설정
if (typeof urlParams === 'undefined') {
	var urlParams = new URLSearchParams(window.location.search);
}
if (typeof ctxPath === 'undefined') {
	var ctxPath = window.location.pathname.substring(0, window.location.pathname.indexOf("/", 2));
}

if (window.projectNo == null) {
	const urlParam = new URLSearchParams(location.search).get('projectNo');
	if (urlParam) {
		window.projectNo = Number(urlParam);
	}
}

console.log('[확정 projectNo]', window.projectNo);

//회의 참석자 배열
if (typeof selectedMembers === 'undefined') {
	var selectedMembers = [];
}

//페이지 로드 시 실행
$(function() {
	//초기 리스트 로드
	if ($('#boardTbody').length > 0) loadList(1);
		
	// [페이지네이션 클릭 처리] - 디버깅용 로그 포함 버전
	$(document).off('click', '#boardPager a').on('click', '#boardPager a', function(e) {
	    e.preventDefault(); // 링크 이동 차단
	    
	    console.log("=== 페이지 클릭 감지됨 ===");
	    
	    let pageNo = null;
	    const href = $(this).attr('href');
	    const text = $(this).text().trim();
	    const dataPage = $(this).data('page'); // 만약 data-page 속성이 있다면

	    console.log("1. href 값:", href);
	    console.log("2. 태그 내용:", text);
	    console.log("3. data-page 값:", dataPage);

	    if (dataPage) {
	        pageNo = dataPage;
	    }
	    else if (href && href.includes('page=')) {
	        // 'page=' 뒤의 숫자를 정규식으로 추출
	        const match = href.match(/page=([0-9]+)/);
	        if (match && match[1]) {
	            pageNo = match[1];
	        }
	    }
	    // [전략 3] href가 없고, 태그 내용 자체가 숫자라면(예: <a>3</a>) 그걸 쓴다.
	    else if (!isNaN(text) && text !== "") {
	        pageNo = text;
	    }

	    console.log("▶ 최종 추출된 페이지 번호:", pageNo);

	    if (pageNo) {
	        loadList(pageNo); // 추출한 번호로 목록 다시 불러오기
	    } else {
	        console.warn("페이지 번호를 찾을 수 없습니다. HTML 구조를 확인해주세요.");
	        // 만약 번호 추출에 실패했다면, 그냥 1페이지로라도 이동하게 비상 처리
	        // loadList(1); 
	    }
	});
	

	$(document).off('click', '.tudio-pill').on('click', '.tudio-pill', function() {
	    // 1. 모든 버튼에서 활성화 클래스(is-active)를 뺏고, 클릭한 버튼에만 줌
	    $(".tudio-pill").removeClass("is-active");
	    $(this).addClass("is-active");
		
	    // 2. 새로운 카테고리 기준으로 첫 페이지부터 다시 로드
	    loadList(1);
	});

	// [등록/수정 폼 로드]
	$(document).off('click', '#btnInsertForm').on('click', '#btnInsertForm', function() {
		const url = `${ctxPath}/tudio/project/board/insert?projectNo=${window.projectNo}`;
		$(".tudio-section").load(url, initInsertForm);
	});

	// [카테고리 변경]
	$(document).off('change', 'input[name="categoryName"]').on('change', 'input[name="categoryName"]', function() {
		toggleMeetingArea($(this).val());
	});

	// [참석자 추가]
	$(document).off('click', '.btn-add-member').on('click', '.btn-add-member', function() {
		const li = $(this).closest('li');
		    const memNo = String(li.data('no'));
		    const memName = li.data('name');

		    // 1. 이미 추가되었는지 확인
		    if (selectedMembers.find(m => m.no === memNo)) {
		        Swal.fire({
		            title: '알림',
		            text: '이미 추가된 멤버입니다.',
		            icon: 'info',
		            timer: 1500, // 1.5초 뒤 자동 닫힘
		            showConfirmButton: false
		        });
		        return;
		    }

		    // 2. 배열에 추가
		    selectedMembers.push({ no: memNo, name: memName });
		    
		    // 3. 화면 업데이트
		    renderSelectedMembers();

		    // 4. ★ 추가 완료 알림창 띄우기 ★
		    Swal.fire({
		        title: '성공',
		        text: `${memName}님이 추가되었습니다.`,
		        icon: 'success',
		        timer: 1000, // 1초 뒤에 자동으로 사라짐 (사용자가 일일이 확인 안 눌러도 됨)
		        showConfirmButton: false
		    });
	});

	// [참석자 삭제] 하나 삭제 시 두 개 지워지는 현상 방지
	$(document).off('click', '.btn-remove-member').on('click', '.btn-remove-member', function() {
		const targetNo = String($(this).data('no'));
		selectedMembers = selectedMembers.filter(m => m.no !== targetNo);
		renderSelectedMembers();
	});

	//[참석자 검색]
	$(document).off('input', '#memberSearchInput')
		.on('input', '#memberSearchInput', function() {
			const val = $(this).val().trim().toLowerCase();
			$('#memberSearchList .member-item').each(function() {
				const memberText = $(this).text().toLowerCase();
				const isMatch = memberText.indexOf(val) > -1;

				$(this).css('display', isMatch ? 'flex' : 'none');
			});
		});

	// [검색 버튼]
	$(document).off('click', '#btnSearch')
		.on('click', '#btnSearch', function() {
			loadList(1);
		});

	// [목록으로 돌아가기]
	$(document).off('click', '#btnBackToList')
		.on('click', '#btnBackToList', function() {
			$(".tudio-section").load(
				`${ctxPath}/tudio/project/board?projectNo=${window.projectNo}`
			);
		});



});

// 카테고리에 따라 회의록 영역 보이기/숨기기 함수
function toggleMeetingArea(category) {
	if (category === 'MINUTES') {
		$('#meetingDetailsArea, #meetingResultArea').stop().slideDown(300);
		$('#titleLabel').html('<i class="bi bi-tag-fill me-1"></i> 회의 주제');
		$('#submitBtn').html('<i class="bi bi-check-lg"></i> 회의록 저장');
		renderSelectedMembers(); // 영역이 보일 때 참석자 태그도 다시 그려줌
	} else {
		$('#meetingDetailsArea, #meetingResultArea').stop().slideUp(200);
		$('#titleLabel').html('<i class="bi bi-tag-fill me-1"></i> 제목');
		$('#submitBtn').html('<i class="bi bi-check-lg"></i> 게시글 저장');
	}
}

// 폼 저장 핸들러
function handleFormSubmit(e) {
	e.preventDefault();
	const form = this;
	const category = $('input[name="categoryName"]:checked').val();

	// 간단한 유효성 검사
	if (!$('#boardTitle').val().trim()) {
		Swal.fire('알림', '제목을 입력해주세요.', 'warning');
		return;
	}

	Swal.fire({ title: '저장하시겠습니까?', showCancelButton: true }).then(res => {
		if (res.isConfirmed) {
			const formData = new FormData(form);
			$.ajax({
				url: $(form).attr('action'),
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function(res) {
					if (res.status === "success") {
						Swal.fire('완료', '저장되었습니다.', 'success')
						const finalBoNo = res.boNo || $('#boNo').val(); 
						            goDetail(finalBoNo);
					}
				}
			});
		}
	});
}





// 목록 데이터, 페이징, 검색
// 목록 데이터, 페이징, 검색
function loadList(page) {
	/*
    console.log("=== [1] loadList 시작 ===");
    console.log("요청할 페이지:", page);
    console.log("프로젝트 번호(window.projectNo):", window.projectNo);
    console.log("요청 URL:", ctxPath + "/tudio/project/board/listData");
*/
	let category = $(".tudio-pill.is-active").data("category") || "";
	let searchType = $("#searchType").val();
	let searchWord = $("#searchWord").val();

	$.ajax({
		url: ctxPath + "/tudio/project/board/listData",
		type: "GET",
		data: {
			projectNo: window.projectNo,
			category: category,
			page: page,
			searchType: searchType,
			searchWord: searchWord
		},
		success: function(res) {
            //console.log("=== [2] AJAX 성공! 데이터 도착 ===");
			// 1. 총 건수 표시
			$("#totalCnt").text(res.totalRecord);

			// 2. 리스트 그리기
			let html = "";
			if (res.dataList && res.dataList.length > 0) {
				res.dataList.forEach(board => {
					// 뱃지 HTML 생성 부분
					let badgeHtml = getBadgeHtml(board.categoryName);
					
					// 날짜 자르기 (안전하게 처리)
					let dateStr = board.boRegdate;
					if(dateStr && dateStr.length >= 10) dateStr = dateStr.substring(0, 10);

					// 멤버 이름 처리
					let memName = board.memberVO ? board.memberVO.memberName : '-';

					html += `
						<tr class="row-click">
							<td class="text-center">${board.boNo}</td>
							<td class="text-center">${badgeHtml}</td>
							<td class="title" onclick="goDetail(${board.boNo})">
								${board.boTitle}
							</td>
							<td class="text-center">${memName}</td>
							<td class="text-center">${dateStr}</td>
							<td class="text-center">${board.boHit}</td>
						</tr>`;
				});
			} else {
				html = "<tr><td colspan='6' class='text-center'>게시글이 없습니다.</td></tr>";
			}
			$("#boardTbody").html(html);

			// 페이징 HTML 넣기
			$("#boardPager").html(res.pagingHTML);
            console.log("=== [3] 화면 갱신 완료 ===");
		},
        error: function(xhr, status, error) {
            // ★ 에러 발생 시 여기가 실행됩니다.
            console.error("=== [Error] AJAX 요청 실패 ===");
            console.error("상태코드(status):", xhr.status);
            console.error("에러내용(error):", error);
            
            if(xhr.status == 404) {
                alert("주소를 찾을 수 없습니다. (404)\nURL: " + ctxPath + "/tudio/project/board/listData");
            } else if(xhr.status == 500) {
                alert("서버 내부 오류입니다. (500)\n로그를 확인해주세요.");
            } else {
                alert("알 수 없는 오류가 발생했습니다.\nF12 콘솔을 확인해주세요.");
            }
        }
	});
}

function loadProjectMembers() {
	console.log("멤버 로딩 시작 - 프로젝트 번호:", window.projectNo);
	$.get(
		`${ctxPath}/tudio/project/member/view`,
		{ projectNo: window.projectNo },
		function(list) {
			const ul = $('#memberSearchList');
			ul.empty();

			list.forEach(m => {
				ul.append(`
					<li class="list-group-item member-item d-flex justify-content-between align-items-center"
					                        data-no="${m.memberNo}"
					                        data-name="${m.memberName}">
					                        <span>${m.memberName} (${m.memberId})</span>
					                        <button type="button" class="btn btn-sm btn-outline-primary btn-add-member">추가</button>
					                    </li>
                `);
			});
		}
	);
};
// 헬퍼 함수: 뱃지 정보
function getBadgeInfo(category) {
	switch (category) {
		case 'NOTICE': return { txt: "공지", cls: "badge-red" };
		case 'FREE': return { txt: "자유", cls: "badge-yellow" };
		case 'MINUTES': return { txt: "회의록", cls: "badge-blue" };
		default: return { txt: "기타", cls: "badge-default" };
	}
}
function getBadgeHtml(category) {
	const info = getBadgeInfo(category);
	// 위에서 정의한 txt와 cls를 사용해서 span 태그를 만듭니다.
	return `<span class="tudio-badge ${info.cls}">${info.txt}</span>`;
}

//글쓰기 폼
function initInsertForm() {

	selectedMembers = []; // 배열 초기화 필수

	//초기 카테고리 설정 (수정 시 serverCategory 우선)
	const serverCategoryInput = $('#serverCategory');
	let currentCategory = null;

	if (serverCategoryInput.length > 0) {
		currentCategory = serverCategoryInput.val();
		$(`input[name="categoryName"][value="${currentCategory}"]`).prop('checked', true);
	} else {
		currentCategory = $('input[name="categoryName"]:checked').val();
	}
	
	$('.old-mem').each(function() {
		const no = String($(this).data('no'));
		const name = $(this).data('name');

		if (no && name && !selectedMembers.find(m => m.no === no)) {
			selectedMembers.push({ no, name });
		}
	});

	
	//화면 UI 및 참석자 태그 업데이트
	loadProjectMembers();
	toggleMeetingArea(currentCategory);
	renderSelectedMembers();

	//저장 버튼 이벤트 (중복 방지를 위해 .off() 후 등록)
	$('#insertForm').off('submit').on('submit', handleFormSubmit);

}



// 선택 멤버 태그로 보이기
function renderSelectedMembers() {
	const nameArea = $('#selectedAttendeeNames');
	const inputArea = $('#attendeeHiddenInputs');
	if (!nameArea.length) return; // 요소가 없으면 중단

	nameArea.empty();
	inputArea.empty();

	if (selectedMembers.length === 0) {
		nameArea.append('<span class="text-muted">선택된 참석자가 없습니다.</span>');
		return;
	}

	selectedMembers.forEach((mem, index) => {
		nameArea.append(`
            <span class="attendee-tag">
                ${mem.name}
                <span class="btn-remove-member" data-no="${mem.no}">&times;</span>
            </span>
        `);
		// 서버로 전송될 실제 input 태그 생성
		inputArea.append(`<input type="hidden" name="meetingMemberList[${index}].memberNo" value="${mem.no}">`);
	});
}


// 상세화면 페이지
function goDetail(boNo) {
	const projectNo = window.projectNo;
	$.post(ctxPath + "/tudio/project/board/hit", { boNo });

	$(".tudio-section").load(
		`${ctxPath}/tudio/project/board/detail?projectNo=${projectNo}&boNo=${boNo}`,
		function() {
			isProcessing = false;
			window.scrollTo(0, 0);
		}
	);
}

// 게시글 상세 - 수정버튼 클릭
function goUpdate(pNo, boNo) {
	$(".tudio-section").load(`${ctxPath}/tudio/project/board/update?projectNo=${pNo}&boNo=${boNo}`, function() {
		console.log("수정 폼 로드 완료");
		initInsertForm();
	});
}

// 게시글 상세 - 삭제버튼 클릭
function deleteBoard(boNo) {
	Swal.fire({
		title: '정말 삭제하시겠습니까?',
		text: "삭제된 게시글은 복구할 수 없습니다.",
		icon: 'warning',
		showCancelButton: true,
		confirmButtonColor: '#d33',
		confirmButtonText: '삭제',
		cancelButtonText: '취소'
	}).then((result) => {
		if (result.isConfirmed) {
			$.ajax({
				url: `${ctxPath}/tudio/project/board/delete`,
				type: 'POST',
				data: { boNo: boNo },
				success: function(res) {
					Swal.fire('완료', '게시글이 삭제되었습니다.', 'success').then(() => {
						$(".tudio-section").load(`${ctxPath}/tudio/project/board?projectNo=${window.projectNo}`);
					});
				},
				error: function() {
					Swal.fire('오류', '삭제 처리 중 문제가 발생했습니다.', 'error');
				}
			});
		}
	});
}

// 게시글 수정 데이터 관련
function setupUpdateData() {
	const currentCategory = $('input[name="categoryName"]:checked').val();
	if (currentCategory === 'MINUTES') {
		$('#meetingDetailsArea, #meetingResultArea').show();

		// 기존 참석자들을 selectedMembers 배열에 복원
		$('.old-mem').each(function() {
			const no = String($(this).data('no'));
			const name = $(this).data('name');
			if (no && name) {
				selectedMembers.push({ no: no, name: name });
			}
		});
		// 화면에 태그 그리기
		renderSelectedMembers();
	}
}


