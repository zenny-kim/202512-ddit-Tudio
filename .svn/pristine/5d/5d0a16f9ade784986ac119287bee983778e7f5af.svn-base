<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tudio - 문의사항</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<link rel="stylesheet" href="${pageContext.request.contextPath}/css/projectBoardlist.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/header.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/sidebar.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/footer.css">
<style>
body {
	background-color: #f8f9fa;
	font-family: 'Pretendard', sans-serif;
	padding-top: var(--header-height);
}

/* 사이드바 우측 본문 영역 설정 */
.main-content {
	margin-left: var(--sidebar-width) !important;
	width: calc(100% - var(--sidebar-width));
	padding: 40px 20px;
}

/* 본문 중앙 정렬 박스 */
.main-content .container {
	margin-left: auto !important;
	margin-right: auto !important;
	max-width: 1000px;
	width: 100%;
}

.card {
	border: none;
	border-radius: 15px;
	box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
}

.table thead th {
	background-color: #fcfcfc;
	border-bottom: 2px solid #f1f1f1;
	color: #666;
	font-weight: 600;
	padding: 15px;
}

.table tbody td {
	padding: 18px 15px;
	vertical-align: middle;
	color: #444;
	border-bottom: 1px solid #f8f9fa;
}

.badge-wait {
	background-color: #fff4e6;
	color: #fd7e14;
	border: 1px solid #ffe8cc;
	padding: 5px 10px;
	border-radius: 6px;
	font-size: 0.85rem;
	display: inline-block;
}

.badge-complete {
	background-color: #e7f5ff;
	color: #228be6;
	border: 1px solid #d0ebff;
	padding: 5px 10px;
	border-radius: 6px;
	font-size: 0.85rem;
	display: inline-block;
}

.inquiry-title {
	text-decoration: none;
	color: #333;
	font-weight: 500;
	transition: 0.2s;
}

.inquiry-title:hover {
	color: #228be6;
}

.breadcrumb {
	font-size: 0.9rem;
	margin-bottom: 30px;
}
</style>
</head>
<body>
	<jsp:include page="../include/headerUser.jsp" />

	<div class="d-flex border-top" style="min-height: calc(100vh - 60px);">
		
		<jsp:include page="../include/sidebarCs.jsp" >
			<jsp:param name="menu" value="inquiry" />
		</jsp:include>

		<div class="main-content flex-grow-1">
			<div class="container">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb">
						<li class="breadcrumb-item text-muted">고객센터</li>
						<li class="breadcrumb-item active fw-bold" aria-current="page">1:1 문의</li>
					</ol>
				</nav>
				
				<c:set var="isAdmin" value="false" />
				<c:forEach items="${loginUser.memberAuthVOList}" var="authVO">
				    <c:if test="${authVO.auth eq 'ROLE_ADMIN'}">
				        <c:set var="isAdmin" value="true" />
				    </c:if>
				</c:forEach>
				<div class="d-flex justify-content-between align-items-end mb-4">
					<h3 class="fw-bold m-0">
						<c:choose>
					        <c:when test="${isAdmin}">
					            문의내역 관리
					        </c:when>
					        <c:otherwise>
					            <i class="bi bi-chat-dots me-2"></i>나의 문의내역
					        </c:otherwise>
				    	</c:choose>
					</h3>
					<c:if test="${not isAdmin}">
				        <a href="${pageContext.request.contextPath}/tudio/inquiry/form"
				           class="btn btn-primary px-4 py-2">
				            <i class="bi bi-pencil-square me-2"></i>문의하기
				        </a>
				    </c:if>
				</div>

				<div class="card p-4">
					<div class="d-flex justify-content-end mb-3 gap-2">
				        <select class="form-select form-select-sm w-auto" id="searchType">
				            <option value="T" ${pagingVO.searchType eq 'T' ? 'selected' : ''}>제목</option>
				            <option value="C" ${pagingVO.searchType eq 'C' ? 'selected' : ''}>내용</option>
				            <option value="TC" ${pagingVO.searchType eq 'TC' ? 'selected' : ''}>제목+내용</option>
				            <c:if test="${isAdmin}">
				                <option value="W" ${pagingVO.searchType eq 'W' ? 'selected' : ''}>작성자</option>
				            </c:if>
				        </select>
				        
				        <div class="input-group input-group-sm" style="width: 250px;">
				            <input type="text" class="form-control" id="searchWord" value="${pagingVO.searchWord}" placeholder="검색어 입력">
				            <button class="btn btn-primary" type="button" id="searchBtn">검색</button>
				        </div>
				
				        <select class="form-select form-select-sm w-auto" id="statusFilter">
				            <option value="" ${empty pagingVO.searchStatus ? 'selected' : ''}>전체 상태</option>
				            <option value="N" ${pagingVO.searchStatus eq 'N' ? 'selected' : ''}>답변 대기</option>
				            <option value="Y" ${pagingVO.searchStatus eq 'Y' ? 'selected' : ''}>답변 완료</option>
				        </select>
				    </div>

					<table class="table mb-5">
						<thead>
							<tr class="text-center">
								<th style="width: 8%;">No</th>
							    <th style="width: 12%;">상태</th>
							    <th class="text-center">제목</th>
							    <c:if test="${isAdmin}">
							        <th style="width: 12%;">작성자</th>
							    </c:if>
							    <th style="width: 15%;">작성일</th>
							    <th style="width: 15%;">답변일</th>
							    <th style="width: 12%;">조회수</th>
							</tr>
						</thead>
						<tbody>
							<c:choose>
								<c:when test="${not empty pagingVO.dataList}">
									<c:forEach items="${pagingVO.dataList}" var="inquiry" varStatus="status">
										<tr class="text-center">
											<td>${pagingVO.totalRecord - (pagingVO.currentPage - 1) * 10 - status.index}</td>
											<td>
												<c:choose>
													<c:when test="${inquiry.replyStatus eq 'Y'}">
														<span class="badge-complete">답변완료</span>
													</c:when>
													<c:otherwise>
														<span class="badge-wait">답변대기</span>
													</c:otherwise>
												</c:choose>
											</td>
											<td class="text-start">
												<c:set var="detailPath" value="${isAdmin ? '/tudio/admin/inquiry/detail/' : '/tudio/inquiry/detail/'}" />
											    <a href="${pageContext.request.contextPath}${detailPath}${inquiry.inquiryNo}" class="inquiry-title"> 
											        ${inquiry.inquiryTitle} 
											        <i class="bi bi-lock-fill ms-1 text-muted small"></i>
											    </a>
											</td>
											<c:if test="${isAdmin}">
									            <td>${inquiry.userName}</td>
									        </c:if>
											<td>${inquiry.inquiryRegdate}</td>
											<td>
												<c:choose>
													<c:when test="${not empty inquiry.replyDate}">
										            	${inquiry.replyDate}
										        	</c:when>
													<c:otherwise>-</c:otherwise>
												</c:choose>
											</td>
											<td>${inquiry.inquiryHit}</td>
										</tr>
									</c:forEach>
								</c:when>
								<c:otherwise>
									<tr>
										<td colspan="${isAdmin ? 7 : 6}" class="text-center py-5 text-muted">문의 내역이 없습니다.</td>
									</tr>
								</c:otherwise>
							</c:choose>
						</tbody>
					</table>

					<div class="d-flex justify-content-center" id="pagingArea">
						${pagingVO.pagingHTML}
					</div>
				</div>
			</div>
		</div>
	</div>

<jsp:include page="../include/footer.jsp" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="${pageContext.request.contextPath}/js/footer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(function() {
	function getTargetUrl(pageNo) {
        var isAdminPage = window.location.pathname.includes('/admin/');
        var targetPath = isAdminPage ? "/tudio/admin/inquiry/list" : "/tudio/inquiry/list";
        
        var status = $("#statusFilter").val() || "";
        var type = $("#searchType").val() || "";
        var word = $("#searchWord").val() || "";
        
        return "${pageContext.request.contextPath}" + targetPath 
               + "?page=" + pageNo 
               + "&searchStatus=" + status 
               + "&searchType=" + type 
               + "&searchWord=" + encodeURIComponent(word);
    }

    // 검색 버튼 클릭 시
    $("#searchBtn").on("click", function() {
        location.href = getTargetUrl(1);
    });

    // 엔터키 검색 지원
    $("#searchWord").on("keypress", function(e) {
        if(e.keyCode == 13) $("#searchBtn").click();
    });

    // 상태 필터 변경 시
    $("#statusFilter").on("change", function() {
        location.href = getTargetUrl(1);
    });

    // 페이징 클릭 시
    $("#pagingArea").on("click", "a", function(event) {
        event.preventDefault();
        var pageNo = $(this).data("page");
        if(pageNo) location.href = getTargetUrl(pageNo);
    });
});
</script>
</body>
</html>