document.addEventListener("DOMContentLoaded", function() {
	
	const contextPath = document.body.dataset.contextPath;
	const projectNo = document.body.dataset.projectNo;
	const contentArea = $('#projectTabContent'); // 내용을 뿌려줄 영역
	
	/**
		* 2. 탭 컨텐츠 로드 함수
		* @param {string} tabName - 탭 이름 (tasks, board, member 등)
	*/
	function loadTab(tabName) {
		if(!tabName) return;

		// URL 생성 (Controller의 @GetMapping 매핑 주소와 일치)
		let url = "";
		url = `${contextPath}/tudio/project/${tabName}?projectNo=${projectNo}`;
		switch (tabName) {
		        case 'task': // 1. 업무
		            url = `${contextPath}/tudio/project/task/list?projectNo=${projectNo}`;
		            break;

		        case 'gantt': // 2. 차트
		            url = `${contextPath}/tudio/project/gantt/view?projectNo=${projectNo}`;
		            break;

		        case 'board': // 3. 게시판
		            url = `${contextPath}/tudio/project/board?projectNo=${projectNo}`;
		            break;

		        case 'calendar': // 4. 일정 (Calendar)
		            url = `${contextPath}/tudio/project/schedule?projectNo=${projectNo}`;
		            break;

		        case 'library': // 5. 자료실 (File/Library)
		            url = `${contextPath}/tudio/project/library/list?projectNo=${projectNo}`;
		            break;

		        case 'member': // 6. 구성원 (Member)
		            url = `${contextPath}/tudio/project/member/view?projectNo=${projectNo}`;
		            break;
					
				case 'stats': // 7. 통계
					url = `${contextPath}/tudio/project/stats/view?projectNo=${projectNo}`;
					break;
					
				case 'reservation': // 8. 회의실
			        url = `${contextPath}/tudio/project/reservation/view?projectNo=${projectNo}`;
	                break;
				
		        default: // 그 외 (예외 처리)
		            url = `${contextPath}/tudio/project/${tabName}?projectNo=${projectNo}`;
				
		    }
			console.log(`[탭 로딩 중] 탭이름: ${tabName} | 요청URL: ${url}`);
		
		
		// 서버에서 해당 URL의 JSP 내용을 가져와서 contentArea(#projectTabContent)에 채워넣기
		contentArea.load(url, function(response, status, xhr) {
			
			if (status == "error") {
				let msg = "해당 컨텐츠를 불러오는 중 오류가 발생했습니다.";
				console.error(`${msg} (${xhr.status} ${xhr.statusText})`);
				contentArea.html(`
			                <div class="tudio-empty">
			                    <i class="bi bi-exclamation-circle"></i>
			                    <p class="title">${msg}</p>
			                    <p class="small text-muted">컨트롤러의 Mapping 주소와 JS의 URL이 일치하는지 확인하세요.</p>
			                </div>
				`);
				return;
			}
			
			// 탭 메뉴별 로드
			$(document).trigger('tab:loaded', [tabName]);
		});
	}
	
	// -------------------------------------------------------------
	// 3. 초기 로딩 처리 (화면 켜지자마자 첫 번째 탭 로드)
	// -------------------------------------------------------------
	// 수정 포인트: #projectTabs 아이디를 명시해서 정확히 프로젝트 탭만 찾습니다.
	let activeTab = document.querySelector('#projectTabs .nav-link.active');

	// 만약 active된 게 없다면? (안전장치: 첫 번째 탭 강제 선택)
	if (!activeTab) {
		activeTab = document.querySelector('#projectTabs .nav-link');
		if(activeTab) activeTab.classList.add('active');
	}

	// 찾은 탭이 있다면 내용 로드 실행
	if (activeTab) {
		const tabName = activeTab.getAttribute('data-tab');
		loadTab(tabName); 
	}
	
	// 4. 탭 클릭 이벤트 리스너 (Bootstrap 5 이벤트)
	// 사용자가 탭을 누를 때마다 해당 내용을 로드합니다.
	const tabButtons = document.querySelectorAll('#projectTabs button[data-bs-toggle="tab"]');
	tabButtons.forEach(button => {
		button.addEventListener('shown.bs.tab', function(event) {
			const tabName = event.target.getAttribute('data-tab');
	    	loadTab(tabName);
	    });
	});
		
	// 북마크 설정 버튼
	const btnBookmark = document.getElementById('btnBookmark');
	if(btnBookmark) {
		btnBookmark.addEventListener("click", function(){
			toggleBookmark(contextPath, projectNo);
		})
	}
});


/**
 * 프로젝트 북마크 설정 함수
 */
function toggleBookmark(contextPath, projectNo) {
	$.ajax({
		url: `${contextPath}/tudio/project/bookmark`,
		type: 'post',
		data: JSON.stringify({projectNo}),
		contentType: 'application/json; charset=utf-8',
		dataType: 'json',
		success: function(res) {
			if(res.status === 'SUCCESS') {
				const bookmarkText = document.getElementById('bookmarkText');
				const icon = document.querySelector('#btnBookmark i');
				const btn = document.getElementById('btnBookmark');
				
				// 설정된 북마크 상태에 따라 아이콘 변경 (Y/N)
				if(res.bookmark === 'Y') {
					icon.classList.remove('bi-star');
					icon.classList.add('bi-star-fill');
					btn.title = "북마크 해제";
					bookmarkText.textContent = "북마크 해제";
				} else {
					icon.classList.remove('bi-star-fill');
					icon.classList.add('bi-star');
					btn.title = "북마크 설정";
					bookmarkText.textContent = "북마크 설정";
				}
			} else {
				Swal.fire('오류', '북마크 설정에 실패하였습니다!', 'error');
			}
		},
		error: function(xhr) {
			console.log(xhr);
			Swal.fire('에러', '서버 통신 중 오류가 발생했습니다!', 'error');
		}
	});
}

/* 프로젝트 팀원 초대를 위한 이메일 검색 및 선택 */
/* ==============================================
   [모달] 팀원 검색 및 초대 목록 관리 스크립트
   ============================================== */
// 초대 대기 중인 사용자 배열
let inviteCandidates = []; 

$(document).ready(function() {
    
    // 1. 엔터키 입력 시 검색 실행
    $('#searchEmailKeyword').on('keyup', function(e) {
        if (e.key === 'Enter') {
            searchMember();
        }
    });

    // 2. 검색 버튼 클릭
    $('#btnSearchMember').on('click', function() {
        searchMember();
    });

    // 3. 초대 적용 버튼 클릭 (모달 -> 메인 화면 이동)
    $('#processInviteBtn').on('click', function() {
        if (inviteCandidates.length === 0) {
            alert('초대할 사용자가 없습니다.');
            return;
        }
        
        // 메인 화면 테이블에 추가
        inviteCandidates.forEach(function(user) {
            addMemberToMainTable(user.memberNo, user.memberName, user.memberEmail, user.role);
        });

        // 초기화 및 모달 닫기
        inviteCandidates = [];
        updateCandidateList();
        $('#inviteModal').modal('hide');
    });
});

/**
 * 사용자 검색 AJAX
 */
function searchMember() {
    const email = $('#searchEmailKeyword').val().trim();
    const resultArea = $('#searchResultArea');

    if (!email) {
        alert('이메일을 입력해주세요.');
        return;
    }

    // 초기화
    resultArea.empty();

    $.ajax({
        url: CONTEXT_PATH + '/tudio/project/searchMember', // 백엔드 API 주소
        type: 'GET',
        data: { email: email },
        dataType: 'json',
        success: function(member) {
            if (!member) {
                resultArea.html(`
                    <div class="alert alert-warning d-flex align-items-center mt-2 mb-0" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>해당 이메일을 가진 사용자를 찾을 수 없습니다.</div>
                    </div>
                `);
            } else {
                renderSearchResult(member);
            }
        },
        error: function() {
            alert('사용자 검색 중 오류가 발생했습니다.');
        }
    });
}

/**
 * 검색 결과 렌더링
 */
function renderSearchResult(member) {
    const roleType = $('input[name="inviteType"]:checked').val(); // MEMBER or CLIENT
    const roleBadge = roleType === 'MEMBER' 
        ? '<span class="badge bg-primary">팀원</span>' 
        : '<span class="badge bg-warning text-dark">기업 담당자</span>';

    // 이미 대기 목록에 있는지 확인
    const isAlreadyAdded = inviteCandidates.some(c => c.memberEmail === member.memberEmail);
    // 이미 메인 화면(참여중)에 있는지 확인 (DOM 체크)
    const isAlreadyInMain = isMemberInMainTable(member.memberEmail);

    let btnHtml = '';
    if (isAlreadyAdded || isAlreadyInMain) {
        btnHtml = `<button class="btn btn-sm btn-secondary" disabled>이미 포함됨</button>`;
    } else {
        // [추가] 버튼 클릭 시 -> 대기 목록으로 이동
        btnHtml = `<button class="btn btn-sm btn-outline-primary btn-add-candidate" 
                    data-no="${member.memberNo}" 
                    data-name="${member.memberName}" 
                    data-email="${member.memberEmail}">
                    <i class="bi bi-plus-lg"></i> 추가
                   </button>`;
    }

    const html = `
        <div class="alert alert-light border shadow-sm mt-2 mb-0">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                            ${member.memberName.charAt(0)}
                        </div>
                    </div>
                    <div>
                        <div class="fw-bold text-dark">
                            ${member.memberName} <small class="text-muted fw-normal">(${member.memberEmail})</small>
                        </div>
                        <div class="small text-muted">
                            ${member.deptName ? member.deptName : '부서 미정'} 
                            ${member.positionName ? ' | ' + member.positionName : ''}
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <div class="mb-1">${roleBadge}</div>
                    ${btnHtml}
                </div>
            </div>
        </div>
    `;

    $('#searchResultArea').html(html);

    // 동적 생성된 버튼 이벤트 바인딩
    $('.btn-add-candidate').on('click', function() {
        const user = {
            memberNo: $(this).data('no'),
            memberName: $(this).data('name'),
            memberEmail: $(this).data('email'),
            role: $('input[name="inviteType"]:checked').val()
        };
        addCandidate(user);
    });
}

/**
 * 초대 대기 목록에 추가
 */
function addCandidate(user) {
    // 중복 체크
    if (inviteCandidates.some(u => u.memberEmail === user.memberEmail)) {
        alert('이미 목록에 추가된 사용자입니다.');
        return;
    }

    inviteCandidates.push(user);
    updateCandidateList();
    $('#searchResultArea').empty(); // 검색 결과 초기화 (선택했으므로)
    $('#searchEmailKeyword').val('').focus(); // 입력창 초기화
}

/**
 * 초대 대기 목록 UI 갱신
 */
function updateCandidateList() {
    const listEl = $('#inviteCandidateList');
    const countEl = $('#candidateCount');
    
    listEl.empty();
    countEl.text(inviteCandidates.length + "명");

    if (inviteCandidates.length === 0) {
        listEl.html('<li class="list-group-item bg-transparent text-center text-muted small py-4 empty-msg">초대할 사용자를 검색하여 추가해주세요.</li>');
        return;
    }

    inviteCandidates.forEach((user, index) => {
        const roleBadge = user.role === 'MEMBER' 
            ? '<span class="badge bg-primary me-2">팀원</span>' 
            : '<span class="badge bg-warning text-dark me-2">담당자</span>';

        const li = `
            <li class="list-group-item bg-white border rounded mb-1 d-flex justify-content-between align-items-center">
                <div>
                    ${roleBadge}
                    <span class="fw-bold">${user.memberName}</span>
                    <small class="text-muted ms-1">(${user.memberEmail})</small>
                </div>
                <button type="button" class="btn-close btn-sm" aria-label="Remove" onclick="removeCandidate(${index})"></button>
            </li>
        `;
        listEl.append(li);
    });
}

/**
 * 대기 목록에서 제거
 */
function removeCandidate(index) {
    inviteCandidates.splice(index, 1);
    updateCandidateList();
}

/**
 * 메인 테이블에 이미 존재하는지 확인 (이메일 기준)
 */
function isMemberInMainTable(email) {
    let exists = false;
    $('#participantList tr').each(function() {
        const rowEmail = $(this).find('td:nth-child(2)').text().trim();
        // 삭제된 멤버(취소선)가 아니라면 중복 처리
        if (rowEmail === email && !$(this).find('td:nth-child(2)').hasClass('text-decoration-line-through')) {
            exists = true;
            return false; // break loop
        }
    });
    return exists;
}


	