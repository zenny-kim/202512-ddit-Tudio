package kr.or.ddit.comment.service.impl;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.comment.mapper.ICommentMapper;
import kr.or.ddit.comment.service.ICommentService;
import kr.or.ddit.file.service.IFileService;
import kr.or.ddit.notification.service.INotificationService;
import kr.or.ddit.vo.CommentVO;
import kr.or.ddit.vo.NotificationSettingVO;
import kr.or.ddit.vo.NotificationVO;
import kr.or.ddit.vo.project.ProjectBoardVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : CommentServiceImpl
 * DESC : 게시판, 업무 등 댓글 기능 공통 서비스
 * </pre>
 * 
 * @author [대덕인재개발원] team1 KSJ
 * @version 1.0, 2026.01.14
 * 
 */


@Slf4j
@Service
public class CommentServiceImpl implements ICommentService {
	
	@Autowired
    private IFileService fileService;

	@Autowired
	private ICommentMapper commentMapper;
	
	@Autowired
	private INotificationService notiService;

	/**
	 * <p>댓글 작성</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글내용, 작성자, 댓글타입 등
	 * @param ServiceResult OK:성공, FAILED :실패
	 */
	@Override
	public ServiceResult insertComment(CommentVO commentVO) {
		ServiceResult result = ServiceResult.FAILED;
		
		List<MultipartFile> fileList = commentVO.getCmtFileList();
        if(fileList != null && !fileList.isEmpty()) {
            boolean hasFile = false;
            for(MultipartFile f : fileList) {
                if(f.getSize() > 0 && f.getOriginalFilename() != null && !f.getOriginalFilename().isEmpty()) {
                    hasFile = true;
                    break;
                }
            }

            if(hasFile) {
                int fileGroupNo = fileService.uploadFiles(fileList, commentVO.getMemberNo(), 412);
                commentVO.setFileGroupNo(fileGroupNo); 
            }
        }
		
		int status = commentMapper.insertComment(commentVO);
		if(status > 0) {
			result = ServiceResult.OK;
			
			
			if("B".equalsIgnoreCase(commentVO.getTargetType())) {
				int boNo = commentVO.getTargetId();
				int commentWriter = commentVO.getMemberNo();
				
				
				ProjectBoardVO vo =notiService.notiCommentNoti(boNo);
				int writerNo=vo.getWriterNo();
				String notiTitle = vo.getBoTitle();
				int projectNo = vo.getProjectNo();
				String categoryName = vo.getCategoryName();
				int categoryNo = vo.getCategoryNo();
				
				
				NotificationSettingVO notiMem =notiService.notiAllMember(writerNo);
				int boardWriter = notiMem.getMemberNo();
				
				 if( commentWriter != boardWriter) {
					 NotificationVO notiVO = new NotificationVO();
					 notiVO.setMemberNo(boardWriter);
					 notiVO.setTargetId(boNo);
					 notiVO.setNotiUrl("/tudio/project/board/detail?projectNo="+projectNo+"&boNo="+boNo);
					 String notiType = "";
					 String notiMessage = "";
					 
					 if("Y".equalsIgnoreCase(notiMem.getNotiBoComment()) && categoryNo == 2) {
						 notiType ="NOTI_ETC";
						 notiMessage= "["+notiTitle+"]에 댓글이 달렸습니다.";
					 } else if("Y".equalsIgnoreCase(notiMem.getNotiBoComment()) && categoryNo == 3){
						 notiType ="NOTI_ETC";
						 notiMessage= "["+notiTitle+"]에 댓글이 달렸습니다.";
					 } else if("Y".equalsIgnoreCase(notiMem.getNotiProjectNotice()) && categoryNo == 1) {
						 notiType = "NOTI_TASK";
						 notiMessage= "["+notiTitle+"]에 댓글이 달렸습니다.";
					 }
						
					  notiVO.setNotiType(notiType);
					  notiVO.setNotiMessage(notiMessage);

					int cnt= notiService.insertNotification(notiVO);
				 }
				 
				
			}
			
			
		} else {
			result = ServiceResult.FAILED;	
		}
		return result;
	}

	
	/**
	 * <p>댓글 목록</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 */
	@Override
	public List<CommentVO> selectCommentList(CommentVO commentVO) {
		return commentMapper.selectCommentList(commentVO);
	}

	/**
	 * <p>댓글 수정</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:삭제 성공, FAILED:삭제 실패
	 */
	@Override
	public ServiceResult updateComment(CommentVO commentVO) {
		ServiceResult result = null;
		int status = commentMapper.updateComment(commentVO);
		if(status>0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;
		}
		return result;
	}

	
	/**
	 * <p>댓글 삭제</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:삭제 성공, FAILED:삭제 실패
	 */
	@Override
	public ServiceResult deleteComment(CommentVO commentVO) {
		ServiceResult result = null;
		int status = commentMapper.deleteComment(commentVO);
		if(status>0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;
		}
		return result;
	}

	
	/**
	 * <p>대댓글 등록</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:성공, FAILED:실패
	 */
	@Override
	public ServiceResult insertReplyComment(CommentVO commentVO) {
		ServiceResult result = ServiceResult.FAILED;
		List<MultipartFile> fileList = commentVO.getCmtFileList();
        if(fileList != null && !fileList.isEmpty()) {
            boolean hasFile = false;
            for(MultipartFile f : fileList) {
                if(f.getSize() > 0 && f.getOriginalFilename() != null && !f.getOriginalFilename().isEmpty()) {
                    hasFile = true;
                    break;
                }
            }

            if(hasFile) {
                // 동일하게 파일 저장 호출
                int fileGroupNo = fileService.uploadFiles(fileList, commentVO.getMemberNo(), 413);
                commentVO.setFileGroupNo(fileGroupNo);
            }
        }
		int status = commentMapper.insertReplyComment(commentVO);
		
		
		if(status > 0) {
			result = ServiceResult.OK;
			
			
			if("B".equalsIgnoreCase(commentVO.getTargetType())) {
				
				int boNo = commentVO.getTargetId();
				int memberNo = commentVO.getMemberNo(); // 대댓글 작성자
				int parentCmtNo = commentVO.getCmtNo(); // 부모 댓글 번호
				
				
				// 게시글 작성자, 원댓글 작성자, 원댓글 내용 조회
				Map<String, Object> notiMap = new HashMap<>();
				notiMap.put("boNo", boNo);
				notiMap.put("parentCmtNo", parentCmtNo);
				
				
				Map<String, Object> selectNotiReply = notiService.selectNotiReply(notiMap);

				if(selectNotiReply != null) {
					int boardWriter = ((Number) selectNotiReply.get("boardWriter")).intValue(); // 게시글 작성자
					int rootWriter = ((Number) selectNotiReply.get("memberNo")).intValue(); // 부모댓글 작성자
					String content = (String) selectNotiReply.get("cmtContent");
					int projectNo = ((Number) selectNotiReply.get("projectNo")).intValue();
					String boTitle = (String) selectNotiReply.get("boTitle");
					int categoryNo = ((Number) selectNotiReply.get("categoryNo")).intValue();
					
					NotificationSettingVO notiAllMember = notiService.notiAllMember(rootWriter);
					// 조건
					if(memberNo != rootWriter && boardWriter!=rootWriter) {
							NotificationVO notiVO = new NotificationVO();
							
							notiVO.setMemberNo(rootWriter);
							notiVO.setNotiType("NOTI_COMMUNITY");
							notiVO.setTargetId(boNo);
							notiVO.setNotiUrl("/tudio/project/board/detail?projectNo="+projectNo+"&boNo="+boNo);
							String notiMessage="";
						
						if("Y".equalsIgnoreCase(notiAllMember.getNotiBoComment()) && categoryNo ==2) {
							notiMessage = "["+content+"]에 답글이 달렸습니다";
						} else if("Y".equalsIgnoreCase(notiAllMember.getNotiBoComment()) && categoryNo == 3) {
							notiMessage ="["+content+"]에 답글이 달렸습니다";
						}else if("Y".equalsIgnoreCase(notiAllMember.getNotiProjectNotice()) && categoryNo == 1){
							notiMessage = "["+content+"]에 답글이 달렸습니다";			
				 }
						notiVO.setNotiMessage(notiMessage);
						notiService.insertNotification(notiVO);	
			}	
					

					// 글 작성자에게도 다른 사람이 댓글/대댓을 달았을 경우 보내야 함 
					NotificationSettingVO notiMember = notiService.notiAllMember(boardWriter);
						if(memberNo != boardWriter) {
							
							NotificationVO notiVO = new NotificationVO();
							
							notiVO.setMemberNo(boardWriter);
							notiVO.setNotiType("NOTI_COMMUNITY");
							notiVO.setTargetId(boNo);
							notiVO.setNotiUrl("/tudio/project/board/detail?projectNo="+projectNo+"&boNo="+boNo);
							String notiMessage="";
							
							if("Y".equalsIgnoreCase(notiMember.getNotiBoComment()) && categoryNo ==2) {
								notiMessage = "["+boTitle+"]에 댓글이 달렸습니다";
							} else if("Y".equalsIgnoreCase(notiMember.getNotiBoComment()) && categoryNo == 3) {
								notiMessage ="["+boTitle+"]에 댓글이 달렸습니다";
							}else if("Y".equalsIgnoreCase(notiMember.getNotiProjectNotice()) && categoryNo == 1){
								notiMessage = "["+boTitle+"]에 댓글이 달렸습니다";			
					 }
							notiVO.setNotiMessage(notiMessage);
							notiService.insertNotification(notiVO);	
							
						}
					}	
				}
			
		} else {
			result = ServiceResult.FAILED;	
		}
		return result;
	}

}
