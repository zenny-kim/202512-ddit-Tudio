<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%-- 
    파일명: mytasks.jsp
    설명: 내 업무/활동 관리 페이지 (프로젝트별 업무 그룹화, 상세 패널 포함)
--%>

<div class="main-content-wrap" id="mainContent">
    <div class="container-fluid">
        
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1">내 업무 및 활동</h2>
                <p class="text-muted mb-0">프로젝트별로 분류된 내 업무를 확인하세요.</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                <i class="bi bi-plus-lg me-1"></i> 새 업무 등록
            </button>
        </div>

        <div class="mb-5">
            <div class="d-flex align-items-center mb-3 text-primary">
                <i class="bi bi-pin-angle-fill fs-5 me-2"></i>
                <span class="table-section-title">상단 고정된 업무 (중요)</span>
            </div>
            <div class="card shadow-sm border-0 overflow-hidden border-top border-primary border-3">
                <table class="table table-hover align-middle mb-0" style="table-layout: fixed;">
                    <thead class="table-light">
                        <tr>
                            <th class="col-pin">고정</th>
                            <th class="col-title">업무 제목</th>
                            <th class="col-priority">우선순위</th>
                            <th class="col-status">상태</th>
                            <th class="col-progress">진척도</th>
                            <th class="col-assignee">담당자</th>
                            <th class="col-date">마감 기한</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr onclick="openTaskDetail('TUDIO-001')" style="cursor: pointer;">
                            <td class="text-center"><i class="bi bi-pin-angle-fill pin-icon active"></i></td>
                            <td>
                                <span class="badge bg-light text-dark border me-1">Tudio 런칭</span>
                                <span class="fw-bold text-dark text-truncate-custom">프론트엔드 기본 구조 설계</span>
                            </td>
                            <td class="text-center"><span class="badge badge-priority-high">긴급</span></td>
                            <td class="text-center"><span class="badge bg-primary-subtle text-primary border border-primary-subtle">진행 중</span></td>
                            <td class="text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="progress flex-grow-1" style="height: 6px; max-width: 60px;">
                                        <div class="progress-bar bg-primary" style="width: 60%"></div>
                                    </div>
                                    <span class="ms-2 small text-muted">60%</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="profile-img-wrap bg-info">P</span> <span class="small">박개발</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="small">2025-12-20 <span class="d-day-text d-day-urgent">D-3</span></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="projectTaskContainer">
        </div>

    </div>
</div>

<div id="taskDetailPanel" class="task-detail-panel">
    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
        <h5 class="fw-bold mb-0">업무 상세 정보</h5>
        <button class="btn-close" onclick="closeTaskPanel()"></button>
    </div>
    <form id="taskEditForm">
        <div class="mb-3"><label class="form-label small fw-bold text-muted">업무 제목</label><input type="text" class="form-control fw-bold" id="detailTitle"></div>
        <div class="row mb-3">
            <div class="col-6"><label class="form-label small fw-bold text-muted">작성자</label><input type="text" class="form-control-plaintext" id="detailAuthor" readonly></div>
            <div class="col-6"><label class="form-label small fw-bold text-muted">최종 수정일</label><input type="text" class="form-control-plaintext" id="detailModDate" readonly></div>
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label class="form-label small fw-bold text-muted">진행 상태</label>
                <select class="form-select form-select-sm" id="detailStatus">
                    <option value="todo">할 일</option>
                    <option value="in_progress">진행 중</option>
                    <option value="done">완료</option>
                </select>
            </div>
            <div class="col-6">
                <label class="form-label small fw-bold text-muted">우선순위</label>
                <select class="form-select form-select-sm" id="detailPriority">
                    <option value="high">긴급</option>
                    <option value="medium">보통</option>
                    <option value="low">낮음</option>
                </select>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted">마감일</label>
            <input type="date" class="form-control" id="detailEndDate">
        </div>
        <div class="mb-3">
            <label class="form-label small fw-bold text-muted d-flex justify-content-between">
                <span>진척도</span><span class="text-primary" id="detailProgressText">0%</span>
            </label>
            <input type="range" class="form-range" id="detailProgress" min="0" max="100" step="5" oninput="document.getElementById('detailProgressText').innerText = this.value + '%'">
        </div>
        <div class="mb-4"><label class="form-label small fw-bold text-muted">내용</label><textarea class="form-control" id="detailContent" rows="5"></textarea></div>
        <div class="d-flex justify-content-between pt-3 border-top" id="detailActionBtns">
            <button type="button" class="btn btn-outline-danger btn-sm">삭제</button>
            <button type="button" class="btn btn-primary btn-sm">수정 저장</button>
        </div>
    </form>
</div>

<div class="modal fade" id="newTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">새 업무 등록</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form>
                    <div class="mb-3"><label class="form-label small fw-bold">프로젝트 선택</label>
                        <select class="form-select">
                            <option>Tudio 런칭</option>
                            <option>마케팅 캠페인</option>
                            <option>Alpha 신규</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold">업무 제목</label><input type="text" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small fw-bold">마감일</label><input type="date" class="form-control"></div>
                     <div class="row mb-3">
                        <div class="col-6"><label class="form-label small fw-bold">우선순위</label><select class="form-select"><option>보통</option><option>긴급</option></select></div>
                        <div class="col-6"><label class="form-label small fw-bold">진행 상태</label><select class="form-select"><option>할 일</option><option>진행 중</option></select></div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold">내용</label><textarea class="form-control" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" onclick="alert('등록되었습니다.')">등록</button></div>
        </div>
    </div>
</div>

<script>
    /* ============================================================
       [Data] 데이터 Mockup (실제 개발 시 JSP EL이나 AJAX로 대체)
    ============================================================ */
    const myTasksData = [
        {
            id: 'MKT-015',
            title: '마케팅 캠페인 슬로건 시안 작성 및 검토 요청',
            project: '마케팅 캠페인',
            priority: 'medium',
            status: 'todo',
            progress: 0,
            assignee: '김사용',
            dueDate: '2025-12-31'
        },
        {
            id: 'MKT-018',
            title: 'SNS 광고 소재 제작',
            project: '마케팅 캠페인',
            priority: 'high',
            status: 'in_progress',
            progress: 30,
            assignee: '김사용',
            dueDate: '2025-12-25'
        },
        {
            id: 'TUDIO-102',
            title: '로그인 페이지 UI 퍼블리싱',
            project: 'Tudio 런칭',
            priority: 'high',
            status: 'in_progress',
            progress: 45,
            assignee: '김사용',
            dueDate: '2025-12-18' 
        },
        {
            id: 'ALPHA-005',
            title: '알파 프로젝트 기획서 초안 작성',
            project: 'Alpha 신규',
            priority: 'low',
            status: 'todo',
            progress: 10,
            assignee: '김사용',
            dueDate: '2026-01-15'
        },
        {
            id: 'TUDIO-105',
            title: 'API 연동 테스트',
            project: 'Tudio 런칭',
            priority: 'high',
            status: 'todo',
            progress: 0,
            assignee: '김사용',
            dueDate: '2025-12-24'
        }
    ];

    /* ============================================================
       [Logic] 날짜 계산 및 데이터 렌더링
    ============================================================ */
    
    // 날짜 차이(D-Day) 계산 함수
    function getDday(dateString) {
        const today = new Date('2025-12-17'); // [시연용 오늘 날짜 고정]
        const target = new Date(dateString);
        const diffTime = target - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    // 프로젝트별 그룹화 및 HTML 렌더링 함수
    function renderTasks() {
        const container = document.getElementById('projectTaskContainer');
        container.innerHTML = ''; // 초기화

        // 1. 프로젝트별 그룹화
        const tasksByProject = {};
        myTasksData.forEach(task => {
            if (!tasksByProject[task.project]) {
                tasksByProject[task.project] = [];
            }
            tasksByProject[task.project].push(task);
        });

        // 2. 프로젝트 이름순 정렬
        const sortedProjects = Object.keys(tasksByProject).sort();

        // 3. 프로젝트별 테이블 생성
        sortedProjects.forEach(projectName => {
            const tasks = tasksByProject[projectName];
            
            // 마감일(D-Day) 순 정렬
            tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            let rowsHtml = '';
            tasks.forEach(task => {
                const dDay = getDday(task.dueDate);
                let dDayStr = '';
                let dDayClass = 'd-day-normal';

                if (dDay === 0) { dDayStr = 'D-Day'; dDayClass = 'd-day-urgent'; }
                else if (dDay < 0) { dDayStr = `D+\${Math.abs(dDay)}`; dDayClass = 'd-day-urgent'; }
                else { dDayStr = `D-\${dDay}`; if(dDay <= 7) dDayClass = 'd-day-urgent'; }

                let priorityBadge = '';
                if(task.priority === 'high') priorityBadge = '<span class="badge badge-priority-high">긴급</span>';
                else if(task.priority === 'medium') priorityBadge = '<span class="badge badge-priority-medium">보통</span>';
                else priorityBadge = '<span class="badge badge-priority-low">낮음</span>';

                let statusBadge = '';
                if(task.status === 'in_progress') statusBadge = '<span class="badge bg-primary-subtle text-primary border border-primary-subtle">진행 중</span>';
                else if(task.status === 'done') statusBadge = '<span class="badge bg-success-subtle text-success border border-success-subtle">완료</span>';
                else statusBadge = '<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">할 일</span>';

                rowsHtml += `
                    <tr onclick="openTaskDetail('\${task.id}')" style="cursor: pointer;">
                        <td class="text-center"><i class="bi bi-pin-angle pin-icon text-muted"></i></td>
                        <td><span class="fw-bold text-dark text-truncate-custom" title="\${task.title}">\${task.title}</span></td>
                        <td class="text-center">\${priorityBadge}</td>
                        <td class="text-center">\${statusBadge}</td>
                        <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="progress flex-grow-1" style="height: 6px; max-width: 60px;">
                                    <div class="progress-bar bg-success" style="width: \${task.progress}%"></div>
                                </div>
                                <span class="ms-2 small text-muted">\${task.progress}%</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="profile-img-wrap bg-primary" style="font-size:0.6rem;">K</span> <span class="small">\${task.assignee}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="small">\${task.dueDate} <span class="d-day-text \${dDayClass}">\${dDayStr}</span></div>
                        </td>
                    </tr>
                `;
            });

            // 프로젝트 섹션 HTML 생성 (CSS 클래스 의존)
            const sectionHtml = `
                <div class="mb-5">
                    <div class="project-group-header text-secondary">
                        <i class="bi bi-folder2-open fs-5 me-2"></i>
                        <span class="table-section-title">\${projectName}</span>
                        <span class="badge bg-light text-secondary border ms-2">\${tasks.length}</span>
                    </div>
                    <div class="card shadow-sm border-0 overflow-hidden">
                        <table class="table table-hover align-middle mb-0" style="table-layout: fixed;">
                            <thead class="table-light">
                                <tr>
                                    <th class="col-pin">고정</th>
                                    <th class="col-title">업무 제목</th>
                                    <th class="col-priority">우선순위</th>
                                    <th class="col-status">상태</th>
                                    <th class="col-progress">진척도</th>
                                    <th class="col-assignee">담당자</th>
                                    <th class="col-date">마감 기한</th>
                                </tr>
                            </thead>
                            <tbody>
                                \${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            container.innerHTML += sectionHtml;
        });
    }

    // 상세 패널 열기
    function openTaskDetail(id) {
        document.getElementById('taskDetailPanel').classList.add('open');
    }

    // 상세 패널 닫기
    function closeTaskPanel() {
        document.getElementById('taskDetailPanel').classList.remove('open');
    }

    // 초기화 및 이벤트 리스너
    document.addEventListener('DOMContentLoaded', () => {
        renderTasks();
        
        // 핀 아이콘 토글 이벤트 (이벤트 위임)
        document.addEventListener('click', function(e) {
            if(e.target.classList.contains('pin-icon')) {
                e.stopPropagation();
                if(e.target.classList.contains('active')) {
                    e.target.classList.remove('active', 'bi-pin-angle-fill');
                    e.target.classList.add('bi-pin-angle', 'text-muted');
                } else {
                    e.target.classList.add('active', 'bi-pin-angle-fill');
                    e.target.classList.remove('bi-pin-angle', 'text-muted');
                }
            }
        });
    });
</script>