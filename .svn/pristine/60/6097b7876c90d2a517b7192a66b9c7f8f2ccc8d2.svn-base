<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
<title>Tudio</title>
	<title>Tudio - 프로젝트 초대 인증</title>
	<jsp:include page="/WEB-INF/views/include/common.jsp" />
	<style>
		.footer {
		    margin-left: 0 !important;
		    width: 100%;
		}
	</style>
</head>
<body class="bg-light min-vh-100 d-flex flex-column">

	<jsp:include page="/WEB-INF/views/include/header_guest.jsp"/>
	
	<main class="flex-grow-1 d-flex align-items-center justify-content-center">
	    <div class="card shadow-sm" style="width: 400px;">
	        <div class="card-header bg-primary text-white text-center py-3">
	            <h5 class="mb-0 fw-bold"><i class="bi bi-envelope-check me-2"></i>프로젝트 초대 인증</h5>
	        </div>
	        <div class="card-body p-4">
	            <p class="text-center text-muted mb-4">
	                이메일로 전송된 인증 코드를 입력하여<br>프로젝트 참여를 확정해주세요.
	            </p>
	            
	            <form id="verifyForm">
	                <input type="hidden" id="projectNo" value="${projectNo}">
	                <div class="mb-3">
	                    <label for="inviteCode" class="form-label fw-bold">인증 코드</label>
	                    <input type="text" class="form-control text-center fs-4 letter-spacing-2" 
	                           id="inviteCode" value="${inviteCode}" placeholder="코드 입력" required>
	                </div>
	                <button type="button" class="btn btn-primary w-100 py-2" id="btnConfirm">
	                    인증하기
	                </button>
	            </form>
	        </div>
	    </div>
	</main>
		
	<jsp:include page="/WEB-INF/views/include/footer.jsp"/>
	
	<script>
		$(document).ready(function() {
		    
		    var isGuest = "${isGuest}";
	
		    // 1. 비로그인(Guest) 사용자일 경우 -> 경고창 띄우고 로그인 페이지로 이동
		    if (isGuest === "true") {
		        Swal.fire({
		            icon: 'warning',
		            title: '로그인 필요',
		            text: '프로젝트에 참여하려면 먼저 로그인이 필요합니다.',
		            confirmButtonText: '로그인 하러 가기',
		            confirmButtonColor: '#0d6efd',
		            allowOutsideClick: false,
		            allowEscapeKey: false
		        }).then((result) => {
		            if (result.isConfirmed) {
		                location.href = '${pageContext.request.contextPath}/tudio/login';
		            }
		        });	        
		    } else {
		        // 2. 로그인 된 사용자일 경우     
		        // 수동 버튼 클릭 이벤트
		        $("#btnConfirm").on("click", function() {
					const projectNo = $("#projectNo").val();
					const code = $("#inviteCode").val();
					
					if(!code) { 
						Swal.fire('알림', '인증 코드를 입력해주세요.', 'warning'); 
						return; 
					}					
		            requestVerification(projectNo, code);
		        });
		    }
		});
	
		// 인증 요청 처리
		function requestVerification(pNo, authCode) {
			// 버튼 클릭 시 로딩 표시
			Swal.fire({
				title: '인증 확인 중...',
				text: '잠시만 기다려주세요.',
				allowOutsideClick: false,
				didOpen: () => {
					Swal.showLoading();
				}
			});
			
		    $.ajax({
		        url: `${pageContext.request.contextPath}/tudio/project/invite/confirm`,
		        type: 'POST',
		        contentType: 'application/json; charset=utf-8',
		        data: JSON.stringify({ projectNo: pNo, code: authCode }),
		        success: function(res) {
		            if (res.status === "SUCCESS") {
						Swal.fire({ 
							icon: 'success', 
							title: '인증 성공!', 
							text: '프로젝트 멤버로 참여되었습니다.',
							confirmButtonText: '프로젝트로 이동'
						}).then(() => movePage(res.redirectUrl));
		            } else if (res.status === "ALREADY_JOINED") {	// 이미 참여중인 경우
						Swal.fire({
							icon: 'info',
							title: '이미 참여중입니다',
							text: '이미 인증이 완료된 프로젝트입니다.\n해당 프로젝트로 이동합니다.',
							confirmButtonText: '이동'
						}).then(() => movePage(res.redirectUrl));
					} else { // 실패
						let msg = '코드가 올바르지 않거나 만료되었습니다.';
						if(res.status === 'INVALID_MEMBER') msg = '초대 명단에 존재하지 않습니다.';
						Swal.fire('인증 실패', msg, 'error');
					}
		        },
		        error: function() {
		            Swal.fire('오류', '서버 통신 중 오류가 발생했습니다.', 'error');
		        }
		    });
		}
		
		// 페이지 이동
		function movePage(url) {
		    let targetUrl = url;
		    let contextPath = '${pageContext.request.contextPath}';
		    if (!targetUrl.startsWith(contextPath)) {
		        targetUrl = contextPath + targetUrl;
		    }
		    location.href = targetUrl;
		}
	</script>
</body>
</html>