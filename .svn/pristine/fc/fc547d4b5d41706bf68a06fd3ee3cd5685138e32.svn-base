<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tudio</title>
<jsp:include page="/WEB-INF/views/include/common.jsp" />
<link rel="stylesheet"
	href="${pageContext.request.contextPath}/css/project_common.css">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script
	src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>
<style>
.ck-editor__editable {
	min-height: 400px !important;
	border: 1px solid #ccced1 !important;
} /* 에디터 높이 확보 */
.bg-light {
	background-color: #f8fafc !important;
}
/* 테이블 마우스 오버 시 발생하는 배경색 변화와 글자 흔들림 방지 */
.table.table-hover-custom, 
.table.table-hover-custom tr, 
.table.table-hover-custom td {
    --bs-table-hover-bg: transparent !important; /* 배경색 변화 제거 */
    --bs-table-accent-bg: transparent !important;
    transition: none !important;                 /* 움직임 효과 제거 */
    transform: none !important;                  /* 위치 이동 제거 */
}
/* 1. 테이블 전체 스타일 수정 */
.custom-table {
    border-collapse: collapse !important;
    border-left: none !important;  /* 왼쪽 외곽선 제거 */
    border-right: none !important; /* 오른쪽 외곽선 제거 */
    border-top: 1px solid #dee2e6 !important; /* 상단 실선 */
    border-bottom: 1px solid #dee2e6 !important; /* 하단 실선 */
}

/* 2. 내부 셀 테두리 설정 */
.custom-table th, 
.custom-table td {
    border: 1px solid #dee2e6 !important; /* 내부를 한줄 실선으로 */
    border-left: none !important;  /* 셀의 왼쪽 선 제거 (중복 방지 및 외곽선 제거) */
    border-right: none !important; /* 셀의 오른쪽 선 제거 */
}

/* 3. 첫 번째 칸(헤더)과 마지막 칸의 간격 조절 */
.custom-table th:first-child, 
.custom-table td:first-child {
    border-left: none !important;
    padding-left: 15px;
}

.custom-table th:last-child, 
.custom-table td:last-child {
    border-right: none !important;
    padding-right: 15px;
}

/* 4. 제목(th) 배경색 및 글자색 살짝 조정 */
.custom-table th.bg-light {
    background-color: #fcfcfc !important; /* 너무 칙칙하지 않은 밝은 회색 */
    font-weight: 600;
    color: #444;
}
</style>
</head>
<body>
	<section class="tudio-section">
		<!-- APPROVAL FORM 화면 입니다. -->
		<jsp:include page="../include/headerUser.jsp" />

		<div class="d-flex">
			<!-- 사이드바 -->
			<jsp:include page="../include/sidebarUser.jsp">
				<jsp:param name="menu" value="approval" />
			</jsp:include>

			<main class="main-content-wrap flex-grow-1 px-4 pt-4 pb-5">
				<div class="container-fluid">

					<div class="d-flex justify-content-between align-items-center mb-4">
						<!-- 소제목 -->
						<h2 class="h3 fw-bold text-primary-dark mb-0">
							<i class="bi bi-file-earmark-check me-2"></i> 결재 문서 작성
						</h2>
					</div>




					<div class="tudio-scope">
						<div class="d-flex justify-content-between align-items-end mb-0">
							<ul class="nav nav-tabs custom-index-tabs border-0 mb-0">
								<li class="nav-item">
									<button class="nav-link active" type="button">
										<i class="bi bi-pencil-fill"></i> <span>기안서 작성</span>
									</button>
								</li>
							</ul>
						</div>

						<div class="tab-content-card p-4">
							<form id="approvalForm">
								<div class="row mb-4">
									<div class="col-md-7">
										<table class="table table-bordered align-middle mb-0 custom-table table-hover-custom" style="height: 100%;">
											<tr>
												<th class="bg-light text-center" style="width: 25%;">프로젝트<span
													class="text-danger">*</span></th>
												<td><select name="projectNo" id="projectSelect"
													class="form-select form-select-sm">
														<option value="0">-- 프로젝트 선택 --</option>
														<c:forEach items="${myProjectList}" var="p">
															<option value="${p.projectNo}"
																${p.projectNo == projectNo ? 'selected' : ''}>
																${p.projectName}</option>
														</c:forEach>
												</select></td>
											</tr>
											<tr>
												<th class="bg-light text-center">기안자</th>
												<td class="small">
											        ${loginUser.memberName} 
											        <span class="text-muted">
											            (<c:out value="${loginUser.memberDepartment}" default="부서미지정" /> / 
											             <c:out value="${loginUser.memberPosition}" default="직책미지정" />)
											        </span>
											    </td>
											</tr>
											<tr>
												<th class="bg-light text-center">기안일자</th>
												<td class="small" id="currentDate"></td>
											</tr>
											<tr>
												<th class="bg-light text-center">보안</th>
												<td>
													<div class="d-flex gap-3 small">
														<div class="form-check">
															<input class="form-check-input" type="radio"
																name="security" id="secPublic" value="Y" checked>
															<label class="form-check-label" for="secPublic">공개
																<span class="text-muted">(모두 조회 가능)</span>
															</label>
														</div>
														<div class="form-check">
															<input class="form-check-input" type="radio"
																name="security" id="secPrivate" value="N"> <label
																class="form-check-label" for="secPrivate">비공개 <span
																class="text-muted">(결재자만 가능)</span></label>
														</div>
													</div>
												</td>
											</tr>
										</table>
									</div>

									<div class="col-md-5">
										<div
											class="d-flex justify-content-end align-items-start gap-1">
											<div class="border text-center" style="width: 80px;">
												<div class="bg-light border-bottom p-1 small">기안</div>
												<div
													class="p-2 d-flex align-items-center justify-content-center"
													style="height: 60px;">${userName}</div>
												<div class="bg-light border-top p-1 small">완료</div>
											</div>

											<c:forEach var="i" begin="1" end="5">
												<div class="border text-center approver-slot" id="slot-${i}"
													style="width: 80px; position: relative;">
													<div class="bg-light border-bottom p-1 small">승인</div>
													<div
														class="p-2 d-flex align-items-center justify-content-center slot-name"
														style="height: 60px; font-size: 0.85rem;">
														<span class="text-muted" style="cursor: pointer;"
															onclick="openApproverModal()">지정</span>
													</div>
													<input type="hidden" class="mem-no" value="">
													<div class="bg-light border-top p-1 small">&nbsp;</div>
												</div>
											</c:forEach>
										</div>
										<div class="text-end mt-2">
											<button type="button" class="btn btn-xs btn-outline-primary"
												onclick="openApproverModal()">
												<i class="bi bi-person-plus"></i> 결재선 지정
											</button>
										</div>
									</div>
								</div>

								<div class="mb-4">
									<label class="fw-bold mb-2">제목 <span
										class="text-danger">*</span>
									</label>
									<div class="row g-2">
										<div class="col-3">
											<select class="form-select" id="docType"
												onchange="changeTemplate(this.value)">
												<option value="">-- 양식 선택 --</option>
												<option value="resource">자원/인력 투입요청</option>
												<option value="schedule">일정변경요청</option>
												<option value="budget">예산조정요청</option>
												<option value="check">검수 및 보고</option>
												<option value="final">최종 완료 보고</option>
												<option value="final">기타</option>
											</select>
										</div>
										<div class="col-9">
											<input type="text" name="documentTitle" class="form-control"
												id="docTitle" placeholder="제목을 입력하세요">
										</div>
									</div>
								</div>

								<div class="mb-4">
									<label class="fw-bold mb-2">상세 내용 <span
										class="text-danger">*</span></label>
									<div id="editor"></div>
								</div>

								<div class="p-3 border rounded bg-light">
									<button type="button"
										class="btn btn-sm btn-outline-secondary mb-2">
										<i class="bi bi-paperclip"></i> 파일 첨부
									</button>
									<div class="text-muted small">첨부된 파일이 없습니다.</div>
								</div>
							</form>
						</div>

						<div class="d-flex justify-content-between mt-4 border-top pt-3">
							<button type="button" class="tudio-btn tudio-btn-outline"
								onclick="history.back()">취소</button>
							<div class="gap-2 d-flex">
								<button type="button" class="tudio-btn tudio-btn-light">임시저장</button>
								<button type="button" class="tudio-btn tudio-btn-primary"
									id="btnSubmit">결재상신</button>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</section>
	<script type="text/javascript">
const contextPath = "/tudio";
let myEditor;

$(document).ready(function() {
    // 1. 에디터 초기화
    ClassicEditor
        .create(document.querySelector('#editor'), {
            language: 'ko'
        })
        .then(editor => { 
            myEditor = editor; 
            console.log("Editor initialized");
        })
        .catch(error => { console.error(error); });
}); 

const now = new Date();
const formattedDate = now.getFullYear() + "-" + (now.getMonth() + 1).toString().padStart(2, '0') + "-" + now.getDate().toString().padStart(2, '0');
$("#currentDate").text(formattedDate);


function setApproverList(selectedMembers) {
    // selectedMembers는 [{memNo: 18, name: '이름'}, ...] 형태의 배열
    
    // 일단 칸을 초기화
    $(".slot-name").html('<span class="text-muted" style="cursor:pointer;" onclick="openApproverModal()">지정</span>');
    $(".approver-slot input").val("");

    selectedMembers.forEach((member, index) => {
        if(index < 5) { // 최대 5명까지
            let slot = $("#slot-" + (index + 1));
            slot.find(".slot-name").text(member.name);
            slot.find(".mem-no").val(member.memNo);
        }
    });
}

// 2. 양식 변경 함수
function changeTemplate(val) {
    const templates = {
        resource: '<h3>[자원/인력 투입요청]</h3><table border="1" style="width:100%"><tr><th>투입인원</th><td></td></tr></table>',
        budget: '<h3>[예산조정요청]</h3><p>사유:</p>', // <-- 쉼표 추가
        schedule: '<h3>[일정변경요청]</h3><p>기존 일정: <br>변경 일정: </p>'
    };
    if(val && myEditor) myEditor.setData(templates[val]);
}

// 3. 결재자 지정 (테스트용)
function openApproverModal() {
    let html = `
        <div class="border approver-row" style="width: 100px;">
            <input type="hidden" class="mem-no" value="202401"> 
            <div class="bg-light border-bottom p-1">승인</div>
            <div class="p-3">김철수</div>
        </div>
    `;
    $("#approverList").prepend(html);
}

// 4. 결재 상신
function submitApproval() {
	
    const projectNo = $("#projectSelect").val();
    if (projectNo === "0" || projectNo === "") {
        alert("관련 프로젝트를 선택해주세요.");
        $("#projectSelect").focus();
        return; // 함수 종료 (AJAX 실행 안 함)
    }

    const docType = $("#docType").val();
    if (docType === "") {
        alert("문서 양식을 선택해주세요. (없을 경우 '기타' 선택)");
        $("#docType").focus();
        return;
    }

    const docTitle = $("#docTitle").val().trim();
    if (docTitle === "") {
        alert("제목을 입력해주세요.");
        $("#docTitle").focus();
        return;
    }
	
    let approvalList = [];
    $(".approver-row").each(function(index) {
        approvalList.push({
            memberNo: $(this).find(".mem-no").val(),
            approvalStep: index + 1,
            approvalStatus: 607
        });
    });
    
    if(approvalList.length === 0) {
        alert("결재자를 지정해주세요.");
        return;
    }

    // [중요] input 태그에 id가 없을 수 있으므로 name 선택자도 함께 씁니다.
    let draftData = {
        projectNo: $("select[name='projectNo']").val(),
        documentType: 601, // 임시 코드값 (DB 공통코드에 맞게 수정)
        documentTitle: $("input[name='documentTitle']").val(),
        documentContent: myEditor.getData(),
        approvalList: approvalList
    };

    $.ajax({
        url: contextPath + "/approval/insert",
        type: "POST",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(draftData),
        success: function(res) {
            if(res === "success") {
                alert("상신되었습니다.");
                location.href = contextPath + "/approval/list";
            } else if(res === "login_required") {
                alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                location.href = contextPath + "/login"; // 로그인 페이지 경로에 맞게 수정
            } else {
                alert("저장 실패: " + res);
            }
        },
        error: function(xhr) {
            console.error(xhr);
            alert("서버 통신 오류가 발생했습니다.");
        }
    });
}

// 버튼 클릭 이벤트 연결
$(function() {
    // "결재상신" 버튼 클래스를 가진 요소를 클릭했을 때 실행
    $("#btnSubmit").on("click", submitApproval);
});
</script>
</body>
</html>