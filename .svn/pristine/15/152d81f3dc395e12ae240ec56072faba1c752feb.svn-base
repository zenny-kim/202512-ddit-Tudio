<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%-- 
    파일명: new_task.jsp
    설명: 새 업무 생성 페이지 (기본 정보, 일정/담당자, 파일 권한 설정)
--%>

<div class="main-content-wrap flex-grow-1">
    <div class="container-fluid" style="max-width: 1000px; margin: 0 auto;">
        
        <div class="mb-4">
            <a href="project_detail.jsp" class="back-link">
                <i class="bi bi-arrow-left me-1"></i> Tudio 런칭 프로젝트로 돌아가기
            </a>
            <div class="d-flex justify-content-between align-items-end mt-2">
                <h2 class="fw-bold mb-0">새 업무 생성</h2>
                <div>
                    <button type="button" class="btn btn-light border me-2" onclick="location.href='project_detail.jsp'">취소</button>
                    <button type="button" class="btn btn-primary px-4" onclick="submitTask()">업무 생성</button>
                </div>
            </div>
        </div>

        <form id="createTaskForm">
            
            <div class="card mb-4 p-4">
                <h5 class="form-section-title">기본 정보</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">프로젝트 <span class="text-danger">*</span></label>
                        <select class="form-select" disabled> <option selected>Tudio 런칭 프로젝트</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">업무 제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" placeholder="업무 내용을 간략히 입력하세요" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <label class="form-label">태그</label>
                        <input type="text" class="form-control" placeholder="#기획 #디자인 #긴급 (쉼표로 구분)">
                        <div class="form-text">태그를 입력하면 캘린더나 간트차트에서 쉽게 필터링할 수 있습니다.</div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 p-4">
                <h5 class="form-section-title">일정 및 담당자</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">상태</label>
                        <select class="form-select">
                            <option value="requested">요청</option>
                            <option value="in_progress" selected>진행</option>
                            <option value="feedback">피드백</option>
                            <option value="done">완료</option>
                            <option value="on_hold">보류</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">우선순위</label>
                        <select class="form-select">
                            <option value="critical">긴급</option>
                            <option value="high">우선</option>
                            <option value="medium" selected>보통</option>
                            <option value="low">낮음</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">시작일</label>
                        <input type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">마감일</label>
                        <input type="date" class="form-control">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">담당자 지정</label>
                    <div class="input-group mb-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">팀원 선택</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="addAssignee('박개발 (Dev)')">박개발 (Dev)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="addAssignee('이디자인 (Design)')">이디자인 (Design)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="addAssignee('정고객 (Client)')">정고객 (Client)</a></li>
                        </ul>
                        <input type="text" class="form-control" placeholder="이름으로 검색하여 추가..." readonly>
                    </div>
                    <div id="assigneeList">
                        <span class="badge bg-primary fw-normal d-flex align-items-center p-2">
                            <span class="me-2">김사용 (PM)</span> <i class="bi bi-person-fill"></i>
                        </span>
                    </div>
                </div>
            </div>

            <div class="card mb-5 p-4">
                <h5 class="form-section-title">상세 내용 및 설정</h5>
                
                <div class="mb-4">
                    <label class="form-label">업무 설명</label>
                    <textarea class="form-control" rows="8" placeholder="업무에 대한 상세한 가이드라인, 요구사항 등을 입력하세요."></textarea>
                </div>

                <div class="mb-4 permission-box">
                    <label class="form-label d-block mb-3 fw-bold text-dark">
                        <i class="bi bi-lock-fill me-2 text-primary"></i>파일 열람 및 다운로드 권한 설정
                    </label>
                    
                    <div class="d-flex flex-column gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filePermission" id="permAll" value="all" checked>
                            <label class="form-check-label" for="permAll">
                                <strong>전체 공개</strong>
                                <div class="text-muted small">프로젝트에 참여 중인 모든 구성원(고객사 포함)이 첨부파일을 열람할 수 있습니다.</div>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filePermission" id="permInternal" value="internal">
                            <label class="form-check-label" for="permInternal">
                                <strong>사내 공개 (고객사 제외)</strong>
                                <div class="text-muted small">우리 회사 내부 팀원들만 파일을 볼 수 있습니다. (고객사 계정 접근 불가)</div>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="filePermission" id="permAssignee" value="assignee">
                            <label class="form-check-label" for="permAssignee">
                                <strong>비공개 (담당자 및 관리자 전용)</strong>
                                <div class="text-muted small">지정된 담당자와 프로젝트 관리자만 파일을 확인할 수 있습니다.</div>
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label">파일 첨부</label>
                    <input type="file" class="form-control" multiple>
                    <div class="form-text">최대 10개, 개당 50MB 이하의 파일만 업로드 가능합니다.</div>
                </div>
            </div>

            <div class="d-flex justify-content-end mb-5">
                <button type="button" class="btn btn-light border px-4 me-2" onclick="location.href='project_detail.jsp'">취소</button>
                <button type="button" class="btn btn-primary px-5 fw-bold" onclick="submitTask()">업무 생성</button>
            </div>

        </form>
    </div>
</div>

<script>
    // 담당자 추가 로직
    function addAssignee(name) {
        const container = document.getElementById('assigneeList');
        
        // 중복 체크
        if (container.innerHTML.includes(name)) {
            alert('이미 추가된 담당자입니다.');
            return;
        }

        const badge = document.createElement('span');
        // CSS 클래스는 제공해주신 style.css 및 Bootstrap 활용
        badge.className = 'badge bg-secondary fw-normal d-flex align-items-center p-2';
        badge.innerHTML = `
            <span class="me-2">\${name}</span> 
            <i class="bi bi-x-lg" style="cursor:pointer;" onclick="this.parentElement.remove()"></i>
        `;
        container.appendChild(badge);
    }

    // 업무 생성 제출
    function submitTask() {
        // [실제 개발 시] 필수값 체크 등 유효성 검사 로직 추가 필요
        
        // 파일 권한 확인 (라디오 버튼 값 읽기)
        const permElement = document.querySelector('input[name="filePermission"]:checked');
        const perm = permElement ? permElement.value : 'all';
        
        let permText = "";
        if(perm === 'all') permText = "전체 공개";
        else if(perm === 'internal') permText = "사내 공개";
        else permText = "비공개";

        if(confirm(`[파일 권한: \${permText}] 으로 설정되었습니다.\n업무를 생성하시겠습니까?`)) {
            // [실제 개발 시] AJAX로 폼 데이터 전송
            alert('새 업무가 성공적으로 생성되었습니다.');
            location.href = 'project_detail.jsp'; // 프로젝트 상세로 이동
        }
    }
</script>