package kr.or.ddit.survey.service.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import jakarta.transaction.Transactional;
import kr.or.ddit.ServiceResult;
import kr.or.ddit.survey.mapper.ISurveyMapper;
import kr.or.ddit.survey.service.ISurveyService;
import kr.or.ddit.vo.survey.SurveyAnswerVO;
import kr.or.ddit.vo.survey.SurveyParticipationVO;
import kr.or.ddit.vo.survey.SurveyVO;

@Service
public class SurveyServiceImpl implements ISurveyService {
	
	@Autowired
	private ISurveyMapper surveyMapper;
	
	@Override
	public SurveyVO getSurveyDetail(int surveyNo, int memberNo) {
		SurveyVO surveyVO = surveyMapper.getSurveyDetail(surveyNo);
        // 로그인한 사람(memberNo > 0)이라면, 참여 기록이 있는지 미리 확인
        if (surveyVO != null && memberNo > 0) {
            SurveyParticipationVO checkVO = new SurveyParticipationVO();
            checkVO.setSurveyNo(surveyNo);
            checkVO.setMemberNo(memberNo);
            
            // DB에 기록이 있는지 조회
            int count = surveyMapper.checkAlreadyParticipated(checkVO);
            
            // 기록이 있으면 VO에 "true" 도장 쾅!
            if (count > 0) {
                surveyVO.setParticipated(true);
            }
        }
		return surveyVO;
	}

	@Override
	@Transactional
	public ServiceResult insertParticipation(SurveyParticipationVO participationVO) {
		// 중복참여 확인
		int count = surveyMapper.checkAlreadyParticipated(participationVO);
		if (count > 0) {
	        return ServiceResult.EXSIST;
	    }
		
		// 참여 정보 저장
		int masterResult = surveyMapper.insertParticipation(participationVO);
		
		if (masterResult > 0) {
			int participationNo = participationVO.getSurveyParticipationNo();
			for (SurveyAnswerVO answerVO : participationVO.getAnswerList()) {
				answerVO.setSurveyParticipationNo(participationNo);
	        }

            // 상세 답변 저장
            int detailResult = surveyMapper.insertAnswers(participationVO.getAnswerList());

            // 질문이 20개, 결과 20개 성공(OK)
            if (detailResult > 0) {
                return ServiceResult.OK;
            }
        }
        return ServiceResult.FAILED;
	}

	/// 관리자용 ///
	
	// 관리자 - 설문 목록 조회
	@Override
	public List<Map<String, Object>> selectSurveyList() {
		return surveyMapper.selectSurveyList();
	}

	// 관리자 - 설문 등록
	@Override
	public int insertSurveyAdmin(Map<String, Object> surveyMap) {
		return surveyMapper.insertSurveyAdmin(surveyMap);
	}

	// 관리자 - 설문 수정
	@Override
	public int updateSurveyAdmin(Map<String, Object> surveyMap) {
		return surveyMapper.updateSurveyAdmin(surveyMap);
	}

	@Override
	public Map<String, Object> resultSurveyAdmin(int surveyNo) {
		Map<String, Object> resultMap = new HashMap<>();

        // (1) 설문 기본 정보 가져오기 (제목, 기간, 총 참여자수 등)
        Map<String, Object> info = surveyMapper.selectSurveyInfo(surveyNo);
        resultMap.put("info", info);

        // (2) 통계 데이터 가져오기 (질문-보기-투표수가 쭉 펼쳐진 Raw 데이터)
        List<Map<String, Object>> rawData = surveyMapper.selectSurveyResultRaw(surveyNo);
        
        // (3) 데이터를 질문별로 묶기 (Grouping)
        List<Map<String, Object>> statsList = new ArrayList<>();
        Map<String, Map<String, Object>> questionMap = new LinkedHashMap<>(); // 순서 유지

        for (Map<String, Object> row : rawData) {
            String qNo = String.valueOf(row.get("QUESTION_NO"));
            
            // 질문 생성 (없으면 만들기)
            if (!questionMap.containsKey(qNo)) {
                Map<String, Object> qData = new HashMap<>();
                qData.put("QUESTION_NO", row.get("QUESTION_NO"));
                qData.put("QUESTION_CONTENT", row.get("QUESTION_CONTENT"));
                qData.put("TOTAL_VOTES", 0); 
                qData.put("options", new ArrayList<Map<String, Object>>()); 
                
                questionMap.put(qNo, qData);
                statsList.add(qData);
            }
            
            // 보기(Option) 추가
            Map<String, Object> currentQuestion = questionMap.get(qNo);
            List<Map<String, Object>> options = (List<Map<String, Object>>) currentQuestion.get("options");
            
            Map<String, Object> option = new HashMap<>();
            option.put("ANSWER_NO", row.get("ANSWER_NO"));
            option.put("ANSWER_CONTENT", row.get("ANSWER_CONTENT"));
            
            // 투표수 처리
            int voteCount = row.get("VOTE_COUNT") == null ? 0 : Integer.parseInt(String.valueOf(row.get("VOTE_COUNT")));
            option.put("VOTE_COUNT", voteCount);
            
            options.add(option);
            
            // 총 투표수 누적
            int currentTotal = (int) currentQuestion.get("TOTAL_VOTES");
            currentQuestion.put("TOTAL_VOTES", currentTotal + voteCount);
        }

        resultMap.put("stats", statsList);
		return resultMap;
	}
	
	

}
