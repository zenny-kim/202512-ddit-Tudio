package kr.or.ddit.member.service.impl;

import java.io.BufferedReader;
import java.io.File;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import org.apache.commons.io.FilenameUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.configurationprocessor.json.JSONArray;
import org.springframework.boot.configurationprocessor.json.JSONObject;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import jakarta.transaction.Transactional;
import kr.or.ddit.ServiceResult;
import kr.or.ddit.member.mapper.MemberMapper;
import kr.or.ddit.member.service.MemberService;
import kr.or.ddit.vo.ClientCompanyVO;
import kr.or.ddit.vo.FileDetailVO;
import kr.or.ddit.vo.FileGroupVO;
import kr.or.ddit.vo.MemberVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class MemberServiceImpl implements MemberService {

	@Autowired
	private BCryptPasswordEncoder passwordEncoder;

	@Autowired
	private MemberMapper memberMapper;

	@Autowired
	private JavaMailSender mailSender;

	@Value("${kr.or.ddit.upload.path}")
	private String uploadPath;

	private final long MAX_FILE_SIZE = 2 * 1024 * 1024;

	// 아이디 찾기
	@Override
	public String findMemberId(MemberVO memberVO) {
		return memberMapper.findMemberId(memberVO);
	}

	// 비밀번호 찾기
	@Override
	public MemberVO findMemberPw(MemberVO memberVO) {
		MemberVO result = memberMapper.findMemberPw(memberVO);
		if (result != null) {
			// 임시 비밀번호 생성 (예: tudio1234)
			String tempPw = "tudio" + (int) (Math.random() * 8999 + 1000);
			String encodedPassword = passwordEncoder.encode(tempPw);

			result.setMemberPw(encodedPassword);
			memberMapper.updateNewMemberPw(result);

			sendTempPwEmail(result.getMemberEmail(), tempPw);
			log.info("발급된 임시 비번: {}, 암호화된 비번: {}", tempPw, encodedPassword);
			return result;
		}
		return null;
	}

	// 임시비밀번호 발송
	public void sendTempPwEmail(String toEmail, String tempPw) {
		try {
			MimeMessage message = mailSender.createMimeMessage();
			MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");

			try {
				helper.setFrom("sujeong1246@gmail.com", "TUDIO 관리자");
			} catch (UnsupportedEncodingException e) {
				e.printStackTrace();
			}
			helper.setTo(toEmail);
			helper.setSubject("[TUDIO] 임시 비밀번호 발급 안내입니다.");

			// 임시 비밀번호 HTML 템플릿
			String html = "<div style='margin:0;padding:0;background-color:#f4f7f9;font-family:\"Apple SD Gothic Neo\", \"Malgun Gothic\", sans-serif;'>"
					+ "    <table width='100%' cellpadding='0' cellspacing='0' style='padding:40px 0;'>"
					+ "        <tr>" + "            <td align='center'>"
					+ "                <table width='500' style='background-color:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.1);'>"
					+ "                    " + "                    <tr>"
					+ "                        <td style='background-color:#0d6efd;padding:30px;text-align:center;'>"
					+ "                            <h1 style='color:#ffffff;margin:0;font-size:24px;letter-spacing:-1px;'>TUDIO</h1>"
					+ "                        </td>" + "                    </tr>" + "                    "
					+ "                    <tr>" + "                        <td style='padding:40px 30px;'>"
					+ "                            <h2 style='color:#333;margin:0 0 20px 0;font-size:20px;'>임시 비밀번호 안내</h2>"
					+ "                            <p style='color:#666;font-size:15px;line-height:1.6;margin:0 0 30px 0;'>"
					+ "안녕하세요. TUDIO를 이용해 주셔서 감사합니다.<br>" + "요청하신 임시 비밀번호를 발급해 드립니다."
					+ "                            </p>" + "                            "
					+ "                            <div style='background-color:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:25px;text-align:center;margin-bottom:30px;'>"
					+ "                                <span style='display:block;color:#999;font-size:13px;margin-bottom:8px;'>임시 비밀번호</span>"
					+ "                                <strong style='color:#0d6efd;font-size:28px;letter-spacing:2px;'>"
					+ tempPw + "</strong>" + "                            </div>"
					+ "                            <p style='color:#e74c3c;font-size:13px;margin:0;'>"
					+ "※ 로그인 후 마이페이지에서 반드시 비밀번호를 변경해 주세요." + "                            </p>"
					+ "                        </td>" + "                    </tr>" + "                    "
					+ "                    <tr>"
					+ "                        <td style='background-color:#f8f9fa;padding:20px;text-align:center;border-top:1px solid #eeeeee;'>"
					+ "                            <p style='color:#999;font-size:12px;margin:0;'>본 메일은 발신 전용 메일입니다.</p>"
					+ "                        </td>" + "                    </tr>" + "                </table>"
					+ "            </td>" + "        </tr>" + "    </table>" + "</div>";
			helper.setText(html, true);
			mailSender.send(message);

		} catch (MessagingException e) {
			e.printStackTrace();
			// 에러 처리 로직
		}
	}

	// 이미지 파일 저장
	private String fileUpload(MultipartFile file, String folderName, int memberNo, String fileType) {
		if (file == null || file.isEmpty()) {
			return "";
		}

		// 1. 폴더 경로 설정
		String savePath = uploadPath + folderName;
		File fileDir = new File(savePath);
		if (!fileDir.exists()) {
			fileDir.mkdirs();
		}

		try {
			// 2. 파일 복사
			String originalName = file.getOriginalFilename();
			String saveName = UUID.randomUUID().toString() + "_" + originalName;
			File target = new File(savePath, saveName);
			file.transferTo(target);

			// 3. DB 저장을 위한 경로
			String webPath = "/upload/" + folderName + "/" + saveName;

			// 4. FileGroupVO
			FileGroupVO fileGroupVO = new FileGroupVO();
			fileGroupVO.setMemberNo(memberNo);
			fileGroupVO.setFileGroupType(fileType); // "08" 또는 "09"

			// 5. FileDetailVO
			FileDetailVO fileDetailVO = new FileDetailVO();
			fileDetailVO.setFileGroupNo(fileGroupVO.getFileGroupNo());
			fileDetailVO.setFileOriginalName(originalName);
			fileDetailVO.setFileSaveName(saveName);
			fileDetailVO.setFilePath(webPath);
			fileDetailVO.setFileSize((int) file.getSize());
			fileDetailVO.setFileExtension(FilenameUtils.getExtension(originalName));
			fileDetailVO.setFileMime(file.getContentType());

			if ("08".equals(fileType)) {
				// 프로필 이미지일 때 (타입 08)
				memberMapper.insertProfileFileGroup(fileGroupVO);
				fileDetailVO.setFileGroupNo(fileGroupVO.getFileGroupNo());
				memberMapper.insertProfileFileDetail(fileDetailVO);
			} else if ("09".equals(fileType)) {
				// 사업자등록증일 때 (타입 09)
				memberMapper.insertbizFileFileGroup(fileGroupVO);
				fileDetailVO.setFileGroupNo(fileGroupVO.getFileGroupNo());
				memberMapper.insertbizFileFileDetail(fileDetailVO);
			}
			return webPath;
		} catch (Exception e) {
			log.error("파일 저장 에러: {}", e.getMessage());
			throw new RuntimeException("파일 저장 중 오류가 발생했습니다.");
		}
	}

	// 아이디 중복 확인
	@Override
	public ServiceResult idCheck(String memberId) {
		ServiceResult result = null;
		MemberVO member = memberMapper.idCheck(memberId);
		if (member != null) {
			result = ServiceResult.EXSIST;
			// 아이디와 일치하는 회원이 있으면 EXSIST
		} else {
			result = ServiceResult.NOTEXSIST;
			// 회원 존재하지 않으면 NOTEXSIST
		}
		return result;
	}

	// 사용자 회원가입
	@Transactional
	@Override
	public ServiceResult signup(MemberVO memberVO,ClientCompanyVO companyVO) {
		// 비밀번호 암호화
		if (memberVO.getMemberPw() != null) {
			memberVO.setMemberPw(passwordEncoder.encode(memberVO.getMemberPw()));
		}

		// 1. 회원 정보 저장 (Insert) -> 여기서 memberNo가 생성됨
		int status = memberMapper.memberSignup(memberVO);
		if (status > 0) {
			// 2. 권한 저장
			memberMapper.insertMemberAuth(memberVO.getMemberNo(), "ROLE_MEMBER");

			// 3. 프로필 이미지 처리 (folderName을 "profile"로 전달)
			String profilePath = fileUpload(memberVO.getProfileImageFile(), "profile", memberVO.getMemberNo(), "08");

			// 4. 회원 테이블에 프로필 이미지 경로 업데이트
			if (!profilePath.equals("")) {
				memberVO.setMemberProfileimg(profilePath);
				memberMapper.updateMemberProfile(memberVO);
			}
			return ServiceResult.OK;
		}
		return ServiceResult.FAILED;
	}

	// 사용자 회원가입 이메일 인증
	public void emailAuthCode(String memberEmail, String authCode) {
		try {
			MimeMessage message = mailSender.createMimeMessage();
			MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
			// 한 번에 예외처리 하도록 수정
			helper.setFrom("sujeong1246@gmail.com");
			helper.setTo(memberEmail);
			helper.setSubject("[TUDIO] 회원가입 이메일 인증번호입니다.");

			String html = "<div style='text-align:center; padding:20px; border:1px solid #ddd;'>" + "<h2>이메일 인증번호</h2>"
					+ "<p>아래의 인증번호 6자리를 회원가입 화면에 입력해주세요.</p>" + "<h1 style='color:#0d6efd; letter-spacing:5px;'>"
					+ authCode + "</h1>" + "</div>";

			helper.setText(html, true);
			mailSender.send(message);
			log.info("메일 발송 성공! 대상: {}, 번호: {}", memberEmail, authCode);

		} catch (Exception e) {
			log.error("메일 발송 중 에러 발생: " + e.getMessage());
			throw new RuntimeException(e);
		}
	}

	// 사업자번호 db 조회
	@Override
	public ClientCompanyVO getCompanyInfoFromDb(String companyNo) {
		return memberMapper.getCompanyInfo(companyNo);
	}

	// 사업자번호 api 조회
	@Override
	public Map<String, Object> getCompanyNameFromApi(String companyNo) {
		Map<String, Object> result = new HashMap<>();

		String apiKey = "HvSmJ3zXG09nGsyqARen21GSJP5QIvtN";
		String cleanNo = companyNo.replace("-", ""); // 숫자만 추출
		String apiUrl = "https://bizno.net/api/fapi?key=" + apiKey + "&gb=1&q=" + cleanNo + "&type=json";

		try {
			URL url = new URL(apiUrl);
			HttpURLConnection conn = (HttpURLConnection) url.openConnection();
			conn.setRequestMethod("GET");

			// API 응답 읽기
			BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream(), "UTF-8"));
			StringBuilder sb = new StringBuilder();
			String line;
			while ((line = br.readLine()) != null) {
				sb.append(line);
			}
			br.close();

			// JSON 파싱 (org.json 라이브러리 사용 가정)
			JSONObject jsonObj = new JSONObject(sb.toString());
			int resultCode = jsonObj.getInt("resultCode");

			result.put("resultCode", resultCode);

			if (resultCode == 0) {
				JSONArray items = jsonObj.getJSONArray("items");
				if (items.length() > 0) {
					result.put("companyName", items.getJSONObject(0).getString("company"));
				}
			}
		} catch (Exception e) {
			e.printStackTrace();
			result.put("resultCode", -9); // 기타 통신 에러
		}
		return result;
	}

	// 기업 회원가입
	@Transactional
	@Override
	public ServiceResult clientSignup(MemberVO memberVO, ClientCompanyVO companyVO, MultipartFile profileImageFile,
			MultipartFile bizFile) {
		// 비밀번호 암호화
		if (memberVO.getMemberPw() != null) {
			memberVO.setMemberPw(passwordEncoder.encode(memberVO.getMemberPw()));
		}
		int companyStatus = memberMapper.insertClientCompany(companyVO);
		if (companyStatus > 0) {
			memberVO.setCompanyNo(companyVO.getCompanyNo());
			int status = memberMapper.memberSignup(memberVO);
			if (status > 0) {
				memberMapper.insertMemberAuth(memberVO.getMemberNo(), "ROLE_CLIENT");
				fileUpload(profileImageFile, "profile", memberVO.getMemberNo(), "08");
				fileUpload(bizFile, "bizFile", memberVO.getMemberNo(), "09");

				return ServiceResult.OK;
			}
		}
		return ServiceResult.FAILED;
	}

}


