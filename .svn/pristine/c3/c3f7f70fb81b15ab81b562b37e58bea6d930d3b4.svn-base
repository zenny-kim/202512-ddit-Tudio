<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/projectTabMemberList.css">
<div class="tab-content-card" id="tabMember" data-project-no="${projectNo}">

	<!-- ===== 구성원 탭 컨텐츠 시작 ===== -->
	<section class="member-panel">

		<main class="project-main">

			<!-- 좌측 : 업무 현황 차트 -->
			<section class="main-card chart-area">
				<h3 class="card-title">진행 중인 담당 업무 현황</h3>
				<div class="chart-box">
					<!-- chart.js / echarts 들어갈 자리 -->
					<canvas id="memTaskChart"></canvas>
					<div id="noTaskMsg" style="display:none; text-align:center; padding:24px 0; font-weight:600;">
   				 진행중인 업무가 없습니다
				</div>
				</div>
			</section>

		
			<section class="main-card member-area">
				<h3 class="card-title">구성원 목록 (${projectMemberCount})</h3>
				
			
			<!--  검색 영역 -->
			  <div class="d-flex gap-2 align-items-center mb-2">
			    <select id="searchType" class="form-select form-select-sm" style="width:140px;">
			      <option value="memberName">이름</option>
			      <option value="companyName">회사명</option>
			      <option value="memberDepartment">부서</option>
			    </select>
			    
			    <input id="searchWord" class="form-control form-control-sm" style="max-width:240px;"
			           type="text" placeholder="검색어 입력" />
			
			    <button id="memSearchBtn" class="btn btn-sm btn-primary" type="button">검색</button>
			    </div>
			<!--  검색 영역 -->
			
				<table class="member-table">
					<thead>
						<tr>
							<th>No</th>
							<th>구성원 이름</th>
							<th>회사명</th>
							<th>부서</th>
							<th>직급</th>
							<th>채팅</th>
						</tr>
					</thead>
		
					<tbody id="memTbody">
							<!-- 비동기 렌더링 -->
					</tbody>
					
				</table>
			</section>

		</main>

	</section>
	
</div>

	<!-- ===== 구성원 상세 모달 (Bootstrap) ===== -->
	<div class="modal fade" id="memberModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content member-modal">

				<div class="modal-header">
					<div>
						<h5 class="modal-title">구성원 상세 정보</h5>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body">
					<!-- 상단 -->
					<div class="modal-body">

						<!-- ===== 상단 카드 (사진 스타일) ===== -->
						<div class="memTopCard">
							<!--     <div class="memAvatarCircle" id="mProfile">프로필</div> -->
							<div class="memAvatarCircle">
								<img id="mAvatarImg" alt="profile" />
							</div>

							<div class="memName" id="mName">이름</div>

							<div class="memStatLine">
								<div class="memStatItem">
									<div class="k">총 업무</div>
									<div class="v">
										<span id="mTotal">0</span>개
									</div>
								</div>
								<div class="memStatItem">
									<div class="k">상위 업무</div>
									<div class="v">
										<span id="mTask">0</span>개
									</div>
								</div>
								<div class="memStatItem">
									<div class="k">하위 업무</div>
									<div class="v">
										<span id="mTaskSub">0</span>개
									</div>
								</div>

							</div>
						</div>

						<!-- ===== 하단 Information ===== -->
						<div class="memInfoWrap">
							<div class="memInfoTitle">Infomation</div>

							<div class="memInfoBox">
								<div class="infoRow">
									<div class="label">이메일</div>
									<div class="val" id="mEmail">-</div>
								</div>

								<div class="infoRow">
									<div class="label">연락처</div>
									<div class="val" id="mTel">-</div>
								</div>

								<div class="infoRow">
									<div class="label">참여일</div>
									<div class="val" id="mDate">-</div>
								</div>
							</div>
						</div>

						<!-- 기존에 있던 힌트 div는 유지(안 쓰면 숨김 처리됨) -->
						<div class="mm-desc" id="mProgHint" style="display: none;"></div>
					</div>

				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary btn-sm"
						data-bs-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>


<!-- 플러그인 CDN 추가. 파이조각 위에 숫자값 표시를 하려고 추가함 -->
<script src="${pageContext.request.contextPath}/js/footer.js"></script>

<script type="text/javascript">

// 1. 모달 이벤트 리스너
document.getElementById('memberModal').addEventListener('show.bs.modal', async(event)=>{
	const target = event.relatedTarget; // 얘가 td일 수도, span일 수도 있음
	const row = target.closest(".member-name"); // member-name td 찾기
	if (!row) return;

	const memberNo = row.dataset.memberNo;

   /* Spring EL과 자바스크립트 템플릿 String 문법 충돌 방지 (\ 추가) */
   const url =  "/tudio/project/member/memberModal?projectNo=" + encodeURIComponent(projectNo)
   + "&memberNo=" + encodeURIComponent(memberNo);

   // 서버 호출
   try {

	   const res = await fetch(url);
	   if (!res.ok) {
	     console.error("memberModal 응답 실패:", res.status, url);
	     return;
	   }
	   const data = await res.json();

      // 모달에 값 채우기
      document.getElementById('mName').innerText = data.memberName;
      document.getElementById('mEmail').innerText = data.memberEmail;
      document.getElementById('mTel').innerText = data.memberTel;
      document.getElementById('mDate').innerText = data.projectMemregdate;

      
      // 업무 수 (nullish coalescing 사용)
      document.getElementById("mTotal").innerText = data.totalCnt ?? 0;
      document.getElementById("mTask").innerText  = data.ingCnt  ?? 0;
      document.getElementById("mTaskSub").innerText  = data.ingSubCnt ?? 0;
      

      // 프로필 이미지 처리
      const img = document.getElementById("mAvatarImg");
      img.src = data.memberProfileImg ? data.memberProfileImg : "/images/default_profile.png";
      
   } catch (err) {
      console.error("모달 데이터 로드 실패:", err);
   }
});

//2. 차트 데이터를 불러오고 그리는 비동기 함수
async function loadMemberChart() {
	
	var canvasEl = document.getElementById("memTaskChart"); // 존재여부 체크, 화면 숨김 제어
	var noTaskMsg = document.getElementById("noTaskMsg");

    var canvas = document.querySelector("#memTaskChart"); // 렌더링 대상

    
    try {
    	const response = await fetch("/tudio/project/member/memberChart?projectNo=" + encodeURIComponent(projectNo));

        if (!response.ok) {
            throw new Error(`서버 통신 오류: ${response.status}`);
        }

        const data = await response.json();

        // data 안전 처리
        const safeData = Array.isArray(data) ? data : [];
        
        console.log("safeData : ",safeData);

        // 담당업무 0개 제외 (여기가 핵심) 배열에서 조건을 만족하는 요소를 남김. 배열순회
        const filteredData = safeData.filter(item => ((item.ingCnt ?? 0) + (item.ingSubCnt ?? 0)) > 0);
        
        // 진행중인 총 업무 개수가 많은 기준으로 내림차순 정렬하기
        filteredData.sort((a,b) =>{
        	const aTotal = (a.ingCnt ?? 0) +(a.ingSubCnt ?? 0);
        	const bTotal = (b.ingCnt ?? 0) + (b.ingSubCnt ?? 0);
        	  return bTotal - aTotal;
        	
        })
        
        
        console.log("filteredData : ",filteredData);

        // 전부 0개면 차트 영역 숨김 + 기존 차트 제거 후 종료
        if (filteredData.length === 0) {
            if (window.memChartInstance != undefined) { // 차트 만든적이 있냐
                window.memChartInstance.destroy(); 
                window.memChartInstance = undefined;
            }
            canvasEl.style.display = "none";
            noTaskMsg.style.display = "block";
            return;
           
        } else {
        	noTaskMsg.style.display = "none";
        	canvasEl.style.display = "block";
        }

        // 데이터 가공. 새 배열 생성. memberName와 totalWorkCnt뽑아서
        var labels = filteredData.map(item => item.memberName); 
        
        // 빨강(상위), 파랑(하위)
        var upperValues  = filteredData.map(item => item.ingCnt ??0);
        var subValues = filteredData.map(item => item.ingSubCnt ?? 0);

        var palette = ['#4e79a7', '#f28e2b', '#bab0ab', '#edc949', '#76b7b2', '#59a14f', '#2f4b7c', '#e15759', '#79706e', '#ff9da7'];
        var bgColors = filteredData.map((_, i) => palette[i % palette.length]);
		// 팔레트 부족 언디파인드 방지, 가독성
        
        
        // 기존 차트 파괴 (중복 방지)
        if (window.memChartInstance != undefined) {
            window.memChartInstance.destroy();
        }

        // 차트 생성
        window.memChartInstance = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                	label: '상위업무',
                    data: upperValues,
                    backgroundColor: '#e15759',
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8 ,       // 그 안에서 막대 비율
                    barThickness: 8       // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                },
                {
                	label: '하위업무',
                    data: subValues,
                    categoryPercentage: 0.6,  // 카테고리(행)에서 차지하는 비율
                    barPercentage: 0.8,        // 그 안에서 막대 비율
                    barThickness: 8,        // ★ 숫자 낮출수록 얇아짐 (예: 8~14)
                    backgroundColor: '#4e79a7'
                },
                
                ]
            },
            options: {
            	 layout: {
            		    padding: { right: 24 }   // 16~40 사이로 조절
            		  },
            	indexAxis:'y', 	// 가로 막대 핵심
                responsive: true,
                maintainAspectRatio: false,
                scales:{
                	x:{
                		beginAtZero:true,
                		grace: '10%',   // 끝에 여유 (Chart.js v3+)
                		ticks:{precision:1}	// 정수만
                		
                	}
                },
                plugins: {
                    legend: { 
                    	position: 'top' 
                    	
                    },
                    datalabels: {
                    	 anchor: 'end',
                    	 align: 'end',
                    	 offset: 4,
                    	 clip: false,     //  중요: 잘림 방지
                    	 clamp: true,	  // 캔버스 밖으로 너무 나가면 안쪽으로 밀어줌(버전에 따라 지원
                         font: { weight: '700', size: 11 },
                  	     formatter: (v) => {
                  	    	 if(!v || v===0)return null; // 0이면 숫자 0표시안함
                  	    	 return v;
                  	     }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

    } catch (error) {
        console.error("차트 로딩 실패:", error);
    }
}

var memState = {
  searchType: "memberName",
  searchWord: ""
};
var memTbody = document.getElementById("memTbody");
var searchTypeEl = document.getElementById("searchType");
var searchWordEl = document.getElementById("searchWord");
var memSearchBtn = document.getElementById("memSearchBtn");

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function renderMemberList(list) {
  if (!Array.isArray(list) || list.length === 0) {
    memTbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; padding:18px 0; color:#888;">
          검색 결과가 없습니다.
        </td>
      </tr>
    `;
    return;
  }

  memTbody.innerHTML = list.map((l, idx) => {
    const roleBadge =
      (l.projectRole === "MANAGER") ? `<span class="role-blue">(PM)</span>` :
      (l.projectRole === "CLIENT")  ? `<span class="role-blue">(기업관리자)</span>` : "";

    return `
      <tr>
        <td>\${idx + 1}</td>
        <td class="member-name"
            data-member-no="\${escapeHtml(l.memberNo)}"
            data-bs-toggle="modal"
            data-bs-target="#memberModal">
          \${escapeHtml(l.memberName)} \${roleBadge}
        </td>
        <td>\${escapeHtml(l.companyName || "")}</td>
        <td>\${escapeHtml(l.memberDepartment || "")}</td>
        <td>\${escapeHtml(l.memberPosition || "")}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" type="button">
            <i class="bi bi-chat-square-text"></i>
          </button>
        </td>
      </tr>
    `;
  }).join("");
}

async function loadMemberList() {
  const params = new URLSearchParams();
  params.set("projectNo", projectNo);

  if (memState.searchWord && memState.searchWord.trim().length > 0) {
    params.set("searchType", memState.searchType);
    params.set("searchWord", memState.searchWord.trim());
  }
  console.log(params.toString());

  const url = "/tudio/project/member/listData?" + params.toString();

  try {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) {
    	const text = await response.text(); // 서버 에러 페이지/ 메세지 보기
      console.error("구성원 목록 응답 실패:", res.status, url, text);
      return;
    }

    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.listData || []);
    console.log(list);
    renderMemberList(list);

  } catch (e) {
    console.error("구성원 목록 로드 실패:", e);
  }
}

// 검색 버튼
memSearchBtn.addEventListener("click", () => {
	console.log("검색 버튼 클릭...!");
	console.log(searchTypeEl.value);
	console.log(searchWordEl.value);
  memState.searchType = searchTypeEl.value;
  memState.searchWord = searchWordEl.value || "";
  loadMemberList();
});

// 엔터 검색
searchWordEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    memState.searchType = searchTypeEl.value;
    memState.searchWord = searchWordEl.value || "";
    loadMemberList();
  }
});

	// 최초 로드
	loadMemberList();
	// 3. 페이지 로드 시 차트 함수 실행
	loadMemberChart();


</script>
