package kr.or.ddit.chat.controller;

import java.net.Authenticator;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import jakarta.servlet.http.HttpSession;
import kr.or.ddit.chat.service.IChatService;
import kr.or.ddit.member.service.impl.CustomUser;
import kr.or.ddit.vo.MemberVO;
import kr.or.ddit.vo.chat.ChatVO;
import kr.or.ddit.vo.chat.ChatroomVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : ChattingController
 * DESC : 실시간 채팅 컨트롤러 클래스
 * </pre>
 * 
 * @author [대덕인재개발원] team1 KJS
 * @version 1.0, 2025.12.26
 * 
 */

@Slf4j
@Controller
@RequestMapping("/tudio/chat")
public class ChatController {
	
	@Autowired
	private IChatService chatService;
	
	/**
	 * 현재 로그인된 회원의 채팅방 목록 조회
	 * @param model
	 * @param session
	 * @return list.jsp 주소
	 */
	@GetMapping("/list")
	public String chatroomList(Model model, HttpSession session) {
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		if(loginUser != null) {
			List<ChatroomVO> chatroomList = chatService.selectChatroomList(loginUser.getMemberNo());
			model.addAttribute("chatroomList", chatroomList);
		}
		return "chat/list";
	}
	
	/**
	 * chatroomNo에 해당하는 채팅방 상세 화면 조회
	 * @param chatVo
	 * @param model
	 * @param session
	 * @return chatroom.jsp 주소
	 */
	@GetMapping("/chatroom/{chatroomNo}")
	public String chatroom(
			ChatVO chatVo, Model model, HttpSession session) {
		log.info("[myLog] 전달받은 chatNo :", chatVo.getChatNo());
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		if(loginUser != null) {
			List<ChatVO> chatList = chatService.selectChatList(chatVo);
			Map<String, Object> chatroomTitle = chatService.selectChatroomTitle(chatVo);

			model.addAttribute("chatList", chatList);
			model.addAttribute("chatroomTitle", chatroomTitle);
			model.addAttribute("myMemNo", loginUser.getMemberNo());
		}
		return "chat/chatroom";
	}
	
	/**
	 * 사용자의 화면상에 출력되어 있는 채팅보다 더 이전 채팅 목록들을 조회
	 * @param chatVo
	 * @param session
	 * @return List<ChatVO>와 상태코드를 담은 ResponseEntity 객체
	 */
	@GetMapping("/chatroom/oldchat")
	@ResponseBody
	public ResponseEntity<List<ChatVO>> oldChats(ChatVO chatVo, HttpSession session){
		MemberVO loginUser = (MemberVO) session.getAttribute("loginUser");
		ResponseEntity<List<ChatVO>> entity = null;
		
		
		if(loginUser != null) {
			List<ChatVO> chatList =  chatService.selectChatList(chatVo);
			entity = new ResponseEntity<List<ChatVO>>(chatList, HttpStatus.OK);
		}
		
		return entity;
	}
	
}
