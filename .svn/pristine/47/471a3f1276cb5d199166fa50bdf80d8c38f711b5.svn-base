<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tudio - My Task</title>
    <jsp:include page="/WEB-INF/views/include/common.jsp" />
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/my_task.css">
</head>
<body class="d-flex flex-column min-vh-100">
    <jsp:include page="/WEB-INF/views/include/headerUser.jsp"/>
    
    <div class="d-flex flex-grow-1">
        <jsp:include page="../include/sidebarUser.jsp">
              <jsp:param name="menu" value="myTask" />
        </jsp:include>
        
        <main class="main-content-wrap flex-grow-1 px-4 pt-4 pb-5">
            <div class="container-fluid my-task-container">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="fw-bold text-primary-dark m-0">
                            <i class="bi bi-collection me-2"></i>내 업무 모아보기
                        </h3>
                        <p class="text-muted mb-0 small mt-2">참여 중인 모든 프로젝트의 업무를 한눈에 확인하세요.</p>
                    </div>
                    
                    <form id="filterForm" action="${pageContext.request.contextPath}/tudio/myTask" method="get" class="d-flex align-items-center gap-2">
                        <select name="projectStatus" class="form-select form-select-sm" style="width: 140px;" onchange="this.form.submit()">
                            <option value="0" ${currentStatus == 0 or currentStatus == null ? 'selected' : ''}>진행중 프로젝트</option>
                            <option value="1" ${currentStatus == 1 ? 'selected' : ''}>완료된 프로젝트</option>
                            <option value=""  ${currentStatus == null and param.projectStatus != null ? 'selected' : ''}>전체 프로젝트</option>
                        </select>

                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="type" id="typeAll" value="" 
                                   ${empty currentType ? 'checked' : ''} onchange="this.form.submit()">
                            <label class="btn btn-outline-primary btn-sm" for="typeAll">전체</label>

                            <input type="radio" class="btn-check" name="type" id="typeWriter" value="writer" 
                                   ${currentType eq 'writer' ? 'checked' : ''} onchange="this.form.submit()">
                            <label class="btn btn-outline-primary btn-sm" for="typeWriter">내가 작성</label>

                            <input type="radio" class="btn-check" name="type" id="typeManager" value="manager" 
                                   ${currentType eq 'manager' ? 'checked' : ''} onchange="this.form.submit()">
                            <label class="btn btn-outline-primary btn-sm" for="typeManager">내가 담당</label>
                        </div>
                        
                        <button type="button" class="tudio-btn tudio-btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                            <i class="bi bi-plus-lg"></i> 새 업무 등록
                        </button>
                    </form>
                </div>
        
                <c:choose>
                    <c:when test="${empty myTaskMap}">
                        <div class="text-center py-5 text-muted border rounded bg-white mt-5">
                            <i class="bi bi-clipboard-x fs-1 d-block mb-3"></i>
                            <p class="m-0">조회된 업무가 없습니다.</p>
                        </div>
                    </c:when>
                    <c:otherwise>
                        <c:forEach items="${myTaskMap}" var="entry">
                            <c:set var="taskList" value="${entry.value}" />
                            <c:set var="pName" value="${taskList[0].projectName}" />

                            <div class="tudio-section mb-5">
                                <div class="tudio-section-header">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-folder2-open text-primary-dark"></i>
                                        <span class="fw-bold text-primary-dark">${pName}</span>
                                        <span class="tudio-badge bg-light text-secondary border">${fn:length(taskList)}</span>
                                    </div>
                                </div>
                                <div class="p-0">
                                    <table class="tudio-table-card mb-0">
                                        <thead>
                                            <tr>
                                                <th class="col-pin"></th>
                                                <th class="col-title">업무명</th>
                                                <th class="col-status">상태</th>
                                                <th class="col-assignee">담당자</th>
                                                <th class="col-start-date">시작일</th> 
                                                <th class="col-end-date">마감일</th>
                                                <th class="col-priority">중요도</th>
                                                <th class="col-progress">진척도</th>
                                                <th class="col-writer">작성자</th> 
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <c:forEach items="${taskList}" var="task">
                                                
                                                <c:set var="isMyParent" value="${task.isMyTask eq 'Y'}" />
                                                <c:set var="hasSubTasks" value="${not empty task.subTasks}" />

                                                <c:if test="${!isMyParent}">
                                                    <tr class="task-shell-row">
                                                        <td class="text-center">
                                                            <c:if test="${hasSubTasks}">
                                                                <button class="accordion-btn collapsed" onclick="toggleSubTasks('${task.taskId}', this)">
                                                                    <i class="bi bi-chevron-right"></i> </button>
                                                            </c:if>
                                                        </td>
                                                        <td colspan="8" class="text-start ps-2">
                                                            <i class="bi bi-folder text-muted me-2"></i>
                                                            <span class="task-shell-text">상위업무 : </span>
                                                            <a href="javascript:openTaskDetail('${task.taskId}')" class="task-shell-link">
                                                                ${task.taskTitle}
                                                            </a>
                                                            <span class="badge bg-white text-secondary border ms-2 small">
                                                                <i class="bi bi-diagram-2 me-1"></i>하위업무 포함
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </c:if>

                                                <c:if test="${isMyParent}">
                                                    <tr class="task-parent-row">
                                                        <td>
                                                            <div class="d-flex align-items-center justify-content-center">
                                                                <c:if test="${hasSubTasks}">
                                                                    <button class="accordion-btn collapsed me-1" onclick="toggleSubTasks('${task.taskId}', this)">
                                                                        <i class="bi bi-chevron-right"></i>
                                                                    </button>
                                                                </c:if>
                                                                <c:if test="${!hasSubTasks}">
                                                                    <span style="width: 24px;"></span> 
                                                                </c:if>
                                                                
                                                                <i class="bi bi-pin-angle${task.taskPinYn eq 'Y' ? '-fill active' : ''} pin-icon text-muted" 
                                                                   onclick="togglePin('${task.taskId}')"></i>
                                                            </div>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="fw-bold text-dark text-truncate-custom">${task.taskTitle}</span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="tudio-badge task-status-${fn:toLowerCase(task.taskStatus.name())}">${task.taskStatus.label}</span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="small text-muted">${task.taskManagerName}</span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="small text-muted"><fmt:formatDate value="${task.taskStartdate}" pattern="yyyy.MM.dd"/></span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="small text-muted"><fmt:formatDate value="${task.taskEnddate}" pattern="yyyy.MM.dd"/></span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="tudio-badge task-priority-${fn:toLowerCase(task.taskPriority.name())}">${task.taskPriority.label}</span>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <div class="d-flex align-items-center justify-content-center gap-2">
                                                                <div class="progress" style="height: 6px; width: 60px;">
                                                                    <div class="progress-bar bg-primary" style="width: ${task.taskRate}%"></div>
                                                                </div>
                                                                <span class="small text-muted" style="width: 30px;">${task.taskRate}%</span>
                                                            </div>
                                                        </td>
                                                        <td onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                            <span class="small text-muted">${task.writerName}</span>
                                                        </td>
                                                    </tr>
                                                </c:if>

                                                <c:forEach items="${task.subTasks}" var="sub">
                                                    <tr class="task-sub-row sub-group-${task.taskId}" onclick="openSubTaskDetail('${sub.subId}')" style="cursor: pointer; display: none;">
                                                        <td></td> 
                                                        <td class="sub-task-connection">
                                                            <span class="text-truncate-custom text-dark" style="font-size: 0.95rem;">${sub.subTitle}</span>
                                                        </td>
                                                        
                                                        <td><span class="tudio-badge task-status-${fn:toLowerCase(sub.subStatus.name())}">${sub.subStatus.label}</span></td>
                                                        <td><span class="small text-muted">${sub.taskManagerName}</span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${sub.subStartdate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${sub.subEnddate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="tudio-badge task-priority-${fn:toLowerCase(sub.subPriority.name())}">${sub.subPriority.label}</span></td>
                                                        <td>
                                                            <div class="d-flex align-items-center justify-content-center gap-2">
                                                                <div class="progress" style="height: 6px; width: 60px;">
                                                                    <div class="progress-bar bg-success" style="width: ${sub.subRate}%"></div>
                                                                </div>
                                                                <span class="small text-muted" style="width: 30px;">${sub.subRate}%</span>
                                                            </div>
                                                        </td>
                                                        <td><span class="small text-muted">${sub.writerName}</span></td>
                                                    </tr>
                                                </c:forEach>
                                            </c:forEach>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </c:forEach>
                    </c:otherwise>
                </c:choose>
		
		        <div id="projectTaskContainer" class="d-flex flex-column gap-4"></div>
		
		    </div>
		</main>
	</div>
    
    <div id="taskDetailPanel" class="task-detail-panel">
        <div class="panel-header">
            <h5 class="fw-bold mb-0 text-primary-dark">업무 상세 정보</h5>
            <button type="button" class="btn-close" onclick="closeTaskPanel()"></button>
        </div>
        <div class="panel-body">
            <form id="taskEditForm">
                <div class="mb-4"><label class="form-label small fw-bold text-muted">업무 제목</label><input type="text" class="form-control fw-bold" id="detailTitle" style="font-size: 1.1rem;"></div>
                 </form>
        </div>
        <div class="panel-footer">
            <button type="button" class="tudio-btn tudio-btn-outline-danger">삭제</button>
            <button type="button" class="tudio-btn tudio-btn-primary">변경사항 저장</button>
        </div>
    </div>

    <div class="modal fade" id="newTaskModal" tabindex="-1">
       <div class="modal-dialog modal-dialog-centered tudio-modal">
            <div class="modal-content">
                <div class="modal-header tudio-modal-header"><h5 class="modal-title tudio-modal-title fw-bold">새 업무 등록</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><form><div class="mb-3"><label class="form-label small fw-bold text-muted">업무명</label><input type="text" class="form-control"></div></form></div>
                <div class="modal-footer tudio-modal-footer"><button type="button" class="tudio-btn tudio-btn-outline" data-bs-dismiss="modal">취소</button><button type="button" class="tudio-btn tudio-btn-primary">등록하기</button></div>
            </div>
        </div>
    </div>

    <jsp:include page="../chat/main.jsp"/>
    <jsp:include page="/WEB-INF/views/include/footer.jsp"/>
</body>
<script>
    // [수정] 토글 함수 (아이콘 회전 로직 변경)
    function toggleSubTasks(taskId, btnElement) {
        const subRows = document.querySelectorAll('.sub-group-' + taskId);
        const icon = btnElement.querySelector('i');
        
        // 1. 상태 판별 (접힘 -> 펼침 or 펼침 -> 접힘)
        const isCollapsed = btnElement.classList.contains('collapsed');

        if (isCollapsed) {
            // 펼치기
            subRows.forEach(row => row.style.display = 'table-row');
            btnElement.classList.remove('collapsed');
            btnElement.classList.add('expanded');
            icon.classList.remove('bi-chevron-right');
            icon.classList.add('bi-chevron-down');
        } else {
            // 접기
            subRows.forEach(row => row.style.display = 'none');
            btnElement.classList.remove('expanded');
            btnElement.classList.add('collapsed');
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-right');
        }
    }

    // 상세 패널 열기/닫기
    function openTaskDetail(id) { document.getElementById('taskDetailPanel').classList.add('open'); }
    function closeTaskPanel() { document.getElementById('taskDetailPanel').classList.remove('open'); }
    
    function openSubTaskDetail(subId) {
        console.log("하위업무 상세 클릭: " + subId);
    }

    document.addEventListener('click', function(e) {
        if(e.target.classList.contains('pin-icon')) {
            e.stopPropagation();
            e.target.classList.toggle('active');
            e.target.classList.toggle('bi-pin-angle');
            e.target.classList.toggle('bi-pin-angle-fill');
        }
    });
</script>
</html>