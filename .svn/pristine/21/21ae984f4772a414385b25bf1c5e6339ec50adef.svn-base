<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="tudio-scope">

	<div class="tudio-section mb-4">
		<div class="tudio-section-header">
			<h5 class="m-0 fw-bold text-primary-dark">
				<i class="bi bi-pie-chart-fill me-2"></i>프로젝트 요약·분석
			</h5>
			<div class="d-flex gap-2">
				<button class="tudio-btn tudio-btn-outline" onclick="window.print()">
					<i class="bi bi-printer"></i> 리포트 출력
				</button>
			</div>
		</div>
	</div>

	<div class="row mb-4">
		<div class="col-12">
			<div class="tudio-card p-4 shadow-sm"
				style="border: 1px solid rgba(0, 0, 0, 0.05); background-color: #fff;">
				<span class="text-primary-dark fw-bold d-block mb-2"
					style="font-size: 1.05rem; letter-spacing: -0.02em;">프로젝트 개요</span>

				<div class="text-dark fw-medium"
					style="line-height: 1; white-space: pre-wrap; font-size: 0.85rem; letter-spacing: -0.01em; text-align: left; color: #4b5563 !important;">
					<c:out
						value="${not empty insight.projectDesc ? insight.projectDesc : '등록된 프로젝트 설명이 없습니다.'}" />
				</div>
			</div>
		</div>
	</div>

	<div class="row g-3 mb-4">
		<div class="col-md-3">
			<div
				class="tudio-card p-3 h-100 d-flex flex-column justify-content-between">
				<span class="text-muted small fw-bold">총 업무</span>
				<div class="d-flex align-items-end justify-content-between mt-2">
					<h2 class="fw-bold m-0 text-primary-dark">${not empty insight.totalTaskCount ? insight.totalTaskCount : 0}<span
							class="fs-6 fw-normal text-muted ms-1">건</span>
					</h2>
					<i class="bi bi-check2-square fs-3 text-primary-light"
						style="opacity: 0.3"></i>
				</div>
				<div class="mt-2 text-end">
					<span
						class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-2"
						style="font-size: 11px;"> Project No. ${projectNo} </span>
				</div>
			</div>
		</div>

		<div class="col-md-3">
			<div
				class="tudio-card p-3 h-100 d-flex flex-column justify-content-between">
				<span class="text-muted small fw-bold">전체 업무 진행률</span>
				<div class="d-flex align-items-end justify-content-between mt-2">
					<h2 class="fw-bold m-0 text-primary">${not empty insight.overallProgress ? insight.overallProgress : 0}<span
							class="fs-6 fw-normal text-muted ms-1">%</span>
					</h2>
					<i class="bi bi-graph-up-arrow fs-3 text-primary"
						style="opacity: 0.3"></i>
				</div>
				<div class="progress mt-3" style="height: 6px;">
					<div class="progress-bar" role="progressbar"
						style="width: ${insight.overallProgress}%; background-color: var(--main-blue);"
						aria-valuenow="${insight.overallProgress}" aria-valuemin="0"
						aria-valuemax="100"></div>
				</div>
			</div>
		</div>

		<div class="col-md-3">
			<div
				class="tudio-card p-3 h-100 d-flex flex-column justify-content-between">
				<span class="text-muted small fw-bold">지연 업무</span>
				<div class="d-flex align-items-end justify-content-between mt-2">
					<h2 class="fw-bold m-0 text-primary-dark">${not empty insight.delayedTaskCount ? insight.delayedTaskCount : 0}<span
							class="fs-6 fw-normal text-muted ms-1">건</span>
					</h2>
					<i class="bi bi-exclamation-triangle-fill fs-3 text-muted"
						style="opacity: 0.3"></i>
				</div>
				<div class="mt-2 text-muted small text-end">마감일 경과 업무 수</div>
			</div>
		</div>

		<div class="col-md-3">
			<div
				class="tudio-card p-3 h-100 d-flex flex-column justify-content-between">
				<span class="text-muted small fw-bold">프로젝트 일정</span>
				<div class="d-flex align-items-end justify-content-between mt-2">
					<h2 class="fw-bold m-0 text-dark">${not empty insight.projectDday ? insight.projectDday : 'D-?'}</h2>
					<i class="bi bi-hourglass-split fs-3 text-muted"
						style="opacity: 0.3"></i>
				</div>
				<div class="mt-2 text-muted small text-end">현 시점 기준 남은 일수</div>
			</div>
		</div>
	</div>

	<div class="row g-4 mb-4">
		<div class="col-md-4">
			<div class="tudio-card p-4 h-100">
				<h6 class="fw-bold mb-4 text-primary-dark">업무 상태 분포</h6>
				<div style="position: relative; height: 250px; width: 100%;">
					<canvas id="taskStatusChart"></canvas>
				</div>
				<div class="mt-3 text-center small text-muted">완료된
					업무(${insight.doneCount}건) 중심 분포</div>
			</div>
		</div>

		<div class="col-md-8">
			<div class="tudio-card p-4 h-100">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h6 class="fw-bold m-0 text-primary-dark">일정 준수 현황</h6>
					<span class="tudio-badge qna">총 ${insight.doneCount}건 완료 기준</span>
				</div>
				<div style="position: relative; height: 250px; width: 100%;">
					<canvas id="schedulePerformanceChart"></canvas>
				</div>
				<div class="row mt-3 text-center small">
					<div class="col text-success">
						<i class="bi bi-lightning-fill"></i> 조기 완료
					</div>
					<div class="col text-primary">
						<i class="bi bi-check-circle-fill"></i> 정시 완료
					</div>
					<div class="col text-danger">
						<i class="bi bi-clock-history"></i> 지연 완료
					</div>
				</div>
			</div>
		</div>
	</div>



	<div class="row g-4 mb-4">
		<div class="col-md-6">
			<div class="tudio-card p-4 h-100">
				<h6 class="fw-bold mb-4 text-primary-dark">업무 우선순위 분포</h6>
				<div style="position: relative; height: 260px; width: 100%;">
					
					 <canvas id="taskPriorityChart" style="width:100% !important; height:100% !important;"></canvas>
				</div>
				<div class="mt-3 text-center small text-muted">우선순위별 업무 비율</div>
			</div>
		</div>

		<div class="col-md-6">
			<div class="tudio-card p-4 h-100">
				<h6 class="fw-bold mb-4 text-primary-dark">프로젝트 기간 대비 진행률</h6>
				<div style="position: relative; height: 260px; width: 100%;">
					 <canvas id="projectProgressChart" style="width:100% !important; height:100% !important;"></canvas>
				</div>
				<div class="mt-3 text-center small text-muted">프로젝트 기간 대비 진행률</div>
			</div>
		</div>
	</div>


	<div class="tudio-section">
		<div class="tudio-section-header">
			<h6 class="m-0 fw-bold text-primary-dark">팀원별 업무 기여도</h6>
		</div>
		<div class="table-responsive">
			<table class="table tudio-table-card table-hover m-0">
				<thead class="bg-light">
					<tr>
						<th class="ps-4">이름 / 직책</th>
						<th class="text-center">배정된 업무</th>
						<th class="text-center">진행 중</th>
						<th class="text-center">완료</th>
						<th class="text-center">지연</th>
						<th class="text-center">완료율</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach items="${memberList}" var="member">
						<tr>
							<td class="ps-4">
								<div class="d-flex align-items-center">
									<div
										class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
										style="width: 36px; height: 36px; font-weight: 700;">
										${member.memberName.substring(0, 1)}</div>
									<div>
										<div class="fw-bold text-dark">${member.memberName}</div>
										<div class="small text-muted">${member.memberPosition}</div>
									</div>
								</div>
							</td>
							<td class="text-center align-middle fw-bold">${member.totalTaskCnt}건</td>
							<td class="text-center align-middle text-primary">${member.ingCnt}</td>
							<td class="text-center align-middle text-success">${member.doneCnt}</td>
							<td
								class="text-center align-middle ${member.delayCnt > 0 ? 'text-danger fw-bold' : ''}">${member.delayCnt}</td>
							<td class="text-center align-middle">
								<div class="d-flex align-items-center justify-content-center">
									<%-- 분모가 0인 경우를 대비해 조건을 겁니다 --%>
									<c:set var="calcRate"
										value="${member.totalTaskCnt > 0 ? (member.doneCnt / member.totalTaskCnt) * 100 : 0}" />

									<div class="progress"
										style="width: 80px; height: 6px; margin-right: 8px;">
										<%-- 계산된 calcRate를 적용 --%>
										<div class="progress-bar bg-primary" role="progressbar"
											style="width: ${calcRate}%"></div>
									</div>
									<span class="small fw-bold text-primary"> <%-- 소수점 첫째자리까지 표시 --%>
										<fmt:formatNumber value="${calcRate}" pattern="0.0" />%
									</span>
								</div>
							</td>
						</tr>
					</c:forEach>
					<c:if test="${empty memberList}">
						<tr>
							<td colspan="6" class="text-center py-5 text-muted">참여 중인 팀원
								정보가 없습니다.</td>
						</tr>
					</c:if>
				</tbody>
			</table>
		</div>
	</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>



(function() {
	


	const priorityLabels = [];
	const priorityCounts = [];
	const priorityPercents = [];

	<c:forEach items = "${priorityData}" var="p">
		priorityLabels.push("${p.priorityLabel}");
		priorityCounts.push(${p.priorityCnt});
		priorityPercents.push(${p.priorityPct});
	</c:forEach>

	
    /* 서버 데이터를 JS 변수로 할당 */
    const taskStats = {
        todo: ${insight.todoCount != null ? insight.todoCount : 0},
        inProgress: ${insight.inProgressCount != null ? insight.inProgressCount : 0},
        review: ${insight.reviewCount != null ? insight.reviewCount : 0},
        done: ${insight.doneCount != null ? insight.doneCount : 0}
    };

    const scheduleStats = {
        early: ${insight.earlyDoneCount != null ? insight.earlyDoneCount : 0},
        onTime: ${insight.onTimeDoneCount != null ? insight.onTimeDoneCount : 0},
        delayed: ${insight.lateDoneCount != null ? insight.lateDoneCount : 0}
    };

    // 1. 업무 상태 파이 차트
    const ctxStatus = document.getElementById('taskStatusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['할 일', '진행 중', '검토', '완료'],
            datasets: [{
                data: [taskStats.todo, taskStats.inProgress, taskStats.review, taskStats.done],
                backgroundColor: ['#e2e8f0', '#3b82f6', '#f59e0b', '#22c55e'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
            cutout: '70%'
        }
    });
    

 //우선순위 도넛 차트

const legendLabels = priorityLabels.map((l, i) => {
  const pct = Number(priorityPercents[i] || 0);
  return l + ' (' + pct.toFixed(1) + '%)';
});

const ctxPriority = document.getElementById('taskPriorityChart').getContext('2d');

new Chart(ctxPriority, {
  type: 'doughnut',
  data: {
    labels: legendLabels, 
    datasets: [{
      data: priorityPercents,
      backgroundColor: ['#ef4444','#f97316','#3b82f6','#22c55e'],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: {
        display: true,
        position: 'bottom',
        labels: { usePointStyle: true, padding: 18 }
      },
      tooltip: {
        callbacks: {
       
          title: (items) => priorityLabels[items[0].dataIndex] || '',
          label: (ctx) => {
            const i = ctx.dataIndex;
            const pct = Number(priorityPercents[i] || 0).toFixed(1);
            return priorityCounts[i] + '건 (' + pct + '%)';
          }
        }
      },
      datalabels: { display: false }
      
    }
  }
});



//날짜 (X축)
const progressDates = [
  '04-10',
  '04-15',
  '04-20',
  '04-25',
  '05-01',
  '05-07',
  '05-12',
  '05-18',
  '05-20'
];

// 실제 진행률 (%) (Y축)
const progressRates = [
   5,   // 4/10
  12,   // 4/15
  25,   // 4/20
  33,   // 4/25
  48,   // 5/01
  55,   // 5/07
  68,   // 5/12
  82,   // 5/18
  90    // 5/20
];


	const ctx = document.getElementById('projectProgressChart');

	new Chart(ctx, {
	  type: 'line',
	  data: {
	    labels: progressDates,
	    datasets: [{
	      label: '실제 진행률(%)',
	      data: progressRates,
	      borderWidth: 3,
	      tension: 0.3,        // 곡선 부드럽게
	      fill: true,
	      pointRadius: 5
	    }]
	  },
	  options: {
	    responsive: true,
	    scales: {
	      y: {
	        min: 0,
	        max: 100,
	        ticks: {
	          callback: v => v + '%'
	        }
	      }
	    },
	    plugins: {
	      legend: {
	        display: false
	      },
	      tooltip: {
	        callbacks: {label: ctx => ctx.raw + '%'}
	      }
	    }
	  }
	});






    // 2. 일정 준수 바 차트
    const ctxSchedule = document.getElementById('schedulePerformanceChart').getContext('2d');
    new Chart(ctxSchedule, {
        type: 'bar',
        data: {
            labels: ['조기 완료', '정시 완료', '지연 완료'],
            datasets: [{
                data: [scheduleStats.early, scheduleStats.onTime, scheduleStats.delayed],
                backgroundColor: ['rgba(34, 197, 94, 0.2)', 'rgba(59, 130, 246, 0.2)', 'rgba(239, 68, 68, 0.2)'],
                borderColor: ['#22c55e', '#3b82f6', '#ef4444'],
                borderWidth: 1,
                borderRadius: 5,
                barThickness: 40
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false }, beginAtZero: true }, y: { grid: { display: false } } }
        }
    });
})();
</script>