<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>

	<link rel="stylesheet" href="${pageContext.request.contextPath}/css/task_list.css">   

<div class="tab-content-card">
    <div class="tudio-section-header mb-4">
        <h5 class="mb-0 text-primary-dark fw-bold" id="taskViewTitle">ì—…ë¬´ ëª©ë¡ (ë¦¬ìŠ¤íŠ¸)</h5>
        <div class="d-flex gap-2">
        
            <button class="tudio-btn tudio-btn-primary" id="createTaskBtn">
                <i class="bi bi-plus"></i> ìƒˆ ì—…ë¬´ ì¶”ê°€
            </button>
            
            <button class="tudio-btn" id="toggleViewButton" style="border: 1px solid var(--tudio-border-soft);">
                <i class="bi bi-list me-1"></i> ì¹¸ë°˜ ë³´ê¸°
            </button>
            
        </div>
    </div>

	<!-- í”Œë˜ì‹œ ì—ëŸ¬ë©”ì‹œì§€ -->
	<c:if test="${not empty errorMsg}">
		<div id="taskErrorMsg" data-error-msg="${fn:escapeXml(errorMsg)}" style="display: none;"></div>
	</c:if>

	<div id="listView">
        <div class="d-flex justify-content-end mb-3 px-3">
            <div class="tudio-search-wrap">
                <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                <button class="border-0 bg-transparent" aria-label="search">ğŸ”</button>
            </div>
        </div>
        <div class="tudio-table-wrap">
            <table class="tudio-table-card">
                <thead>
                    <tr>
                        <th>ì—…ë¬´ëª…</th>
                        <th>ìƒíƒœ</th>
                        <th>ë‹´ë‹¹ì</th>
                        <th>ì‹œì‘ì¼</th>
                        <th>ë§ˆê°ì¼</th>
                        <th>ì¤‘ìš”ë„</th>
                        <th>ì§„ì²™ë„</th>
                        <th>ì‘ì„±ì</th>
                    </tr>
                </thead>
                <tbody>
                    <c:forEach items="${taskList}" var="task">
                    	<!-- ìƒìœ„ì—…ë¬´ -->
                        <tr class="task-row" 
                        	data-task-id="${task.taskId}"
                        	style="cursor:pointer;">
                            <td class="task-title" style="cursor:pointer;">
	                        	<!-- ìƒìœ„ì—…ë¬´ ì•„ì½”ë””ì–¸ ì•„ì´ì½˜ -->
	                        	<i class="bi bi-caret-right-fill toggle-icon me-1"></i>
                            	${task.taskTitle}
                            </td>
                            <td><span class="tudio-badge ${task.statusCss }">${task.statusLabel }</span></td>
                            
                            <!-- ìƒìœ„ì—…ë¬´ ë‹´ë‹¹ì -->
                            <td>
                            	<c:set value="${task.taskManagers }" var="taskManager"/>
                            	<c:choose>
                            		<c:when test="${empty taskManager }">
                            			<span>-</span>
                            		</c:when>
                            		<c:when test="${fn:length(taskManager) > 1 }">
					                    <span>${taskManager[0].memberName } + ${fn:length(taskManager) -1 }</span>
                            		</c:when>
                            		<c:otherwise>
					                    <span>${taskManager[0].memberName }</span>
                            		</c:otherwise>
                            	</c:choose>
		                    </td>
                            <td class="text-muted">
                            	<fmt:formatDate value="${task.taskStartdate }" pattern="yyyy-MM-dd"/>
                            </td>
                            <td class="text-muted">
                            	<fmt:formatDate value="${task.taskEnddate }" pattern="yyyy-MM-dd"/>
                            </td>
                            <td><span class="tudio-badge notice">${task.priorityLabel }</span></td>
                            <td>
                                <div class="progress" style="height: 6px; width: 80px;">
                                    <div class="progress-bar bg-primary" style="width: 50%;"></div>
                                </div>
                                ${task.taskRate }%
                            </td>
                            <td><small class="text-muted">${task.writerName }</small></td>
                        </tr>
                        
                        <!-- í•˜ìœ„ì—…ë¬´ -->
                        <c:forEach items="${task.subTasks }" var="sub">
                        	<tr class="sub-row" 
                        		data-parent-task-id="${sub.taskId}"
                        		data-sub-id="${sub.subId }"
                        		style="display:none; background:#fafafa;">
                        		<td class="sub-title ps-4" style="cursor:pointer;">${sub.subTitle}</td>
	                            <td><span class="tudio-badge ${sub.statusCss }">${sub.statusLabel }</span></td>
	                            
	                            <!-- í•˜ìœ„ì—…ë¬´ ë‹´ë‹¹ì -->
	                            <td>
	                            	<c:set value="${sub.subManagers }" var="subManager"/>
	                            	<c:choose>
	                            		<c:when test="${empty subManager }">
	                            			<span>-</span>
	                            		</c:when>
	                            		<c:when test="${fn:length(subManager) > 1 }">
						                    <span>${subManager[0].memberName } + ${fn:length(subManager) -1 }</span>
	                            		</c:when>
	                            		<c:otherwise>
						                    <span>${subManager[0].memberName }</span>
	                            		</c:otherwise>
	                            	</c:choose>
			                    </td>
	                            <td class="text-muted">
	                            	<fmt:formatDate value="${sub.subStartdate }" pattern="yyyy-MM-dd"/>
	                            </td>
	                            <td class="text-muted">
	                            	<fmt:formatDate value="${sub.subEnddate }" pattern="yyyy-MM-dd"/>
	                            </td>
	                            <td><span class="tudio-badge notice">${sub.priorityLabel }</span></td>
	                            <td>
	                                <div class="progress" style="height: 6px; width: 80px;">
	                                    <div class="progress-bar bg-primary" style="width: 50%;"></div>
	                                </div>
	                                ${sub.subRate }%
	                            </td>
	                            <td><small class="text-muted">${sub.writerName }</small></td>
                        	</tr>
                        </c:forEach>
                        
                        <!-- í•˜ìœ„ì—…ë¬´ ì¶”ê°€ ë²„íŠ¼ -->
                        <tr class="sub-add-row"
					        data-parent-task-id="${task.taskId}"
					        style="display:none; background:#f0f0f0;">
					        <td colspan="8" class="ps-4">
					            <button class="btn btn-sm btn-outline-primary add-sub-btn"
					                    data-task-id="${task.taskId}">
					                + í•˜ìœ„ì—…ë¬´ ì¶”ê°€
					            </button>
					        </td>
					    </tr>
                        
                    </c:forEach>
                </tbody>
            </table>
        </div>
    </div> 
</div> 
