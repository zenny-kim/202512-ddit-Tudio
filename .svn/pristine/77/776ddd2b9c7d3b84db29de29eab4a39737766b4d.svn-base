<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.projectInsight.mapper.IProjectInsightMapper">

    <select id="getProjectInsight" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectInsightVO">
        SELECT 
        	P.PROJECT_DESC AS projectDesc,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO) AS totalTaskCount,
            (SELECT NVL(ROUND(AVG(TASK_RATE), 1), 0) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO) AS overallProgress,
            
            (SELECT COUNT(*) FROM PROJECT_TASK 
              WHERE PROJECT_NO = P.PROJECT_NO 
                AND TRUNC(TASK_ENDDATE) &lt; TRUNC(CURRENT_TIMESTAMP) 
                AND TASK_STATUS != 203) AS delayedTaskCount,
            
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 201) AS todoCount,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 202) AS inProgressCount,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 204) AS reviewCount,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 203) AS doneCount,

            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 203 AND TRUNC(TASK_FINISHDATE) &lt; TRUNC(TASK_ENDDATE)) AS earlyDoneCount,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 203 AND TRUNC(TASK_FINISHDATE) = TRUNC(TASK_ENDDATE)) AS onTimeDoneCount,
            (SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = P.PROJECT_NO AND TASK_STATUS = 203 AND TRUNC(TASK_FINISHDATE) > TRUNC(TASK_ENDDATE)) AS lateDoneCount,

            CASE 
                WHEN (TRUNC(P.PROJECT_ENDDATE) - TRUNC(SYSDATE)) > 0 THEN 'D-' || (TRUNC(P.PROJECT_ENDDATE) - TRUNC(SYSDATE))
                WHEN (TRUNC(P.PROJECT_ENDDATE) - TRUNC(SYSDATE)) = 0 THEN 'D-Day'
                ELSE '만료'
            END AS projectDday
        FROM PROJECT P
        WHERE P.PROJECT_NO = #{projectNo}
    </select>

    <select id="getMemberContributionList" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectMemberVO">
        SELECT 
            M.MEMBER_NO,
            U.MEMBER_NAME AS memberName,
            U.MEMBER_POSITION AS memberPosition,
            COUNT(T.TASK_ID) AS totalTaskCnt,
            COUNT(CASE WHEN T.TASK_STATUS = 202 THEN 1 END) AS ingCnt,
            COUNT(CASE WHEN T.TASK_STATUS = 203 THEN 1 END) AS doneCnt,
            COUNT(CASE WHEN TRUNC(T.TASK_ENDDATE) &lt; TRUNC(SYSDATE) AND T.TASK_STATUS != 203 THEN 1 END) AS delayCnt,
            
            NVL(ROUND((COUNT(CASE WHEN T.TASK_STATUS = 203 THEN 1 END) / 
                   NULLIF((SELECT COUNT(*) FROM PROJECT_TASK WHERE PROJECT_NO = #{projectNo} AND TASK_STATUS = 203), 0)) * 100, 1), 0) AS contributionRate
        FROM PROJECT_MEMBER M
        JOIN MEMBER U ON (M.MEMBER_NO = U.MEMBER_NO)
        /* 담당자 테이블(PTM)을 거쳐서 실제 배정된 업무(T)를 조인합니다 */
        LEFT JOIN PROJECT_TASK_MANAGER PTM ON (M.MEMBER_NO = PTM.MEMBER_NO AND PTM.WORK_TYPE = 'T')
        LEFT JOIN PROJECT_TASK T ON (PTM.WORK_ID = T.TASK_ID AND M.PROJECT_NO = T.PROJECT_NO)
        WHERE M.PROJECT_NO = #{projectNo}
          AND M.PROJECT_MEM_STATUS = 'Y'
        GROUP BY M.MEMBER_NO, U.MEMBER_NAME, U.MEMBER_POSITION
        ORDER BY contributionRate DESC
    </select>
    
  <select id="selectPriorityDistribution" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectInsightVO">
	    WITH base AS (
		  SELECT 211 AS PRIORITY_CODE, '낮음' AS PRIORITY_LABEL FROM DUAL UNION ALL
		  SELECT 212, '보통' FROM DUAL UNION ALL
		  SELECT 213, '높음' FROM DUAL UNION ALL
		  SELECT 214, '긴급' FROM DUAL
		),
		all_work AS (
		
		  SELECT t.TASK_PRIORITY AS PRIORITY_CODE
		  FROM PROJECT_TASK t
		  WHERE t.PROJECT_NO = #{projectNo}
		
		  UNION ALL
		
		  SELECT s.SUB_PRIORITY AS PRIORITY_CODE
		  FROM PROJECT_TASK_SUB s
		  JOIN PROJECT_TASK t ON t.TASK_ID = s.TASK_ID
		  WHERE t.PROJECT_NO = #{projectNo}
		),
		agg AS (
		  SELECT PRIORITY_CODE, COUNT(*) AS priorityCnt
		  FROM all_work
		  WHERE PRIORITY_CODE IN (211, 212, 213, 214)
		  GROUP BY PRIORITY_CODE
		),
		total AS (
		  SELECT COUNT(*) AS TOTAL_CNT
		  FROM all_work
		  WHERE PRIORITY_CODE IN (211, 212, 213, 214)
		)
		SELECT
		  b.PRIORITY_CODE,
		  b.PRIORITY_LABEL,
		  NVL(a.priorityCnt, 0) AS priorityCnt,
		  CASE 
		    WHEN t.TOTAL_CNT = 0 THEN 0
		    ELSE ROUND(NVL(a.priorityCnt, 0) / t.TOTAL_CNT * 100, 1)
		  END AS priorityPct
		FROM base b
		LEFT JOIN agg a ON a.PRIORITY_CODE = b.PRIORITY_CODE
		CROSS JOIN total t
		ORDER BY b.PRIORITY_CODE DESC
    </select>
    
</mapper>