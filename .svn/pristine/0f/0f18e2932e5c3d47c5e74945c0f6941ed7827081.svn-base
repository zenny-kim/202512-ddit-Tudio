package kr.or.ddit.comment.service.impl;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.comment.mapper.ICommentMapper;
import kr.or.ddit.comment.service.ICommentService;
import kr.or.ddit.file.service.IFileService;
import kr.or.ddit.vo.CommentVO;
import lombok.extern.slf4j.Slf4j;

/**
 * <pre>
 * PROJ : Tudio
 * Name : CommentServiceImpl
 * DESC : 게시판, 업무 등 댓글 기능 공통 서비스
 * </pre>
 * 
 * @author [대덕인재개발원] team1 KSJ
 * @version 1.0, 2026.01.14
 * 
 */


@Slf4j
@Service
public class CommentServiceImpl implements ICommentService {
	
	@Autowired
    private IFileService fileService;

	@Autowired
	private ICommentMapper commentMapper;

	/**
	 * <p>댓글 작성</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글내용, 작성자, 댓글타입 등
	 * @param ServiceResult OK:성공, FAILED :실패
	 */
	@Override
	public ServiceResult insertComment(CommentVO commentVO) {
		ServiceResult result = ServiceResult.FAILED;
		
		List<MultipartFile> fileList = commentVO.getCmtFileList();
        if(fileList != null && !fileList.isEmpty()) {
            boolean hasFile = false;
            for(MultipartFile f : fileList) {
                if(f.getSize() > 0 && f.getOriginalFilename() != null && !f.getOriginalFilename().isEmpty()) {
                    hasFile = true;
                    break;
                }
            }

            if(hasFile) {
                int fileGroupNo = fileService.uploadFiles(fileList, commentVO.getMemberNo(), 412);
                commentVO.setFileGroupNo(fileGroupNo); 
            }
        }
		
		int status = commentMapper.insertComment(commentVO);
		if(status > 0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;	
		}
		return result;
	}

	
	/**
	 * <p>댓글 목록</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 */
	@Override
	public List<CommentVO> selectCommentList(CommentVO commentVO) {
		return commentMapper.selectCommentList(commentVO);
	}

	/**
	 * <p>댓글 수정</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:삭제 성공, FAILED:삭제 실패
	 */
	@Override
	public ServiceResult updateComment(CommentVO commentVO) {
		ServiceResult result = null;
		int status = commentMapper.updateComment(commentVO);
		if(status>0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;
		}
		return result;
	}

	
	/**
	 * <p>댓글 삭제</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:삭제 성공, FAILED:삭제 실패
	 */
	@Override
	public ServiceResult deleteComment(CommentVO commentVO) {
		ServiceResult result = null;
		int status = commentMapper.deleteComment(commentVO);
		if(status>0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;
		}
		return result;
	}

	
	/**
	 * <p>대댓글 등록</p>
	 * @date 2026.01.15
	 * @author [대덕인재개발원] team1 KSJ
	 * @param CommentVO 댓글번호
	 * @return ServiceResult OK:성공, FAILED:실패
	 */
	@Override
	public ServiceResult insertReplyComment(CommentVO commentVO) {
		ServiceResult result = ServiceResult.FAILED;
		List<MultipartFile> fileList = commentVO.getCmtFileList();
        if(fileList != null && !fileList.isEmpty()) {
            boolean hasFile = false;
            for(MultipartFile f : fileList) {
                if(f.getSize() > 0 && f.getOriginalFilename() != null && !f.getOriginalFilename().isEmpty()) {
                    hasFile = true;
                    break;
                }
            }

            if(hasFile) {
                // 동일하게 파일 저장 호출
                int fileGroupNo = fileService.uploadFiles(fileList, commentVO.getMemberNo(), 413);
                commentVO.setFileGroupNo(fileGroupNo);
            }
        }
		int status = commentMapper.insertReplyComment(commentVO);
		if(status > 0) {
			result = ServiceResult.OK;
		} else {
			result = ServiceResult.FAILED;	
		}
		return result;
	}



}
