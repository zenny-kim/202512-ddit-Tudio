<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.notification.mapper.INotificationMapper">


  <!-- 알림 목록 조회 (전체 / 안읽음) -->
  <select id="notiList"
          parameterType="map"
          resultType="kr.or.ddit.vo.NotificationVO">

    SELECT
        N.NOTI_NO,
        N.NOTI_TYPE,
        N.NOTI_URL,
        N.IS_READ,
        N.NOTI_REGDATE,
        N.MEMBER_NO,
        CASE
            WHEN N.NOTI_TYPE = 'PROJECT_INVITE' THEN
                NVL(
                    (SELECT P.PROJECT_NAME
                       FROM PROJECT P
                      WHERE P.PROJECT_NO = N.TARGET_ID),'알 수 없음')

            WHEN N.NOTI_TYPE = 'CMT_TASK_SUB' THEN
                '하위 업무 [' || NVL(
                    (SELECT PTS.SUB_TITLE
                       FROM PROJECT_TASK_SUB PTS
                      WHERE PTS.SUB_ID = N.TARGET_ID),
                    '제목없음'
                ) || ']에 댓글이 달렸습니다.'

            WHEN N.NOTI_TYPE = 'CMT_BOARD' THEN
                '[' || NVL(
                    (SELECT PB.BO_TITLE
                       FROM PROJECT_BOARD PB
                      WHERE PB.BO_NO = N.TARGET_ID),
                    '제목없음'
                ) || ']에 댓글이 달렸습니다.'

            WHEN N.NOTI_TYPE = 'CMT_TASK' THEN
                '상위업무 [' || NVL(
                    (SELECT PT.TASK_TITLE
                       FROM PROJECT_TASK PT
                      WHERE PT.TASK_ID = N.TARGET_ID),
                    '제목없음'
                ) || ']에 댓글이 달렸습니다.'

            WHEN N.NOTI_TYPE = 'CMT_INQUIRY' THEN
                '문의사항 [' || NVL(
                    (SELECT IQ.INQUIRY_TITLE
                       FROM INQUIRY IQ
                      WHERE IQ.INQUIRY_NO = N.TARGET_ID),
                    '제목없음'
                ) || ']에 답변이 등록됐습니다.'

            WHEN N.NOTI_TYPE = 'CHAT' THEN
                '[' || NVL(
                    (SELECT CR.CHATROOM_NAME
                       FROM CHATROOM CR
                      WHERE CR.CHATROOM_NO = N.TARGET_ID),
                    '제목없음'
                ) || '] 채팅방에 초대되었습니다.'

            WHEN N.NOTI_TYPE = 'SITE_NOTICE' THEN
                '전체 공지사항 [' || NVL(
                    (SELECT NT.NOTICE_TITLE
                       FROM NOTICE NT
                      WHERE NT.NOTICE_NO = N.TARGET_ID),
                    '제목없음'
                ) || ']이(가) 등록되었습니다.'

            WHEN N.NOTI_TYPE = 'BOARD_NOTICE' THEN
                '프로젝트 공지사항 [' || NVL(
                    (SELECT PRB.BO_TITLE
                       FROM PROJECT_BOARD PRB
                      WHERE PRB.BO_NO = N.TARGET_ID),
                    '제목없음'
                ) || ']이(가) 등록되었습니다.'

            ELSE
                '알림이 도착했습니다.'
        END AS notiMessage
    FROM NOTIFICATION N
    WHERE N.MEMBER_NO = #{memberNo}

    <if test="unreadOnly == true">
        AND N.IS_READ = 'N'
    </if>
    
    <if test="readOnly == true">
    	AND N.IS_READ = 'Y'
    </if>

    ORDER BY
        N.NOTI_REGDATE DESC,
        N.NOTI_NO DESC
  </select>


  <!-- 안읽음 알림 개수 -->
  <select id="selectUnreadCount"
          parameterType="int"
          resultType="int">
    SELECT COUNT(*)
    FROM NOTIFICATION
    WHERE MEMBER_NO = #{memberNo}
      AND IS_READ = 'N'
  </select>


  <!-- 읽음 처리 -->
  <update id="updateRead"
          parameterType="map">
    UPDATE NOTIFICATION
       SET IS_READ = 'Y'
     WHERE MEMBER_NO = #{memberNo}
       AND NOTI_NO = #{notiNo}
  </update>


  <!-- 알림 물리 삭제 -->
  <delete id="deleteNoti"
          parameterType="map">
    DELETE
      FROM NOTIFICATION
     WHERE MEMBER_NO = #{memberNo}
       AND NOTI_NO = #{notiNo}
  </delete>


  <!-- 알림 저장 (강제 알림) -->
  <insert id="insertNoti"
          parameterType="kr.or.ddit.vo.NotificationVO">
    INSERT INTO NOTIFICATION (
        NOTI_NO,
        MEMBER_NO,
        NOTI_TYPE,
        TARGET_ID,
        NOTI_URL,
        IS_READ,
        NOTI_REGDATE
    ) VALUES (
        SEQ_NOTIFICATION.NEXTVAL,
        #{memberNo},
        #{notiType},
        #{targetId},
        #{notiUrl},
        'N',
        CURRENT_TIMESTAMP
    )
  </insert>


  <!-- 알림 저장 (알림 설정 ON일 때만) -->
  <insert id="insertNotiEnabled"
          parameterType="map">
    INSERT INTO NOTIFICATION (
        NOTI_NO,
        MEMBER_NO,
        NOTI_TYPE,
        TARGET_ID,
        NOTI_URL,
        IS_READ,
        NOTI_REGDATE
    )
    SELECT
        SEQ_NOTIFICATION.NEXTVAL,
        #{vo.memberNo},
        #{vo.notiType},
        #{vo.targetId},
        #{vo.notiUrl},
        'N',
        CURRENT_TIMESTAMP
    FROM NOTIFICATION_SETTING S
    WHERE S.MEMBER_NO = #{vo.memberNo}

    <choose>
        <when test="settingKey == 'NOTI_TASK_COMMENT'">
            AND S.NOTI_TASK_COMMENT = 'Y'
        </when>
        <when test="settingKey == 'NOTI_BO_COMMENT'">
            AND S.NOTI_BO_COMMENT = 'Y'
        </when>
        <when test="settingKey == 'NOTI_MANAGER'">
            AND S.NOTI_MANAGER = 'Y'
        </when>
        <when test="settingKey == 'NOTI_SCHEDULE'">
            AND S.NOTI_SCHEDULE = 'Y'
        </when>
        <when test="settingKey == 'NOTI_SITE'">
            AND S.NOTI_SITE = 'Y'
        </when>
        <when test="settingKey == 'NOTI_INQUIRY_COMMENT'">
            AND S.NOTI_INQUIRY_COMMENT = 'Y'
        </when>
        <when test="settingKey == 'NOTI_DRAFT_UPLOAD'">
            AND S.NOTI_DRAFT_UPLOAD = 'Y'
        </when>
        <when test="settingKey == 'NOTI_CHAT'">
            AND S.NOTI_CHAT = 'Y'
        </when>
        <when test="settingKey == 'NOTI_APPROVAL'">
            AND S.NOTI_APPROVAL = 'Y'
        </when>
        <when test="settingKey == 'NOTI_PROJECT_NOTICE'">
            AND S.NOTI_PROJECT_NOTICE = 'Y'
        </when>
        <otherwise>
            AND 1 = 0
        </otherwise>
    </choose>
  </insert>
  
  
  <!--  공지사항 알림 db등록 -->
  <insert id="insertSiteNoticeNoti" parameterType="map">
	  INSERT INTO NOTIFICATION (
	    NOTI_NO, MEMBER_NO, NOTI_TYPE, TARGET_ID, NOTI_URL, IS_READ, NOTI_REGDATE
	  )
	  SELECT
	    SEQ_NOTIFICATION.NEXTVAL,
	    S.MEMBER_NO,
	    'SITE_NOTICE',
	    #{noticeNo},
	    #{notiUrl},
	    'N',
	    CURRENT_TIMESTAMP
	  FROM NOTIFICATION_SETTING S
	  WHERE S.NOTI_SITE = 'Y'
</insert>
  



</mapper>