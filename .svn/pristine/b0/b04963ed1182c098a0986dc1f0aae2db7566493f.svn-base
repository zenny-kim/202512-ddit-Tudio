package kr.or.ddit.config;

import javax.sql.DataSource;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.ProviderManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityCustomizer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;
import jakarta.servlet.DispatcherType;
import kr.or.ddit.member.service.impl.UserDetailServiceImpl;

@Configuration
@EnableWebSecurity(debug = false)
@EnableMethodSecurity // pre(전)Authorize, post(후)Authorize 애너테이션 사용 가능
public class SecurityConfig {

   @Autowired
   private DataSource dataSource;

   @Autowired
   UserDetailServiceImpl userDetailServiceImpl;

   @Bean // 매개변수
   protected SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
      return http.csrf(csrf -> csrf.disable()).httpBasic(hbasic -> hbasic.disable())
            .headers(config -> config.frameOptions(customizer -> customizer.sameOrigin()))
            .authorizeHttpRequests(authz -> authz
                  .dispatcherTypeMatchers(DispatcherType.FORWARD, DispatcherType.INCLUDE, DispatcherType.ASYNC).permitAll()
                  //여기 안에 필요한 사이트 넣어주기
                  .requestMatchers(
                		"/",
                		"/tudio/main",
                		"/tudio/login",
                		"/tudio/**",
                		"/tudio/login",
                        "/tudio/memberSignup",
                        "/tudio/clientSignup",
                        "/tudio/idCheck",
                        "/tudio/findMemberId",
                        "/tudio/findMemberPw",
                        "/tudio/emailAuthCode",
                        "/tudio/verifyAuthCode",
                        "/bizno/checkDb",
                        "/bizno/checkApi",
                        "/tudio/project/**",
                        "/error",
                        "/js/**",
                        "/adminlte/**",
                        "/images/**",
                        "/notice/**",
                        "/member/**",
                        "/resources/**",
                        "/css/**",
                        "/notice/**",
                        "/inquiry/**",
                        "/chat/**",
                        "/project/**")
                  .permitAll().anyRequest().authenticated())
            .formLogin(formLogin -> formLogin
                     .loginPage("/tudio/login")
                     .loginProcessingUrl("/login")
                     .successHandler(roleBasedSuccessHandler())
                     .failureUrl("/tudio/login?error")
                     .permitAll()
                 )
            .sessionManagement(session -> session.maximumSessions(1))
            .logout(logout -> logout.logoutSuccessUrl("/tudio/login").invalidateHttpSession(true)).build();
   }

   // 인증(로그인=Authentication) 관리자 설정
   public AuthenticationManager authenticationManager(HttpSecurity http, BCryptPasswordEncoder bCryptPasswordEncoder,
         UserDetailsService detailsService) {

      DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
      authProvider.setUserDetailsService(this.userDetailServiceImpl);
      authProvider.setPasswordEncoder(bCryptPasswordEncoder);
      return new ProviderManager(authProvider);
   }

   @Bean
   public WebSecurityCustomizer webSecurityCustomizer() {
       return (web) -> web.ignoring().requestMatchers(
           new AntPathRequestMatcher("/static/**"),
           new AntPathRequestMatcher("/resources/**"),
           new AntPathRequestMatcher("/css/**"),       
           new AntPathRequestMatcher("/js/**")         
       );
   }

   //패스워드 인코더로 사용할 빈 등록
   @Bean
   public BCryptPasswordEncoder bCryptPasswordEncoder() {
      return new BCryptPasswordEncoder();
   }
   
   @Bean
   public AuthenticationSuccessHandler roleBasedSuccessHandler() {
       return (request, response, authentication) -> {

           boolean isAdmin = authentication.getAuthorities().stream()
                   .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));

           // contextPath가 있든 없든 안전하게 처리
           String ctx = request.getContextPath(); // 보통 "" 또는 "/tudio"

           // ROLE_ADMIN -> /admin
           // ROLE_MEMBER, ROLE_CLIENT -> /tudio
           String targetUrl = isAdmin ? ctx + "/admin" : ctx + "/tudio/main";

           response.sendRedirect(targetUrl);
       };
   }
   

}
