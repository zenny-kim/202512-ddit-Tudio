<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.drive.mapper.IDriveMapper">
	
	<resultMap id="driveResultMap" type="java.util.HashMap">
	    <result property="fileId"        column="ID"/>
	    <result property="fileName"      column="NAME"/>
	    <result property="fileType"      column="TYPE"/>
	    <result property="fileSize"      column="SIZE_VAL"/> 
	    <result property="fileExtension" column="EXTENSION"/>
	    <result property="uploaderName"  column="UPLOADER_NAME"/>
	    <result property="regDate"       column="REG_DATE" javaType="java.time.LocalDate"/>
    </resultMap>

	<!-- 프로젝트 폴더(최상위 루트 폴더) 번호 조회 -->
	<select id="selectProjectRootFolderNo" resultType="int">
        SELECT FOLDER_NO
        FROM DRIVE_FOLDER
        WHERE PROJECT_NO = #{projectNo}
          AND PARENT_FOLDER_NO IS NULL  
          AND FOLDER_DELETE = 'N'
    </select>

	<!-- 선택 폴더에 해당되는 모든 폴더&파일 조회 -->
    <select id="selectDriveItems" resultMap="driveResultMap">
        SELECT 
            FOLDER_NO        AS ID,
            FOLDER_NAME      AS NAME,
            'FOLDER'         AS TYPE,
            0                AS SIZE_VAL,
            NULL             AS EXTENSION,
            (SELECT MEMBER_NAME 
             FROM MEMBER 
             WHERE MEMBER_NO = F.MEMBER_NO) AS UPLOADER_NAME,
            FOLDER_REGDATE   AS REG_DATE
        FROM DRIVE_FOLDER F
        WHERE PROJECT_NO = #{projectNo}
          AND PARENT_FOLDER_NO = #{folderId} 
          AND FOLDER_DELETE = 'N'

        UNION ALL

        SELECT 
            FF.DRIVE_FOLDER_FILE_NO AS ID,
            FF.FILE_NAME            AS NAME,
            'FILE'                  AS TYPE,
            FF.DRIVE_FILE_SIZE      AS SIZE_VAL,
            FF.DRIVE_FILE_EXTENSION AS EXTENSION,
            (SELECT MEMBER_NAME FROM MEMBER WHERE MEMBER_NO = FF.UPLOADER_NO) AS UPLOADER_NAME,
            FF.DRIVE_FILE_REGDATE   AS REG_DATE
        FROM DRIVE_FOLDER_FILE FF
        WHERE FF.FOLDER_NO = #{folderId}         
          AND FF.DRIVE_FILE_DELETE = 'N'
          
        ORDER BY TYPE DESC, NAME ASC
    </select>
    
    <!-- 폴더 트리 내의 모드 파일 정보 조회 -->
    <select id="selectAllFilesInFolderTree" parameterType="int" resultType="kr.or.ddit.vo.DriveFolderFileVO">
        SELECT *
        FROM DRIVE_FOLDER_FILE
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </select>
    
    <!-- 폴더 생성 -->
    <insert id="insertFolder" parameterType="kr.or.ddit.vo.DriveFolderVO">
        <selectKey keyProperty="folderNo" resultType="int" order="BEFORE">
            SELECT SEQ_DRIVE_FOLDER.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO DRIVE_FOLDER (
              FOLDER_NO
            , PROJECT_NO
            , FOLDER_NAME
            , MEMBER_NO
            , PARENT_FOLDER_NO
            , FOLDER_REGDATE
            , FOLDER_DELETE
        ) VALUES (
              #{folderNo}
            , #{projectNo}
            , #{folderName}
            , #{memberNo}
            , #{parentFolderNo}  
            , CURRENT_TIMESTAMP
            , 'N'
        )
    </insert>
    
    <!-- 프로젝트 폴더 생성 (프로젝트 생성시 최초 1회만 실행) -->
    <insert id="insertRootFolder" parameterType="kr.or.ddit.vo.DriveFolderVO">
		<selectKey keyProperty="folderNo" resultType="int" order="BEFORE">
			SELECT SEQ_DRIVE_FOLDER.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO DRIVE_FOLDER (
			  FOLDER_NO
			, PROJECT_NO
			, FOLDER_NAME
			, MEMBER_NO
			, PARENT_FOLDER_NO  
			, FOLDER_REGDATE
			, FOLDER_DELETE
		) VALUES (
			  #{folderNo}
			, #{projectNo}
			, #{folderName}
			, #{memberNo}
			, NULL              
			, CURRENT_TIMESTAMP
			, 'N'
		)
	</insert>
	
	<!-- 파일 업로드 -->
	<insert id="insertFile" parameterType="kr.or.ddit.vo.DriveFolderFileVO">
        <selectKey keyProperty="driveFolderFileNo" resultType="int" order="BEFORE">
            SELECT SEQ_DRIVE_FOLDER_FILE.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO DRIVE_FOLDER_FILE (
            DRIVE_FOLDER_FILE_NO
          , FOLDER_NO
          , UPLOADER_NO
          , FILE_NAME
          , DRIVE_FILE_SAVE_NAME
          , DRIVE_FILE_REGDATE
          , DRIVE_FILE_SIZE
          , DRIVE_FILE_FANCYSIZE
          , DRIVE_FILE_EXTENSION
          , DRIVE_FILE_MIME
          , DRIVE_FILE_DOWNLOAD_CNT
          , DRIVE_FILE_DELETE
          , DRIVE_FILE_PATH
        ) VALUES (
            #{driveFolderFileNo}
          , #{folderNo}
          , #{uploaderNo}
          , #{fileName}
          , #{driveFileSaveName}
          , CURRENT_TIMESTAMP
          , #{driveFileSize}
          , #{driveFileFancysize}
          , #{driveFileExtension}
          , #{driveFileMime}
          , 0
          , 'N'
          , #{driveFilePath}
        )
    </insert>

	<!-- 휴지통 목록 조회 -->
    <select id="selectTrashItems" resultMap="driveResultMap">
        SELECT 
            F.FOLDER_NO AS ID
          , F.FOLDER_NAME AS NAME
          , 'FOLDER' AS TYPE
          , 0 AS SIZE_VAL
          , NULL AS EXTENSION
          , (SELECT MEMBER_NAME FROM MEMBER WHERE MEMBER_NO = F.MEMBER_NO) AS UPLOADER_NAME
          , F.FOLDER_DELDATE AS REG_DATE 
        FROM DRIVE_FOLDER F
        LEFT JOIN DRIVE_FOLDER P ON F.PARENT_FOLDER_NO = P.FOLDER_NO -- 부모 폴더 조인
        WHERE F.PROJECT_NO = #{projectNo} 
          AND F.FOLDER_DELETE = 'Y'
          AND (P.FOLDER_DELETE = 'N' OR P.FOLDER_DELETE IS NULL) -- [핵심] 부모가 정상이거나 루트일 때만 보임
        
        UNION ALL
        
        SELECT 
            FF.DRIVE_FOLDER_FILE_NO AS ID
          , FF.FILE_NAME AS NAME
          , 'FILE' AS TYPE
          , FF.DRIVE_FILE_SIZE AS SIZE_VAL
          , FF.DRIVE_FILE_EXTENSION AS EXTENSION
          , (SELECT MEMBER_NAME FROM MEMBER WHERE MEMBER_NO = FF.UPLOADER_NO) AS UPLOADER_NAME
          , FF.DRIVE_FILE_DELDATE AS REG_DATE
        FROM DRIVE_FOLDER_FILE FF
        JOIN DRIVE_FOLDER DF 
          ON FF.FOLDER_NO = DF.FOLDER_NO
        WHERE DF.PROJECT_NO = #{projectNo}
		AND FF.DRIVE_FILE_DELETE = 'Y'
		AND DF.FOLDER_DELETE = 'N' -- [핵심] 부모 폴더가 정상일 때만 파일이 리스트에 뜸
    </select>

	<!-- 폴더 휴지통 이동 -->
    <update id="softDeleteFolder" parameterType="int">
        UPDATE DRIVE_FOLDER 
        SET FOLDER_DELETE = 'Y'
          , FOLDER_DELDATE = CURRENT_TIMESTAMP 
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </update>
    
    <!-- 특정 폴더(및 하위 폴더)에 속한 모든 파일 휴지통 이동 -->
    <update id="softDeleteFolderFiles" parameterType="int">
        UPDATE DRIVE_FOLDER_FILE
        SET DRIVE_FILE_DELETE = 'Y'
          , DRIVE_FILE_DELDATE = CURRENT_TIMESTAMP
        WHERE FOLDER_NO 
        IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </update>

	<!-- 파일 휴지통 이동 -->
    <update id="softDeleteFile" parameterType="int">
        UPDATE DRIVE_FOLDER_FILE 
        SET 
        	DRIVE_FILE_DELETE = 'Y'
          , DRIVE_FILE_DELDATE = CURRENT_TIMESTAMP 
        WHERE DRIVE_FOLDER_FILE_NO = #{fileNo}
    </update>

	<!-- 폴더 복구 -->
    <update id="restoreFolder" parameterType="int">
        UPDATE DRIVE_FOLDER 
        SET 
        	FOLDER_DELETE = 'N'
          , FOLDER_DELDATE = NULL 
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </update>
    
    <!-- 특정 폴더(및 하위 폴더)에 속한 모든 파일 복구 -->
    <update id="restoreFolderFiles" parameterType="int">
        UPDATE DRIVE_FOLDER_FILE
        SET DRIVE_FILE_DELETE = 'N'
          , DRIVE_FILE_DELDATE = NULL
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </update>
    
    <!--  파일 복구 -->
    <update id="restoreFile" parameterType="int">
        UPDATE DRIVE_FOLDER_FILE 
        SET 
        	DRIVE_FILE_DELETE = 'N'
          , DRIVE_FILE_DELDATE = NULL 
        WHERE DRIVE_FOLDER_FILE_NO = #{fileNo}
    </update>

	<!-- 폴더 영구 삭제 -->
    <delete id="deleteFolder" parameterType="int">
        DELETE FROM DRIVE_FOLDER 
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </delete>
    
    <!-- 특정 폴더(및 하위 폴더)에 속한 모든 파일 영구 삭제 -->
    <delete id="deleteFolderFiles" parameterType="int">
        DELETE FROM DRIVE_FOLDER_FILE
        WHERE FOLDER_NO IN (
            SELECT FOLDER_NO 
            FROM DRIVE_FOLDER
            START WITH FOLDER_NO = #{folderNo}
            CONNECT BY PRIOR FOLDER_NO = PARENT_FOLDER_NO
        )
    </delete>

	<!-- 파일 영구 삭제 -->
    <delete id="deleteFile" parameterType="int">
        DELETE FROM DRIVE_FOLDER_FILE 
        WHERE DRIVE_FOLDER_FILE_NO = #{fileNo}
    </delete>
    
    <!-- 파일 다운로드용 정보 조회 -->
    <select id="selectFileDetail" parameterType="int" resultType="kr.or.ddit.vo.DriveFolderFileVO">
        SELECT * 
        FROM DRIVE_FOLDER_FILE 
        WHERE DRIVE_FOLDER_FILE_NO = #{fileNo}
    </select>

</mapper>