<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c" %>

<div class="chat-widget">

    <header class="chat-room-header">
        <div class="header-left">
            <button id="backBtn" class="header-btn" aria-label="뒤로 가기" 
                    data-tooltip="뒤로 가기" data-tooltip-pos="left">
                <i data-feather="chevron-left"></i>
            </button>
        </div>

        <h2 class="room-title">
            <span class="room-name-text">AI 튜디오 비서</span>
            </h2>
        
        <div class="header-right">
            <button class="header-btn" aria-label="검색" data-tooltip="대화 검색">
                <i data-feather="search" style="width:20px; height:20px;"></i>
            </button>

            <button id="settingBtn" class="header-btn" aria-label="설정" data-tooltip="설정">
		        <i data-feather="more-vertical" style="width:20px; height:20px;"></i>
		    </button>
		
            <div id="settingMenu" class="chat-dropdown-menu" >
		        <ul>
		            <li><a href="#">알림 끄기</a></li>
		            <li class="danger"><a href="#">대화 내용 삭제</a></li>
		        </ul>
		    </div>
        </div>
    </header>

    <main class="chat-room-content">

        <div class="message-row received">
            <div class="default-avatar" style="background-color: var(--primary-color); color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="10" rx="2"></rect>
                    <circle cx="12" cy="5" r="2"></circle>
                    <path d="M12 7v4"></path>
                    <line x1="8" y1="16" x2="8.01" y2="16"></line>
                    <line x1="16" y1="16" x2="16.01" y2="16"></line>
                </svg>
            </div>

            <div class="message-content">
                <span class="sender-name">AI 비서</span>
                <div class="bubble-container">
                    <div class="message-bubble">안녕하세요! Tudio AI 비서입니다. 🤖<br>일정 관리나 프로젝트 진행 상황에 대해 궁금한 점이 있으신가요?</div>
                </div>
            </div>
        </div>

        <div class="message-row sent">
            <div class="bubble-container">
                <div class="message-bubble">오늘 내 일정 좀 알려줘</div>
            </div>
        </div>

        <div class="message-row received">
            <div class="default-avatar" style="background-color: var(--primary-color); color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="10" rx="2"></rect>
                    <circle cx="12" cy="5" r="2"></circle>
                    <path d="M12 7v4"></path>
                    <line x1="8" y1="16" x2="8.01" y2="16"></line>
                    <line x1="16" y1="16" x2="16.01" y2="16"></line>
                </svg>
            </div>

            <div class="message-content">
                <span class="sender-name">AI 비서</span>
                <div class="bubble-container">
                    <div class="message-bubble">📅 <strong>오늘 예정된 일정입니다.</strong><br><br>- 10:00 팀 주간 회의<br>- 14:00 최종 프로젝트 중간 점검<br><br>더 궁금한 사항이 있으신가요?</div>
                </div>
            </div>
        </div>

        <div class="message-row sent">
            <div class="bubble-container">
                <div class="message-bubble">중간 점검 때 필요한 서류가 뭐야?</div>
            </div>
        </div>
        
         <div class="message-row received">
             <div class="default-avatar" style="background-color: var(--primary-color); color: white;">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="10" rx="2"></rect>
                    <circle cx="12" cy="5" r="2"></circle>
                    <path d="M12 7v4"></path>
                    <line x1="8" y1="16" x2="8.01" y2="16"></line>
                    <line x1="16" y1="16" x2="16.01" y2="16"></line>
                </svg>
             </div>
             <div class="message-content">
                 <span class="sender-name">AI 비서</span>
                 <div class="bubble-container">
                     <div class="message-bubble">
                        <span style="display: inline-flex; gap: 4px; align-items: center;">
                            <span style="width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: blink 1s infinite 0s;"></span>
                            <span style="width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: blink 1s infinite 0.2s;"></span>
                            <span style="width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: blink 1s infinite 0.4s;"></span>
                        </span>
                     </div>
                 </div>
             </div>
         </div>

    </main>

    <footer class="chat-input-area">
        <button class="footer-btn attach-btn" aria-label="파일 첨부" 
                data-tooltip="파일 첨부" data-tooltip-pos="left">
            <i data-feather="plus" width="24" height="24"></i>
        </button>
        
        <div class="input-wrapper">
            <textarea class="chat-input" placeholder="AI에게 무엇이든 물어보세요..." rows="1"></textarea>
        </div>

        <button class="footer-btn send-btn" aria-label="전송" 
                data-tooltip="전송" data-tooltip-pos="right">
            <i data-feather="send" width="18" height="18"></i>
        </button>
    </footer>
    
</div>

<style>
    /* 타이핑 인디케이터 애니메이션 */
    @keyframes blink {
        0% { opacity: 0.2; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0.2; transform: scale(0.8); }
    }
</style>

<script>
$(function(){
    // 1. 아이콘 렌더링
    feather.replace();

    // 2. 스크롤 맨 아래로 이동
    const $chatContent = $('.chat-room-content');
    if($chatContent.length > 0) {
        $chatContent.scrollTop($chatContent[0].scrollHeight);
    }

    // 3. 텍스트 입력창 자동 높이 조절 (chatroom.js 로직과 동일)
    const textarea = $('.chat-input');
    function adjustHeight() {
        textarea.css('height', 'auto'); 
        let newHeight = textarea[0].scrollHeight;
        if (newHeight > 120) {
            textarea.css("overflow-y", "auto");  
        } else {
            textarea.css("overflow-y", "hidden"); 
        }
        if(newHeight < 36) newHeight = 36;
        textarea.css('height', newHeight + 'px');
    }

    textarea.on('input', adjustHeight);
    textarea.on('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            // 전송 로직 시늉
            let msg = $(this).val();
            if(msg.trim() !== "") {
                $(this).val('');
                adjustHeight();
                // 실제 전송은 안되지만 UX 확인용
                console.log("봇에게 전송: " + msg);
            }
        }
    });

    // 4. 설정 메뉴 토글
    $("#settingBtn").on("click", function(e){
        e.stopPropagation();
        $(this).toggleClass("active");
        $("#settingMenu").toggleClass("active");		
    });

    $(document).off("click").on("click", function(){
        $("#settingMenu").removeClass("active");		
        $("#settingBtn").removeClass("active");		
    });

    // 5. 뒤로 가기 (목록으로 로드)
    $("#backBtn").on("click", function(){
        // $container 변수는 main.jsp 스크립트 범위에 있다고 가정
        if(typeof $container !== 'undefined'){
            $container.load("/tudio/chat/list", function(){
                feather.replace();
            });
        } else {
            console.log("뒤로가기 클릭 (컨테이너 못찾음)");
        }
    });
});
</script>