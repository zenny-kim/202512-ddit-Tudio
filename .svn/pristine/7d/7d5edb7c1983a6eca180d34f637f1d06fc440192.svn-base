<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>

<style>
    /* 뱃지 스타일 */
    .badge-apply { background-color: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: normal; margin-right: 5px; }
    .badge-confirm { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: normal; margin-right: 5px; }
    
    /* 관리자 취소 사유 스타일 */
    .admin-cancel-reason {
        margin-top: 8px;
        padding: 4px 8px;
        background-color: #fff5f5;
        border: 1px solid #ffc9c9;
        border-radius: 4px;
        color: #e03131;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        overflow: hidden;
    }
</style>

<section class="tudio-section reservation-wrap">
    
    <div class="tudio-section-header d-flex align-items-center justify-content-between">
        <h2 class="h5 fw-bold m-0 text-primary-dark">
            <i class="bi bi-journal-check me-2"></i>나의 예약 현황
        </h2>
        <div class="my-res-tab-group">
            <button class="my-res-tab ${currentFilter eq 'ACTIVE' ? 'active' : ''}" onclick="reloadList('ACTIVE')">이용 현황</button>
            <button class="my-res-tab ${currentFilter eq 'HISTORY' ? 'active' : ''}" onclick="reloadList('HISTORY')">완료/취소 내역</button>
        </div>
        <button class="tudio-btn tudio-btn-primary" id="btnGoToMakeReservation">
            <i class="bi bi-plus-lg me-1"></i>새 예약 하러가기
        </button>
    </div>

    <div class="my-res-grid-container" id="my-res-list">
        <c:choose>
            <c:when test="${empty reservationList}">
                <div style="grid-column: 1 / -1; text-align: center; padding: 80px; color: #888;">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; color:#cbd5e1;"></i><br>
                    <span class="mt-3 d-block">
                        <c:choose>
                            <c:when test="${currentFilter eq 'HISTORY'}">완료되거나 취소된 내역이 없습니다.</c:when>
                            <c:otherwise>예약된 내역이 없습니다.</c:otherwise>
                        </c:choose>
                    </span>
                </div>
            </c:when>

            <c:otherwise>
                <%-- 비교용 변수 초기화 --%>
                <c:set var="prevDate" value="" />
                <%-- [중요] 이전 그룹 상태를 저장할 변수 (초기값: INIT) --%>
                <c:set var="prevKey" value="INIT" />

                <c:forEach items="${reservationList}" var="res">
                    
                    <%-- 날짜 포맷팅 --%>
                    <c:set var="startDateTimeStr" value="${res.resStartdate}" />
                    <fmt:parseDate value="${startDateTimeStr}" pattern="yyyy-MM-dd'T'HH:mm" var="parsedDate" type="both" />
                    <fmt:formatDate value="${parsedDate}" pattern="yyyy-MM-dd" var="currDate" />
                    <fmt:formatDate value="${parsedDate}" pattern="yyyy년 MM월 dd일 (E)" var="headerDate" />

                    <%-- 
                        ★ [그룹핑 핵심] 
                        703과 706을 'ST_CANCEL'이라는 같은 이름으로 묶어줍니다.
                        XML에서 정렬을 해줬기 때문에 이제 연속으로 나와서 헤더가 하나만 뜹니다.
                    --%>
                    <c:set var="currKey" value="ST_${(res.resStatus == 703 or res.resStatus == 706) ? 'CANCEL' : res.resStatus}" />

                    <%-- 1. 날짜 헤더 (ACTIVE 탭) --%>
                    <c:if test="${currentFilter eq 'ACTIVE' and currDate ne prevDate}">
                        <div class="date-group-header"><i class="bi bi-calendar-week"></i> ${headerDate}</div>
                        <c:set var="prevDate" value="${currDate}" />
                    </c:if>

                    <%-- 2. 상태 헤더 (HISTORY 탭) --%>
                    <c:if test="${currentFilter eq 'HISTORY' and currKey ne prevKey}">
                        <div class="status-group-header">
                            <c:choose>
                                <%-- 703, 706 둘 다 여기 걸림 --%>
                                <c:when test="${currKey eq 'ST_CANCEL'}">
                                    <span class="header-cancel"><i class="bi bi-x-circle-fill me-2"></i>예약 취소</span>
                                </c:when>
                                <c:when test="${currKey eq 'ST_704'}">
                                    <span class="header-done"><i class="bi bi-check-circle-fill me-2"></i>이용 완료</span>
                                </c:when>
                                <c:when test="${currKey eq 'ST_705'}">
                                    <span class="header-noshow"><i class="bi bi-exclamation-triangle-fill me-2"></i>미방문</span>
                                </c:when>
                            </c:choose>
                        </div>
                        <c:set var="prevKey" value="${currKey}" />
                    </c:if>

                    <%-- 3. 예약 카드 --%>
                    <div class="my-res-card ${currentFilter eq 'HISTORY' ? 'history' : ''}" style="position: relative;">
                        
                        <%-- 뱃지 --%>
                        <div style="position: absolute; top: 15px; right: 15px;">
                            <c:if test="${currentFilter eq 'ACTIVE'}">
                                <c:choose>
                                    <c:when test="${res.resStatus == 701}"><span class="badge badge-apply">예약 신청</span></c:when>
                                    <c:when test="${res.resStatus == 702}"><span class="badge badge-confirm">예약 확정</span></c:when>
                                </c:choose>
                            </c:if>
                        </div>
                    
                        <%-- 시간 --%>
                        <div class="my-res-date-badge">
                            <i class="bi bi-clock me-1"></i>
                            <c:if test="${currentFilter eq 'HISTORY'}"><fmt:formatDate value="${parsedDate}" pattern="MM.dd(E) " /></c:if>
                            <fmt:formatDate value="${parsedDate}" pattern="HH:mm" /> ~ 
                            <fmt:parseDate value="${res.resEnddate}" pattern="yyyy-MM-dd'T'HH:mm" var="parsedEndDate" type="both" />
                            <fmt:formatDate value="${parsedEndDate}" pattern="HH:mm" />
                        </div>
                    
                        <div class="my-res-location">${res.branchName} - ${res.roomName}</div>
                        <div class="my-res-title">${res.resMeetingTitle}</div>
                    
                        <div class="my-res-info-row">
                            <span class="my-res-info-label">예약자</span>
                            <span class="my-res-info-content">${res.memberName}</span>
                        </div>
                    
                        <div class="my-res-info-row">
                            <span class="my-res-info-label">참석자</span>
                            <span class="my-res-info-content my-res-attendees">
                                ${not empty res.memberListName ? res.memberListName : '<span class="text-muted small">정보 없음</span>'}
                            </span>
                        </div>

                        <%-- ★ 706번일 때만 뜨는 작고 깔끔한 사유 박스 --%>
                        <c:if test="${res.resStatus == 706}">
                            <div class="admin-cancel-reason">
                                <i class="bi bi-info-circle-fill"></i>
                                <span class="fw-bold me-1">취소 사유:</span>
                                <span class="text-truncate" style="flex: 1;" title="${res.resContent}">
                                    ${res.resContent}
                                </span>
                            </div>
                        </c:if>
                    
                        <c:if test="${currentFilter eq 'ACTIVE'}">
                            <div class="my-res-btn-group">
                                <button class="btn-action btn-edit" onclick="openEditModal(${res.reservationId}, ${res.projectNo})">
                                    <i class="bi bi-pencil-square"></i> 변경
                                </button>
                                <button class="btn-action btn-cancel" onclick="cancelReservation(${res.reservationId})">
                                    <i class="bi bi-trash"></i> 취소
                                </button>
                            </div>
                        </c:if>
                    
                    </div>
                </c:forEach>
            </c:otherwise>
        </c:choose>
    </div>
</section>

<script src="/js/projectBoard.js"></script>