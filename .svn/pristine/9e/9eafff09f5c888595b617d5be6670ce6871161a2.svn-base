<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.member.mapper.MemberMapper">

	<resultMap id="memberMap" type="kr.or.ddit.vo.MemberVO">
		<id column="MEMBER_NO" property="memberNo" />
		<result column="MEMBER_ID" property="memberId" />
		<result column="MEMBER_PW" property="memberPw" />
		<result column="MEMBER_NAME" property="memberName" />
		<result column="MEMBER_TEL" property="memberTel" />

		<result column="COMPANY_NO" property="companyNo" />
		<result column="COMPANY_NO_STATUS" property="companyNoStatus" />

		<result column="MEMBER_EMAIL" property="memberEmail" />
		<result column="EMAIL_STATUS" property="emailStatus" />

		<result column="MEMBER_DEPARTMENT" property="memberDepartment" />
		<result column="MEMBER_POSITION" property="memberPosition" />
		<result column="SELECTIVE_CONSENT" property="selectiveConsent" />

		<result column="MEMBER_JOIN_DATE" property="memberJoinDate" />
		<result column="MEMBER_LEAVE_DATE" property="memberLeaveDate" />

		<result column="LEAVE_STATUS" property="leaveStatus" />
		<result column="LEAVE_REASON" property="leaveReason" />

		<result column="MEMBER_REGNO" property="memberRegno" />
		<result column="MEMBER_REGDATE" property="memberRegdate" />
		<result column="MEMBER_PROFILEIMG" property="memberProfileimg" />

		<collection property="memberAuthVOList" resultMap="authMap" />
	</resultMap>

	<resultMap id="authMap" type="kr.or.ddit.vo.MemberAuthVO">
		<result column="MEMBER_NO" property="memberNo" />
		<result column="AUTH" property="auth" />
	</resultMap>

	<!-- 아이디 찾기 -->
	<select id="findMemberId" parameterType="kr.or.ddit.vo.MemberVO" resultType="string">
		SELECT 
			member_id
		FROM 
			member
		WHERE 
			member_name = #{memberName}
		AND member_email = #{memberEmail}
		AND leave_status = 'N' 
	</select>
	
	<!-- 비밀번호 찾기 -->
	<select id="findMemberPw" parameterType="kr.or.ddit.vo.MemberVO" resultMap="memberMap">
	    SELECT 
	        MEMBER_NO, MEMBER_ID, MEMBER_NAME, COMPANY_NO,
	        MEMBER_TEL, MEMBER_EMAIL, LEAVE_STATUS
	    FROM MEMBER
	    WHERE MEMBER_ID = #{memberId}
	      AND MEMBER_NAME = #{memberName}
	      AND MEMBER_TEL = #{memberTel}
	      AND LEAVE_STATUS = 'N'
	</select>
	<update id="updateNewMemberPw" parameterType="kr.or.ddit.vo.MemberVO">
	    UPDATE MEMBER
	    SET MEMBER_PW = #{memberPw}
	    WHERE MEMBER_ID = #{memberId}
	</update>
       
       
	<!-- 로그인 (권한테이블과 조인, 컬럼생성) -->
	<select id="findByMemberId" parameterType="string" resultMap="memberMap">
		SELECT
			M.MEMBER_NO, M.MEMBER_ID, M.MEMBER_PW,
			M.MEMBER_NAME, M.MEMBER_TEL, M.COMPANY_NO, M.COMPANY_NO_STATUS,
			M.MEMBER_EMAIL, M.EMAIL_STATUS, M.MEMBER_DEPARTMENT, M.MEMBER_POSITION,
			M.SELECTIVE_CONSENT, M.MEMBER_JOIN_DATE, M.MEMBER_LEAVE_DATE,
			M.LEAVE_STATUS, M.LEAVE_REASON, M.MEMBER_REGNO, M.MEMBER_PROFILEIMG,
			A.AUTH
		FROM MEMBER M
			LEFT OUTER JOIN MEMBER_AUTH A ON(M.MEMBER_NO = A.MEMBER_NO)
		WHERE
			M.MEMBER_ID = #{memberId}
		AND M.LEAVE_STATUS = 'N'
	</select>
	
	<!-- 아이디 중복확인 -->
	<select id="idCheck" parameterType="string" resultType="kr.or.ddit.vo.MemberVO">
	    SELECT MEMBER_NO, MEMBER_ID
		FROM MEMBER
		WHERE MEMBER_ID = #{memberId}
	</select>
	
	<!-- 일반회원가입 -->
	<insert id="memberSignup" parameterType="kr.or.ddit.vo.MemberVO" useGeneratedKeys="true" keyProperty="memberNo">
		<selectKey keyProperty="memberNo" resultType="int" order="BEFORE">
	        SELECT SEQ_MEMBER.NEXTVAL FROM DUAL
	    </selectKey>
	    
		INSERT INTO MEMBER (
	        MEMBER_NO, 
	        MEMBER_ID, 
	        MEMBER_PW,
	        MEMBER_NAME, 
	        MEMBER_TEL, 
	        COMPANY_NO, 
	        COMPANY_NO_STATUS,
	        MEMBER_EMAIL, 
	        EMAIL_STATUS, 
	        MEMBER_DEPARTMENT, 
	        MEMBER_POSITION,
	        SELECTIVE_CONSENT, 
	        MEMBER_JOIN_DATE, 
	        LEAVE_STATUS,
	        MEMBER_REGNO, 
	        MEMBER_PROFILEIMG
	    ) VALUES (
	        #{memberNo},
	        #{memberId},
	        #{memberPw},
	        #{memberName},
	        #{memberTel}, 
	        #{companyNo},
	        #{companyNoStatus}, 
	        #{memberEmail},
	        #{emailStatus}, 
	        #{memberDepartment},
	        #{memberPosition},
	        #{selectiveConsent},
	        CURRENT_TIMESTAMP,
	        'N', 
	        #{memberRegno},
	        #{memberProfileimg}
	    )
	</insert>
	
	<!-- 기업관리자 회원가입 -->
	<insert id="insertClientCompany" parameterType="kr.or.ddit.vo.ClientCompanyVO">
	    INSERT INTO CLIENT_COMPANY (
	        COMPANY_NO, 
	        COMPANY_NAME,
	        COMPANY_ADDR1, 
	        COMPANY_ADDR2,
	        COMPANY_TEL, 
	        COMPANY_POSTCODE, 
	        COMPANY_CEO_NAME,
	        COMPANY_AUTH_STATUS, 
	        BIZ_FILE_NO
	    ) VALUES (
	        #{companyNo}, #{companyName},
	        #{companyAddr1},
	        #{companyAddr2},
	        #{companyTel},
	        #{companyPostcode},
	        #{companyCeoName},
	        'N',
	        #{bizFileNo} )
	</insert>
		
	<!-- 일반회원가입 권한생성 -->
	<insert id="insertMemberAuth">
	    INSERT INTO MEMBER_AUTH (MEMBER_NO, AUTH)
	    VALUES (#{memberNo}, #{auth})
	</insert>
	
	<!-- 회원가입 프로필 파일 그룹 -->
	<insert id="insertProfileFileGroup" parameterType="kr.or.ddit.vo.FileGroupVO">
	    <selectKey keyProperty="fileGroupNo" resultType="int" order="BEFORE">
	        SELECT SEQ_FILE_GROUP.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO FILE_GROUP (
	        FILE_GROUP_NO, 
	        FILE_GROUP_TYPE, 
	        MEMBER_NO, 
	        FILE_GROUP_REGDATE
	    ) VALUES (
	        #{fileGroupNo}, 
	        #{fileGroupType}, 
	        #{memberNo}, 
	        CURRENT_TIMESTAMP
	    )
	</insert>

	<!-- 회원가입 프로필 파일디테일 -->
	<insert id="insertProfileFileDetail" parameterType="kr.or.ddit.vo.FileDetailVO">
	    INSERT INTO FILE_DETAIL (
	        FILE_NO, 
	        FILE_GROUP_NO, 
	        FILE_ORIGINAL_NAME, 
	        FILE_SAVE_NAME, 
	        FILE_PATH, 
	        FILE_SIZE, 
	        FILE_EXTENSION, 
	        FILE_MIME, 
	        FILE_DOWNLOAD_CNT, 
	        FILE_REGDATE, 
	        FILE_DELETE
	    ) VALUES (
	        SEQ_FILE.NEXTVAL, 
	        #{fileGroupNo},
	        #{fileOriginalName}, 
	        #{fileSaveName},
	        #{filePath}, 
	        #{fileSize}, 
	        #{fileExtension}, 
	        #{fileMime}, 
	        0, 
	        CURRENT_TIMESTAMP, 
	        'N'
	    )
	</insert>
	
	<!-- 공통 프로필 위치 업로드 -->
	<update id="updateMemberProfile" parameterType="kr.or.ddit.vo.MemberVO">
	    UPDATE MEMBER
	    SET MEMBER_PROFILEIMG = #{memberProfileimg}
	    WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 회원가입 사업자번호 db 조회 -->
	<select id="getCompanyInfo" parameterType="String" resultType="kr.or.ddit.vo.ClientCompanyVO">
	    SELECT 
	        COMPANY_NO, 
	        COMPANY_NAME, 
	        COMPANY_CEO_NAME, 
	        COMPANY_ADDR1, 
	        COMPANY_ADDR2
	    FROM 
	        CLIENT_COMPANY
	    WHERE 
	        COMPANY_NO = #{companyNo}
	</select>

	<!-- 사업자등록증 파일 그룹 -->
	<insert id="insertbizFileFileGroup" parameterType="fileGroupVO">
		<selectKey keyProperty="fileGroupNo" resultType="int" order="BEFORE">
	        SELECT SEQ_FILE_GROUP.NEXTVAL FROM DUAL
	    </selectKey>
		INSERT INTO FILE_GROUP (
	        FILE_GROUP_NO, 
	        FILE_GROUP_TYPE, 
	        MEMBER_NO, 
	        FILE_GROUP_REGDATE
	    ) VALUES (
	        #{fileGroupNo}, 
	        #{fileGroupType}, 
	        #{memberNo}, 
	        CURRENT_TIMESTAMP
	    )
	</insert>

	<!-- 사업자등록증 파일 디테일 -->
	<insert id="insertbizFileFileDetail" parameterType="fileDetailVO">
		INSERT INTO FILE_DETAIL (
			FILE_NO, 
	        FILE_GROUP_NO, 
	        FILE_ORIGINAL_NAME, 
	        FILE_SAVE_NAME, 
	        FILE_PATH, 
	        FILE_SIZE, 
	        FILE_EXTENSION, 
	        FILE_MIME, 
	        FILE_DOWNLOAD_CNT, 
	        FILE_REGDATE, 
	        FILE_DELETE
		) VALUES (
			#{fileGroupNo},
	        #{fileOriginalName}, 
	        #{fileSaveName},
	        #{filePath}, 
	        #{fileSize}, 
	        #{fileExtension}, 
	        #{fileMime}, 
	        0, 
	        CURRENT_TIMESTAMP, 
	        'N'
		)
	</insert>
	
	
	

</mapper>