<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tudio - My Task</title>
    <jsp:include page="/WEB-INF/views/include/common.jsp" />
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/my_task.css">
</head>
<body class="d-flex flex-column min-vh-100">
    <jsp:include page="/WEB-INF/views/include/headerUser.jsp"/>
    
    <div class="d-flex flex-grow-1">
        <jsp:include page="../include/sidebarUser.jsp">
              <jsp:param name="menu" value="myTask" />
        </jsp:include>
        
        <main class="main-content-wrap flex-grow-1 px-4 pt-4 pb-5">
            <div class="container-fluid my-task-container">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="fw-bold text-primary-dark m-0">
                            <i class="bi bi-collection me-2"></i>내 업무 모아보기
                        </h3>
                        <p class="text-muted mb-0 small mt-2">참여 중인 모든 프로젝트의 업무를 한눈에 확인하세요.</p>
                        
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="toggleAllCheckbox" style="cursor: pointer;">
                            <label class="form-check-label small text-muted user-select-none" for="toggleAllCheckbox" style="cursor: pointer;">
                                하위업무 모두 펼치기
                            </label>
                        </div>
                    </div>
                    
                    <form id="filterForm" action="${pageContext.request.contextPath}/tudio/myTask" method="get" class="d-flex align-items-center gap-2">
                        <select name="projectStatus" class="form-select form-select-sm" style="width: 140px;" onchange="this.form.submit()">
                            <option value="0" ${currentStatus == 0 or currentStatus == null ? 'selected' : ''}>진행중 프로젝트</option>
                            <option value="1" ${currentStatus == 1 ? 'selected' : ''}>완료된 프로젝트</option>
                            <option value=""  ${currentStatus == null and param.projectStatus != null ? 'selected' : ''}>전체 프로젝트</option>
                        </select>

                        <div class="btn-group" role="group">
						    <input type="radio" class="btn-check" name="type" id="typeAll" value="" onchange="this.form.submit()">
						    <label class="btn btn-outline-primary btn-sm" for="typeAll">전체</label>
						
						    <input type="radio" class="btn-check" name="type" id="typeWriter" value="writer" onchange="this.form.submit()">
						    <label class="btn btn-outline-primary btn-sm" for="typeWriter">내가 작성</label>
						
						    <input type="radio" class="btn-check" name="type" id="typeManager" value="manager" onchange="this.form.submit()">
						    <label class="btn btn-outline-primary btn-sm" for="typeManager">내가 담당</label>
						</div>
                        
                        <button type="button" class="tudio-btn tudio-btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                            <i class="bi bi-plus-lg"></i> 새 업무 등록
                        </button>
                    </form>
                </div>
        
                <c:choose>
                    <c:when test="${empty myTaskMap}">
                        <div class="text-center py-5 text-muted border rounded bg-white mt-5">
                            <i class="bi bi-clipboard-x fs-1 d-block mb-3"></i>
                            <p class="m-0">조회된 업무가 없습니다.</p>
                        </div>
                    </c:when>
                    <c:otherwise>
                        <c:forEach items="${myTaskMap}" var="entry">
                            <c:set var="taskList" value="${entry.value}" />
                            <c:set var="pName" value="${taskList[0].projectName}" />

                            <div class="tudio-section mb-5">
                                <div class="tudio-section-header">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-folder2-open text-primary-dark"></i>
                                        <span class="fw-bold text-primary-dark">${pName}</span>
                                        <span class="tudio-badge bg-light text-secondary border">${fn:length(taskList)}</span>
                                    </div>
                                </div>
                                <div class="p-0">
                                    <table class="tudio-table-card mb-0">
                                        <colgroup>
                                            <col style="width: 20%;"> <col style="width: 8%;">  <col style="width: 9%;">  <col style="width: 10%;"> <col style="width: 10%;"> <col style="width: 8%;">  <col style="width: 12%;"> <col style="width: 8%;">  </colgroup>
                                        <thead>
                                            <tr>
                                                <th>업무명</th>
                                                <th>상태</th>
                                                <th>담당자</th>
                                                <th>시작일</th> 
                                                <th>마감일</th>
                                                <th>중요도</th>
                                                <th>진척도</th>
                                                <th>작성자</th> 
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <c:forEach items="${taskList}" var="task">
                                                
                                                <c:set var="isMyParent" value="${task.isMyTask eq 'Y'}" />
                                                <c:set var="hasSubTasks" value="${not empty task.subTasks}" />

                                                <c:if test="${!isMyParent}">
                                                    <tr class="task-shell-row">
                                                        <td class="task-title">
                                                            <c:if test="${hasSubTasks}">
                                                                <span class="toggle-btn me-2" onclick="toggleSubTasks('${task.taskId}', this)">
                                                                    <i class="bi bi-caret-right-fill toggle-icon"></i>
                                                                </span>
                                                            </c:if>
                                                            <c:if test="${!hasSubTasks}"><span style="width:20px; display:inline-block;"></span></c:if>
                                                            
                                                            <span class="text-muted" style="text-decoration: none;">${task.taskTitle}</span>
                                                        </td>
                                                        <td colspan="7" class="text-start">
                                                            <span class="small text-muted ps-2" style="opacity: 0.6;">
                                                                <i class="bi bi-info-circle me-1"></i>내 하위업무가 포함된 상위 그룹입니다.
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </c:if>

                                                <c:if test="${isMyParent}">
                                                    <tr class="task-row" onclick="openTaskDetail('${task.taskId}')" style="cursor: pointer;">
                                                        <td class="task-title">
                                                            <c:if test="${hasSubTasks}">
                                                                <span class="toggle-btn me-1" onclick="toggleSubTasks('${task.taskId}', this); event.stopPropagation();">
                                                                    <i class="bi bi-caret-right-fill toggle-icon"></i>
                                                                </span>
                                                            </c:if>
                                                            <c:if test="${!hasSubTasks}">
                                                                <span class="me-1" style="width: 20px; display:inline-block;"></span> 
                                                            </c:if>
                                                            
                                                            <div class="pin-wrapper me-1" onclick="event.stopPropagation(); togglePin('${task.taskId}')">
                                                                <i class="bi bi-pin-angle${task.taskPinYn eq 'Y' ? '-fill active' : ''} task-pin-icon" 
                                                                   title="상단 고정"></i>
                                                            </div>

                                                            <span class="task-title-text">${task.taskTitle}</span>
                                                        </td>

                                                        <td><span class="tudio-badge task-status-${fn:toLowerCase(task.taskStatus.name())}">${task.taskStatus.label}</span></td>
                                                        <td><span class="small text-muted">${task.taskManagerName}</span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${task.taskStartdate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${task.taskEnddate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="tudio-badge task-priority-${fn:toLowerCase(task.taskPriority.name())}">${task.taskPriority.label}</span></td>
                                                        <td>
                                                            <div class="d-flex align-items-center justify-content-center gap-2">
                                                                <div class="progress" style="height: 6px; width: 60px;">
                                                                    <div class="progress-bar bg-primary" style="width: ${task.taskRate}%"></div>
                                                                </div>
                                                                <span class="small text-muted" style="width: 30px;">${task.taskRate}%</span>
                                                            </div>
                                                        </td>
                                                        <td><span class="small text-muted">${task.writerName}</span></td>
                                                    </tr>
                                                </c:if>

                                                <c:forEach items="${task.subTasks}" var="sub">
                                                    <tr class="sub-row sub-group-${task.taskId}" onclick="openSubTaskDetail('${sub.subId}')" style="cursor: pointer;">
                                                        <td class="sub-title">
                                                            <div class="d-flex align-items-center">
                                                                <i class="bi bi-arrow-return-right text-muted me-2"></i>
                                                                <div class="pin-wrapper me-2" onclick="event.stopPropagation();"> 
                                                                    <i class="bi bi-pin-angle${sub.subPinYn eq 'Y' ? '-fill active' : ''} sub-pin-icon"></i>
                                                                </div>
                                                                <span class="text-dark small">${sub.subTitle}</span>
                                                            </div>
                                                        </td>
                                                        
                                                        <td><span class="tudio-badge task-status-${fn:toLowerCase(sub.subStatus.name())}">${sub.subStatus.label}</span></td>
                                                        <td><span class="small text-muted">${sub.taskManagerName}</span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${sub.subStartdate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="small text-muted"><fmt:formatDate value="${sub.subEnddate}" pattern="yyyy.MM.dd"/></span></td>
                                                        <td><span class="tudio-badge task-priority-${fn:toLowerCase(sub.subPriority.name())}">${sub.subPriority.label}</span></td>
                                                        <td>
                                                            <div class="d-flex align-items-center justify-content-center gap-2">
                                                                <div class="progress" style="height: 6px; width: 60px;">
                                                                    <div class="progress-bar bg-success" style="width: ${sub.subRate}%"></div>
                                                                </div>
                                                                <span class="small text-muted" style="width: 30px;">${sub.subRate}%</span>
                                                            </div>
                                                        </td>
                                                        <td><span class="small text-muted">${sub.writerName}</span></td>
                                                    </tr>
                                                </c:forEach>
                                            </c:forEach>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </c:forEach>
                    </c:otherwise>
                </c:choose>
		
		        <div id="projectTaskContainer" class="d-flex flex-column gap-4"></div>
		
		    </div>
		</main>
	</div>
    
    <div id="taskDetailPanel" class="task-detail-panel">
        <div class="panel-header">
            <h5 class="fw-bold mb-0 text-primary-dark">업무 상세 정보</h5>
            <button type="button" class="btn-close" onclick="closeTaskPanel()"></button>
        </div>
        <div class="panel-body">
            <form id="taskEditForm">
                <div class="mb-4"><label class="form-label small fw-bold text-muted">업무 제목</label><input type="text" class="form-control fw-bold" id="detailTitle" style="font-size: 1.1rem;"></div>
            </form>
        </div>
        <div class="panel-footer">
            <button type="button" class="tudio-btn tudio-btn-outline-danger">삭제</button>
            <button type="button" class="tudio-btn tudio-btn-primary">변경사항 저장</button>
        </div>
    </div>

    <div class="modal fade" id="newTaskModal" tabindex="-1">
       <div class="modal-dialog modal-dialog-centered tudio-modal">
            <div class="modal-content">
                <div class="modal-header tudio-modal-header"><h5 class="modal-title tudio-modal-title fw-bold">새 업무 등록</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><form><div class="mb-3"><label class="form-label small fw-bold text-muted">업무명</label><input type="text" class="form-control"></div></form></div>
                <div class="modal-footer tudio-modal-footer"><button type="button" class="tudio-btn tudio-btn-outline" data-bs-dismiss="modal">취소</button><button type="button" class="tudio-btn tudio-btn-primary">등록하기</button></div>
            </div>
        </div>
    </div>

    <jsp:include page="../chat/main.jsp"/>
    <jsp:include page="/WEB-INF/views/include/footer.jsp"/>
</body>
<script>
    function toggleSubTasks(taskId, btnElement) {
        const subRows = document.querySelectorAll('.sub-group-' + taskId);
        const icon = btnElement.querySelector('i');
        let isVisible = false;
        if(subRows.length > 0) isVisible = (window.getComputedStyle(subRows[0]).display !== 'none');

        if (!isVisible) {
            subRows.forEach(row => row.style.display = 'table-row');
            icon.classList.remove('bi-caret-right-fill');
            icon.classList.add('bi-caret-down-fill');
        } else {
            subRows.forEach(row => row.style.display = 'none');
            icon.classList.remove('bi-caret-down-fill');
            icon.classList.add('bi-caret-right-fill');
        }
    }

    function openTaskDetail(id) { document.getElementById('taskDetailPanel').classList.add('open'); }
    function closeTaskPanel() { document.getElementById('taskDetailPanel').classList.remove('open'); }
    
    function openSubTaskDetail(subId) { console.log("하위업무 상세 클릭: " + subId); }

    function togglePin(id) {
        const target = event.currentTarget.querySelector('i');
        if(target){
            target.classList.toggle('active');
            target.classList.toggle('bi-pin-angle');
            target.classList.toggle('bi-pin-angle-fill');
        }
    }
    
 	//============================================================
    // [추가] 페이지 로드 시 URL 파라미터를 읽어 필터 버튼 활성화
    // [추가] 하위업무 모두 펼치기/접기 기능
    // ============================================================
    document.addEventListener("DOMContentLoaded", function() {
        // --------------------------------------------------------
        // 1. 라디오 버튼 색상 유지 로직
        // --------------------------------------------------------
        const urlParams = new URLSearchParams(window.location.search);
        const typeParam = urlParams.get('type'); 

        let targetId = 'typeAll'; 
        if (typeParam === 'writer') {
            targetId = 'typeWriter';
        } else if (typeParam === 'manager') {
            targetId = 'typeManager';
        }

        const targetInput = document.getElementById(targetId);
        if (targetInput) {
            targetInput.checked = true; 
            const targetLabel = document.querySelector('label[for="' + targetId + '"]');
            if (targetLabel) {
                targetLabel.classList.add('active');
            }
        }

        // --------------------------------------------------------
        // 2. [NEW] 하위업무 모두 펼치기 기능
        // --------------------------------------------------------
        const toggleAllBtn = document.getElementById('toggleAllCheckbox');
        
        if(toggleAllBtn){
            toggleAllBtn.addEventListener('change', function(){
                const isChecked = this.checked;
                
                // 모든 하위업무 행 (.sub-row)
                const allSubRows = document.querySelectorAll('.sub-row');
                // 모든 토글 아이콘 (.toggle-btn 안의 i 태그)
                const allIcons = document.querySelectorAll('.toggle-btn i');

                // A. 하위업무 표시/숨김 처리
                allSubRows.forEach(row => {
                    row.style.display = isChecked ? 'table-row' : 'none';
                });

                // B. 아이콘 방향 일괄 변경
                allIcons.forEach(icon => {
                    if(isChecked){
                        // 펼쳐짐 (아래 화살표)
                        icon.classList.remove('bi-caret-right-fill');
                        icon.classList.add('bi-caret-down-fill');
                    } else {
                        // 접힘 (오른쪽 화살표)
                        icon.classList.remove('bi-caret-down-fill');
                        icon.classList.add('bi-caret-right-fill');
                    }
                });
            });
        }
    });
</script>
</html>