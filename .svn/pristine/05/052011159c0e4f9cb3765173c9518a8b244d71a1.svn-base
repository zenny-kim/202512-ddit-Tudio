<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<jsp:include page="/WEB-INF/views/include/common.jsp" />
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/project_common.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
.bg-light { background-color: #f8fafc !important; }
.custom-table {
    border-collapse: collapse !important;
    border-left: none !important;
    border-right: none !important;
    border-top: 1px solid #dee2e6 !important;
    border-bottom: 1px solid #dee2e6 !important;
}
.custom-table th, .custom-table td {
    border: 1px solid #dee2e6 !important;
    border-left: none !important;
    border-right: none !important;
}
.custom-table th.bg-light {
    background-color: #fcfcfc !important;
    font-weight: 600;
    color: #444;
}
/* 결재 칸 전용 스타일 추가 */
.approver-box {
    width: 80px;
    border: 1px solid #dee2e6;
    text-align: center;
}
</style>
</head>
<body>
	<section class="tudio-section">
		<!-- APPROVAL DETAIL 화면 입니다. -->
		<jsp:include page="../include/headerUser.jsp" />

		<div class="d-flex">
			<!-- 사이드바 -->
			<jsp:include page="../include/sidebarUser.jsp">
				<jsp:param name="menu" value="approval" />
			</jsp:include>

			<main class="main-content-wrap flex-grow-1 px-4 pt-4 pb-5">
				<div class="container-fluid">

					<div class="d-flex justify-content-between align-items-center mb-4">
						<!-- 소제목 -->
						<h2 class="h3 fw-bold text-primary-dark mb-0">
							<i class="bi bi-file-earmark-check me-2"></i> 결재 문서 
						</h2>
					</div>




					<div class="tudio-scope">
						<div class="d-flex justify-content-between align-items-end mb-0">
							<ul class="nav nav-tabs custom-index-tabs border-0 mb-0">
								<li class="nav-item">
									<button class="nav-link active" type="button">
										<i class="bi bi-pencil-fill"></i> <span>문서 확인</span>
									</button>
								</li>
							</ul>
						</div>

						<div class="tab-content-card p-4">
								<div class="row mb-4">
									<div class="col-md-7">
										<table class="table table-bordered align-middle mb-0 custom-table">
											<tr>
												<th class="bg-light text-center" style="width: 25%;">프로젝트</th>
												<td>${draft.projectName}</td>
											</tr>
											<tr>
												<th class="bg-light text-center">기안자</th>
												<td class="small">${draft.drafterName}
													<span class="text-muted"> 
														(<c:out value="${draft.drafterDept}" default="부서미지정" /> / 
														 <c:out value="${draft.drafterPos}" default="직책미지정" />)
													</span>
												</td>
											</tr>
											<tr>
												<th class="bg-light text-center">기안일자</th>
												<td class="small">${draft.documentRegdate}</td>
											</tr>
											<tr>
												<th class="bg-light text-center">보안 여부</th>
												<td>
						                            <c:choose>
						                                <c:when test="${draft.isPublic == 'Y'}">
						                                    <span class="badge bg-success">공개</span> 
						                                    <span class="text-muted small">(모두 조회 가능)</span>
						                                </c:when>
						                                <c:otherwise>
						                                    <span class="badge bg-danger">비공개</span> 
						                                    <span class="text-muted small">(결재자만 가능)</span>
						                                </c:otherwise>
						                            </c:choose>
						                        </td>
											</tr>
										</table>
									</div>

									<div class="col-md-5">
										<div class="d-flex justify-content-end align-items-start gap-1">
										    <div class="border text-center" style="width: 80px;">
										        <div class="bg-light border-bottom p-1 small">담당</div>
										        <div class="p-2 d-flex align-items-center justify-content-center" style="height: 60px;">
										            ${draft.drafterName}
										        </div>
										        <div class="bg-light border-top p-1 small">${draft.documentRegdate}</div>
										    </div>
										
										    <c:forEach var="app" items="${approvalList}">
										        <div class="border text-center" style="width: 80px;">
										            <div class="bg-light border-bottom p-1 small">승인</div>
										            <div class="p-2 d-flex align-items-center justify-content-center" style="height: 60px;">
										                <c:choose>
										                    <c:when test="${app.approvalStatus == 609}">
										                        <span class="text-primary fw-bold">승인</span>
										                    </c:when>
										                    <c:when test="${app.approvalStatus == 610}">
										                        <span class="text-danger fw-bold">반려</span>
										                    </c:when>
										                    <c:otherwise>
										                        <span class="text-muted">${app.memberName}</span>
										                    </c:otherwise>
										                </c:choose>
										            </div>
										            <div class="bg-light border-top p-1 small">
										                <c:choose>
										                    <c:when test="${not empty app.approvalDate}">
										                        <fmt:formatDate value="${app.approvalDate}" pattern="MM-dd"/>
										                    </c:when>
										                    <c:otherwise>&nbsp;</c:otherwise>
										                </c:choose>
										            </div>
										        </div>
										    </c:forEach>
										</div>
									</div>
								</div>

								<div class="mb-4">
									<label class="fw-bold mb-2">제목</label>
						            <div class="p-2 border rounded bg-white">
						                ${draft.documentTitle}
						            </div>
								</div>

								<div class="mb-4">
									<label class="fw-bold mb-2">내용</label>
						            <div class="p-4 border rounded bg-white" style="min-height: 300px;">
						                ${draft.documentContent} </div>
								</div>

								<div class="p-3 border rounded bg-light">
						            <label class="fw-bold small mb-2"><i class="bi bi-paperclip"></i> 첨부파일</label>
						            <div id="fileListContainer">
						                <c:choose>
						                    <c:when test="${empty fileList}">
						                        <span class="text-muted small">첨부된 파일이 없습니다.</span>
						                    </c:when>
						                    <c:otherwise>
						                        <c:forEach var="file" items="${fileList}">
						                            <div class="mb-1">
						                                <a href="${contextPath}/approval/download?fileNo=${file.fileNo}" class="text-decoration-none small">
						                                    <i class="bi bi-file-earmark-arrow-down"></i> ${file.originName}
						                                </a>
						                            </div>
						                        </c:forEach>
						                    </c:otherwise>
						                </c:choose>
						            </div>
						        </div>
						</div>

						<div class="mt-4 text-center">
						    <a href="/tudio/approval/list" class="btn btn-secondary">목록으로</a>
						
						    <c:if test="${projectRole == 'MANAGER' && draft.memberNo == loginUser.memberNo && draft.documentStatus == 611}">
						        <button type="button" class="btn btn-warning" onclick="recallDocument()">회수</button>
						    </c:if>
						
						    <c:if test="${userAuth == 'ROLE_CLIENT' && isCurrentApprover && (draft.documentStatus == 611 || draft.documentStatus == 612)}">
							    <button type="button" class="btn btn-success" onclick="approveDocument()">승인</button>
							    <button type="button" class="btn btn-danger" onclick="openRejectModal()">반려</button>
							</c:if>
						</div>
					</div>
				</div>
			</main>
		</div>
		
	</section>
	<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title fw-bold">결재 반려</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	            </div>
	            <div class="modal-body">
	                <p class="text-muted small">반려 사유를 입력해주세요. 기안자가 확인할 수 있습니다.</p>
	                <textarea id="rejectionReason" class="form-control" rows="4" placeholder="사유 입력 (필수)"></textarea>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	                <button type="button" class="btn btn-danger" onclick="rejectDocument()">반려 처리</button>
	            </div>
	        </div>
	    </div>
	</div>
<script type="text/javascript">
function openRejectModal() {
    // 부트스트랩 모달 객체를 생성해서 보여줌
    const myModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    myModal.show();
}

// 2. 실제 반려 처리 (Ajax로 보낼 예정)
function rejectDocument() {
    const reason = document.getElementById('rejectionReason').value;
    if(!reason.trim()) {
        alert("반려 사유를 입력해주세요!");
        return;
    }
    
    console.log("반려 사유 : " + reason);
}
</script>
</body>
</html>