<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>

<link rel="stylesheet"
	href="${pageContext.request.contextPath}/css/task_list.css">

<div class="tab-content-card">
	<div class="tudio-section-header mb-4">
		<h5 class="mb-0 text-primary-dark fw-bold" id="taskViewTitle">ì—…ë¬´
			ëª©ë¡ (ë¦¬ìŠ¤íŠ¸)</h5>
		<div class="d-flex gap-2">
			<button class="tudio-btn tudio-btn-primary" id="createTaskBtn">
				<i class="bi bi-plus"></i> ìƒˆ ì—…ë¬´ ì¶”ê°€
			</button>
			<button class="tudio-btn" id="toggleViewButton"
				style="border: 1px solid var(--tudio-border-soft);">
				<i class="bi bi-list me-1"></i> ì¹¸ë°˜ ë³´ê¸°
			</button>
		</div>
	</div>

	<c:if test="${not empty errorMsg}">
		<div id="taskErrorMsg" data-error-msg="${fn:escapeXml(errorMsg)}"
			style="display: none;"></div>
	</c:if>

	<div id="listView">
		<div class="d-flex justify-content-end mb-3 px-3">
			<div class="tudio-search-wrap">
				<input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
				<button class="border-0 bg-transparent" aria-label="search">ğŸ”</button>
			</div>
		</div>
		<div class="tudio-table-wrap">
			<table class="tudio-table-card">
				<thead>
					<tr>
						<th>ì—…ë¬´ëª…</th>
						<th>ìƒíƒœ</th>
						<th>ë‹´ë‹¹ì</th>
						<th>ì‹œì‘ì¼</th>
						<th>ë§ˆê°ì¼</th>
						<th>ì¤‘ìš”ë„</th>
						<th>ì§„ì²™ë„</th>
						<th>ì‘ì„±ì</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach items="${taskList}" var="task">
						<tr class="task-row" data-task-id="${task.taskId}"
							style="cursor: pointer;">
							<td class="task-title" style="cursor: pointer;"><i
								class="bi bi-caret-right-fill toggle-icon me-1"></i>
								${task.taskTitle}</td>
							<td><span class="tudio-badge ${task.taskStatus.cssClass }">${task.taskStatus.label }</span></td>

							<td><c:set value="${task.taskManagers }" var="taskManager" />
								<c:choose>
									<c:when test="${empty taskManager }">
										<span>-</span>
									</c:when>
									<c:when test="${fn:length(taskManager) > 1 }">
										<span>${taskManager[0].memberName } +
											${fn:length(taskManager) -1 }</span>
									</c:when>
									<c:otherwise>
										<span>${taskManager[0].memberName }</span>
									</c:otherwise>
								</c:choose></td>
							<td class="text-muted"><fmt:formatDate
									value="${task.taskStartdate }" pattern="yyyy-MM-dd" /></td>
							<td class="text-muted"><fmt:formatDate
									value="${task.taskEnddate }" pattern="yyyy-MM-dd" /></td>
							<td><span class="tudio-badge notice ${task.taskPriority.cssClass}">${task.taskPriority.label }</span></td>

							<td>
								<div class="d-flex align-items-center gap-2">
									<div class="progress" style="height: 6px; width: 60px;">
										<div class="progress-bar bg-primary" role="progressbar"
											style="width: ${task.taskRate}%;"
											aria-valuenow="${task.taskRate}" aria-valuemin="0"
											aria-valuemax="100"></div>
									</div>
									<span class="small text-muted" style="min-width: 30px;">${task.taskRate }%</span>
								</div>
							</td>

							<td><small class="text-muted">${task.writerName }</small></td>
						</tr>

						<c:forEach items="${task.subTasks }" var="sub">
							<tr class="sub-row" data-parent-task-id="${sub.taskId}"
								data-sub-id="${sub.subId }"
								style="display: none; background: #fafafa;">
								<td class="sub-title ps-4" style="cursor: pointer;">${sub.subTitle}</td>
								<td><span class="tudio-badge ${sub.subStatus.cssClass }">${sub.subStatus.label }</span></td>

								<td><c:set value="${sub.subManagers }" var="subManager" />
									<c:choose>
										<c:when test="${empty subManager }">
											<span>-</span>
										</c:when>
										<c:when test="${fn:length(subManager) > 1 }">
											<span>${subManager[0].memberName } +
												${fn:length(subManager) -1 }</span>
										</c:when>
										<c:otherwise>
											<span>${subManager[0].memberName }</span>
										</c:otherwise>
									</c:choose></td>
								<td class="text-muted"><fmt:formatDate
										value="${sub.subStartdate }" pattern="yyyy-MM-dd" /></td>
								<td class="text-muted"><fmt:formatDate
										value="${sub.subEnddate }" pattern="yyyy-MM-dd" /></td>
								<td><span class="tudio-badge ${sub.subPriority.cssClass }">${sub.subPriority.label }</span></td>

								<td>
									<div class="d-flex align-items-center gap-2">
										<div class="progress" style="height: 6px; width: 60px;">
											<div class="progress-bar bg-primary" role="progressbar"
												style="width: ${sub.subRate}%;"
												aria-valuenow="${sub.subRate}" aria-valuemin="0"
												aria-valuemax="100"></div>
										</div>
										<span class="small text-muted" style="min-width: 30px;">${sub.subRate }%</span>
									</div>
								</td>

								<td><small class="text-muted">${sub.writerName }</small></td>
							</tr>
						</c:forEach>

						<tr class="sub-add-row" data-parent-task-id="${task.taskId}"
							style="display: none; background: #f0f0f0;">
							<td colspan="8" class="ps-4">
								<button class="btn btn-sm btn-outline-primary add-sub-btn"
									data-task-id="${task.taskId}">+ í•˜ìœ„ì—…ë¬´ ì¶”ê°€</button>
							</td>
						</tr>

					</c:forEach>
				</tbody>
			</table>
		</div>
	</div>
</div>