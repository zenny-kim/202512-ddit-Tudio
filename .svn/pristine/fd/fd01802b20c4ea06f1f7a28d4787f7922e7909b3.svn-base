<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
   
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시글 작성</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/sidebar.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/header.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/footer.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/member.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/css/boardinsertform.css">
</head>

<body>
<jsp:include page="/WEB-INF/views/include/header_user.jsp"/>
<jsp:include page="/WEB-INF/views/include/sidebar_user.jsp"/>

<section class="board-section">
  <div class="post-wrap">

    <div class="post-header">
      <h2>게시글 작성</h2>

      <label class="pin-toggle">
        <span>상단 고정</span>
        <input type="checkbox" id="pinYn" name="pinYn" value="Y"/>
        <i></i>
      </label>
    </div>

    <!-- ✅ form 추가: enctype 꼭 필요(파일) -->
    <form id="writeForm" method="post" enctype="multipart/form-data"
          action="${pageContext.request.contextPath}/project/board/insert">

      <div class="post-card">

        <div class="form-row">
          <div class="form-group form-head">
            <label for="prefix">말머리</label>
            <select id="prefix" name="prefix" class="bw-select">
              <option value="자유">자유</option>
              <option value="공지">공지</option>
              <option value="회의록">회의록</option>
            </select>
          </div>

          <div class="form-group form-title">
            <label for="boTitle">제목</label>
            <div class="title-input-wrap">
              <input type="text" id="boTitle" name="boTitle" maxlength="200" class="bw-input"
                     placeholder="제목을 입력하세요" />
            </div>
          </div>
        </div>

        <!-- 내용 -->
        <div class="form-group">
          <label for="content">내용</label>

          <!-- 실제 입력은 div -->
          <div class="editor-box" contenteditable="true" id="content"
               aria-label="내용을 입력하세요"></div>

          <!-- 서버로 보낼 값은 hidden -->
          <input type="hidden" id="boContentHidden" name="boContent" />
        </div>

        <!-- 첨부 파일 -->
        <div class="post-bottom">
          <div class="form-group">
            <label>첨부 파일</label>
            <input type="file" id="files" name="files" multiple class="bw-file" />
            <small>각 파일 10MB 이하</small>
          </div>
        </div>
      </div>

      <div class="post-actions">
        <button type="button" class="btn cancel" onclick="history.back()">취소</button>
        <button type="button" class="btn submit" id="submitBtn">등록하기</button>
      </div>

    </form>
  </div>
</section>

<jsp:include page="/WEB-INF/views/include/footer.jsp"/>
<script src="${pageContext.request.contextPath}/js/footer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="text/javascript">
$(function () {


  let $form = $("#writeForm");
  let $boTitle = $("#boTitle");
  let $content = $("#content");
  let $boContent = $("#boContentHidden");
  let $btn = $("#submitBtn");


  
  // 제목 input에서 Enter => 내용으로 포커스 이동시키기
  $boTitle.on("keydown", function(e){
  	if(e.key ==="Enter"){
  		e.preventDefault(); // submit 막기
  		$content.focus(); // 내용으로 퍼키스 이동
  	}
  	
  })
  

   //등록하기
   $btn.on("click", function (e) {
	   
	   e.preventDefault(); 
	   

    // 검증
    let title = $boTitle.val().trim();
    
    if(title == "" || title == null ){
    	
    	  Swal.fire({
				icon:"warning",
				text :"제목을 입력해주세요"
			  });
    	  
    	$boTitle.focus();
    	
    	return false;
    }

    
    let contentText = $content.text().trim();
    
    if(contentText == "" || contentText == null ){
    	
    	  Swal.fire({
				icon:"warning",
				text :"내용을 입력해주세요"
			  });
    	  
    	 $boContent.focus(); 
    	    	
    	return false;
    }
    
    
    let html = $content.html(); // 서버 전송용
	   $boContent.val(html);

    
    // 파일 제한(최대 5개, 각 10MB)
    const files = $("#files")[0].files;

    
    for (let i = 0; i < files.length; i++) {
      if (files[i].size > 10 * 1024 * 1024) {
        return;
      }
    }

    // 3) 서버로 전송 (일반 form submit)
    $form.submit();
  });
  
  $("#files").on("change", function(){
	  let files = this.files;
	  
	  for(let i=0; i<files.length; i++){
		  
		  if(files[i].size> 10*1024*1024){
			  
			  Swal.fire({
				icon:"warning",
				text : "10MB 이하의 파일만 등록 가능합니다.\n("+files[i].name+")"
			  });
			  
			  $(this).val(""); // 파일 초기화
			  return;
		  }
	  }
	  
  })
  
  

});
</script>
</body>
</html>
