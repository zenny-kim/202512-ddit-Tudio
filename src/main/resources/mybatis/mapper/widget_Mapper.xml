<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.dashboard.mapper.IWidgetMapper">

	<!-- 회원가입 시 자동 설정되는 위젯 정보 등록 -->
	<insert id="insertDefaultWidget" parameterType="list">
        INSERT INTO WIDGET (
            WIDGET_NO
            , MEMBER_NO
            , WIDGET_TYPE
            , WIDTH
            , HEIGHT
            , LOCATION_NO
            , WIDGET_STATUS
        )
        SELECT SEQ_WIDGET.NEXTVAL, A.* FROM (
            <foreach collection="list" item="item" separator=" UNION ALL ">
                SELECT 
                    #{item.memberNo} as MEMBER_NO
                    , #{item.widgetType} as WIDGET_TYPE
                    , #{item.width} as WIDTH
                    , #{item.height} as HEIGHT
                    , #{item.locationNo} as LOCATION_NO
                    , #{item.widgetStatus} as WIDGET_STATUS
                FROM DUAL
            </foreach>
        ) A
    </insert>

	<!-- 위젯 목록 조회 -->
	<select id="selectWidgetList" parameterType="int" resultType="kr.or.ddit.vo.WidgetVO">
		SELECT 
			WIDGET_NO
			, MEMBER_NO
			, WIDGET_TYPE
			, WIDTH
			, HEIGHT
			, WIDGET_STATUS
			, LOCATION_NO
		FROM WIDGET
		WHERE MEMBER_NO = #{memberNo}
		<!-- AND WIDGET_STATUS = 'Y' -->
	</select>
	
	 <!-- 위젯 레이아웃 변경 -->
	<update id="updateWidgetLayout" parameterType="kr.or.ddit.vo.WidgetVO">
		UPDATE WIDGET
		SET
			LOCATION_NO = #{locationNo}
			, WIDTH = #{width}
			, HEIGHT = #{height}
			, WIDGET_STATUS = #{widgetStatus}
		WHERE WIDGET_NO = #{widgetNo}
	      AND MEMBER_NO = #{memberNo} 
	</update>
	
	<!-- 위젯 사용여부 상태 변경 -->
	<update id="updateWidgetStatus" parameterType="map">
	    UPDATE WIDGET
	    SET WIDGET_STATUS = #{widgetStatus}
	    WHERE WIDGET_NO = #{widgetNo}
	</update>
	
	   
    <!-- [위젯 1] 지연 업무 조회 -->
   	<select id="selectDeadlineTask" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectTaskVO">
        SELECT 
            A.TASK_ID
            , A.TASK_TITLE
            , A.TASK_STATUS
            , A.TASK_RATE
            , A.TASK_ENDDATE
            , A.TASK_PRIORITY
            , A.PROJECT_NO
            , A.PROJECT_NAME
            , A.D_DAY AS taskDday
        FROM (
            SELECT 
                T.TASK_ID
                , T.TASK_TITLE
                , T.TASK_STATUS
                , T.TASK_RATE
                , T.TASK_ENDDATE
                , T.TASK_PRIORITY
                , P.PROJECT_NO
                , P.PROJECT_NAME
                , CEIL(CAST(T.TASK_ENDDATE AS DATE) - CAST(CURRENT_TIMESTAMP AS DATE)) AS D_DAY
            FROM PROJECT_TASK T
            INNER JOIN PROJECT P ON T.PROJECT_NO = P.PROJECT_NO
        	INNER JOIN PROJECT_TASK_MANAGER PTM ON T.TASK_ID = PTM.WORK_ID
        	INNER JOIN PROJECT_MEMBER PM ON P.PROJECT_NO = PM.PROJECT_NO AND PM.MEMBER_NO = PTM.MEMBER_NO
        	WHERE PTM.MEMBER_NO = #{memberNo}    
        	  AND PM.PROJECT_MEM_STATUS = 'Y'
              AND T.TASK_STATUS NOT IN (203, 204) 
              <![CDATA[ 
                AND T.TASK_ENDDATE >= TRUNC(CURRENT_TIMESTAMP)
              	AND T.TASK_ENDDATE <= (TRUNC(CURRENT_TIMESTAMP) + 7)  
              ]]> 
            ORDER BY T.TASK_ENDDATE ASC       
        ) A
        <![CDATA[ WHERE ROWNUM <= 5 ]]>                  
    </select>
    
    <!-- [위젯 2] 주간 일정 조회 -->
	<select id="selectWeeklyWorkList" parameterType="map" resultType="map">
		WITH WEEK_DAYS AS (
	        SELECT TO_DATE(#{startDate}, 'YYYY-MM-DD') + (LEVEL - 1) AS CAL_DATE
	        FROM DUAL
	        CONNECT BY LEVEL <![CDATA[ <= ]]> 7 
	    ),
	    MY_TASKS AS (
	    	SELECT 
				CAST(T.TASK_ID AS VARCHAR2(20)) AS WORK_ID
				, T.TASK_TITLE AS WORK_TITLE
				, T.TASK_STATUS AS WORK_STATUS
				, TRUNC(T.TASK_STARTDATE) AS START_DATE
            	, TRUNC(T.TASK_ENDDATE) AS END_DATE
				, 'TASK' AS WORK_TYPE
				, T.PROJECT_NO
			FROM PROJECT_TASK T
			INNER JOIN PROJECT_TASK_MANAGER PM ON T.TASK_ID = PM.WORK_ID
			INNER JOIN PROJECT_MEMBER PMM ON T.PROJECT_NO = PMM.PROJECT_NO AND PMM.MEMBER_NO = PM.MEMBER_NO
			WHERE PM.MEMBER_NO = #{memberNo} 
			  AND PMM.PROJECT_MEM_STATUS = 'Y'
			  AND PM.WORK_TYPE = 'T'           
	            
	        UNION ALL
	            
			SELECT 
				CAST(S.SUB_ID AS VARCHAR2(20)) AS WORK_ID
				, S.SUB_TITLE AS WORK_TITLE
			    , S.SUB_STATUS AS WORK_STATUS
				, TRUNC(S.SUB_STARTDATE) AS START_DATE
            	, TRUNC(S.SUB_ENDDATE) AS END_DATE
				, 'SUB' AS WORK_TYPE
				, T.PROJECT_NO
			FROM PROJECT_TASK_SUB S
			INNER JOIN PROJECT_TASK_MANAGER PM ON S.SUB_ID = PM.WORK_ID
			INNER JOIN PROJECT_TASK T ON S.TASK_ID = T.TASK_ID
			INNER JOIN PROJECT_MEMBER PMM ON T.PROJECT_NO = PMM.PROJECT_NO AND PMM.MEMBER_NO = PM.MEMBER_NO
			WHERE PM.MEMBER_NO = #{memberNo} 
			  AND PMM.PROJECT_MEM_STATUS = 'Y'
			  AND PM.WORK_TYPE = 'S'            
		)
		SELECT 
	        M.WORK_ID
	        , M.WORK_TITLE
	        , M.WORK_STATUS
	        , M.WORK_TYPE
	        , TO_CHAR(W.CAL_DATE, 'YYYY-MM-DD') AS WORK_DATE_STR
	        , TO_CHAR(W.CAL_DATE, 'DY') AS WORK_DAY
	        , M.PROJECT_NO
	        , P.PROJECT_NAME
	        , COUNT(M.WORK_ID) OVER(PARTITION BY TO_CHAR(W.CAL_DATE, 'YYYY-MM-DD')) AS DAILY_COUNT
	    FROM WEEK_DAYS W
	    INNER JOIN MY_TASKS M ON W.CAL_DATE BETWEEN M.START_DATE AND M.END_DATE
	    LEFT JOIN PROJECT P ON M.PROJECT_NO = P.PROJECT_NO
	    ORDER BY W.CAL_DATE ASC			-- 날짜 순으로 먼저 정렬
	             , M.END_DATE ASC		-- 같은 날짜라면 마감일이 빠른 순으로 정렬
	             , M.WORK_TITLE ASC	    -- 마감일도 같다면 제목 순으로 가나다 정렬
    </select>
	
	<!-- [위젯 3] 시스템 공지사항 -->
	<select id="selectWidgetNoticeList" resultType="kr.or.ddit.vo.NoticeVO">
        SELECT A.* 
    	FROM (
            SELECT 
                N.NOTICE_NO
                , N.NOTICE_TITLE
                , N.NOTICE_REGDATE
                , M.MEMBER_ID as writer
            FROM NOTICE N
            LEFT JOIN MEMBER M ON N.MEMBER_NO = M.MEMBER_NO
            ORDER BY N.NOTICE_REGDATE DESC   
        ) A
        <![CDATA[ WHERE ROWNUM <= 10 ]]>
    </select>
    
    <!-- [위젯 4] 알림 -->
	<select id="selectWidgetNotiList" parameterType="int" resultType="kr.or.ddit.vo.NotificationVO">
        SELECT 
            N.NOTI_NO
            , N.NOTI_TYPE
            , N.NOTI_URL
            , N.IS_READ
            , N.NOTI_REGDATE
            , N.NOTI_MESSAGE
	        , NVL((
	            CASE 
	                -- 1. [시스템/일정]
	                WHEN N.NOTI_TYPE IN ('NOTI_SCHEDULE', 'NOTI_SYSTEM') THEN 'SYSTEM'
	                
	                -- 2. [전자결재] 다단계 차수별 발신자 추적
	                WHEN N.NOTI_TYPE = 'NOTI_APPROVAL' AND N.TARGET_ID != 0 THEN (
	                    CASE 
	                        -- A. 승인/반려 결과: 알림 생성 시점보다 과거에 가장 가까운 승인자를 찾음
	                        WHEN N.NOTI_MESSAGE LIKE '%되었습니다%' THEN (
	                            SELECT SENDER_NAME FROM (
	                                SELECT M.MEMBER_NAME AS SENDER_NAME
	                                FROM DRAFT_APPROVAL A 
	                                INNER JOIN MEMBER M ON A.MEMBER_NO = M.MEMBER_NO
	                                WHERE A.DOCUMENT_NO = N.TARGET_ID 
	                                  AND A.APPROVAL_STATUS IN (608, 609, 610, 613, 614)
	                                  -- 알림 생성 시간(N)보다 이전에 승인(A)한 사람 중 가장 최근 사람
	                                  <![CDATA[ AND A.APPROVAL_DATE <= N.NOTI_REGDATE  ]]> 
	                                ORDER BY A.APPROVAL_DATE DESC
	                            ) WHERE ROWNUM = 1
	                        )
	                        -- B. 결재 요청: 기안자를 찾음
	                        WHEN N.NOTI_MESSAGE LIKE '%확인하세요%' THEN (
	                            SELECT MAX(M.MEMBER_NAME)
	                            FROM DRAFT_DOCUMENT D INNER JOIN MEMBER M ON D.MEMBER_NO = M.MEMBER_NO
	                            WHERE D.DOCUMENT_NO = N.TARGET_ID
	                        )
	                        ELSE 'SYSTEM'
	                    END
	                )
	                
	                -- 3. [게시판/업무/초대] 알림 통합 처리
	                WHEN N.NOTI_TYPE IN ('NOTI_TASK', 'NOTI_INVITE') AND N.TARGET_ID != 0 THEN (
	                    CASE 
	                        -- A. 댓글/답글인 경우 (URL 판별 강화)
	                        WHEN N.NOTI_MESSAGE LIKE '%댓글%' OR N.NOTI_MESSAGE LIKE '%답글%' THEN (
	                            SELECT MAX(M.MEMBER_NAME)
	                            FROM TB_COMMENT C
	                            INNER JOIN MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
	                            WHERE C.TARGET_ID = N.TARGET_ID
	                              AND C.TARGET_TYPE = (
	                                  CASE 
	                                      WHEN N.NOTI_URL LIKE '%boNo=%' OR N.NOTI_URL LIKE '%tab=board%' THEN 'B' 
	                                      ELSE 'T' 
	                                  END
	                              )
	                        )
	                        -- B. 프로젝트/초대 (URL에 게시글 정보가 없는 경우)
	                        WHEN N.NOTI_URL NOT LIKE '%boNo=%' AND N.NOTI_URL NOT LIKE '%tab=board%' THEN (
	                            SELECT MAX(M.MEMBER_NAME) FROM PROJECT P 
	                            INNER JOIN MEMBER M ON P.MEMBER_NO = M.MEMBER_NO
	                            WHERE P.PROJECT_NO = N.TARGET_ID
	                        )
	                        -- C. 일반 게시글 등록/수정
	                        ELSE (
	                            SELECT MAX(M.MEMBER_NAME) FROM PROJECT_BOARD B 
	                            INNER JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
	                            WHERE B.BO_NO = N.TARGET_ID
	                        )
	                    END
	                )
	                ELSE 'SYSTEM'
	            END
	        ), 'SYSTEM') AS "senderId"
        FROM NOTIFICATION N
        WHERE N.MEMBER_NO = #{memberNo}
        ORDER BY N.NOTI_REGDATE DESC
    </select>
    
    <select id="selectNotiStats" parameterType="int" resultType="map">
	    SELECT 
	        COUNT(*) AS "ALL_COUNT"
	        , COUNT(CASE WHEN IS_READ = 'N' THEN 1 END) AS "UNREAD_COUNT"
	        , COUNT(CASE WHEN IS_READ = 'Y' THEN 1 END) AS "READ_COUNT"
	    FROM NOTIFICATION
	    WHERE MEMBER_NO = #{memberNo}
	</select>
    
    <!-- [위젯 4] 알림 상태 변경 -->
    <update id="updateNotiStatus" parameterType="map">
        UPDATE NOTIFICATION
        SET IS_READ = #{status}
        WHERE NOTI_NO = #{notiNo}
    </update>

    <delete id="deleteNoti" parameterType="int">
        DELETE FROM NOTIFICATION
        WHERE NOTI_NO = #{notiNo}
    </delete>
    
    
	<!-- [위젯 5] 북마크 프로젝트 -->
	<select id="selectWidgetBookmarkList" parameterType="int" resultType="kr.or.ddit.vo.project.ProjectVO">
        SELECT 
            P.PROJECT_NO
            , P.PROJECT_NAME
            , P.PROJECT_STATUS
            , P.PROJECT_DESC
            , P.PROJECT_STARTDATE AS projectStartdate
            , P.PROJECT_ENDDATE AS projectEnddate
            , (
	            (SELECT COUNT(*)
	               FROM PROJECT_TASK T
	              INNER JOIN PROJECT_TASK_MANAGER PM ON T.TASK_ID = PM.WORK_ID
	              WHERE T.PROJECT_NO = P.PROJECT_NO
	                AND PM.MEMBER_NO = #{memberNo}
	                AND PM.WORK_TYPE = 'T'     
	                AND T.TASK_STATUS != 203) 
	             + 
	            (SELECT COUNT(*)
	               FROM PROJECT_TASK_SUB S
	              INNER JOIN PROJECT_TASK_MANAGER PM ON S.SUB_ID = PM.WORK_ID
	              INNER JOIN PROJECT_TASK T ON S.TASK_ID = T.TASK_ID  
	              WHERE T.PROJECT_NO = P.PROJECT_NO     
	                AND PM.MEMBER_NO = #{memberNo}
	                AND PM.WORK_TYPE = 'S'
	                AND S.SUB_STATUS != 203)
	        ) AS myTaskCount
	        , (
	            (SELECT COUNT(*) FROM PROJECT_TASK T 
	               JOIN PROJECT_TASK_MANAGER PM ON T.TASK_ID = PM.WORK_ID 
	              WHERE T.PROJECT_NO = P.PROJECT_NO AND PM.MEMBER_NO = #{memberNo} AND PM.WORK_TYPE = 'T') 
	             + 
	            (SELECT COUNT(*) FROM PROJECT_TASK_SUB S 
	               JOIN PROJECT_TASK_MANAGER PM ON S.SUB_ID = PM.WORK_ID 
	               JOIN PROJECT_TASK T ON S.TASK_ID = T.TASK_ID  
	              WHERE T.PROJECT_NO = P.PROJECT_NO AND PM.MEMBER_NO = #{memberNo} AND PM.WORK_TYPE = 'S')
	        ) AS myTotalTaskCount
	
	        , (
	            (SELECT COUNT(*) FROM PROJECT_TASK T 
	               JOIN PROJECT_TASK_MANAGER PM ON T.TASK_ID = PM.WORK_ID 
	              WHERE T.PROJECT_NO = P.PROJECT_NO AND PM.MEMBER_NO = #{memberNo} AND PM.WORK_TYPE = 'T' AND T.TASK_STATUS = 203) 
	             + 
	            (SELECT COUNT(*) FROM PROJECT_TASK_SUB S 
	               JOIN PROJECT_TASK_MANAGER PM ON S.SUB_ID = PM.WORK_ID 
	               JOIN PROJECT_TASK T ON S.TASK_ID = T.TASK_ID  
	              WHERE T.PROJECT_NO = P.PROJECT_NO AND PM.MEMBER_NO = #{memberNo} AND PM.WORK_TYPE = 'S' AND S.SUB_STATUS = 203)
	        ) AS myDoneTaskCount
	        
            , (SELECT COUNT(*) 
               	 FROM PROJECT_TASK T 
              	WHERE T.PROJECT_NO = P.PROJECT_NO) AS totalTaskCount
            , (SELECT COUNT(*) 
                 FROM PROJECT_TASK T 
                WHERE T.PROJECT_NO = P.PROJECT_NO 
                  AND T.TASK_STATUS = 203) AS completedTaskCount
        FROM PROJECT P
        INNER JOIN PROJECT_MEMBER M ON P.PROJECT_NO = M.PROJECT_NO
        WHERE M.MEMBER_NO = #{memberNo}
          AND M.PROJECT_BOOKMARK = 'Y'  
        ORDER BY P.PROJECT_STATUS ASC
        	   , P.PROJECT_ENDDATE ASC
    </select>
    
    <!-- [위젯 7] 결재 -->
    <select id="selectDocumentlStats" parameterType="int" resultType="map">
        SELECT 
	        -- 대기 (611: 승인대기)
	        (SELECT COUNT(*) FROM DRAFT_DOCUMENT 
	          WHERE MEMBER_NO = #{memberNo} AND DOCUMENT_STATUS = 611) AS WAIT_COUNT
	          
	        -- 진행 (612: 진행중)
	        , (SELECT COUNT(*) FROM DRAFT_DOCUMENT 
	            WHERE MEMBER_NO = #{memberNo} AND DOCUMENT_STATUS = 612) AS PROG_COUNT
	            
	        -- 반려 (614: 반려)
	        , (SELECT COUNT(*) FROM DRAFT_DOCUMENT 
	            WHERE MEMBER_NO = #{memberNo} AND DOCUMENT_STATUS = 614) AS REJECT_COUNT
	            
	        -- 승인 (613: 최종승인)
	        , (SELECT COUNT(*) FROM DRAFT_DOCUMENT 
	            WHERE MEMBER_NO = #{memberNo} AND DOCUMENT_STATUS = 613) AS APPROVED_COUNT
	    FROM DUAL
    </select>

    <select id="selectMyDraftList" parameterType="int" resultType="kr.or.ddit.vo.DraftDocumentVO">
        SELECT 
        	D.DOCUMENT_NO
            , D.DOCUMENT_TITLE
            , D.DOCUMENT_STATUS
            , TO_CHAR(D.DOCUMENT_REGDATE, 'YY.MM.DD') AS "DOCUMENT_REGDATE"
            , D.DOCUMENT_TYPE
        FROM DRAFT_DOCUMENT D
        WHERE D.MEMBER_NO = #{memberNo}
          AND D.DOCUMENT_STATUS NOT IN (615, 616)
        ORDER BY D.DOCUMENT_REGDATE DESC
    </select>
    
    <select id="selectApprovalStats" parameterType="int" resultType="map">
	    SELECT 
	        -- 미결 (607)
	        (SELECT COUNT(*) 
	           FROM DRAFT_APPROVAL A
	          INNER JOIN DRAFT_DOCUMENT D ON A.DOCUMENT_NO = D.DOCUMENT_NO
	          WHERE A.MEMBER_NO = #{memberNo} 
	            AND A.APPROVAL_STATUS = 607
	            AND D.DOCUMENT_STATUS NOT IN (615, 616)) AS "PENDING_COUNT"
	            
	        -- 확인 (608)
	        , (SELECT COUNT(*) 
	             FROM DRAFT_APPROVAL A
	            INNER JOIN DRAFT_DOCUMENT D ON A.DOCUMENT_NO = D.DOCUMENT_NO
	            WHERE A.MEMBER_NO = #{memberNo} 
	              AND A.APPROVAL_STATUS = 608
	              AND D.DOCUMENT_STATUS NOT IN (615, 616)) AS "CONFIRM_COUNT"
	            
	        -- 반려 (610)
	        , (SELECT COUNT(*) 
	             FROM DRAFT_APPROVAL A
	            INNER JOIN DRAFT_DOCUMENT D ON A.DOCUMENT_NO = D.DOCUMENT_NO
	            WHERE A.MEMBER_NO = #{memberNo} 
	              AND A.APPROVAL_STATUS = 610
	              AND D.DOCUMENT_STATUS NOT IN (615, 616)) AS "REJECT_COUNT"
	            
	        -- 승인 (609)
	        , (SELECT COUNT(*) 
	             FROM DRAFT_APPROVAL A
	            INNER JOIN DRAFT_DOCUMENT D ON A.DOCUMENT_NO = D.DOCUMENT_NO
	            WHERE A.MEMBER_NO = #{memberNo} 
	              AND A.APPROVAL_STATUS = 609
	              AND D.DOCUMENT_STATUS NOT IN (615, 616)) AS "APPROVE_COUNT"
	    FROM DUAL
	</select>

    <select id="selectToApproveList" parameterType="int" resultType="kr.or.ddit.vo.DraftDocumentVO">
		SELECT 
			D.DOCUMENT_NO
			, D.DOCUMENT_TITLE
			, TO_CHAR(D.DOCUMENT_REGDATE, 'YY.MM.DD') AS DOCUMENT_REGDATE
			, D.DOCUMENT_TYPE
			, A.APPROVAL_STATUS AS DOCUMENT_STATUS
			, M.MEMBER_NAME AS "drafterName"
		FROM DRAFT_APPROVAL A
        INNER JOIN DRAFT_DOCUMENT D ON A.DOCUMENT_NO = D.DOCUMENT_NO
        INNER JOIN MEMBER M ON D.MEMBER_NO = M.MEMBER_NO
	    WHERE A.MEMBER_NO = #{memberNo}     
	      AND A.APPROVAL_STATUS IN (607, 608, 609, 610)
          AND D.DOCUMENT_STATUS NOT IN (615, 616)
	    ORDER BY CASE WHEN A.APPROVAL_STATUS = 607 THEN 1 
	             ELSE 2 END ASC
              , D.DOCUMENT_REGDATE DESC      
    </select>
    
    <!-- 설문 -->
    <select id="selectPendingSurvey" parameterType="int" resultType="kr.or.ddit.vo.survey.SurveyVO">
        SELECT 
            S.SURVEY_NO
            , S.SURVEY_TITLE
            , S.SURVEY_END_DATE
        FROM SURVEY S
        WHERE S.SURVEY_CLOSE_STATUS = 'N'
          AND S.SURVEY_DELETE_STATUS = 'N'
          AND S.SURVEY_NO NOT IN (
              SELECT SP.SURVEY_NO 
              FROM SURVEY_PARTICIPATION SP 
              WHERE SP.MEMBER_NO = #{memberNo}
          )
        ORDER BY S.SURVEY_END_DATE ASC
    </select>
</mapper>